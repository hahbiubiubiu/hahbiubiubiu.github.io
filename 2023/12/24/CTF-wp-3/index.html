<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>CTF-WP-3 | hahbiubiubiu</title><meta name="keywords" content="Reverse,CTF"><meta name="author" content="hahbiubiubiu"><meta name="copyright" content="hahbiubiubiu"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="N1CTF2023AdditionPlus程序获取输入，然后八个字节八个字节的加密。 八个字节的加密方式是分别经过八个函数，每个函数得到一个字节的运算结果，然后进行比对。 每个函数有一堆运算由与、异或、左移1位组成。 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950">
<meta property="og:type" content="article">
<meta property="og:title" content="CTF-WP-3">
<meta property="og:url" content="http://hahbiubiubiu.github.io/2023/12/24/CTF-wp-3/index.html">
<meta property="og:site_name" content="hahbiubiubiu">
<meta property="og:description" content="N1CTF2023AdditionPlus程序获取输入，然后八个字节八个字节的加密。 八个字节的加密方式是分别经过八个函数，每个函数得到一个字节的运算结果，然后进行比对。 每个函数有一堆运算由与、异或、左移1位组成。 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://hahbiubiubiu.github.io/img/preview.jpg">
<meta property="article:published_time" content="2023-12-24T06:15:07.041Z">
<meta property="article:modified_time" content="2023-12-24T06:22:03.161Z">
<meta property="article:author" content="hahbiubiubiu">
<meta property="article:tag" content="Reverse">
<meta property="article:tag" content="CTF">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://hahbiubiubiu.github.io/img/preview.jpg"><link rel="shortcut icon" href="/./img/Valkyrie.jpg"><link rel="canonical" href="http://hahbiubiubiu.github.io/2023/12/24/CTF-wp-3/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":100},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'CTF-WP-3',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-12-24 14:22:03'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/./img/Valkyrie.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">24</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fa fa-sitemap"></i><span> 站点</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener" href="https://0x3.com"><i class="fa-fw fa fa-paper-plane"></i><span> 我的导航</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.bilibili.com/"><i class="fa-fw fa fa fa-window-restore"></i><span> BilBil</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-bookmark"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user"></i><span> 关于我</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/./img/preview.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">hahbiubiubiu</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fa fa-sitemap"></i><span> 站点</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener" href="https://0x3.com"><i class="fa-fw fa fa-paper-plane"></i><span> 我的导航</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.bilibili.com/"><i class="fa-fw fa fa fa-window-restore"></i><span> BilBil</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-bookmark"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user"></i><span> 关于我</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">CTF-WP-3</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-12-24T06:15:07.041Z" title="发表于 2023-12-24 14:15:07">2023-12-24</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-12-24T06:22:03.161Z" title="更新于 2023-12-24 14:22:03">2023-12-24</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Reverse/">Reverse</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="CTF-WP-3"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="N1CTF2023"><a href="#N1CTF2023" class="headerlink" title="N1CTF2023"></a>N1CTF2023</h1><h2 id="AdditionPlus"><a href="#AdditionPlus" class="headerlink" title="AdditionPlus"></a>AdditionPlus</h2><p>程序获取输入，然后八个字节八个字节的加密。</p>
<p>八个字节的加密方式是分别经过八个函数，每个函数得到一个字节的运算结果，然后进行比对。</p>
<p>每个函数有一堆运算由与、异或、左移1位组成。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">    __int64 v3; <span class="comment">// r15</span></span><br><span class="line">    __int64 v4; <span class="comment">// rax</span></span><br><span class="line">    __int64 v5; <span class="comment">// r12</span></span><br><span class="line">    <span class="type">int</span> *v6; <span class="comment">// r14</span></span><br><span class="line">    <span class="type">char</span> v7; <span class="comment">// cl</span></span><br><span class="line">    <span class="type">char</span> v8; <span class="comment">// al</span></span><br><span class="line">    __int64 v9; <span class="comment">// rax</span></span><br><span class="line">    __int64 v10; <span class="comment">// rdx</span></span><br><span class="line">    _BOOL8 v11; <span class="comment">// rdi</span></span><br><span class="line">    <span class="type">int</span> *v13; <span class="comment">// [rsp+8h] [rbp-F0h]</span></span><br><span class="line">    <span class="type">int</span> *v14; <span class="comment">// [rsp+8h] [rbp-F0h]</span></span><br><span class="line">    <span class="type">unsigned</span> __int64 v15; <span class="comment">// [rsp+10h] [rbp-E8h]</span></span><br><span class="line">    __m128i si128; <span class="comment">// [rsp+20h] [rbp-D8h]</span></span><br><span class="line">    __m128i v17; <span class="comment">// [rsp+30h] [rbp-C8h]</span></span><br><span class="line">    <span class="type">char</span> input[<span class="number">64</span>]; <span class="comment">// [rsp+40h] [rbp-B8h] BYREF</span></span><br><span class="line">    __int128 v19; <span class="comment">// [rsp+80h] [rbp-78h]</span></span><br><span class="line">    __int128 v20; <span class="comment">// [rsp+90h] [rbp-68h]</span></span><br><span class="line">    __int128 v21; <span class="comment">// [rsp+A0h] [rbp-58h]</span></span><br><span class="line">    __int16 v22; <span class="comment">// [rsp+B0h] [rbp-48h]</span></span><br><span class="line">    <span class="type">unsigned</span> __int64 v23; <span class="comment">// [rsp+B8h] [rbp-40h]</span></span><br><span class="line"></span><br><span class="line">    v3 = <span class="number">0LL</span>;</span><br><span class="line">    v23 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">    v22 = <span class="number">0</span>;</span><br><span class="line">    v15 = _mm_load_si128(&amp;xmmword_5581678DF060).m128i_u64[<span class="number">0</span>]; <span class="comment">// 加密结果</span></span><br><span class="line">    si128 = _mm_load_si128(&amp;xmmword_5581678DF070);</span><br><span class="line">    v17 = _mm_load_si128(&amp;xmmword_5581678DF080);</span><br><span class="line">    v19 = <span class="number">0LL</span>;</span><br><span class="line">    v20 = <span class="number">0LL</span>;</span><br><span class="line">    v21 = <span class="number">0LL</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;flag&gt;&gt;&quot;</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%48s&quot;</span>, input);</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        ...</span><br><span class="line">            </span><br><span class="line">        LABEL_14:</span><br><span class="line">        <span class="comment">// 分别调用八个加密函数</span></span><br><span class="line">        *(&amp;v19 + v3) = (*(v6 + <span class="number">5</span>))(			<span class="comment">// 8 hits. Symbolic instruction</span></span><br><span class="line">            input[v3 &amp; <span class="number">0xFFFFFFF8</span>],			<span class="comment">// 8 hits. Symbolic instruction</span></span><br><span class="line">            input[((v3 &amp; <span class="number">0xFFFFFFF8</span>) + <span class="number">1</span>)],			<span class="comment">// 8 hits. Symbolic instruction</span></span><br><span class="line">            input[((v3 &amp; <span class="number">0xFFFFFFF8</span>) + <span class="number">2</span>)],			<span class="comment">// 8 hits. Symbolic instruction</span></span><br><span class="line">            input[((v3 &amp; <span class="number">0xFFFFFFF8</span>) + <span class="number">3</span>)],			<span class="comment">// 8 hits. Symbolic instruction</span></span><br><span class="line">            input[((v3 &amp; <span class="number">0xFFFFFFF8</span>) + <span class="number">4</span>)],			<span class="comment">// 8 hits. Symbolic instruction</span></span><br><span class="line">            input[((v3 &amp; <span class="number">0xFFFFFFF8</span>) + <span class="number">5</span>)],			<span class="comment">// 8 hits. Symbolic instruction</span></span><br><span class="line">            input[((v3 &amp; <span class="number">0xFFFFFFF8</span>) + <span class="number">6</span>)],			<span class="comment">// 8 hits. Symbolic instruction</span></span><br><span class="line">            input[((v3 &amp; <span class="number">0xFFFFFFF8</span>) + <span class="number">7</span>)]);			<span class="comment">// 8 hits. Symbolic instruction</span></span><br><span class="line">        ++v3;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v3 != <span class="number">48</span> );			<span class="comment">// 8 hits. Symbolic instruction</span></span><br><span class="line">    <span class="keyword">if</span> ( v15 == v19 &amp;&amp; *&amp;si128 == v20 &amp;&amp; *&amp;v17 == v21 )			<span class="comment">// Symbolic instruction</span></span><br><span class="line">        <span class="built_in">puts</span>(aCorrectFlagCon);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">puts</span>(aNoTryAgain);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="解法一——Ponce"><a href="#解法一——Ponce" class="headerlink" title="解法一——Ponce"></a>解法一——Ponce</h3><p>这里看了师傅的WP复现一下👉<a target="_blank" rel="noopener" href="https://cn-sec.com/archives/2140081.html">2023 N1CTF writeup by Arr3stY0u</a></p>
<p>顺便了解一下Ponce这个工具的使用。</p>
<p>首先，<a target="_blank" rel="noopener" href="https://github.com/illera88/Ponce">illera88&#x2F;Ponce</a>获取两个<code>DLL</code>直接放在<code>plugins</code>目录下即可。</p>
<p>进入IDA，由Ponce配置设置，这里红框中有时间的设置，在这题得设大一些。</p>
<p><img src="/2023/12/24/CTF-wp-3/image-20231118160448115.png"></p>
<p>这里每次八个字节进行符号执行，以前八个字节为例，先对程序进行Patch。</p>
<p>前八个字节，就先将index上限到8。</p>
<p>然后比对的时候，程序是十六个字节进行比对的，这里将<code>or rdx, rax</code>改为<code>or rax, rax</code>，即可改为只比对前八个字节。</p>
<p><img src="/2023/12/24/CTF-wp-3/image-20231118161528905.png"></p>
<p>在程序获取输入后，为前八字节进行操作：</p>
<p><img src="/2023/12/24/CTF-wp-3/image-20231118161242504.png"></p>
<p>接下来可以直接运行到判断前八字节比对结果的跳转指令处：</p>
<p><img src="/2023/12/24/CTF-wp-3/image-20231118161333906.png"></p>
<p>在这里，如果比对失败会走<code>0x000055816786A38F</code>，比对成功会走<code>0x000055816786A374</code>，这里由于输入的不是flag，会走<code>0x000055816786A38F</code>，这里让Ponce解出走<code>0x000055816786A374</code>的输入：</p>
<p><img src="/2023/12/24/CTF-wp-3/image-20231118161905897.png"></p>
<p>跑了小久，成功解出前八个字节的flag：</p>
<p><img src="/2023/12/24/CTF-wp-3/image-20231118161957035.png"></p>
<p>尝试一次跑十六个字节的，也是可以的：</p>
<p><img src="/2023/12/24/CTF-wp-3/image-20231119135836045.png"></p>
<p>之后就是如法炮制解出剩余flag：<code>n1ctf&#123;c327b78b-8ead-425H1N09d-89fb-1d2d0a8f3e7c&#125;</code></p>
<h2 id="N1LLua"><a href="#N1LLua" class="headerlink" title="N1LLua"></a>N1LLua</h2><p><a target="_blank" rel="noopener" href="https://orientalglass.github.io/2023/10/25/%E6%AF%94%E8%B5%9B/N1CTF2023/N1CTF2023-N1LLua/">N1CTF2023-N1LLua | OrientalGlass</a> 👈 看这位师傅的WP</p>
<p>使用AssetBundleExtractor导出<code>main.lua</code>:</p>
<p><img src="/2023/12/24/CTF-wp-3/image-20231118184743664.png"></p>
<p>根据<code>luac</code>的文件头删去多余的前十六个字节：</p>
<p><img src="/2023/12/24/CTF-wp-3/image-20231118184849889.png"></p>
<p>使用<code>unluac</code>来反编译：<code>java -jar .\unluac.jar .\main.lua-resources.assets-13.dat &gt; main.lua</code></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> L0_1, L1_1, L2_1, L3_1, L4_1</span><br><span class="line">L0_1 = <span class="built_in">require</span></span><br><span class="line">L1_1 = <span class="string">&quot;luavm.bytecode&quot;</span></span><br><span class="line">L0_1 = L0_1(L1_1)</span><br><span class="line">L1_1 = <span class="built_in">require</span></span><br><span class="line">L2_1 = <span class="string">&quot;luavm.vm&quot;</span></span><br><span class="line">L1_1 = L1_1(L2_1)</span><br><span class="line">L2_1 = <span class="built_in">require</span></span><br><span class="line">L3_1 = <span class="string">&quot;luavm.vm52&quot;</span></span><br><span class="line">L2_1(L3_1)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">L2_1</span><span class="params">(...)</span></span></span><br><span class="line">  <span class="keyword">local</span> L0_2, L1_2</span><br><span class="line">  L0_2, L1_2 = ...</span><br><span class="line">  <span class="keyword">return</span> L0_2, L1_2</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">pass = L2_1</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">L2_1</span><span class="params">(A0_2)</span></span></span><br><span class="line">  <span class="keyword">local</span> L1_2, L2_2, L3_2, L4_2</span><br><span class="line">  L2_2 = A0_2</span><br><span class="line">  L1_2 = A0_2.<span class="built_in">gsub</span></span><br><span class="line">  L3_2 = <span class="string">&quot;%x%x&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">L4_2</span><span class="params">(A0_3)</span></span></span><br><span class="line">    <span class="keyword">local</span> L1_3, L2_3, L3_3, L4_3</span><br><span class="line">    L1_3 = <span class="built_in">string</span></span><br><span class="line">    L1_3 = L1_3.<span class="built_in">char</span></span><br><span class="line">    L2_3 = <span class="built_in">tonumber</span></span><br><span class="line">    L3_3 = A0_3</span><br><span class="line">    L4_3 = <span class="number">16</span></span><br><span class="line">    L2_3, L3_3, L4_3 = L2_3(L3_3, L4_3)</span><br><span class="line">    <span class="keyword">return</span> L1_3(L2_3, L3_3, L4_3)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">  L1_2 = L1_2(L2_2, L3_2, L4_2)</span><br><span class="line">  <span class="keyword">return</span> L1_2</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">L3_1</span><span class="params">(A0_2)</span></span></span><br><span class="line">  <span class="keyword">local</span> L1_2, L2_2, L3_2, L4_2</span><br><span class="line">  L2_2 = A0_2</span><br><span class="line">  L1_2 = A0_2.<span class="built_in">gsub</span></span><br><span class="line">  L3_2 = <span class="string">&quot;.&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">L4_2</span><span class="params">(A0_3)</span></span></span><br><span class="line">    <span class="keyword">local</span> L1_3, L2_3, L3_3, L4_3</span><br><span class="line">    L1_3 = <span class="built_in">string</span></span><br><span class="line">    L1_3 = L1_3.<span class="built_in">format</span></span><br><span class="line">    L2_3 = <span class="string">&quot;%02x&quot;</span></span><br><span class="line">    L4_3 = A0_3</span><br><span class="line">    L3_3 = A0_3.<span class="built_in">byte</span></span><br><span class="line">    L3_3, L4_3 = L3_3(L4_3)</span><br><span class="line">    <span class="keyword">return</span> L1_3(L2_3, L3_3, L4_3)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">  L1_2 = L1_2(L2_2, L3_2, L4_2)</span><br><span class="line">  <span class="keyword">return</span> L1_2</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">L4_1</span><span class="params">(A0_2)</span></span></span><br><span class="line">  <span class="keyword">local</span> L1_2, L2_2, L3_2, L4_2</span><br><span class="line">  L1_2 = L2_1</span><br><span class="line">  L2_2 = <span class="string">&quot;1b4c7561520001040804080019930d0a1a0a0a0000005f000000000102090000002500000008000080254000000800808006404000660000001e0000001f0000001f00800002000000040800000000000000656e6372797074000405000000000000006d61696e00020000002b0000003a0000000300132e000000cd004001c7c000000d414001070101004181000081c10000c701c0000742c0004702c1008742c100c10200000183010041030000e10206804d818102c6c34100c703c20706c4410007044208524441024dc481088d4401021d848001524442024d048208dd838001cdc08301c6c34100c703c20706c44100070442085244c1014d4482088d4481011d8480015244c2014d848208dd8380010dc10302e042f97fcd0240010d434001400380010a0001060a4083051f0080000a00000003000000000000f03f0300000000000000400300000000000000000300002037efc6e34103000000000000084003000000000000104003000000000000404004060000000000000062697433320004050000000000000062786f7200030000000000001440000000000100000000000a0000000000000040746573742e6c7561002e0000002c0000002c0000002c0000002c0000002d0000002e0000002f0000002f0000002f0000002f00000031000000310000003100000031000000320000003500000035000000350000003500000035000000350000003500000035000000350000003500000035000000350000003600000036000000360000003600000036000000360000003600000036000000360000003600000036000000360000003100000039000000390000003900000039000000390000003a0000000f00000002000000000000007600000000002e00000002000000000000006b00000000002e00000002000000000000007000000000002e0000000300000000000000763000040000002e0000000300000000000000763100040000002e000000040000000000000073756d00050000002e000000060000000000000064656c746100060000002e00000003000000000000006b30000a0000002e00000003000000000000006b31000a0000002e00000003000000000000006b32000a0000002e00000003000000000000006b33000a0000002e0000000c0000000000000028666f7220696e64657829000d000000280000000c0000000000000028666f72206c696d697429000d000000280000000b0000000000000028666f72207374657029000d00000028000000020000000000000069000e000000270000000100000005000000000000005f454e56004d0000005c00000001000b140000004b00000281000000c14000000181000041c100006440000280000000c1000100150100010e41410241810100e1000180c6c14100000200014002800080020003dd410002e040fe7f9f0000011f00800008000000030000e0dfb7d5eb41030000c057d75fe941030000c01bb8d5eb41030000e01f0200e84103000000000000000003000000000000f03f030000000000000040040800000000000000656e637279707400000000000100000000000a0000000000000040746573742e6c756100140000005000000050000000500000005000000050000000500000005100000053000000530000005300000053000000530000005400000054000000540000005400000054000000530000005b0000005c0000000700000002000000000000007800000000001400000002000000000000006b0006000000140000000200000000000000760007000000140000000c0000000000000028666f7220696e64657829000b000000120000000c0000000000000028666f72206c696d697429000b000000120000000b0000000000000028666f72207374657029000b00000012000000020000000000000069000c000000110000000100000005000000000000005f454e56000100000000000a0000000000000040746573742e6c756100090000003a0000002b0000005c0000004d0000005e0000005e0000005e0000005e0000005f000000000000000100000005000000000000005f454e5600&quot;</span></span><br><span class="line">  L1_2 = L1_2(L2_2)</span><br><span class="line">  <span class="built_in">dump</span> = L1_2</span><br><span class="line">  L1_2 = L1_1.lua52</span><br><span class="line">  L1_2 = L1_2.run</span><br><span class="line">  L2_2 = L0_1.<span class="built_in">load</span></span><br><span class="line">  L3_2 = <span class="built_in">dump</span></span><br><span class="line">  L2_2 = L2_2(L3_2)</span><br><span class="line">  L3_2 = &#123;&#125;</span><br><span class="line">  L4_2 = A0_2</span><br><span class="line">  L3_2[<span class="number">1</span>] = L4_2</span><br><span class="line">  L1_2 = L1_2(L2_2, L3_2)</span><br><span class="line">  v = L1_2</span><br><span class="line">  L1_2 = v</span><br><span class="line">  <span class="keyword">return</span> L1_2</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">encrypt = L4_1</span><br></pre></td></tr></table></figure>

<p>根据GPT的解释：</p>
<blockquote>
<p>所以总体来说,这段代码通过 Lua 虚拟机实现对一段密文的解密,利用 luavm 模块解析并运行字节码来还原明文。流程就是将密文解析为字节码-&gt;运行解析-&gt;返回结果。</p>
</blockquote>
<p>再把代码中的字节码dump成一个<code>luac</code>文件，再次反编译：<code>java -jar .\unluac.jar .\new_code.luac &gt; new_code.lua</code></p>
<p>这是一段非标准的TEA加密：</p>
<p><strong>Lua中<code>^</code>是乘幂符号</strong></p>
<p>但知道了也没用，写解密函数半天写不出来，看WP才知道乘幂操作被改了😫😫</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">encrypt</span><span class="params">(v, k, p)</span></span></span><br><span class="line">  <span class="keyword">local</span> v0, v1 = v[p + <span class="number">1</span>], v[p + <span class="number">2</span>]</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">local</span> sum = <span class="number">0</span></span><br><span class="line">  <span class="keyword">local</span> delta = <span class="number">2654435769</span></span><br><span class="line">  <span class="keyword">local</span> k0, k1, k2, k3 = k[<span class="number">1</span>], k[<span class="number">2</span>], k[<span class="number">3</span>], k[<span class="number">4</span>]</span><br><span class="line">  <span class="keyword">for</span> i = <span class="number">1</span>, <span class="number">32</span> <span class="keyword">do</span></span><br><span class="line">    sum = sum + delta</span><br><span class="line">    v0 = v0 + bit32.bxor(bit32.bxor(v1 ^ <span class="number">4</span> + k0, v1 + sum), v1 ^ <span class="number">5</span> + k1)</span><br><span class="line">    v1 = v1 + bit32.bxor(bit32.bxor(v0 ^ <span class="number">4</span> + k2, v0 + sum), v0 ^ <span class="number">5</span> + k3)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  v[p + <span class="number">1</span>], v[p + <span class="number">2</span>] = v0, v1</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">(x)</span></span></span><br><span class="line">  <span class="keyword">local</span> k = &#123;</span><br><span class="line">    <span class="number">3735928575</span>,</span><br><span class="line">    <span class="number">3405691582</span>,</span><br><span class="line">    <span class="number">3735929054</span>,</span><br><span class="line">    <span class="number">3221229823</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">local</span> v = x</span><br><span class="line">  <span class="keyword">for</span> i = <span class="number">0</span>, #v - <span class="number">1</span>, <span class="number">2</span> <span class="keyword">do</span></span><br><span class="line">    encrypt(v, k, i)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">return</span> v</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> main(...)</span><br></pre></td></tr></table></figure>

<p>不知道是怎么改的，就只好改加密函数为解密函数，让程序自己解密了。</p>
<p>首先更改加密函数的Lua：<code>java -jar .\unluac.jar --disassemble .\new_code.luac &gt; .\new_code.luaasm</code>获取Lua的字节码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line">.version	5.2</span><br><span class="line"></span><br><span class="line">.format	0</span><br><span class="line">.endianness	LITTLE</span><br><span class="line">.int_size	4</span><br><span class="line">.size_t_size	8</span><br><span class="line">.instruction_size	4</span><br><span class="line">.number_format	float	8</span><br><span class="line"></span><br><span class="line">.function	main</span><br><span class="line"></span><br><span class="line">.linedefined	10</span><br><span class="line">.lastlinedefined	95</span><br><span class="line">.numparams	0</span><br><span class="line">.is_vararg	1</span><br><span class="line">.maxstacksize	2</span><br><span class="line">.source	&quot;@test.lua&quot;</span><br><span class="line"></span><br><span class="line">.upvalue	&quot;_ENV&quot;	0	false</span><br><span class="line"></span><br><span class="line">.constant	k0	&quot;encrypt&quot;</span><br><span class="line">.constant	k1	&quot;main&quot;</span><br><span class="line"></span><br><span class="line">.line	58	closure       r0    f0</span><br><span class="line">.line	43	settabup      u0    k0    r0 ; k0 = &quot;encrypt&quot;</span><br><span class="line">.line	92	closure       r0    f1</span><br><span class="line">.line	77	settabup      u0    k1    r0 ; k1 = &quot;main&quot;</span><br><span class="line">.line	94	gettabup      r0    u0    k1 ; k1 = &quot;main&quot;</span><br><span class="line">.line	94	vararg        r1     0</span><br><span class="line">.line	94	tailcall      r0     0</span><br><span class="line">.line	94	return        r0     0</span><br><span class="line">.line	95	return        r0     1</span><br><span class="line"></span><br><span class="line">.function	main/f0</span><br><span class="line"></span><br><span class="line">.linedefined	43</span><br><span class="line">.lastlinedefined	58</span><br><span class="line">.numparams	3</span><br><span class="line">.is_vararg	0</span><br><span class="line">.maxstacksize	19</span><br><span class="line">.source	&quot;@test.lua&quot;</span><br><span class="line"></span><br><span class="line">.local	&quot;v&quot;	0	46</span><br><span class="line">.local	&quot;k&quot;	0	46</span><br><span class="line">.local	&quot;p&quot;	0	46</span><br><span class="line">.local	&quot;v0&quot;	4	46</span><br><span class="line">.local	&quot;v1&quot;	4	46</span><br><span class="line">.local	&quot;sum&quot;	5	46</span><br><span class="line">.local	&quot;delta&quot;	6	46</span><br><span class="line">.local	&quot;k0&quot;	10	46</span><br><span class="line">.local	&quot;k1&quot;	10	46</span><br><span class="line">.local	&quot;k2&quot;	10	46</span><br><span class="line">.local	&quot;k3&quot;	10	46</span><br><span class="line">.local	&quot;(for index)&quot;	13	40</span><br><span class="line">.local	&quot;(for limit)&quot;	13	40</span><br><span class="line">.local	&quot;(for step)&quot;	13	40</span><br><span class="line">.local	&quot;i&quot;	14	39</span><br><span class="line"></span><br><span class="line">.upvalue	&quot;_ENV&quot;	0	false</span><br><span class="line"></span><br><span class="line">.constant	k0	1</span><br><span class="line">.constant	k1	2</span><br><span class="line">.constant	k2	0</span><br><span class="line">.constant	k3	2654435769</span><br><span class="line">.constant	k4	3</span><br><span class="line">.constant	k5	4</span><br><span class="line">.constant	k6	32</span><br><span class="line">.constant	k7	&quot;bit32&quot;</span><br><span class="line">.constant	k8	&quot;bxor&quot;</span><br><span class="line">.constant	k9	5</span><br><span class="line"></span><br><span class="line">.line	44	add           r3    r2    k0 ; k0 = 1</span><br><span class="line">.line	44	gettable      r3    r0    r3</span><br><span class="line">.line	44	add           r4    r2    k1 ; k1 = 2</span><br><span class="line">.line	44	gettable      r4    r0    r4</span><br><span class="line">.line	45	loadk         r5    k2 ; k2 = 0</span><br><span class="line">.line	46	loadk         r6    k3 ; k3 = 2654435769</span><br><span class="line">.line	47	gettable      r7    r1    k0 ; k0 = 1</span><br><span class="line">.line	47	gettable      r8    r1    k1 ; k1 = 2</span><br><span class="line">.line	47	gettable      r9    r1    k4 ; k4 = 3</span><br><span class="line">.line	47	gettable     r10    r1    k5 ; k5 = 4</span><br><span class="line">.line	49	loadk        r11    k0 ; k0 = 1</span><br><span class="line">.line	49	loadk        r12    k6 ; k6 = 32</span><br><span class="line">.line	49	loadk        r13    k0 ; k0 = 1</span><br><span class="line">.line	49	forprep      r11   l40</span><br><span class="line">.label	l15</span><br><span class="line">.line	50	add           r5    r5    r6</span><br><span class="line">.line	53	gettabup     r15    u0    k7 ; k7 = &quot;bit32&quot;</span><br><span class="line">.line	53	gettable     r15   r15    k8 ; k8 = &quot;bxor&quot;</span><br><span class="line">.line	53	gettabup     r16    u0    k7 ; k7 = &quot;bit32&quot;</span><br><span class="line">.line	53	gettable     r16   r16    k8 ; k8 = &quot;bxor&quot;</span><br><span class="line">.line	53	pow          r17    r4    k5 ; k5 = 4</span><br><span class="line">.line	53	add          r17   r17    r7</span><br><span class="line">.line	53	add          r18    r4    r5</span><br><span class="line">.line	53	call         r16     3     2</span><br><span class="line">.line	53	pow          r17    r4    k9 ; k9 = 5</span><br><span class="line">.line	53	add          r17   r17    r8</span><br><span class="line">.line	53	call         r15     3     2</span><br><span class="line">.line	53	add           r3    r3   r15</span><br><span class="line">.line	54	gettabup     r15    u0    k7 ; k7 = &quot;bit32&quot;</span><br><span class="line">.line	54	gettable     r15   r15    k8 ; k8 = &quot;bxor&quot;</span><br><span class="line">.line	54	gettabup     r16    u0    k7 ; k7 = &quot;bit32&quot;</span><br><span class="line">.line	54	gettable     r16   r16    k8 ; k8 = &quot;bxor&quot;</span><br><span class="line">.line	54	pow          r17    r3    k5 ; k5 = 4</span><br><span class="line">.line	54	add          r17   r17    r9</span><br><span class="line">.line	54	add          r18    r3    r5</span><br><span class="line">.line	54	call         r16     3     2</span><br><span class="line">.line	54	pow          r17    r3    k9 ; k9 = 5</span><br><span class="line">.line	54	add          r17   r17   r10</span><br><span class="line">.line	54	call         r15     3     2</span><br><span class="line">.line	54	add           r4    r4   r15</span><br><span class="line">.label	l40</span><br><span class="line">.line	49	forloop      r11   l15</span><br><span class="line">.line	57	add          r11    r2    k0 ; k0 = 1</span><br><span class="line">.line	57	add          r12    r2    k1 ; k1 = 2</span><br><span class="line">.line	57	move         r13    r3</span><br><span class="line">.line	57	settable      r0   r12    r4</span><br><span class="line">.line	57	settable      r0   r11   r13</span><br><span class="line">.line	58	return        r0     1</span><br><span class="line"></span><br><span class="line">.function	main/f1</span><br><span class="line"></span><br><span class="line">.linedefined	77</span><br><span class="line">.lastlinedefined	92</span><br><span class="line">.numparams	1</span><br><span class="line">.is_vararg	0</span><br><span class="line">.maxstacksize	11</span><br><span class="line">.source	&quot;@test.lua&quot;</span><br><span class="line"></span><br><span class="line">.local	&quot;x&quot;	0	20</span><br><span class="line">.local	&quot;k&quot;	6	20</span><br><span class="line">.local	&quot;v&quot;	7	20</span><br><span class="line">.local	&quot;(for index)&quot;	11	18</span><br><span class="line">.local	&quot;(for limit)&quot;	11	18</span><br><span class="line">.local	&quot;(for step)&quot;	11	18</span><br><span class="line">.local	&quot;i&quot;	12	17</span><br><span class="line"></span><br><span class="line">.upvalue	&quot;_ENV&quot;	0	false</span><br><span class="line"></span><br><span class="line">.constant	k0	3735928575</span><br><span class="line">.constant	k1	3405691582</span><br><span class="line">.constant	k2	3735929054</span><br><span class="line">.constant	k3	3221229823</span><br><span class="line">.constant	k4	0</span><br><span class="line">.constant	k5	1</span><br><span class="line">.constant	k6	2</span><br><span class="line">.constant	k7	&quot;encrypt&quot;</span><br><span class="line"></span><br><span class="line">.line	80	newtable      r1     4     0</span><br><span class="line">.line	80	loadk         r2    k0 ; k0 = 3735928575</span><br><span class="line">.line	80	loadk         r3    k1 ; k1 = 3405691582</span><br><span class="line">.line	80	loadk         r4    k2 ; k2 = 3735929054</span><br><span class="line">.line	80	loadk         r5    k3 ; k3 = 3221229823</span><br><span class="line">.line	80	setlist       r1     4     1</span><br><span class="line">.line	81	move          r2    r0</span><br><span class="line">.line	83	loadk         r3    k4 ; k4 = 0</span><br><span class="line">.line	83	len           r4    r2</span><br><span class="line">.line	83	sub           r4    r4    k5 ; k5 = 1</span><br><span class="line">.line	83	loadk         r5    k6 ; k6 = 2</span><br><span class="line">.line	83	forprep       r3   l18</span><br><span class="line">.label	l13</span><br><span class="line">.line	84	gettabup      r7    u0    k7 ; k7 = &quot;encrypt&quot;</span><br><span class="line">.line	84	move          r8    r2</span><br><span class="line">.line	84	move          r9    r1</span><br><span class="line">.line	84	move         r10    r6</span><br><span class="line">.line	84	call          r7     4     1</span><br><span class="line">.label	l18</span><br><span class="line">.line	83	forloop       r3   l13</span><br><span class="line">.line	91	return        r2     2</span><br><span class="line">.line	92	return        r0     1</span><br></pre></td></tr></table></figure>

<p>红框里为<code>sum = 0</code>的操作，因此需要改<code>k2=2654435769*32</code></p>
<p><img src="/2023/12/24/CTF-wp-3/image-20231119144608206.png"></p>
<p>从上到下分别对应循环中的三个加法，解密应该逆序，所以直接调换位置，<code>add</code>也要改为<code>sub</code></p>
<ol>
<li><code>sum = sum + delta</code></li>
<li><code>v0 = v0 + bit32.bxor(bit32.bxor(v1 ^ 4 + k0, v1 + sum), v1 ^ 5 + k1)</code></li>
<li><code>v1 = v1 + bit32.bxor(bit32.bxor(v0 ^ 4 + k2, v0 + sum), v0 ^ 5 + k3)</code></li>
</ol>
<p><img src="/2023/12/24/CTF-wp-3/image-20231119144947764.png"></p>
<p>改完后，<code>java -jar .\unluac.jar --assemble .\new_code.luaasm --output .\new_code_dec.luac</code>编译会Luac文件，然后将其二进制字符串patch到<code>main.luac</code>中：</p>
<p><img src="/2023/12/24/CTF-wp-3/image-20231119161918761.png"></p>
<p>使用AssetBundleExtractor将更改的<code>main.luac</code>patch回去：</p>
<p><img src="/2023/12/24/CTF-wp-3/image-20231119162020681.png"></p>
<p>然后更改Assembly-CSharp.dll里的check方法的逻辑，使其使用密文作为输入进行解密。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Token: 0x06000002 RID: 2</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Check</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">this</span>.luaenv = <span class="keyword">new</span> LuaEnv();</span><br><span class="line">    <span class="keyword">this</span>.luaenv.DoString(<span class="string">&quot;require &#x27;main&#x27;&quot;</span>, <span class="string">&quot;chunk&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">    ByFile.FDelegate fdelegate = <span class="keyword">this</span>.luaenv.Global.Get&lt;ByFile.FDelegate&gt;(<span class="string">&quot;encrypt&quot;</span>);</span><br><span class="line">    LuaTable luaTable = <span class="keyword">this</span>.luaenv.NewTable();</span><br><span class="line">    <span class="built_in">string</span> text = <span class="keyword">this</span>.input.text;</span><br><span class="line">    <span class="keyword">if</span> (text.Length == <span class="number">23</span> &amp;&amp; text.Substring(<span class="number">0</span>, <span class="number">6</span>) == <span class="string">&quot;n1ctf&#123;&quot;</span> &amp;&amp; text.Substring(<span class="number">22</span>, <span class="number">1</span>) == <span class="string">&quot;&#125;&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">string</span> s = text.Substring(<span class="number">6</span>, <span class="number">16</span>);</span><br><span class="line">        Encoding.ASCII.GetBytes(s);</span><br><span class="line">        <span class="built_in">ulong</span>[] array = <span class="keyword">new</span> <span class="built_in">ulong</span>[]</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="number">0U</span>L,</span><br><span class="line">            <span class="number">75405591852U</span>L,</span><br><span class="line">            <span class="number">78071625542U</span>L,</span><br><span class="line">            <span class="number">69577277816U</span>L,</span><br><span class="line">            <span class="number">57193980063U</span>L</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            luaTable.Set&lt;<span class="built_in">int</span>, <span class="built_in">ulong</span>&gt;(i + <span class="number">1</span>, array[i+<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        LuaTable luaTable2 = fdelegate(luaTable);</span><br><span class="line">        luaTable2.Cast&lt;ArrayList&gt;();</span><br><span class="line">        <span class="built_in">bool</span> flag = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">this</span>.text2 += <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        <span class="keyword">this</span>.text2 += <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        <span class="keyword">this</span>.text2 += <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        <span class="keyword">this</span>.text2 += <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        <span class="keyword">this</span>.text2 += <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">1</span>; j &lt; array.Length; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.text2 += j.ToString();</span><br><span class="line">            <span class="keyword">this</span>.text2 += <span class="string">&quot;:&quot;</span>;</span><br><span class="line">            <span class="keyword">this</span>.text2 += Encoding.UTF8.GetString(</span><br><span class="line">                BitConverter.GetBytes(luaTable2.Get&lt;<span class="built_in">int</span>, <span class="built_in">ulong</span>&gt;(j))</span><br><span class="line">            ).Substring(<span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="keyword">this</span>.text2 += <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">            <span class="keyword">if</span> (array[j] != luaTable2.Get&lt;<span class="built_in">int</span>, <span class="built_in">ulong</span>&gt;(j))</span><br><span class="line">            &#123;</span><br><span class="line">                flag = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (flag)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.result.text = <span class="string">&quot;Congratulations!&quot;</span>;</span><br><span class="line">            <span class="keyword">this</span>.luaenv.Dispose();</span><br><span class="line">            <span class="keyword">this</span>.luaenv = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.result.text = <span class="keyword">this</span>.text2;</span><br><span class="line">    <span class="keyword">this</span>.luaenv.Dispose();</span><br><span class="line">    <span class="keyword">this</span>.luaenv = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后运行程序获取flag：<code> n1ctf&#123;E5c4p3_N1Lva7ua!&#125;</code></p>
<p><img src="/2023/12/24/CTF-wp-3/image-20231119162150262.png"></p>
<h2 id="N1go"><a href="#N1go" class="headerlink" title="N1go"></a>N1go</h2><p><a target="_blank" rel="noopener" href="https://nese.team/posts/n1ctf2023/">NeSE Team</a>👈👈</p>
<p>给了GO的源码，但混淆了，且一堆字符串需要运行时才能知道，用WP里的脚本（稍微改了一下可以在Windows下运行）解一下，思路是获取<code>func() string</code>里的函数内容，配合Go的<code>print</code>模板写入到一个go文件中，执行获取输出结果，替换回去。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_cmd</span>(<span class="params">cmd</span>):</span><br><span class="line">    p = subprocess.Popen(</span><br><span class="line">        cmd, shell=<span class="literal">True</span>, stdout=subprocess.PIPE, stderr=subprocess.PIPE)</span><br><span class="line">    stdout, stderr = p.communicate()</span><br><span class="line">    <span class="keyword">return</span> stdout, stderr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_constant_func_range</span>(<span class="params">codes</span>):</span><br><span class="line">    i = -<span class="number">1</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            start = codes.index(<span class="string">&#x27;func() string &#123;&#x27;</span>, i + <span class="number">1</span>)</span><br><span class="line">            i = start + <span class="number">15</span></span><br><span class="line">            b_cnt = <span class="number">1</span></span><br><span class="line">            <span class="keyword">while</span> b_cnt:</span><br><span class="line">                <span class="keyword">if</span> codes[i] == <span class="string">&#x27;&#125;&#x27;</span>:</span><br><span class="line">                    b_cnt -= <span class="number">1</span></span><br><span class="line">                <span class="keyword">elif</span> codes[i] == <span class="string">&#x27;&#123;&#x27;</span>:</span><br><span class="line">                    b_cnt += <span class="number">1</span></span><br><span class="line">                <span class="keyword">elif</span> codes[i] == <span class="string">&#x27;&quot;&#x27;</span>:</span><br><span class="line">                    i += <span class="number">1</span></span><br><span class="line">                    <span class="keyword">while</span> codes[i] != <span class="string">&#x27;&quot;&#x27;</span>:</span><br><span class="line">                        <span class="keyword">if</span> codes[i] == <span class="string">&#x27;\\&#x27;</span>:</span><br><span class="line">                            i += <span class="number">2</span></span><br><span class="line">                        <span class="keyword">else</span>:</span><br><span class="line">                            i += <span class="number">1</span></span><br><span class="line">                i += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> codes[i] == <span class="string">&#x27;(&#x27;</span> <span class="keyword">and</span> codes[i + <span class="number">1</span>] == <span class="string">&#x27;)&#x27;</span>:</span><br><span class="line">                end = i + <span class="number">2</span></span><br><span class="line">                <span class="comment"># print(codes[start: end])</span></span><br><span class="line">                <span class="keyword">return</span> start, end</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_constant_func_result</span>(<span class="params">func_codes</span>):</span><br><span class="line">    <span class="built_in">open</span>(<span class="string">&#x27;aaa.go&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>).write(</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        package main</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        func main() &#123;</span></span><br><span class="line"><span class="string">            print(%s);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span> </span><br><span class="line">        % func_codes</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">assert</span> os.system(<span class="string">&#x27;go build aaa.go&#x27;</span>) == <span class="number">0</span></span><br><span class="line">    stdout, stderr = run_cmd(<span class="string">&#x27;aaa.exe&#x27;</span>)</span><br><span class="line">    <span class="keyword">assert</span> stdout == <span class="string">b&#x27;&#x27;</span>, stdout</span><br><span class="line">    <span class="built_in">print</span>(stderr.decode(encoding=<span class="string">&quot;GBK&quot;</span>))</span><br><span class="line">    <span class="keyword">return</span> stderr.decode(encoding=<span class="string">&quot;GBK&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">codes = <span class="built_in">open</span>(<span class="string">&#x27;./N1G0.go&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>).read()</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    start, end = get_constant_func_range(codes)</span><br><span class="line">    <span class="keyword">if</span> start == <span class="literal">None</span> <span class="keyword">and</span> end == <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    result = get_constant_func_result(codes[start: end])</span><br><span class="line">    <span class="built_in">print</span>(start)</span><br><span class="line">    codes = codes[: start] + <span class="string">&#x27;&quot;&#x27;</span> + result + <span class="string">&#x27;&quot;&#x27;</span> + codes[end:]</span><br><span class="line"></span><br><span class="line"><span class="built_in">open</span>(<span class="string">&#x27;./N1G0_out.go&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>).write(codes)</span><br></pre></td></tr></table></figure>

<p>生成的新的Go文件从四万多行变到了一万六千多行，还行。</p>
<p>其逻辑主体大概如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> qaQbPkAEKC <span class="type">string</span></span><br><span class="line">	qaQbPkAEKC = <span class="string">&quot;ckh47fcp3bslge52qs30&quot;</span></span><br><span class="line">	<span class="keyword">for</span> qaQbPkAEKC != <span class="string">&quot;ckh47fcp3bslge52qs3g&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">switch</span> qaQbPkAEKC &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&quot;ckh47fcp3bslge52qs30&quot;</span>:</span><br><span class="line">			fmt.Println(<span class="string">&quot;Welcome to N1CTF 2023!&quot;</span>)</span><br><span class="line">			fmt.Print(<span class="string">&quot;Please input secret: &quot;</span>)</span><br><span class="line">			qaQbPkAEKC = <span class="string">&quot;ckh47fcp3bslge52qs40&quot;</span></span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&quot;ckh47fcp3bslge52qs40&quot;</span>:</span><br><span class="line">			cMpCg2IkJ95()</span><br><span class="line">			qaQbPkAEKC = <span class="string">&quot;ckh47fcp3bslge52qs3g&quot;</span></span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">dWhhB1d</span><span class="params">()</span></span> <span class="type">byte</span> &#123;</span><br><span class="line">	<span class="keyword">var</span> _bQdQE80pC []<span class="type">byte</span> = <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">1</span>)</span><br><span class="line">	_, z7BBrnp6VaCz := os.Stdin.Read(_bQdQE80pC)</span><br><span class="line">	<span class="keyword">if</span> z7BBrnp6VaCz != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(z7BBrnp6VaCz)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> _bQdQE80pC[<span class="number">0</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">cMpCg2IkJ95</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">switch</span> dWhhB1d() &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;o&#x27;</span>:</span><br><span class="line">		hq5elFu7TI()</span><br><span class="line">	<span class="keyword">case</span> <span class="number">89</span>:</span><br><span class="line">		u8X9_w()</span><br><span class="line">	<span class="keyword">case</span> <span class="number">76</span>:</span><br><span class="line">		l9RBlu4JE()</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;D&#x27;</span>:</span><br><span class="line">		ns7jsUASz2_1()</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		zB1HplFa()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">eicz56Kamp</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">&quot;congratulation! your flag is N1CTF&#123;md5(your input)&#125;&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>大概就是根据输入进入了不同的函数，如果输入的是flag则最后进入的是<code>eicz56Kamp</code>，解法就是构造输入让程序一直走到成功。</p>
<p>有798个函数，如果用DFS遇到有几个函数可以绕圈圈的情况就出不来了，如果用BFS情况也不少，但想来出题师傅应该不会这么狠吧🙁</p>
<p><img src="/2023/12/24/CTF-wp-3/image-20231119213129139.png"></p>
<p>WP里用了<code>networkx</code>，这个东西没见过但看上去蛮厉害的，把每个函数看成节点，flag执行路径就是找<code>cMpCg2IkJ95</code>到<code>eicz56Kamp</code>的路径。</p>
<p>这里贴一下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def parse_func(func_code):</span><br><span class="line">    lines = func_code.strip().splitlines()</span><br><span class="line">    <span class="keyword">if</span> not re.match(<span class="string">&#x27;^func (.+)\(\) \&#123;$&#x27;</span>, lines[<span class="number">0</span>]):</span><br><span class="line">        <span class="keyword">return</span> None, None</span><br><span class="line">    funcname = re.findall(<span class="string">&#x27;^func (.+)\(\) \&#123;$&#x27;</span>, lines[<span class="number">0</span>])[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;switch dWhhB1d() &#123;&#x27;</span> != lines[<span class="number">1</span>].strip():</span><br><span class="line">        <span class="keyword">return</span> None, None</span><br><span class="line">    edges = &#123;&#125;</span><br><span class="line">    i = <span class="number">2</span></span><br><span class="line">    while True:</span><br><span class="line">        line = lines[i].strip()</span><br><span class="line">        <span class="keyword">if</span> line.startswith(<span class="string">&#x27;default&#x27;</span>):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        assert line.startswith(<span class="string">&#x27;case&#x27;</span>), line</span><br><span class="line">        v = eval(re.findall(<span class="string">&#x27;^case (.*):$&#x27;</span>, line)[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">type</span>(v) == <span class="type">int</span>:</span><br><span class="line">            v = chr(v)</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">        line = lines[i].strip()</span><br><span class="line">        <span class="keyword">if</span> not line.endswith(<span class="string">&#x27;()&#x27;</span>):</span><br><span class="line">            while not lines[i].strip().startswith(<span class="string">&#x27;case&#x27;</span>) and not lines[i].strip().startswith(<span class="string">&#x27;default&#x27;</span>):</span><br><span class="line">                i += <span class="number">1</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        f = re.findall(<span class="string">&#x27;^(.*)\(\)$&#x27;</span>, line)[<span class="number">0</span>]</span><br><span class="line">        # <span class="built_in">print</span>(<span class="string">&#x27;%s %s %s&#x27;</span> % (funcname, v, f))</span><br><span class="line">        edges[f] = v</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> not edges:</span><br><span class="line">        <span class="keyword">return</span> None, None</span><br><span class="line">    <span class="keyword">return</span> funcname, edges</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def get_funcs(codes):</span><br><span class="line">    try:</span><br><span class="line">        i = <span class="number">-1</span></span><br><span class="line">        while True:</span><br><span class="line">            start = codes.index(<span class="string">&#x27;func &#x27;</span>, i + <span class="number">1</span>)</span><br><span class="line">            i = start + <span class="number">5</span></span><br><span class="line">            while codes[i] != <span class="string">&#x27;&#123;&#x27;</span>: i += <span class="number">1</span></span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">            b_cnt = <span class="number">1</span></span><br><span class="line">            while b_cnt:</span><br><span class="line">                <span class="keyword">if</span> codes[i] == <span class="string">&#x27;&#125;&#x27;</span>:</span><br><span class="line">                    b_cnt -= <span class="number">1</span></span><br><span class="line">                elif codes[i] == <span class="string">&#x27;&#123;&#x27;</span>:</span><br><span class="line">                    b_cnt += <span class="number">1</span></span><br><span class="line">                elif codes[i] == <span class="string">&#x27;&quot;&#x27;</span>:</span><br><span class="line">                    i += <span class="number">1</span></span><br><span class="line">                    while codes[i] != <span class="string">&#x27;&quot;&#x27;</span>:</span><br><span class="line">                        <span class="keyword">if</span> codes[i] == <span class="string">&#x27;\\&#x27;</span>:</span><br><span class="line">                            i += <span class="number">2</span></span><br><span class="line">                        <span class="keyword">else</span>:</span><br><span class="line">                            i += <span class="number">1</span></span><br><span class="line">                i += <span class="number">1</span></span><br><span class="line">            end = i</span><br><span class="line">            yield codes[start: end]</span><br><span class="line">    except:</span><br><span class="line">        pass</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">codes = open(<span class="string">&#x27;./N1G0_out.go&#x27;</span>, <span class="string">&#x27;r&#x27;</span>).read()</span><br><span class="line"><span class="keyword">import</span> networkx as nx</span><br><span class="line"></span><br><span class="line">G = nx.DiGraph()</span><br><span class="line"></span><br><span class="line">graph = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> <span class="function"><span class="keyword">func</span> <span class="title">in</span> <span class="title">get_funcs</span><span class="params">(codes)</span></span>:</span><br><span class="line">    name, edges = parse_func(<span class="function"><span class="keyword">func</span>)</span></span><br><span class="line">    <span class="keyword">if</span> name == None and edges == None:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    graph[name] = edges</span><br><span class="line">    <span class="keyword">for</span> f in edges:</span><br><span class="line">        G.add_edge(name, f)</span><br><span class="line"></span><br><span class="line">p = nx.shortest_path(G, <span class="string">&#x27;cMpCg2IkJ95&#x27;</span>, <span class="string">&#x27;eicz56Kamp&#x27;</span>)</span><br><span class="line"># <span class="built_in">print</span>(p)</span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i in <span class="keyword">range</span>(<span class="built_in">len</span>(p) - <span class="number">1</span>):</span><br><span class="line">    flag += graph[p[i]][p[i + <span class="number">1</span>]]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;N1CTF&#123;%s&#125;&#x27;</span> % hashlib.md5(flag.encode()).hexdigest())</span><br></pre></td></tr></table></figure>

<p>这里借用了WP里的两个辅助函数，写一下DFS的解法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_func</span>(<span class="params">func_code</span>):</span><br><span class="line">    lines = func_code.strip().splitlines()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> re.<span class="keyword">match</span>(<span class="string">&#x27;^func (.+)\(\) \&#123;$&#x27;</span>, lines[<span class="number">0</span>]):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line">    funcname = re.findall(<span class="string">&#x27;^func (.+)\(\) \&#123;$&#x27;</span>, lines[<span class="number">0</span>])[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;switch dWhhB1d() &#123;&#x27;</span> != lines[<span class="number">1</span>].strip():</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line">    edges = &#123;&#125;</span><br><span class="line">    i = <span class="number">2</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        line = lines[i].strip()</span><br><span class="line">        <span class="keyword">if</span> line.startswith(<span class="string">&#x27;default&#x27;</span>):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">assert</span> line.startswith(<span class="string">&#x27;case&#x27;</span>), line</span><br><span class="line">        v = <span class="built_in">eval</span>(re.findall(<span class="string">&#x27;^case (.*):$&#x27;</span>, line)[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(v) == <span class="built_in">int</span>:</span><br><span class="line">            v = <span class="built_in">chr</span>(v)</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">        line = lines[i].strip()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> line.endswith(<span class="string">&#x27;()&#x27;</span>):</span><br><span class="line">            <span class="keyword">while</span> <span class="keyword">not</span> lines[i].strip().startswith(<span class="string">&#x27;case&#x27;</span>) <span class="keyword">and</span> <span class="keyword">not</span> lines[i].strip().startswith(<span class="string">&#x27;default&#x27;</span>):</span><br><span class="line">                i += <span class="number">1</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        f = re.findall(<span class="string">&#x27;^(.*)\(\)$&#x27;</span>, line)[<span class="number">0</span>]</span><br><span class="line">        edges[f] = v</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> edges:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line">    <span class="keyword">return</span> funcname, edges</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_funcs</span>(<span class="params">codes</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        i = -<span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            start = codes.index(<span class="string">&#x27;func &#x27;</span>, i + <span class="number">1</span>)</span><br><span class="line">            i = start + <span class="number">5</span></span><br><span class="line">            <span class="keyword">while</span> codes[i] != <span class="string">&#x27;&#123;&#x27;</span>: i += <span class="number">1</span></span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">            b_cnt = <span class="number">1</span></span><br><span class="line">            <span class="keyword">while</span> b_cnt:</span><br><span class="line">                <span class="keyword">if</span> codes[i] == <span class="string">&#x27;&#125;&#x27;</span>:</span><br><span class="line">                    b_cnt -= <span class="number">1</span></span><br><span class="line">                <span class="keyword">elif</span> codes[i] == <span class="string">&#x27;&#123;&#x27;</span>:</span><br><span class="line">                    b_cnt += <span class="number">1</span></span><br><span class="line">                <span class="keyword">elif</span> codes[i] == <span class="string">&#x27;&quot;&#x27;</span>:</span><br><span class="line">                    i += <span class="number">1</span></span><br><span class="line">                    <span class="keyword">while</span> codes[i] != <span class="string">&#x27;&quot;&#x27;</span>:</span><br><span class="line">                        <span class="keyword">if</span> codes[i] == <span class="string">&#x27;\\&#x27;</span>:</span><br><span class="line">                            i += <span class="number">2</span></span><br><span class="line">                        <span class="keyword">else</span>:</span><br><span class="line">                            i += <span class="number">1</span></span><br><span class="line">                i += <span class="number">1</span></span><br><span class="line">            end = i</span><br><span class="line">            <span class="keyword">yield</span> codes[start: end]</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">codes = <span class="built_in">open</span>(<span class="string">&#x27;./N1G0_out.go&#x27;</span>, <span class="string">&#x27;r&#x27;</span>).read()</span><br><span class="line">nodes = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> func <span class="keyword">in</span> get_funcs(codes):</span><br><span class="line">    name, edges = parse_func(func)</span><br><span class="line">    nodes[name] = edges</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dfs</span>(<span class="params">graph, start, end, path=[]</span>):</span><br><span class="line">    path = path + [start]</span><br><span class="line">    <span class="keyword">if</span> start == end:</span><br><span class="line">        <span class="keyword">return</span> path</span><br><span class="line">    <span class="keyword">if</span> start <span class="keyword">not</span> <span class="keyword">in</span> graph:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">for</span> node <span class="keyword">in</span> graph[start]:</span><br><span class="line">        <span class="keyword">if</span> node <span class="keyword">not</span> <span class="keyword">in</span> path:</span><br><span class="line">            new_path = dfs(graph, node, end, path)</span><br><span class="line">            <span class="keyword">if</span> new_path:</span><br><span class="line">                <span class="keyword">return</span> new_path</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用DFS函数查找路径</span></span><br><span class="line">start_node = <span class="string">&#x27;cMpCg2IkJ95&#x27;</span></span><br><span class="line">end_node = <span class="string">&#x27;eicz56Kamp&#x27;</span></span><br><span class="line">path = dfs(nodes, start_node, end_node)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> path:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;找到路径：&quot;</span>, <span class="string">&quot;-&gt;&quot;</span>.join(path))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;未找到路径&quot;</span>)</span><br><span class="line"></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(path) - <span class="number">1</span>):</span><br><span class="line">    <span class="built_in">print</span>(nodes[path[i]][path[i + <span class="number">1</span>]], end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    flag += nodes[path[i]][path[i + <span class="number">1</span>]]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line"><span class="built_in">print</span>(hashlib.md5(flag.encode()).hexdigest())</span><br></pre></td></tr></table></figure>

<h1 id="鹏程杯"><a href="#鹏程杯" class="headerlink" title="鹏程杯"></a>鹏程杯</h1><h2 id="bad-pe"><a href="#bad-pe" class="headerlink" title="bad_pe"></a>bad_pe</h2><p>ida打开提示有对不齐的节指针，去010editor中看下，把.ATOM修改正确：</p>
<p><img src="/2023/12/24/CTF-wp-3/image-20231104162451257.png"></p>
<p>修改之后，程序可以运行了，调试以下，发现以下异或：</p>
<p><img src="/2023/12/24/CTF-wp-3/image-20231104165039116.png"></p>
<p>异或出来的结果为MZ开头：</p>
<p><img src="/2023/12/24/CTF-wp-3/image-20231104165102159.png"></p>
<p>可知.ATOM为PE程序，dump出来，手动异或得到PE程序。</p>
<p>发现是个RC4加密：</p>
<p><img src="/2023/12/24/CTF-wp-3/image-20231104165149506.png"></p>
<p>调试一下，得到比较的结果，再当作自己的输入让其进行一次加密，得到flag：</p>
<p><img src="/2023/12/24/CTF-wp-3/image-20231104165253928.png"></p>
<h2 id="安全编程"><a href="#安全编程" class="headerlink" title="安全编程"></a>安全编程</h2><p>调试程序：</p>
<p>在sub_7FDDCEB2EC70中，有程序逻辑。</p>
<p>检测是否猜对数字：</p>
<p><img src="/2023/12/24/CTF-wp-3/image-20231104173934365.png"></p>
<p>如果猜对了次数加一，然后和100比较，若达到一百次，就解密图片：</p>
<p><img src="/2023/12/24/CTF-wp-3/image-20231104174016264.png"></p>
<p>直接该right_times为100就可以直接跑出来了。</p>
<p><img src="/2023/12/24/CTF-wp-3/image-20231104174051549.png"></p>
<h2 id="babyre"><a href="#babyre" class="headerlink" title="babyre"></a>babyre</h2><p>用条件断点获取rand数据。</p>
<p>逻辑很清晰，直接脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">rand_num = [</span><br><span class="line">    <span class="number">19954</span>, <span class="number">28965</span>, <span class="number">14137</span>, <span class="number">3558</span>, <span class="number">10069</span>, <span class="number">31251</span>, <span class="number">32362</span>, <span class="number">11940</span>, <span class="number">3430</span>, <span class="number">27969</span>, <span class="number">14847</span>, <span class="number">11465</span>, <span class="number">12175</span>, <span class="number">9021</span>, <span class="number">27614</span>, <span class="number">8175</span>, <span class="number">12050</span>,</span><br><span class="line">    <span class="number">16408</span>, <span class="number">20581</span>, <span class="number">6478</span>, <span class="number">17749</span>, <span class="number">4203</span>, <span class="number">22364</span>, <span class="number">2272</span>, <span class="number">9340</span>, <span class="number">14232</span>, <span class="number">10535</span>, <span class="number">32196</span>, <span class="number">17981</span>, <span class="number">4946</span>, <span class="number">3136</span>, <span class="number">17889</span>, <span class="number">7408</span>, <span class="number">30816</span>,</span><br><span class="line">    <span class="number">16101</span>, <span class="number">12491</span>, <span class="number">23270</span>, <span class="number">11421</span>, <span class="number">6414</span>, <span class="number">31210</span>, <span class="number">17404</span>, <span class="number">16964</span>, <span class="number">2722</span>, <span class="number">7641</span>, <span class="number">15728</span>, <span class="number">14442</span>, <span class="number">18922</span>, <span class="number">7948</span>, <span class="number">4083</span>, <span class="number">1228</span>, <span class="number">17990</span>,</span><br><span class="line">    <span class="number">32182</span>, <span class="number">4095</span>, <span class="number">27339</span>, <span class="number">13087</span>, <span class="number">26345</span>, <span class="number">8298</span>, <span class="number">17333</span>, <span class="number">16156</span>, <span class="number">24319</span>, <span class="number">17212</span>, <span class="number">7238</span>, <span class="number">19353</span>, <span class="number">27450</span>, <span class="number">11454</span>, <span class="number">19311</span>, <span class="number">14421</span>, <span class="number">32423</span>,</span><br><span class="line">    <span class="number">3283</span>, <span class="number">26197</span>, <span class="number">5994</span>, <span class="number">11848</span>, <span class="number">651</span>, <span class="number">13725</span>, <span class="number">23939</span>, <span class="number">28785</span>, <span class="number">28150</span>, <span class="number">4071</span>, <span class="number">25161</span>, <span class="number">27507</span>, <span class="number">5174</span>, <span class="number">15768</span>, <span class="number">17694</span>, <span class="number">6008</span>, <span class="number">18904</span>,</span><br><span class="line">    <span class="number">18909</span>, <span class="number">2574</span>, <span class="number">14254</span>, <span class="number">5989</span>, <span class="number">25837</span>, <span class="number">770</span>, <span class="number">28328</span>, <span class="number">3123</span>, <span class="number">15246</span>, <span class="number">22839</span>, <span class="number">29185</span>, <span class="number">13185</span>, <span class="number">26586</span>, <span class="number">19183</span>, <span class="number">8514</span>, <span class="number">24515</span>, <span class="number">24387</span>,</span><br><span class="line">    <span class="number">29031</span>, <span class="number">1029</span>, <span class="number">16443</span>, <span class="number">469</span>, <span class="number">8968</span>, <span class="number">29531</span>, <span class="number">29897</span>, <span class="number">11963</span>, <span class="number">17889</span>, <span class="number">29292</span>, <span class="number">5124</span>, <span class="number">517</span>, <span class="number">9813</span>, <span class="number">31325</span>, <span class="number">22409</span>, <span class="number">8104</span>, <span class="number">9745</span>, <span class="number">15735</span>,</span><br><span class="line">    <span class="number">25236</span>, <span class="number">12230</span>, <span class="number">22338</span>, <span class="number">9605</span>, <span class="number">22221</span>, <span class="number">28720</span>, <span class="number">22532</span>, <span class="number">4477</span>, <span class="number">11108</span>, <span class="number">32554</span>, <span class="number">541</span>, <span class="number">5731</span>, <span class="number">31327</span>, <span class="number">17262</span>, <span class="number">17131</span>, <span class="number">18283</span>, <span class="number">14387</span>,</span><br><span class="line">    <span class="number">5491</span>, <span class="number">12187</span>, <span class="number">18782</span>, <span class="number">2450</span>, <span class="number">3566</span>, <span class="number">10652</span>, <span class="number">13630</span>, <span class="number">11141</span>, <span class="number">7578</span>, <span class="number">10067</span>, <span class="number">3629</span>, <span class="number">8634</span>, <span class="number">21044</span>, <span class="number">29969</span>, <span class="number">20107</span>, <span class="number">7967</span>, <span class="number">27850</span>, <span class="number">578</span>,</span><br><span class="line">    <span class="number">20575</span>, <span class="number">23728</span>, <span class="number">11574</span>, <span class="number">3815</span>, <span class="number">5368</span>, <span class="number">21132</span>, <span class="number">30438</span>, <span class="number">19782</span>, <span class="number">12244</span>, <span class="number">1871</span>, <span class="number">13022</span>, <span class="number">19423</span>, <span class="number">22720</span>, <span class="number">27036</span>, <span class="number">4863</span>, <span class="number">15267</span>, <span class="number">26945</span>,</span><br><span class="line">    <span class="number">26617</span>, <span class="number">6793</span>, <span class="number">26209</span>, <span class="number">18739</span>, <span class="number">15072</span>, <span class="number">4063</span>, <span class="number">27009</span>, <span class="number">3760</span>, <span class="number">5394</span>, <span class="number">15242</span>, <span class="number">2292</span>, <span class="number">21811</span>, <span class="number">11823</span>, <span class="number">6273</span>, <span class="number">11883</span>, <span class="number">4093</span>, <span class="number">23428</span>,</span><br><span class="line">    <span class="number">22951</span>, <span class="number">26823</span>, <span class="number">23480</span></span><br><span class="line">]</span><br><span class="line">rand_index = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rand</span>():</span><br><span class="line">    <span class="keyword">global</span> rand_num</span><br><span class="line">    <span class="keyword">global</span> rand_index</span><br><span class="line">    num = rand_num[rand_index % <span class="built_in">len</span>(rand_num)]</span><br><span class="line">    rand_index += <span class="number">1</span></span><br><span class="line">    <span class="comment"># print(num)</span></span><br><span class="line">    <span class="keyword">return</span> num</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fun1</span>(<span class="params">num</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        <span class="keyword">if</span> (i * <span class="number">0x17</span> + <span class="number">0x42</span>) &amp; <span class="number">0xff</span> == num:</span><br><span class="line">            <span class="keyword">return</span> i</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrtyp</span>(<span class="params">data</span>):</span><br><span class="line">    num1 = data[<span class="number">0</span>]</span><br><span class="line">    num2 = data[<span class="number">1</span>]</span><br><span class="line">    num3 = data[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        num3 -= (((rand() ^ (((num1 &gt;&gt; <span class="number">15</span>) ^ (num1 &lt;&lt; <span class="number">10</span>)) | <span class="number">3</span>)) + ((num1 &gt;&gt; <span class="number">7</span>) + rand())) &amp; <span class="number">0xffffffff</span>)</span><br><span class="line">        num3 &amp;= <span class="number">0xffffffff</span></span><br><span class="line">        num2 -= (((rand() ^ (((num3 &gt;&gt; <span class="number">15</span>) ^ (num3 &lt;&lt; <span class="number">10</span>)) | <span class="number">3</span>)) + ((num3 &gt;&gt; <span class="number">7</span>) + rand())) &amp; <span class="number">0xffffffff</span>)</span><br><span class="line">        num2 &amp;= <span class="number">0xffffffff</span></span><br><span class="line">        num1 -= (((rand() ^ (((num2 &gt;&gt; <span class="number">15</span>) ^ (num2 &lt;&lt; <span class="number">10</span>)) | <span class="number">3</span>)) + ((num2 &gt;&gt; <span class="number">7</span>) + rand())) &amp; <span class="number">0xffffffff</span>)</span><br><span class="line">        num1 &amp;= <span class="number">0xffffffff</span></span><br><span class="line"></span><br><span class="line">        num1_byte1 = num1 &amp; <span class="number">0xff</span></span><br><span class="line">        num1_byte2 = (num1 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span></span><br><span class="line">        num1_byte3 = (num1 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span></span><br><span class="line">        num1_byte4 = (num1 &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span></span><br><span class="line">        num1_byte = [num1_byte1, num1_byte2, num1_byte3, num1_byte4]</span><br><span class="line">        num2_byte1 = num2 &amp; <span class="number">0xff</span></span><br><span class="line">        num2_byte2 = (num2 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span></span><br><span class="line">        num2_byte3 = (num2 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span></span><br><span class="line">        num2_byte4 = (num2 &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span></span><br><span class="line">        num2_byte = [num2_byte1, num2_byte2, num2_byte3, num2_byte4]</span><br><span class="line">        num3_byte1 = num3 &amp; <span class="number">0xff</span></span><br><span class="line">        num3_byte2 = (num3 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span></span><br><span class="line">        num3_byte3 = (num3 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span></span><br><span class="line">        num3_byte4 = (num3 &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span></span><br><span class="line">        num3_byte = [num3_byte1, num3_byte2, num3_byte3, num3_byte4]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">            num1_byte[j] = fun1(num1_byte[j])</span><br><span class="line">            num2_byte[j] = fun1(num2_byte[j])</span><br><span class="line">            num3_byte[j] = fun1(num3_byte[j])</span><br><span class="line"></span><br><span class="line">        num1 = num1_byte[<span class="number">0</span>] | (num1_byte[<span class="number">1</span>] &lt;&lt; <span class="number">8</span>) | (num1_byte[<span class="number">2</span>] &lt;&lt; <span class="number">16</span>) | (num1_byte[<span class="number">3</span>] &lt;&lt; <span class="number">24</span>)</span><br><span class="line">        num2 = num2_byte[<span class="number">0</span>] | (num2_byte[<span class="number">1</span>] &lt;&lt; <span class="number">8</span>) | (num2_byte[<span class="number">2</span>] &lt;&lt; <span class="number">16</span>) | (num2_byte[<span class="number">3</span>] &lt;&lt; <span class="number">24</span>)</span><br><span class="line">        num3 = num3_byte[<span class="number">0</span>] | (num3_byte[<span class="number">1</span>] &lt;&lt; <span class="number">8</span>) | (num3_byte[<span class="number">2</span>] &lt;&lt; <span class="number">16</span>) | (num3_byte[<span class="number">3</span>] &lt;&lt; <span class="number">24</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [num1, num2, num3]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt</span>(<span class="params">data</span>):</span><br><span class="line">    num1 = data[<span class="number">0</span>]</span><br><span class="line">    num2 = data[<span class="number">1</span>]</span><br><span class="line">    num3 = data[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        num1_byte1 = num1 &amp; <span class="number">0xff</span></span><br><span class="line">        num1_byte2 = (num1 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span></span><br><span class="line">        num1_byte3 = (num1 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span></span><br><span class="line">        num1_byte4 = (num1 &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span></span><br><span class="line">        num1_byte = [num1_byte1, num1_byte2, num1_byte3, num1_byte4]</span><br><span class="line">        num2_byte1 = num2 &amp; <span class="number">0xff</span></span><br><span class="line">        num2_byte2 = (num2 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span></span><br><span class="line">        num2_byte3 = (num2 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span></span><br><span class="line">        num2_byte4 = (num2 &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span></span><br><span class="line">        num2_byte = [num2_byte1, num2_byte2, num2_byte3, num2_byte4]</span><br><span class="line">        num3_byte1 = num3 &amp; <span class="number">0xff</span></span><br><span class="line">        num3_byte2 = (num3 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span></span><br><span class="line">        num3_byte3 = (num3 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span></span><br><span class="line">        num3_byte4 = (num3 &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span></span><br><span class="line">        num3_byte = [num3_byte1, num3_byte2, num3_byte3, num3_byte4]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">            num1_byte[j] = num1_byte[j] * <span class="number">23</span> + <span class="number">66</span></span><br><span class="line">            num1_byte[j] = num1_byte[j] &amp; <span class="number">0xff</span></span><br><span class="line">            num2_byte[j] = num2_byte[j] * <span class="number">23</span> + <span class="number">66</span></span><br><span class="line">            num2_byte[j] = num2_byte[j] &amp; <span class="number">0xff</span></span><br><span class="line">            num3_byte[j] = num3_byte[j] * <span class="number">23</span> + <span class="number">66</span></span><br><span class="line">            num3_byte[j] = num3_byte[j] &amp; <span class="number">0xff</span></span><br><span class="line"></span><br><span class="line">        num1 = num1_byte[<span class="number">0</span>] | (num1_byte[<span class="number">1</span>] &lt;&lt; <span class="number">8</span>) | (num1_byte[<span class="number">2</span>] &lt;&lt; <span class="number">16</span>) | (num1_byte[<span class="number">3</span>] &lt;&lt; <span class="number">24</span>)</span><br><span class="line">        num2 = num2_byte[<span class="number">0</span>] | (num2_byte[<span class="number">1</span>] &lt;&lt; <span class="number">8</span>) | (num2_byte[<span class="number">2</span>] &lt;&lt; <span class="number">16</span>) | (num2_byte[<span class="number">3</span>] &lt;&lt; <span class="number">24</span>)</span><br><span class="line">        num3 = num3_byte[<span class="number">0</span>] | (num3_byte[<span class="number">1</span>] &lt;&lt; <span class="number">8</span>) | (num3_byte[<span class="number">2</span>] &lt;&lt; <span class="number">16</span>) | (num3_byte[<span class="number">3</span>] &lt;&lt; <span class="number">24</span>)</span><br><span class="line"></span><br><span class="line">        num1 += (((num2 &gt;&gt; <span class="number">7</span>) + rand())) + ((rand() ^ (((num2 &gt;&gt; <span class="number">15</span>) ^ (num2 &lt;&lt; <span class="number">10</span>)) | <span class="number">3</span>))) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        num1 &amp;= <span class="number">0xffffffff</span></span><br><span class="line">        num2 += (((num3 &gt;&gt; <span class="number">7</span>) + rand())) + ((rand() ^ (((num3 &gt;&gt; <span class="number">15</span>) ^ (num3 &lt;&lt; <span class="number">10</span>)) | <span class="number">3</span>))) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        num2 &amp;= <span class="number">0xffffffff</span></span><br><span class="line">        num3 += (((num1 &gt;&gt; <span class="number">7</span>) + rand())) + ((rand() ^ (((num1 &gt;&gt; <span class="number">15</span>) ^ (num1 &lt;&lt; <span class="number">10</span>)) | <span class="number">3</span>))) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        num3 &amp;= <span class="number">0xffffffff</span></span><br><span class="line">    <span class="keyword">return</span> [num1, num2, num3]</span><br><span class="line"></span><br><span class="line">result = [</span><br><span class="line">    <span class="number">0x48</span>, <span class="number">0x4D</span>, <span class="number">0x3B</span>, <span class="number">0xA0</span>, <span class="number">0x27</span>, <span class="number">0x31</span>, <span class="number">0x28</span>, <span class="number">0x54</span>, <span class="number">0x6D</span>, <span class="number">0xF1</span>,</span><br><span class="line">    <span class="number">0x21</span>, <span class="number">0x35</span>, <span class="number">0x18</span>, <span class="number">0x73</span>, <span class="number">0x6A</span>, <span class="number">0x4C</span>, <span class="number">0x71</span>, <span class="number">0x3B</span>, <span class="number">0xBD</span>, <span class="number">0x98</span>,</span><br><span class="line">    <span class="number">0xB6</span>, <span class="number">0x5A</span>, <span class="number">0x77</span>, <span class="number">0x2D</span>, <span class="number">0x0B</span>, <span class="number">0x2B</span>, <span class="number">0xCB</span>, <span class="number">0x9B</span>, <span class="number">0xE4</span>, <span class="number">0x8A</span>,</span><br><span class="line">    <span class="number">0x4C</span>, <span class="number">0xA9</span>, <span class="number">0x5C</span>, <span class="number">0x4F</span>, <span class="number">0x1B</span>, <span class="number">0xF1</span>, <span class="number">0x98</span>, <span class="number">0x3D</span>, <span class="number">0x30</span>, <span class="number">0x59</span>,</span><br><span class="line">    <span class="number">0x3F</span>, <span class="number">0x14</span>, <span class="number">0xFC</span>, <span class="number">0x7A</span>, <span class="number">0xF4</span>, <span class="number">0x64</span>, <span class="number">0x02</span>, <span class="number">0x2B</span></span><br><span class="line">]</span><br><span class="line">flag = []</span><br><span class="line">rand_num.reverse()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(result) // <span class="number">12</span>):</span><br><span class="line">    c = []</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        c.append(result[<span class="number">0</span> + j * <span class="number">4</span> + i * <span class="number">12</span>] | (result[<span class="number">1</span> + j * <span class="number">4</span> + i * <span class="number">12</span>] &lt;&lt; <span class="number">8</span>) | (result[<span class="number">2</span> + j * <span class="number">4</span> + i * <span class="number">12</span>] &lt;&lt; <span class="number">16</span>) | (</span><br><span class="line">                    result[<span class="number">3</span> + j * <span class="number">4</span> + i * <span class="number">12</span>] &lt;&lt; <span class="number">24</span>))</span><br><span class="line">    c = decrtyp(c)</span><br><span class="line">    flag += c</span><br><span class="line"><span class="built_in">print</span>(struct.pack(<span class="string">&#x27;I&#x27;</span> * <span class="number">12</span>, *flag))</span><br></pre></td></tr></table></figure>

<h2 id="ezapk"><a href="#ezapk" class="headerlink" title="ezapk"></a>ezapk</h2><p>Apk里的逻辑很简单，加密逻辑都在so中。</p>
<p>进so逻辑都呈现出来了，但是需要分析，比赛的时候只看出来了XXTEA，没看出来DES😫</p>
<h3 id="逻辑"><a href="#逻辑" class="headerlink" title="逻辑"></a>逻辑</h3><p>获取输入，分为四个32bit数，进行XXTEA加密</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sscanf</span>((<span class="type">const</span> <span class="type">char</span> *)input, <span class="string">&quot;%8x%8x%8x%8x&quot;</span>, &amp;c0, &amp;c1, &amp;p2_, &amp;c3);</span><br><span class="line">p3 = c3;</span><br><span class="line">p0 = c0;</span><br><span class="line">p1 = c1;</span><br><span class="line">v16 = <span class="number">-19</span>;</span><br><span class="line">v17 = <span class="number">0x98654782</span>;</span><br><span class="line">p2 = p2_;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">    v19 = (v17 &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>;</span><br><span class="line">    p0 += (((p3 &gt;&gt; <span class="number">5</span>) ^ (<span class="number">4</span> * p1)) + ((p1 &gt;&gt; <span class="number">3</span>) ^ (<span class="number">16</span> * p3))) ^ ((v17 ^ p1) + (p3 ^ key[v19]));</span><br><span class="line">    p1 += (((p0 &gt;&gt; <span class="number">5</span>) ^ (<span class="number">4</span> * p2)) + ((p2 &gt;&gt; <span class="number">3</span>) ^ (<span class="number">16</span> * p0))) ^ ((v17 ^ p2) + (p0 ^ key[(v17 &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span> ^ <span class="number">1</span>]));</span><br><span class="line">    p2 += (((p1 &gt;&gt; <span class="number">5</span>) ^ (<span class="number">4</span> * p3)) + ((p3 &gt;&gt; <span class="number">3</span>) ^ (<span class="number">16</span> * p1))) ^ ((v17 ^ p3) + (p1 ^ key[(v17 &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span> ^ <span class="number">2</span>]));</span><br><span class="line">    p3 += (((p2 &gt;&gt; <span class="number">5</span>) ^ (<span class="number">4</span> * p0)) + ((p0 &gt;&gt; <span class="number">3</span>) ^ (<span class="number">16</span> * p2))) ^ ((v17 ^ p0) + (p2 ^ key[(<span class="type">unsigned</span> <span class="type">int</span>)v19 ^ <span class="number">3</span>]));</span><br><span class="line">    v17 -= <span class="number">0x679AB87E</span>;</span><br><span class="line">    ++v16;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> ( v16 );</span><br></pre></td></tr></table></figure>

<p>之后每两个数为一组进入<code>sub_22B0</code>，根据<code>a1</code>，进入不同模式的DES加密</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">_QWORD *__fastcall <span class="title function_">sub_22B0</span><span class="params">(<span class="type">unsigned</span> __int64 a1, __int64 a2)</span></span><br><span class="line">&#123;</span><br><span class="line">    _QWORD *v3; <span class="comment">// r14</span></span><br><span class="line">    <span class="type">int</span> i; <span class="comment">// ebx</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> *v5; <span class="comment">// rax</span></span><br><span class="line">    <span class="type">unsigned</span> __int64 v6; <span class="comment">// rax</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> *v7; <span class="comment">// rax</span></span><br><span class="line">    __int64 j; <span class="comment">// rax</span></span><br><span class="line">    _QWORD *result; <span class="comment">// rax</span></span><br><span class="line">    <span class="type">char</span> v10[<span class="number">168</span>]; <span class="comment">// [rsp+0h] [rbp-A8h] BYREF</span></span><br><span class="line"></span><br><span class="line">    v3 = <span class="built_in">malloc</span>(<span class="number">0x11</span>uLL);</span><br><span class="line">    v3[<span class="number">1</span>] = <span class="number">0LL</span>;</span><br><span class="line">    *((_BYTE *)v3 + <span class="number">16</span>) = <span class="number">0</span>;</span><br><span class="line">    *v3 = a2;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i != <span class="number">64</span>; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">        v6 = a1;</span><br><span class="line">        a1 *= <span class="number">2LL</span>;</span><br><span class="line">        <span class="keyword">if</span> ( a1 &lt; v6 )</span><br><span class="line">        &#123;</span><br><span class="line">            a1 ^= <span class="number">0x4A2E3FEAC2675AB3</span>uLL;</span><br><span class="line">            v5 = (<span class="type">unsigned</span> <span class="type">int</span> *)<span class="built_in">malloc</span>(<span class="number">9uLL</span>);</span><br><span class="line">            *((_BYTE *)v5 + <span class="number">8</span>) = <span class="number">0</span>;</span><br><span class="line">            *(_QWORD *)v5 = a1;</span><br><span class="line">            DES_cbc_enc((__int64)v3, (__int64)v3, <span class="number">8u</span>, v5);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            v7 = (<span class="type">unsigned</span> <span class="type">int</span> *)<span class="built_in">malloc</span>(<span class="number">9uLL</span>);</span><br><span class="line">            *((_BYTE *)v7 + <span class="number">8</span>) = <span class="number">0</span>;</span><br><span class="line">            *(_QWORD *)v7 = a1;</span><br><span class="line">            sub_16A0((__int64)v10, v7);</span><br><span class="line">            sub_1B90((__int64)v10, (<span class="type">unsigned</span> <span class="type">int</span> *)v3, v3);</span><br><span class="line">            <span class="keyword">for</span> ( j = <span class="number">0LL</span>; j != <span class="number">128</span>; j += <span class="number">8LL</span> )</span><br><span class="line">            &#123;</span><br><span class="line">                v10[j] = <span class="number">0</span>;</span><br><span class="line">                v10[j + <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">                v10[j + <span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">                v10[j + <span class="number">3</span>] = <span class="number">0</span>;</span><br><span class="line">                v10[j + <span class="number">4</span>] = <span class="number">0</span>;</span><br><span class="line">                v10[j + <span class="number">5</span>] = <span class="number">0</span>;</span><br><span class="line">                v10[j + <span class="number">6</span>] = <span class="number">0</span>;</span><br><span class="line">                v10[j + <span class="number">7</span>] = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    result = <span class="built_in">malloc</span>(<span class="number">0x10</span>uLL);</span><br><span class="line">    *result = a1;</span><br><span class="line">    result[<span class="number">1</span>] = *v3;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="DES-cbc-enc"><a href="#DES-cbc-enc" class="headerlink" title="DES_cbc_enc"></a>DES_cbc_enc</h4><p>第一个条件分支，将a1异或后就进入了该函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">DES_cbc_enc</span><span class="params">(__int64 c2_, __int64 c2, <span class="type">unsigned</span> <span class="type">int</span> value_8, <span class="type">unsigned</span> <span class="type">int</span> *c1)</span></span><br><span class="line">&#123;</span><br><span class="line">	...</span><br><span class="line">    sub_16A0((__int64)v19, c1);</span><br><span class="line">    v18 = value_8;</span><br><span class="line">    <span class="keyword">if</span> ( value_8 &amp;&amp; (value_8 &amp; <span class="number">7</span>) == <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        LOBYTE(v7) = <span class="string">&#x27;w&#x27;</span>;</span><br><span class="line">        LOBYTE(v8) = <span class="string">&#x27;v&#x27;</span>;</span><br><span class="line">        LOBYTE(v9) = <span class="string">&#x27;z&#x27;</span>;</span><br><span class="line">        LOBYTE(v10) = <span class="string">&#x27;m&#x27;</span>;</span><br><span class="line">        LOBYTE(v11) = <span class="string">&#x27;x&#x27;</span>;</span><br><span class="line">        LOBYTE(v12) = <span class="string">&#x27;r&#x27;</span>;</span><br><span class="line">        v13 = <span class="number">0LL</span>;</span><br><span class="line">        LOBYTE(v14) = <span class="string">&#x27;r&#x27;</span>;</span><br><span class="line">        LOBYTE(v15) = <span class="string">&#x27;r&#x27;</span>;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            *(_BYTE *)(c2_ + v13) = *(_BYTE *)(c2 + v13) ^ v15;</span><br><span class="line">            *(_BYTE *)(c2_ + v13 + <span class="number">1</span>) = *(_BYTE *)(c2 + v13 + <span class="number">1</span>) ^ v7;</span><br><span class="line">            *(_BYTE *)(c2_ + v13 + <span class="number">2</span>) = *(_BYTE *)(c2 + v13 + <span class="number">2</span>) ^ v8;</span><br><span class="line">            *(_BYTE *)(c2_ + v13 + <span class="number">3</span>) = *(_BYTE *)(c2 + v13 + <span class="number">3</span>) ^ v14;</span><br><span class="line">            *(_BYTE *)(c2_ + v13 + <span class="number">4</span>) = *(_BYTE *)(c2 + v13 + <span class="number">4</span>) ^ v9;</span><br><span class="line">            *(_BYTE *)(c2_ + v13 + <span class="number">5</span>) = *(_BYTE *)(c2 + v13 + <span class="number">5</span>) ^ v10;</span><br><span class="line">            *(_BYTE *)(c2_ + v13 + <span class="number">6</span>) = *(_BYTE *)(c2 + v13 + <span class="number">6</span>) ^ v11;</span><br><span class="line">            *(_BYTE *)(c2_ + v13 + <span class="number">7</span>) = *(_BYTE *)(c2 + v13 + <span class="number">7</span>) ^ v12;</span><br><span class="line">            sub_1B90((__int64)v19, (<span class="type">unsigned</span> <span class="type">int</span> *)(c2_ + v13), (_BYTE *)(c2_ + v13));</span><br><span class="line">            v15 = *(_QWORD *)(c2_ + v13);</span><br><span class="line">            v7 = v15 &gt;&gt; <span class="number">8</span>;</span><br><span class="line">            v8 = v15 &gt;&gt; <span class="number">16</span>;</span><br><span class="line">            v14 = v15 &gt;&gt; <span class="number">24</span>;</span><br><span class="line">            v9 = HIDWORD(v15);</span><br><span class="line">            v10 = v15 &gt;&gt; <span class="number">40</span>;</span><br><span class="line">            v11 = HIWORD(v15);</span><br><span class="line">            v12 = HIBYTE(v15);</span><br><span class="line">            v13 += <span class="number">8LL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ( v18 != v13 );</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> v18;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>while循环只执行了一次，里面有一个异或，猜测是模式的异或，猜测异或的是IV，那<code>sub_16A0</code>应该是使用<code>c1</code>生成密钥，存储在<code>v19</code>，然后使用<code>sub_1B90</code>加密<code>c2</code></p>
<h5 id="子密钥生成"><a href="#子密钥生成" class="headerlink" title="子密钥生成"></a>子密钥生成</h5><p>猜测一下函数是子密钥生成，但逻辑上有些理不清</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Dword dword_750[<span class="number">16</span>] = &#123;<span class="number">0</span>, <span class="number">0x1</span>, <span class="number">0x100</span>, <span class="number">0x101</span>, <span class="number">0x10000</span>, <span class="number">0x10001</span>, <span class="number">0x10100</span>, <span class="number">0x10101</span>, <span class="number">0x1000000</span>, <span class="number">0x1000001</span>, <span class="number">0x1000100</span>, <span class="number">0x1000101</span>, <span class="number">0x1010000</span>, <span class="number">0x1010001</span>, <span class="number">0x1010100</span>, <span class="number">0x1010101</span>&#125;;</span><br><span class="line">Dword dword_790[<span class="number">16</span>] = &#123;<span class="number">0</span>, <span class="number">0x1000000</span>, <span class="number">0x10000</span>, <span class="number">0x1010000</span>, <span class="number">0x100</span>, <span class="number">0x1000100</span>, <span class="number">0x10100</span>, <span class="number">0x1010100</span>, <span class="number">0x1</span>, <span class="number">1000001</span>, <span class="number">0x10001</span>, <span class="number">0x1010001</span>, <span class="number">0x101</span>, <span class="number">0x1000101</span>, <span class="number">0x10101</span>, <span class="number">0x1010101</span>&#125;;</span><br><span class="line"></span><br><span class="line">__int64 __fastcall <span class="title function_">sub_16A0</span><span class="params">(__int64 a1, <span class="type">unsigned</span> <span class="type">int</span> *c1)</span></span><br><span class="line">&#123;</span><br><span class="line">	...</span><br><span class="line">    <span class="comment">// 将字节倒转</span></span><br><span class="line">    v2 = _byteswap_ulong(*c1);</span><br><span class="line">    v3 = _byteswap_ulong(c1[<span class="number">1</span>]);</span><br><span class="line">    <span class="comment">// v4, v5, v6, v7的操作 猜测是子密钥的第一个置换</span></span><br><span class="line">    v4 = v2 ^ (v2 ^ (v3 &gt;&gt; <span class="number">4</span>)) &amp; <span class="number">0xF0F0F0F</span>;</span><br><span class="line">    v5 = v2 &amp; <span class="number">0x10101010</span> | (v3 ^ (<span class="number">16</span> * ((v2 ^ (v3 &gt;&gt; <span class="number">4</span>)) &amp; <span class="number">0xF0F0F0F</span>))) &amp; <span class="number">0xEFEFEFEF</span>;</span><br><span class="line">    v6 = (</span><br><span class="line">          (dword_750[HIBYTE(v4) &amp; <span class="number">0xF</span>]) | \</span><br><span class="line">          (<span class="number">8</span> * dword_750[((<span class="type">unsigned</span> __int8)v2 ^ ((<span class="type">unsigned</span> __int8)v2 ^ (<span class="type">unsigned</span> __int8)(v3 &gt;&gt; <span class="number">4</span>)) &amp; <span class="number">0xF</span>) &amp; <span class="number">0xF</span>]) | \</span><br><span class="line">          (<span class="number">4</span> * dword_750[(v4 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xF</span>]) | \</span><br><span class="line">          (<span class="number">2</span> * dword_750[HIWORD(v4) &amp; <span class="number">0xF</span>]) | \</span><br><span class="line">          (dword_750[(v4 &gt;&gt; <span class="number">5</span>) &amp; <span class="number">0xF</span>] &lt;&lt; <span class="number">7</span>) | \</span><br><span class="line">          (dword_750[(v4 &gt;&gt; <span class="number">13</span>) &amp; <span class="number">0xF</span>] &lt;&lt; <span class="number">6</span>) | \</span><br><span class="line">          (<span class="number">32</span> * dword_750[(v4 &gt;&gt; <span class="number">21</span>) &amp; <span class="number">0xF</span>]) | \</span><br><span class="line">          (<span class="number">16</span> * *(_DWORD *)((<span class="type">char</span> *)dword_750 + ((*(<span class="type">unsigned</span> __int8 *)c1 &gt;&gt; <span class="number">3</span>) &amp; <span class="number">0x1C</span>)))</span><br><span class="line">    	) &amp; <span class="number">0xFFFFFFF</span>;</span><br><span class="line">    </span><br><span class="line">    v7 = (dword_790[(v5 &gt;&gt; <span class="number">25</span>) &amp; <span class="number">0xF</span>] | \</span><br><span class="line">          (<span class="number">8</span> * *(_DWORD *)((<span class="type">char</span> *)dword_790 + <span class="number">2</span> * (v5 &amp; <span class="number">0x1E</span>))) |\</span><br><span class="line">          (<span class="number">4</span> * dword_790[(v5 &gt;&gt; <span class="number">9</span>) &amp; <span class="number">0xF</span>]) | (<span class="number">2</span> * dword_790[(v5 &gt;&gt; <span class="number">17</span>) &amp; <span class="number">0xF</span>]) | \</span><br><span class="line">          (dword_790[(<span class="type">unsigned</span> __int8)v5 &gt;&gt; <span class="number">4</span>] &lt;&lt; <span class="number">7</span>) | \</span><br><span class="line">          (dword_790[(<span class="type">unsigned</span> __int16)v5 &gt;&gt; <span class="number">12</span>] &lt;&lt; <span class="number">6</span>) | \</span><br><span class="line">          (<span class="number">32</span> * dword_790[(v5 &gt;&gt; <span class="number">20</span>) &amp; <span class="number">0xF</span>]) | \</span><br><span class="line">          (<span class="number">16</span> * dword_790[v5 &gt;&gt; <span class="number">28</span>])) &amp; <span class="number">0xFFFFFFF</span>;</span><br><span class="line">    </span><br><span class="line">    v8 = <span class="number">0LL</span>;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 检测当前轮次是否为0，1，8，15</span></span><br><span class="line">        <span class="comment">// 若是，则左右密钥移位step为2，否则为1</span></span><br><span class="line">        <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)v8 &lt;= <span class="number">0xF</span> &amp;&amp; (v22 = <span class="number">33027</span>, _bittest(&amp;v22, v8)) )</span><br><span class="line">        &#123;</span><br><span class="line">            v9 = <span class="number">0xFFFFFFE</span>;</span><br><span class="line">            v10 = <span class="number">27</span>;</span><br><span class="line">            v11 = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            v9 = <span class="number">0xFFFFFFC</span>;</span><br><span class="line">            v10 = <span class="number">26</span>;</span><br><span class="line">            v11 = <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        v12 = v6 &lt;&lt; v11;</span><br><span class="line">        v13 = v6 &gt;&gt; v10;</span><br><span class="line">        v14 = v9 &amp; v12;</span><br><span class="line">        v15 = v13 | v9 &amp; v12;</span><br><span class="line">        v16 = v7 &lt;&lt; v11;</span><br><span class="line">        v17 = v7 &gt;&gt; v10;</span><br><span class="line">        v18 = v16 &amp; v9;</span><br><span class="line">        v19 = v17 | v18;</span><br><span class="line">        v20 = ((((<span class="type">unsigned</span> __int8)v17 | (<span class="type">unsigned</span> __int8)v18) &amp; <span class="number">0x20</span>) &lt;&lt; <span class="number">6</span>) | (v16 &gt;&gt; <span class="number">1</span>) &amp; <span class="number">0x400</span>;</span><br><span class="line">        v18 &gt;&gt;= <span class="number">14</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 上面是分组移位，下面就应该是密钥置换2了</span></span><br><span class="line">        *(_DWORD *)(a1 + <span class="number">8</span> * v8) = (<span class="number">16</span> * v14) &amp; <span class="number">0x24000000</span> | \</span><br><span class="line">            ((v13 &amp; <span class="number">1</span>) &lt;&lt; <span class="number">28</span>) | \</span><br><span class="line">            (v12 &lt;&lt; <span class="number">14</span>) &amp; <span class="number">0x8000000</span> | \</span><br><span class="line">            (v15 &lt;&lt; <span class="number">18</span>) &amp; <span class="number">0x2080000</span> | \</span><br><span class="line">            (v12 &lt;&lt; <span class="number">6</span>) &amp; <span class="number">0x1000000</span> | \</span><br><span class="line">            (v12 &lt;&lt; <span class="number">9</span>) &amp; <span class="number">0x200000</span> | \</span><br><span class="line">            (v12 &gt;&gt; <span class="number">1</span>) &amp; <span class="number">0x100000</span> | \</span><br><span class="line">            (v16 &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0x1000</span> | \</span><br><span class="line">            (v16 &gt;&gt; <span class="number">13</span>) &amp; <span class="number">0x2000</span> | \</span><br><span class="line">            (v15 &lt;&lt; <span class="number">10</span>) &amp; <span class="number">0x40000</span> | \</span><br><span class="line">            (<span class="number">4</span> * v14) &amp; <span class="number">0x20000</span> | \</span><br><span class="line">            (v12 &gt;&gt; <span class="number">10</span>) &amp; <span class="number">0x10000</span> | \</span><br><span class="line">            v16 &amp; <span class="number">0x100</span> | \</span><br><span class="line">            v20 | \</span><br><span class="line">            v18 &amp; <span class="number">0x200</span> | \</span><br><span class="line">            (v16 &gt;&gt; <span class="number">5</span>) &amp; <span class="number">0x20</span> | \</span><br><span class="line">            (v16 &gt;&gt; <span class="number">10</span>) &amp; <span class="number">0x10</span> | \</span><br><span class="line">            (v19 &gt;&gt; <span class="number">3</span>) &amp; <span class="number">8</span> | \</span><br><span class="line">            (v16 &gt;&gt; <span class="number">18</span>) &amp; <span class="number">4</span> | \</span><br><span class="line">            (v16 &gt;&gt; <span class="number">26</span>) &amp; <span class="number">2</span> | \</span><br><span class="line">            HIBYTE(v16) &amp; <span class="number">1</span>;</span><br><span class="line">        </span><br><span class="line">        result = (((v15 &lt;&lt; <span class="number">15</span>) &amp; <span class="number">0x20000000</span> | \</span><br><span class="line">                   (v12 &lt;&lt; <span class="number">17</span>) &amp; <span class="number">0x10000000</span> | \</span><br><span class="line">                   (v15 &lt;&lt; <span class="number">10</span>) &amp; <span class="number">0x8000000</span> | \</span><br><span class="line">                   ((v15 &amp; <span class="number">0x10</span>) &lt;&lt; <span class="number">22</span>) | \</span><br><span class="line">                   (v12 &gt;&gt; <span class="number">2</span>) &amp; <span class="number">0x2000000</span>) + <span class="number">2</span> * (v14 &amp; <span class="number">0x800000</span>)) | \</span><br><span class="line">            ((v15 &amp; <span class="number">0x20</span>) &lt;&lt; <span class="number">16</span>) | \</span><br><span class="line">            ((v19 &amp; <span class="number">0x10</span>) &lt;&lt; <span class="number">8</span>) | \</span><br><span class="line">            (v16 &gt;&gt; <span class="number">2</span>) &amp; <span class="number">0x2000</span> | \</span><br><span class="line">            (v12 &lt;&lt; <span class="number">11</span>) &amp; <span class="number">0x100000</span> | \</span><br><span class="line">            (<span class="number">8</span> * v14) &amp; <span class="number">0x80000</span> | \</span><br><span class="line">            (v12 &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x40000</span> | \</span><br><span class="line">            (v15 &lt;&lt; <span class="number">15</span>) &amp; <span class="number">0x20000</span> | \</span><br><span class="line">            (v12 &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0x10000</span> | \</span><br><span class="line">            v16 &amp; <span class="number">0x200</span>;</span><br><span class="line">        </span><br><span class="line">        *(_DWORD *)(a1 + <span class="number">8</span> * v8 + <span class="number">4</span>) = result | v18 &amp; <span class="number">0x808</span> | (v16 &gt;&gt; <span class="number">9</span>) &amp; <span class="number">0x400</span> |\</span><br><span class="line">            ((v19 &amp; <span class="number">2</span>) &lt;&lt; <span class="number">7</span>) | (v16 &gt;&gt; <span class="number">7</span>) &amp; <span class="number">0x20</span> | (v19 &gt;&gt; <span class="number">3</span>) &amp; <span class="number">0x11</span> | \</span><br><span class="line">            (<span class="number">4</span> * (_BYTE)v17) &amp; <span class="number">4</span> | (v16 &gt;&gt; <span class="number">21</span>) &amp; <span class="number">2</span>;</span><br><span class="line">        </span><br><span class="line">        v7 = v19;</span><br><span class="line">        v6 = v15;</span><br><span class="line">        ++v8;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( (_DWORD)v8 != <span class="number">16</span> );</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="DES-64bit-加密"><a href="#DES-64bit-加密" class="headerlink" title="DES 64bit 加密"></a>DES 64bit 加密</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_1B90</span><span class="params">(__int64 a1, <span class="type">unsigned</span> <span class="type">int</span> *a2, _BYTE *a3)</span></span><br><span class="line">&#123;</span><br><span class="line">	...</span><br><span class="line">    <span class="comment">// 字节倒转</span></span><br><span class="line">    <span class="comment">// 拆成左右块</span></span><br><span class="line">    v3 = _byteswap_ulong(*a2);</span><br><span class="line">    v4 = _byteswap_ulong(a2[<span class="number">1</span>]);</span><br><span class="line">    v5 = (v4 ^ (v3 &gt;&gt; <span class="number">4</span>)) &amp; <span class="number">0xF0F0F0F</span>;</span><br><span class="line">    v6 = v5 ^ v4;</span><br><span class="line">    v7 = v3 ^ (<span class="number">16</span> * v5);</span><br><span class="line">    v8 = HIWORD(v7) ^ (<span class="type">unsigned</span> __int16)v6;</span><br><span class="line">    v9 = v8 ^ v6;</span><br><span class="line">    v10 = v7 ^ (v8 &lt;&lt; <span class="number">16</span>);</span><br><span class="line">    v11 = (v10 ^ (v9 &gt;&gt; <span class="number">2</span>)) &amp; <span class="number">0x33333333</span>;</span><br><span class="line">    v12 = v11 ^ v10;</span><br><span class="line">    v13 = v9 ^ (<span class="number">4</span> * v11);</span><br><span class="line">    v14 = (v12 ^ (v13 &gt;&gt; <span class="number">8</span>)) &amp; <span class="number">0xFF00FF</span>;</span><br><span class="line">    v15 = v14 ^ v12;</span><br><span class="line">    v16 = __ROL4__(v13 ^ (v14 &lt;&lt; <span class="number">8</span>), <span class="number">1</span>);</span><br><span class="line">    v17 = (v15 ^ v16) &amp; <span class="number">0xAAAAAAAA</span>;</span><br><span class="line">    v18 = v17 ^ v16;</span><br><span class="line">    v19 = __ROL4__(v15 ^ v17, <span class="number">1</span>);</span><br><span class="line">    v20 = <span class="number">0LL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 这里的while循环应该是加密操作了，但不知道为什么是8轮</span></span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        v21 = *(_DWORD *)(a1 + v20 + <span class="number">4</span>) ^ __ROL4__(v18, <span class="number">28</span>);</span><br><span class="line">        v19 ^= DES_sbox_ED0[HIBYTE(v21) &amp; <span class="number">0x3F</span>] ^ dword_DD0[HIWORD(v21) &amp; <span class="number">0x3F</span>] ^ dword_CD0[(v21 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0x3F</span>] ^ dword_BD0[v21 &amp; <span class="number">0x3F</span>] ^ dword_AD0[(((<span class="type">unsigned</span> <span class="type">int</span>)v18 ^ *(_DWORD *)(a1 + v20)) &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0x3F</span>] ^ dword_9D0[(((<span class="type">unsigned</span> <span class="type">int</span>)v18 ^ *(_DWORD *)(a1 + v20)) &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0x3F</span>] ^ dword_8D0[(((<span class="type">unsigned</span> <span class="type">int</span>)v18 ^ *(_DWORD *)(a1 + v20)) &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0x3F</span>] ^ dword_7D0[((<span class="type">unsigned</span> __int8)v18 ^ *(_BYTE *)(a1 + v20)) &amp; <span class="number">0x3F</span>];</span><br><span class="line">        </span><br><span class="line">        v22 = *(_DWORD *)(a1 + v20 + <span class="number">12</span>) ^ __ROL4__(v19, <span class="number">28</span>);</span><br><span class="line">        </span><br><span class="line">        v18 ^= DES_sbox_ED0[HIBYTE(v22) &amp; <span class="number">0x3F</span>] ^ dword_DD0[HIWORD(v22) &amp; <span class="number">0x3F</span>] ^ dword_CD0[(v22 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0x3F</span>] ^ dword_BD0[v22 &amp; <span class="number">0x3F</span>] ^ dword_AD0[((v19 ^ *(_DWORD *)(a1 + v20 + <span class="number">8</span>)) &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0x3F</span>] ^ dword_9D0[((v19 ^ *(_DWORD *)(a1 + v20 + <span class="number">8</span>)) &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0x3F</span>] ^ dword_8D0[((v19 ^ *(_DWORD *)(a1 + v20 + <span class="number">8</span>)) &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0x3F</span>] ^ dword_7D0[((<span class="type">unsigned</span> __int8)v19 ^ *(_BYTE *)(a1 + v20 + <span class="number">8</span>)) &amp; <span class="number">0x3F</span>];</span><br><span class="line">        </span><br><span class="line">        v20 += <span class="number">16LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( (_DWORD)v20 != <span class="number">128</span> );</span><br><span class="line">    v23 = __ROR4__(v18, <span class="number">1</span>);</span><br><span class="line">    v24 = (v19 ^ v23) &amp; <span class="number">0xAAAAAAAA</span>;</span><br><span class="line">    v25 = v24 ^ v23;</span><br><span class="line">    LODWORD(v26) = v19 ^ v24;</span><br><span class="line">    HIDWORD(v26) = v19;</span><br><span class="line">    v27 = (v25 ^ ((<span class="type">unsigned</span> <span class="type">int</span>)(v26 &gt;&gt; <span class="number">1</span>) &gt;&gt; <span class="number">8</span>)) &amp; <span class="number">0xFF00FF</span>;</span><br><span class="line">    v28 = v27 ^ v25;</span><br><span class="line">    v29 = (v26 &gt;&gt; <span class="number">1</span>) ^ (v27 &lt;&lt; <span class="number">8</span>);</span><br><span class="line">    v30 = (v28 ^ (v29 &gt;&gt; <span class="number">2</span>)) &amp; <span class="number">0x33333333</span>;</span><br><span class="line">    v31 = v30 ^ v28;</span><br><span class="line">    v32 = v29 ^ (<span class="number">4</span> * v30);</span><br><span class="line">    v33 = HIWORD(v31) ^ (<span class="type">unsigned</span> __int16)v32;</span><br><span class="line">    v34 = v33 ^ v32;</span><br><span class="line">    v35 = v31 ^ (v33 &lt;&lt; <span class="number">16</span>);</span><br><span class="line">    v36 = (v34 ^ (v35 &gt;&gt; <span class="number">4</span>)) &amp; <span class="number">0xF0F0F0F</span>;</span><br><span class="line">    v37 = v36 ^ v34;</span><br><span class="line">    v38 = v35 ^ (<span class="number">16</span> * v36);</span><br><span class="line">    *a3 = HIBYTE(v38);</span><br><span class="line">    a3[<span class="number">1</span>] = BYTE2(v38);</span><br><span class="line">    a3[<span class="number">2</span>] = BYTE1(v38);</span><br><span class="line">    a3[<span class="number">3</span>] = v38;</span><br><span class="line">    a3[<span class="number">4</span>] = HIBYTE(v37);</span><br><span class="line">    a3[<span class="number">5</span>] = BYTE2(v37);</span><br><span class="line">    a3[<span class="number">6</span>] = BYTE1(v37);</span><br><span class="line">    a3[<span class="number">7</span>] = v37;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="DES-ecb-enc"><a href="#DES-ecb-enc" class="headerlink" title="DES_ecb_enc"></a>DES_ecb_enc</h4><p>另一个条件分支的加密和上面差不多，只是少了明文一开始的异或</p>
<p><code>sub_16A0</code>初始化密钥，<code>sub_1B90</code>进行加密。</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><p>知道以上逻辑就可以写脚本解密flag了，借鉴了其他师傅WP的一部分👉<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/tjz3urSdsQac30JiqVN62Q">2023第三届“鹏城杯”线上初赛WriteUp</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> DES</span><br><span class="line"></span><br><span class="line">dst = [[<span class="number">0x3B3B082ADFEFF15B</span>, <span class="number">0x39A4E7E46830C917</span>], [<span class="number">0x699BB6FB1FF1E699</span>, <span class="number">0x8A25934CD21D7C9A</span>]]</span><br><span class="line">des_res = []</span><br><span class="line">iv = <span class="string">b&#x27;rwvrzmxr&#x27;</span></span><br><span class="line"><span class="keyword">for</span> num <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    res = dst[num]</span><br><span class="line">    res[<span class="number">1</span>] = res[<span class="number">1</span>].to_bytes(<span class="number">8</span>, <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">64</span>):</span><br><span class="line">        <span class="keyword">if</span> res[<span class="number">0</span>] &amp; <span class="number">1</span> == <span class="number">1</span>:</span><br><span class="line">            des = DES.new(res[<span class="number">0</span>].to_bytes(<span class="number">8</span>, <span class="string">&#x27;little&#x27;</span>), DES.MODE_ECB)</span><br><span class="line">            res[<span class="number">1</span>] = des.decrypt(res[<span class="number">1</span>])</span><br><span class="line">            res[<span class="number">1</span>] = <span class="built_in">bytes</span>([x ^ y <span class="keyword">for</span> x, y <span class="keyword">in</span> <span class="built_in">zip</span>(res[<span class="number">1</span>], iv)])</span><br><span class="line">            res[<span class="number">0</span>] ^= <span class="number">0x4A2E3FEAC2675AB3</span></span><br><span class="line">            res[<span class="number">0</span>] = (res[<span class="number">0</span>] // <span class="number">2</span>) + <span class="number">0x8000000000000000</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            des = DES.new(res[<span class="number">0</span>].to_bytes(<span class="number">8</span>, <span class="string">&#x27;little&#x27;</span>), DES.MODE_ECB)</span><br><span class="line">            res[<span class="number">1</span>] = des.decrypt(res[<span class="number">1</span>])</span><br><span class="line">            res[<span class="number">0</span>] //= <span class="number">2</span></span><br><span class="line">    res[<span class="number">1</span>] = <span class="built_in">int</span>.from_bytes(res[<span class="number">1</span>], <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">    des_res += res</span><br><span class="line"><span class="built_in">print</span>(des_res)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">res = des_res</span><br><span class="line">key = [<span class="number">0x0E0C7E0C7</span>, <span class="number">0x0C6F1D3D7</span>, <span class="number">0x0C6D3C6D3</span>, <span class="number">0x0C4D0D2CE</span>]</span><br><span class="line"></span><br><span class="line">delta = <span class="number">0x679AB87E</span></span><br><span class="line">num = (<span class="number">0x98654782</span> - delta * <span class="number">19</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">19</span>):</span><br><span class="line">    num += delta</span><br><span class="line">    num &amp;= <span class="number">0xFFFFFFFF</span></span><br><span class="line">    k_index = (num &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span></span><br><span class="line">    res[<span class="number">3</span>] -= ((((res[<span class="number">2</span>] &gt;&gt; <span class="number">5</span>) ^ (res[<span class="number">0</span>] &lt;&lt; <span class="number">2</span>)) &amp; <span class="number">0xFFFFFFFF</span>) + (((res[<span class="number">0</span>] &gt;&gt; <span class="number">3</span>) ^ (res[<span class="number">2</span>] &lt;&lt; <span class="number">4</span>)) &amp; <span class="number">0xFFFFFFFF</span>)) ^ ((num ^ res[<span class="number">0</span>]) + (res[<span class="number">2</span>] ^ key[k_index ^ <span class="number">3</span>]) &amp; <span class="number">0xFFFFFFFF</span>)</span><br><span class="line">    res[<span class="number">3</span>] &amp;= <span class="number">0xFFFFFFFF</span></span><br><span class="line">    res[<span class="number">2</span>] -= ((((res[<span class="number">1</span>] &gt;&gt; <span class="number">5</span>) ^ (res[<span class="number">3</span>] &lt;&lt; <span class="number">2</span>)) &amp; <span class="number">0xFFFFFFFF</span>) + (((res[<span class="number">3</span>] &gt;&gt; <span class="number">3</span>) ^ (res[<span class="number">1</span>] &lt;&lt; <span class="number">4</span>)) &amp; <span class="number">0xFFFFFFFF</span>)) ^ ((num ^ res[<span class="number">3</span>]) + (res[<span class="number">1</span>] ^ key[k_index ^ <span class="number">2</span>]) &amp; <span class="number">0xFFFFFFFF</span>)</span><br><span class="line">    res[<span class="number">2</span>] &amp;= <span class="number">0xFFFFFFFF</span></span><br><span class="line">    res[<span class="number">1</span>] -= ((((res[<span class="number">0</span>] &gt;&gt; <span class="number">5</span>) ^ (res[<span class="number">2</span>] &lt;&lt; <span class="number">2</span>)) &amp; <span class="number">0xFFFFFFFF</span>) + (((res[<span class="number">2</span>] &gt;&gt; <span class="number">3</span>) ^ (res[<span class="number">0</span>] &lt;&lt; <span class="number">4</span>)) &amp; <span class="number">0xFFFFFFFF</span>)) ^ ((num ^ res[<span class="number">2</span>]) + (res[<span class="number">0</span>] ^ key[k_index ^ <span class="number">1</span>]) &amp; <span class="number">0xFFFFFFFF</span>)</span><br><span class="line">    res[<span class="number">1</span>] &amp;= <span class="number">0xFFFFFFFF</span></span><br><span class="line">    res[<span class="number">0</span>] -= ((((res[<span class="number">3</span>] &gt;&gt; <span class="number">5</span>) ^ (res[<span class="number">1</span>] &lt;&lt; <span class="number">2</span>)) &amp; <span class="number">0xFFFFFFFF</span>) + (((res[<span class="number">1</span>] &gt;&gt; <span class="number">3</span>) ^ (res[<span class="number">3</span>] &lt;&lt; <span class="number">4</span>)) &amp; <span class="number">0xFFFFFFFF</span>)) ^ ((num ^ res[<span class="number">1</span>]) + (res[<span class="number">3</span>] ^ key[k_index]) &amp; <span class="number">0xFFFFFFFF</span>)</span><br><span class="line">    res[<span class="number">0</span>] &amp;= <span class="number">0xFFFFFFFF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&quot;</span>.join([<span class="built_in">hex</span>(x)[<span class="number">2</span>:] <span class="keyword">for</span> x <span class="keyword">in</span> res]))</span><br></pre></td></tr></table></figure>

<h2 id="StateMachine"><a href="#StateMachine" class="headerlink" title="StateMachine"></a>StateMachine</h2><p>看了网上师傅的WP👉<a target="_blank" rel="noopener" href="https://ycznkvrmzo.feishu.cn/docx/SBPWd7UWTo6OH3xqIM6cyMtznWd">2023 11.04 鹏城杯 wp - LaoGong</a></p>
<h3 id="逻辑-1"><a href="#逻辑-1" class="headerlink" title="逻辑"></a>逻辑</h3><p>先看获取<code>opcode</code>的函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">get_opcode</span><span class="params">(<span class="type">int</span> index, <span class="type">unsigned</span> <span class="type">int</span> unk_5150_indexMul329)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// [rsp+Ch] [rbp-Ch]</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> v4; <span class="comment">// [rsp+10h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">    v3 = unk_5150_indexMul329 &gt;&gt; <span class="number">3</span>;</span><br><span class="line">    v4 = unk_5150_indexMul329 &amp; <span class="number">7</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v4 &gt; <span class="number">3</span> )</span><br><span class="line">        <span class="keyword">return</span> ((<span class="type">int</span>)*((<span class="type">unsigned</span> __int8 *)&amp;unk_557993B73158 + <span class="number">1316</span> * index + v3) &gt;&gt; v4) </span><br><span class="line">        	| ((((<span class="number">1</span> &lt;&lt; ((unk_5150_indexMul329 &amp; <span class="number">7</span>) - <span class="number">3</span>)) - <span class="number">1</span>) &amp; (<span class="type">unsigned</span> <span class="type">int</span>)*((<span class="type">unsigned</span> __int8 *)&amp;unk_557993B73158 + <span class="number">1316</span> * index + v3 + <span class="number">1</span>)) &lt;&lt; (<span class="number">8</span> - v4));</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> ((<span class="type">int</span>)*((<span class="type">unsigned</span> __int8 *)&amp;unk_557993B73158 + <span class="number">1316</span> * index + v3) &gt;&gt; v4) &amp; <span class="number">0x1F</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 让代码好看一点</span></span><br><span class="line">__int64 __fastcall <span class="title function_">get_opcode</span><span class="params">(<span class="type">int</span> index, <span class="type">unsigned</span> <span class="type">int</span> unk_5150_indexMul329)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// [rsp+Ch] [rbp-Ch]</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> v4; <span class="comment">// [rsp+10h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> num2 = *((_DWORD *)&amp;unk_557993B73150 + <span class="number">329</span> * index)</span><br><span class="line">    v3 = num2 &gt;&gt; <span class="number">3</span>;</span><br><span class="line">    v4 = num2 &amp; <span class="number">7</span>;</span><br><span class="line">    <span class="type">void</span> * num1 = ((<span class="type">unsigned</span> __int8 *)&amp;unk_557993B73158 + <span class="number">1316</span> * index + v3)；</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ( v4 &gt; <span class="number">3</span> )</span><br><span class="line">        <span class="keyword">return</span> ((<span class="type">int</span>)*(num1) &gt;&gt; v4) | ((((<span class="number">1</span> &lt;&lt; ((v4) - <span class="number">3</span>)) - <span class="number">1</span>) &amp; (<span class="type">int</span>)*(num1 + <span class="number">1</span>)) &lt;&lt; (<span class="number">8</span> - v4));</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> ((<span class="type">int</span>)*(num1) &gt;&gt; v4) &amp; <span class="number">0x1F</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再看获取<code>op_num</code>的函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">get_op_num</span><span class="params">(<span class="type">int</span> a1, <span class="type">unsigned</span> <span class="type">int</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// [rsp+Ch] [rbp-Ch]</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> v4; <span class="comment">// [rsp+10h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">    v3 = a2 &gt;&gt; <span class="number">3</span>;</span><br><span class="line">    v4 = a2 &amp; <span class="number">7</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v4 &gt; <span class="number">4</span> )</span><br><span class="line">        <span class="keyword">return</span> ((<span class="type">int</span>)*((<span class="type">unsigned</span> __int8 *)&amp;unk_557993B73158 + <span class="number">1316</span> * a1 + v3) &gt;&gt; v4) | ((((<span class="number">1</span> &lt;&lt; ((a2 &amp; <span class="number">7</span>) - <span class="number">4</span>)) - <span class="number">1</span>) &amp; (<span class="type">unsigned</span> <span class="type">int</span>)*((<span class="type">unsigned</span> __int8 *)&amp;unk_557993B73158 + <span class="number">1316</span> * a1 + v3 + <span class="number">1</span>)) &lt;&lt; (<span class="number">8</span> - v4));</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> ((<span class="type">int</span>)*((<span class="type">unsigned</span> __int8 *)&amp;unk_557993B73158 + <span class="number">1316</span> * a1 + v3) &gt;&gt; v4) &amp; <span class="number">0xF</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 让代码好看一点</span></span><br><span class="line">__int64 __fastcall <span class="title function_">get_op_num</span><span class="params">(<span class="type">int</span> index, <span class="type">unsigned</span> <span class="type">int</span> a2=num2)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// [rsp+Ch] [rbp-Ch]</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> v4; <span class="comment">// [rsp+10h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> num2 = *((_DWORD *)&amp;unk_557993B73150 + <span class="number">329</span> * index) + <span class="number">5</span></span><br><span class="line">    <span class="type">void</span> * num1 = ((<span class="type">unsigned</span> __int8 *)&amp;unk_557993B73158 + <span class="number">1316</span> * index + v3)</span><br><span class="line">    v3 = num2 &gt;&gt; <span class="number">3</span>;</span><br><span class="line">    v4 = num2 &amp; <span class="number">7</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v4 &gt; <span class="number">4</span> )</span><br><span class="line">        <span class="keyword">return</span> ((<span class="type">int</span>)*num1 &gt;&gt; v4) | ((((<span class="number">1</span> &lt;&lt; ((v4) - <span class="number">4</span>)) - <span class="number">1</span>) &amp; (<span class="type">unsigned</span> <span class="type">int</span>)*(num1 + <span class="number">1</span>)) &lt;&lt; (<span class="number">8</span> - v4));</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> ((<span class="type">int</span>)*((<span class="type">unsigned</span> __int8 *)&amp;unk_557993B73158 + <span class="number">1316</span> * a1 + v3) &gt;&gt; v4) &amp; <span class="number">0xF</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>get_opcode</code>和<code>get_op_num</code>都是获取同一个数据里的数据，且最后返回的时候，经过了移位变换。</p>
<p>调试可以获取数据：</p>
<p><img src="/2023/12/24/CTF-wp-3/image-20231129212531090.png"></p>
<p>再来看其他函数，应该是控制流进行操作的函数了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall __noreturn <span class="title function_">start_routine</span><span class="params">(<span class="type">int</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">	...</span><br><span class="line">        </span><br><span class="line">    v3 = *a1; <span class="comment">// &amp;unk_5020 + 4 * i (i: 0~9)</span></span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">1</span>; i &lt;= &amp;unk_F423F; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">        *(&amp;unk_5100 + <span class="number">329</span> * i + <span class="number">2</span> * v3) = *(&amp;unk_5100 + <span class="number">329</span> * i + <span class="number">2</span> * v3 - <span class="number">329</span>);</span><br><span class="line">        <span class="keyword">while</span> ( !byte_5154[<span class="number">1316</span> * i - <span class="number">1316</span>] )	    <span class="comment">// 等待其他线程完成任务</span></span><br><span class="line">            ;</span><br><span class="line">        <span class="keyword">while</span> ( !byte_5558[<span class="number">1316</span> * i - <span class="number">1316</span>] )       <span class="comment">// 等待其他线程完成任务</span></span><br><span class="line">            ;</span><br><span class="line">        v4 = get_opcode((i - <span class="number">1</span>), *(&amp;unk_5150 + <span class="number">329</span> * i - <span class="number">329</span>)); <span class="comment">// 获取opcode</span></span><br><span class="line">        <span class="keyword">if</span> ( v4 != <span class="number">29</span> || v3 )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> ( v4 == <span class="number">31</span> )</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">if</span> ( v3 == get_op_num((i - <span class="number">1</span>), (*(&amp;unk_5150 + <span class="number">329</span> * i - <span class="number">329</span>) + <span class="number">5</span>)) )</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> ( (v4 &amp; <span class="number">0x18</span>) != <span class="number">0</span> )</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> ( (v4 &amp; <span class="number">0x18</span>) == <span class="number">8</span> )</span><br><span class="line">                    &#123;</span><br><span class="line">                        v6 = sub_13F9((i - <span class="number">1</span>), (*(&amp;unk_5150 + <span class="number">329</span> * i - <span class="number">329</span>) + <span class="number">9</span>));</span><br><span class="line">                        <span class="keyword">switch</span> ( v4 &amp; <span class="number">7</span> )</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                                *(&amp;unk_5100 + <span class="number">329</span> * i + <span class="number">2</span> * v3) = v6 + *(&amp;unk_5100 + <span class="number">329</span> * i + <span class="number">2</span> * v3 - <span class="number">329</span>);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                                *(&amp;unk_5100 + <span class="number">329</span> * i + <span class="number">2</span> * v3) = *(&amp;unk_5100 + <span class="number">329</span> * i + <span class="number">2</span> * v3 - <span class="number">329</span>) - v6;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                                *(&amp;unk_5100 + <span class="number">329</span> * i + <span class="number">2</span> * v3) = v6;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                                *(&amp;unk_5100 + <span class="number">329</span> * i + <span class="number">2</span> * v3) = *(&amp;unk_5100 + <span class="number">329</span> * i + <span class="number">2</span> * v3 - <span class="number">329</span>) &lt;&lt; v6;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                                *(&amp;unk_5100 + <span class="number">329</span> * i + <span class="number">2</span> * v3) = *(&amp;unk_5100 + <span class="number">329</span> * i + <span class="number">2</span> * v3 - <span class="number">329</span>) &gt;&gt; v6;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            <span class="keyword">default</span>:</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> ( v4 == <span class="number">16</span> )</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">// opcode == 16: mov</span></span><br><span class="line">                        v5 = get_op_num((i - <span class="number">1</span>), (*(&amp;unk_5150 + <span class="number">329</span> * i - <span class="number">329</span>) + <span class="number">9</span>));</span><br><span class="line">                        <span class="keyword">do</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">while</span> ( !*(&amp;byte_5104 + <span class="number">1316</span> * i + <span class="number">8</span> * v5 - <span class="number">1316</span>) )</span><br><span class="line">                                ;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">while</span> ( !byte_5621[<span class="number">1316</span> * i - <span class="number">1316</span>] );</span><br><span class="line">                        *(&amp;unk_5100 + <span class="number">329</span> * i + <span class="number">2</span> * v3) = *(&amp;byte_5559 + <span class="number">1316</span> * i + *(&amp;unk_5100 + <span class="number">329</span> * i + <span class="number">2</span> * v5 - <span class="number">329</span>) - <span class="number">1316</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// opcode &amp; 0x18 == 0</span></span><br><span class="line">                    v7 = get_op_num((i - <span class="number">1</span>), (*(&amp;unk_5150 + <span class="number">329</span> * i - <span class="number">329</span>) + <span class="number">9</span>));</span><br><span class="line">                    <span class="keyword">while</span> ( !*(&amp;byte_5104 + <span class="number">1316</span> * i + <span class="number">8</span> * v7 - <span class="number">1316</span>) )</span><br><span class="line">                        ;</span><br><span class="line">                    v1 = v4 &amp; <span class="number">7</span>;</span><br><span class="line">                    <span class="keyword">if</span> ( v1 == <span class="number">3</span> )</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">// opcode &amp; 7 == 3: xor</span></span><br><span class="line">                        *(&amp;unk_5100 + <span class="number">329</span> * i + <span class="number">2</span> * v3) = *(&amp;unk_5100 + <span class="number">329</span> * i + <span class="number">2</span> * v7 - <span class="number">329</span>)</span><br><span class="line">                                ^ *(&amp;unk_5100 + <span class="number">329</span> * i + <span class="number">2</span> * v3 - <span class="number">329</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> ( (v4 &amp; <span class="number">7u</span>) &lt;= <span class="number">3</span> )</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">if</span> ( v1 == <span class="number">2</span> )</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="comment">// opcode &amp; 7 == 2: </span></span><br><span class="line">                            *(&amp;unk_5100 + <span class="number">329</span> * i + <span class="number">2</span> * v3) = *(&amp;unk_5100 + <span class="number">329</span> * i + <span class="number">2</span> * v7 - <span class="number">329</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> ( (v4 &amp; <span class="number">7</span>) != <span class="number">0</span> )</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="comment">// opcode &amp; 7 == 1: sub</span></span><br><span class="line">                            *(&amp;unk_5100 + <span class="number">329</span> * i + <span class="number">2</span> * v3) = *(&amp;unk_5100 + <span class="number">329</span> * i + <span class="number">2</span> * v3 - <span class="number">329</span>)</span><br><span class="line">                                - *(&amp;unk_5100 + <span class="number">329</span> * i + <span class="number">2</span> * v7 - <span class="number">329</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="comment">// opcode &amp; 7 == 0: add</span></span><br><span class="line">                            *(&amp;unk_5100 + <span class="number">329</span> * i + <span class="number">2</span> * v3) = *(&amp;unk_5100 + <span class="number">329</span> * i + <span class="number">2</span> * v3 - <span class="number">329</span>)</span><br><span class="line">                                + *(&amp;unk_5100 + <span class="number">329</span> * i + <span class="number">2</span> * v7 - <span class="number">329</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// opcode == 29: getchar</span></span><br><span class="line">            *(&amp;unk_5100 + <span class="number">329</span> * i) = getchar();</span><br><span class="line">        &#125;</span><br><span class="line">        *(&amp;byte_5104 + <span class="number">1316</span> * i + <span class="number">8</span> * v3) = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    pthread_exit(<span class="number">0LL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __fastcall __noreturn <span class="title function_">sub_1C41</span><span class="params">(<span class="type">void</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">    <span class="type">int</span> v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line">    <span class="type">int</span> v3; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">1</span>; i &lt;= &amp;unk_1869F; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">        *(&amp;unk_5150 + <span class="number">329</span> * i) = *(&amp;unk_5150 + <span class="number">329</span> * i - <span class="number">329</span>);</span><br><span class="line">        <span class="keyword">while</span> ( !byte_5558[<span class="number">1316</span> * i - <span class="number">1316</span>] )</span><br><span class="line">            ;</span><br><span class="line">        v2 = get_opcode(i - <span class="number">1</span>, *(&amp;unk_5150 + <span class="number">329</span> * i - <span class="number">329</span>));</span><br><span class="line">        <span class="keyword">if</span> ( (v2 &amp; <span class="number">0x18</span>) != <span class="number">0</span> &amp;&amp; (v2 &amp; <span class="number">0x18</span>) != <span class="number">0x10</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> ( (v2 &amp; <span class="number">0x18</span>) == <span class="number">24</span> )</span><br><span class="line">            &#123;</span><br><span class="line">                *(&amp;unk_5150 + <span class="number">329</span> * i) = *(&amp;unk_5150 + <span class="number">329</span> * i - <span class="number">329</span>) + <span class="number">5</span>;</span><br><span class="line">                <span class="keyword">if</span> ( v2 == <span class="number">28</span> )</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// opcode == 28: putchar</span></span><br><span class="line">                    <span class="keyword">while</span> ( !*(&amp;byte_5104 + <span class="number">1316</span> * i - <span class="number">1316</span>) )</span><br><span class="line">                        ;</span><br><span class="line">                    <span class="built_in">putchar</span>(*(&amp;unk_5100 + <span class="number">329</span> * i - <span class="number">329</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ( v2 == <span class="number">31</span> )</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ( (v2 &amp; <span class="number">0x18</span>) == <span class="number">8</span> )</span><br><span class="line">            &#123;</span><br><span class="line">                *(&amp;unk_5150 + <span class="number">329</span> * i) = *(&amp;unk_5150 + <span class="number">329</span> * i - <span class="number">329</span>) + <span class="number">25</span>;</span><br><span class="line">                <span class="keyword">if</span> ( v2 == <span class="number">15</span> )</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// opcode == 15: jnz</span></span><br><span class="line">                    v3 = get_op_num((i - <span class="number">1</span>), (*(&amp;unk_5150 + <span class="number">329</span> * i - <span class="number">329</span>) + <span class="number">5</span>));</span><br><span class="line">                    <span class="keyword">while</span> ( !*(&amp;byte_5104 + <span class="number">1316</span> * i + <span class="number">8</span> * v3 - <span class="number">1316</span>) )</span><br><span class="line">                        ;</span><br><span class="line">                    <span class="keyword">if</span> ( *(&amp;unk_5100 + <span class="number">329</span> * i + <span class="number">2</span> * v3 - <span class="number">329</span>) )</span><br><span class="line">                        *(&amp;unk_5150 + <span class="number">329</span> * i) = sub_13F9((i - <span class="number">1</span>), (*(&amp;unk_5150 + <span class="number">329</span> * i - <span class="number">329</span>) + <span class="number">9</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            *(&amp;unk_5150 + <span class="number">329</span> * i) = *(&amp;unk_5150 + <span class="number">329</span> * i - <span class="number">329</span>) + <span class="number">13</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        byte_5154[<span class="number">1316</span> * i] = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    pthread_exit(<span class="number">0LL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __fastcall __noreturn <span class="title function_">sub_1F91</span><span class="params">(<span class="type">void</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line">    <span class="type">int</span> v2; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">    <span class="type">int</span> v3; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line">    <span class="type">int</span> v4; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">1</span>; i &lt;= &amp;unk_1869F; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;unk_5100 + <span class="number">1316</span> * i + <span class="number">1113</span>, &amp;unk_5100 + <span class="number">1316</span> * i - <span class="number">203</span>, <span class="number">0xC8</span>uLL);</span><br><span class="line">        <span class="keyword">while</span> ( !byte_5154[<span class="number">1316</span> * i - <span class="number">1316</span>] )</span><br><span class="line">            ;</span><br><span class="line">        <span class="keyword">while</span> ( !byte_5558[<span class="number">1316</span> * i - <span class="number">1316</span>] )</span><br><span class="line">            ;</span><br><span class="line">        v2 = get_opcode(i - <span class="number">1</span>, *(&amp;unk_5150 + <span class="number">329</span> * i - <span class="number">329</span>));</span><br><span class="line">        <span class="keyword">if</span> ( v2 == <span class="number">17</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// opcode= == 17: mov</span></span><br><span class="line">            v3 = get_op_num((i - <span class="number">1</span>), (*(&amp;unk_5150 + <span class="number">329</span> * i - <span class="number">329</span>) + <span class="number">5</span>));</span><br><span class="line">            v4 = get_op_num((i - <span class="number">1</span>), (*(&amp;unk_5150 + <span class="number">329</span> * i - <span class="number">329</span>) + <span class="number">9</span>));</span><br><span class="line">            <span class="keyword">do</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">while</span> ( !*(&amp;byte_5104 + <span class="number">1316</span> * i + <span class="number">8</span> * v3 - <span class="number">1316</span>) );</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> ( !*(&amp;byte_5104 + <span class="number">1316</span> * i + <span class="number">8</span> * v4 - <span class="number">1316</span>) );</span><br><span class="line">            *(&amp;byte_5559 + <span class="number">1316</span> * i + *(&amp;unk_5100 + <span class="number">329</span> * i + <span class="number">2</span> * v4 - <span class="number">329</span>)) = *(&amp;unk_5100 + <span class="number">329</span> * i + <span class="number">2</span> * v3 - <span class="number">329</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( v2 == <span class="number">31</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        byte_5621[<span class="number">1316</span> * i] = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    pthread_exit(<span class="number">0LL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>利用网上师傅WP里的脚本可以讲逻辑输出，对于<code>codes</code>为什么要二进制然后倒转这点我暂时没搞懂😭</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">codes = <span class="built_in">open</span>(<span class="string">&#x27;./vm&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>).read()[<span class="number">0x3020</span>: <span class="number">0x3020</span> + <span class="number">0x157</span>]</span><br><span class="line">codes = <span class="string">&#x27;&#x27;</span>.join(<span class="built_in">bin</span>(i)[<span class="number">2</span>: ].rjust(<span class="number">8</span>, <span class="string">&#x27;0&#x27;</span>)[:: -<span class="number">1</span>] <span class="keyword">for</span> i <span class="keyword">in</span> codes)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fetch_imm</span>(<span class="params">codes, pc, size</span>):</span><br><span class="line">    <span class="keyword">assert</span> pc + size &lt;= <span class="built_in">len</span>(codes)</span><br><span class="line">    value = <span class="built_in">int</span>(codes[pc: pc + size][:: -<span class="number">1</span>], <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> value, pc + size</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fetch_opcode</span>(<span class="params">codes, pc</span>):</span><br><span class="line">    <span class="keyword">return</span> fetch_imm(codes, pc, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fetch_reg_index</span>(<span class="params">codes, pc</span>):</span><br><span class="line">    <span class="keyword">return</span> fetch_imm(codes, pc, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fetch_imm16</span>(<span class="params">codes, pc</span>):</span><br><span class="line">    <span class="keyword">return</span> fetch_imm(codes, pc, <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">regs = [<span class="string">&#x27;rax&#x27;</span>, <span class="string">&#x27;rbp&#x27;</span>, <span class="string">&#x27;r8&#x27;</span>, <span class="string">&#x27;r9&#x27;</span>, <span class="string">&#x27;r10&#x27;</span>, <span class="string">&#x27;r11&#x27;</span>, <span class="string">&#x27;r12&#x27;</span>, <span class="string">&#x27;r13&#x27;</span>, <span class="string">&#x27;r14&#x27;</span>, <span class="string">&#x27;r15&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;.intel_syntax noprefix&#x27;</span>)</span><br><span class="line">pc = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> pc &lt; <span class="built_in">len</span>(codes):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;_0x%04x: &#x27;</span> % pc, end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    opcode, pc = fetch_opcode(codes, pc)</span><br><span class="line">    <span class="keyword">if</span> opcode == <span class="number">15</span>:</span><br><span class="line">        dreg, pc = fetch_reg_index(codes, pc)</span><br><span class="line">        imm, pc = fetch_imm16(codes, pc)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;cmp %s, 0\n  jnz _0x%04x&#x27;</span> % (regs[dreg], imm))</span><br><span class="line">    <span class="keyword">elif</span> opcode == <span class="number">17</span>:</span><br><span class="line">        dreg, pc = fetch_reg_index(codes, pc)</span><br><span class="line">        sreg, pc = fetch_reg_index(codes, pc)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;mov [%s + 0x2000], %s&#x27;</span> % (regs[sreg], regs[dreg]))</span><br><span class="line">    <span class="keyword">elif</span> opcode == <span class="number">28</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;call m_putchar&#x27;</span>)</span><br><span class="line">    <span class="keyword">elif</span> opcode == <span class="number">29</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;call m_getchar&#x27;</span>)</span><br><span class="line">    <span class="keyword">elif</span> opcode == <span class="number">31</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;ret&#x27;</span>)</span><br><span class="line">    <span class="keyword">elif</span> opcode == <span class="number">16</span>:</span><br><span class="line">        dreg, pc = fetch_reg_index(codes, pc)</span><br><span class="line">        sreg, pc = fetch_reg_index(codes, pc)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;mov %s, [%s + 0x2000]&#x27;</span> % (regs[dreg], regs[sreg]))</span><br><span class="line">    <span class="keyword">elif</span> opcode &amp; <span class="number">0x18</span> == <span class="number">8</span>:</span><br><span class="line">        dreg, pc = fetch_reg_index(codes, pc)</span><br><span class="line">        imm, pc = fetch_imm16(codes, pc)</span><br><span class="line">        op = [<span class="string">&#x27;add&#x27;</span>, <span class="string">&#x27;sub&#x27;</span>, <span class="string">&#x27;mov&#x27;</span>, <span class="string">&#x27;shl&#x27;</span>, <span class="string">&#x27;shr&#x27;</span>][opcode &amp; <span class="number">7</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;%s %s, 0x%x&#x27;</span> % (op, regs[dreg], imm))</span><br><span class="line">    <span class="keyword">elif</span> opcode &amp; <span class="number">0x18</span> == <span class="number">0</span>:</span><br><span class="line">        dreg, pc = fetch_reg_index(codes, pc)</span><br><span class="line">        sreg, pc = fetch_reg_index(codes, pc)</span><br><span class="line">        op = [<span class="string">&#x27;add&#x27;</span>, <span class="string">&#x27;sub&#x27;</span>, <span class="string">&#x27;mov&#x27;</span>, <span class="string">&#x27;xor&#x27;</span>][opcode &amp; <span class="number">7</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;%s %s, %s&#x27;</span> % (op, regs[dreg], regs[sreg]))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">assert</span> <span class="literal">False</span>, <span class="built_in">hex</span>(opcode)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用<code>gcc -c ./main.s -o main.o</code>可以将输出的汇编代码转成二进制文件，更好分析。</p>
<p>先获取输入，然后将输入分为三组，每组两个四字节数进行TEA加密，最后进行比较。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="number">0x0000</span>(__int64 a1, __int64 a2)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    v2 = <span class="number">24</span>i64;</span><br><span class="line">    v3 = <span class="number">0</span>i64;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        v4 = m_getchar(a1, a2, v3);</span><br><span class="line">        *(_QWORD *)(v5 + <span class="number">0x2000</span>) = v4;</span><br><span class="line">        --v2;</span><br><span class="line">        v3 = v5 + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v2 );</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        v6 = <span class="number">4</span>i64;</span><br><span class="line">        v7 = <span class="number">8</span>i64 * MEMORY[<span class="number">0x2030</span>];</span><br><span class="line">        input_8char1 = <span class="number">0</span>i64;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            input_8char1 = *(_QWORD *)(v7 + <span class="number">0x2000</span>) ^ (input_8char1 &lt;&lt; <span class="number">8</span>);</span><br><span class="line">            ++v7;</span><br><span class="line">            --v6;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ( v6 );</span><br><span class="line">        v9 = <span class="number">4</span>i64;</span><br><span class="line">        input_8char2 = <span class="number">0</span>i64;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            input_8char2 = *(_QWORD *)(v7 + <span class="number">0x2000</span>) ^ (input_8char2 &lt;&lt; <span class="number">8</span>);</span><br><span class="line">            ++v7;</span><br><span class="line">            --v9;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ( v9 );</span><br><span class="line">        v11 = <span class="number">32</span>i64;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            v9 += <span class="number">0x43217856</span>i64;</span><br><span class="line">            v12 = <span class="number">4</span>i64;</span><br><span class="line">            key0 = <span class="number">0</span>i64;</span><br><span class="line">            <span class="keyword">do</span></span><br><span class="line">            &#123;</span><br><span class="line">                v14 = v12 + <span class="number">23</span>;</span><br><span class="line">                key0 = *(_QWORD *)(v14 + <span class="number">0x2000</span>) ^ (key0 &lt;&lt; <span class="number">8</span>);</span><br><span class="line">                v12 = v14 - <span class="number">24</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> ( v12 );</span><br><span class="line">            v15 = <span class="number">4</span>i64;</span><br><span class="line">            key1 = <span class="number">0</span>i64;</span><br><span class="line">            <span class="keyword">do</span></span><br><span class="line">            &#123;</span><br><span class="line">                v17 = v15 + <span class="number">27</span>;</span><br><span class="line">                key1 = *(_QWORD *)(v17 + <span class="number">0x2000</span>) ^ (key1 &lt;&lt; <span class="number">8</span>);</span><br><span class="line">                v15 = v17 - <span class="number">28</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> ( v15 );</span><br><span class="line">            input_8char1 += (key1 + (input_8char2 &gt;&gt; <span class="number">5</span>)) ^ (input_8char2 + v9) ^ (key0 + <span class="number">16</span> * input_8char2);</span><br><span class="line">            v18 = <span class="number">4</span>i64;</span><br><span class="line">            key2 = <span class="number">0</span>i64;</span><br><span class="line">            <span class="keyword">do</span></span><br><span class="line">            &#123;</span><br><span class="line">                v20 = v18 + <span class="number">31</span>;</span><br><span class="line">                key2 = *(_QWORD *)(v20 + <span class="number">0x2000</span>) ^ (key2 &lt;&lt; <span class="number">8</span>);</span><br><span class="line">                v18 = v20 - <span class="number">32</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> ( v18 );</span><br><span class="line">            v21 = <span class="number">4</span>i64;</span><br><span class="line">            key3 = <span class="number">0</span>i64;</span><br><span class="line">            <span class="keyword">do</span></span><br><span class="line">            &#123;</span><br><span class="line">                v23 = v21 + <span class="number">35</span>;</span><br><span class="line">                key3 = *(_QWORD *)(v23 + <span class="number">0x2000</span>) ^ (key3 &lt;&lt; <span class="number">8</span>);</span><br><span class="line">                v21 = v23 - <span class="number">36</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> ( v21 );</span><br><span class="line">            input_8char2 += (key3 + (input_8char1 &gt;&gt; <span class="number">5</span>)) ^ (input_8char1 + v9) ^ (key2 + <span class="number">16</span> * input_8char1);</span><br><span class="line">            --v11;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ( v11 );</span><br><span class="line">        v24 = <span class="number">8</span>i64 * MEMORY[<span class="number">0x2030</span>] + <span class="number">64</span>;</span><br><span class="line">        v25 = <span class="number">8</span>i64 * MEMORY[<span class="number">0x2030</span>] + <span class="number">68</span>;</span><br><span class="line">        v26 = <span class="number">4</span>i64;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            --v26;</span><br><span class="line">            *(_QWORD *)(v24 + <span class="number">0x2000</span>) = input_8char1;</span><br><span class="line">            *(_QWORD *)(v25 + <span class="number">0x2000</span>) = input_8char2;</span><br><span class="line">            ++v24;</span><br><span class="line">            ++v25;</span><br><span class="line">            input_8char1 &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">            input_8char2 &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ( v26 );</span><br><span class="line">        ++MEMORY[<span class="number">0x2030</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( MEMORY[<span class="number">0x2030</span>] != <span class="number">3</span>i64 );</span><br><span class="line">    <span class="keyword">if</span> ( MEMORY[<span class="number">0x2058</span>] != MEMORY[<span class="number">0x2040</span>] )</span><br><span class="line">        m_putchar(a1, a2, <span class="number">88</span>i64, <span class="number">24</span>i64);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        m_putchar(a1, a2, <span class="number">89</span>i64, <span class="number">23</span>i64);</span><br><span class="line">    m_putchar(v28, v27, v29, v30);</span><br><span class="line">    m_putchar(v32, v31, v33, v34);</span><br><span class="line">    <span class="keyword">return</span> m_putchar(v36, v35, v37, v38);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>密文在之前有一个初始化函数中：</p>
<p><img src="/2023/12/24/CTF-wp-3/image-20231129220333027.png"></p>
<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><p>懒得写解密脚本了，借鉴一下网上师傅的，阿里嘎多</p>
<p>主要是前面的逻辑或多或少没理清</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">encrypt</span><span class="params">(<span class="type">char</span>* data)</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>* _data = (<span class="type">unsigned</span> <span class="type">int</span>*) data;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> _data0 = __builtin_bswap32(_data[<span class="number">2</span> * i + <span class="number">0</span>]);</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> _data1 = __builtin_bswap32(_data[<span class="number">2</span> * i + <span class="number">1</span>]);</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> sum = <span class="number">0</span>, delta = <span class="number">0x43217856</span>;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> key[] = &#123; <span class="number">0x11</span>, <span class="number">0x22</span>, <span class="number">0x88</span>, <span class="number">0xff</span> &#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">32</span>; j++) &#123;</span><br><span class="line">            sum += delta;</span><br><span class="line">            _data0 += (key[<span class="number">1</span>] + (_data1 &gt;&gt; <span class="number">5</span>)) ^ (_data1 + sum) ^ (key[<span class="number">0</span>] + (_data1 &lt;&lt; <span class="number">4</span>));</span><br><span class="line">            _data1 += (key[<span class="number">3</span>] + (_data0 &gt;&gt; <span class="number">5</span>)) ^ (_data0 + sum) ^ (key[<span class="number">2</span>] + (_data0 &lt;&lt; <span class="number">4</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        _data[<span class="number">2</span> * i + <span class="number">0</span>] = _data0;</span><br><span class="line">        _data[<span class="number">2</span> * i + <span class="number">1</span>] = _data1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">decrypt</span><span class="params">(<span class="type">char</span>* data)</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>* _data = (<span class="type">unsigned</span> <span class="type">int</span>*) data;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> _data0 = _data[<span class="number">2</span> * i + <span class="number">0</span>];</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> _data1 = _data[<span class="number">2</span> * i + <span class="number">1</span>];</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> sum = <span class="number">0</span>, delta = <span class="number">0x43217856</span>;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> key[] = &#123; <span class="number">0x11</span>, <span class="number">0x22</span>, <span class="number">0x88</span>, <span class="number">0xff</span> &#125;;</span><br><span class="line">        sum = delta * <span class="number">32</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">32</span>; j++) &#123;</span><br><span class="line">            _data1 -= (key[<span class="number">3</span>] + (_data0 &gt;&gt; <span class="number">5</span>)) ^ (_data0 + sum) ^ (key[<span class="number">2</span>] + (_data0 &lt;&lt; <span class="number">4</span>));</span><br><span class="line">            _data0 -= (key[<span class="number">1</span>] + (_data1 &gt;&gt; <span class="number">5</span>)) ^ (_data1 + sum) ^ (key[<span class="number">0</span>] + (_data1 &lt;&lt; <span class="number">4</span>));</span><br><span class="line">            sum -= delta;</span><br><span class="line">        &#125;</span><br><span class="line">        _data[<span class="number">2</span> * i + <span class="number">0</span>] = __builtin_bswap32(_data0);</span><br><span class="line">        _data[<span class="number">2</span> * i + <span class="number">1</span>] = __builtin_bswap32(_data1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> data[<span class="number">25</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    ((<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*) data)[<span class="number">0</span>] = <span class="number">0x3a84f4140fb6b1b8</span>l;</span><br><span class="line">    ((<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*) data)[<span class="number">1</span>] = <span class="number">0xb485900290ce01cb</span>l;</span><br><span class="line">    ((<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*) data)[<span class="number">2</span>] = <span class="number">0x2d7458b7ea807f7c</span>l;</span><br><span class="line">    <span class="comment">// encrypt(data);</span></span><br><span class="line">    decrypt(data);</span><br><span class="line">    <span class="built_in">puts</span>(data);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="ACTF2023"><a href="#ACTF2023" class="headerlink" title="ACTF2023"></a>ACTF2023</h1><h2 id="native-app"><a href="#native-app" class="headerlink" title="native-app"></a>native-app</h2><p>👉<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-279403.htm">flutter逆向 ACTF native app</a></p>
<p>👉<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/671753808">blutter使用+ACTF习题</a></p>
<h3 id="blutter"><a href="#blutter" class="headerlink" title="blutter"></a>blutter</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/worawit/blutter --depth=1</span><br><span class="line">cd blutter/</span><br><span class="line">python .\scripts\init_env_win.py</span><br></pre></td></tr></table></figure>

<p>在<code>x64 Native Tools Command Prompt for VS 2022</code>中：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python ./blutter.py E:\CTFChallenge\攻防世界\ACTF2023\native_app\chall\lib\arm64-v8a ./out</span><br></pre></td></tr></table></figure>

<p><code>out</code>目录下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">│  blutter_frida.js</span><br><span class="line">│  objs.txt</span><br><span class="line">│  pp.txt</span><br><span class="line">│</span><br><span class="line">├─asm</span><br><span class="line">│  ├─characters</span><br><span class="line">│  │  └─src</span><br><span class="line">│  │      │  characters.dart</span><br><span class="line">│  │      │  characters_impl.dart</span><br><span class="line">│  │      │</span><br><span class="line">│  │      └─grapheme_clusters</span><br><span class="line">│  │              breaks.dart</span><br><span class="line">│  │</span><br><span class="line">│  ├─collection</span><br><span class="line">│  │  └─src</span><br><span class="line">│  │          priority_queue.dart</span><br><span class="line">│  │</span><br><span class="line">│  ├─flutter</span><br><span class="line">│  │  └─src</span><br><span class="line">│  │      ......</span><br><span class="line">│  │</span><br><span class="line">│  └─flutter_application_1</span><br><span class="line">│          main.dart</span><br><span class="line">│</span><br><span class="line">└─ida_script</span><br><span class="line">        addNames.py</span><br><span class="line">        ida_dart_struct.h</span><br></pre></td></tr></table></figure>

<p><code>IDA</code>打开<code>libapp.so</code>，使用<code>addNames.py</code>恢复符号。</p>
<p><img src="/2023/12/24/CTF-wp-3/image-20231213165132644.png"></p>
<h1 id="DASCTF-X-0psu3十一月挑战赛"><a href="#DASCTF-X-0psu3十一月挑战赛" class="headerlink" title="DASCTF X 0psu3十一月挑战赛"></a>DASCTF X 0psu3十一月挑战赛</h1><h2 id="ezpython"><a href="#ezpython" class="headerlink" title="ezpython"></a>ezpython</h2><p>PYC文件将前十六个字节换成Python11的文件头，原来是由Key的<code>yuanshen</code>。</p>
<p>反编译以下，发现有些错误，但根据字节码让GPT反编译就可以补齐逻辑了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Source Generated with Decompyle++</span></span><br><span class="line"><span class="comment"># File: ezpython.pyc (Python 3.11)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pyDes</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">adjust_length</span>(<span class="params"><span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(<span class="built_in">str</span>) &lt; <span class="number">8</span>:</span><br><span class="line">        <span class="built_in">str</span> = <span class="built_in">str</span>.ljust(<span class="number">8</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    <span class="keyword">elif</span> <span class="built_in">len</span>(<span class="built_in">str</span>) &gt; <span class="number">8</span>:</span><br><span class="line">        <span class="built_in">str</span> = <span class="built_in">str</span>[:<span class="number">8</span>]</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Wrong</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">yuanshen</span>(<span class="params">array, start, end</span>):</span><br><span class="line">    num = <span class="built_in">len</span>(array)</span><br><span class="line">    dis = [<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>)] * num</span><br><span class="line">    tree = [<span class="literal">False</span>] * num</span><br><span class="line">    parent = [-<span class="number">1</span>] * num</span><br><span class="line">    dis[start] = <span class="number">0</span></span><br><span class="line"><span class="comment"># WARNING: Decompyle incomplete</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">yuanshen</span>(<span class="params">array, start, end</span>):</span><br><span class="line">    num = <span class="built_in">len</span>(array)</span><br><span class="line">    inf = math.inf</span><br><span class="line">    dis = [inf] * num</span><br><span class="line">    tree = [<span class="literal">False</span>] * num </span><br><span class="line">    parent = [-<span class="number">1</span>] * num</span><br><span class="line">    </span><br><span class="line">    dis[start] = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num):</span><br><span class="line">        min_dis = inf</span><br><span class="line">        min_index = -<span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> v <span class="keyword">in</span> <span class="built_in">range</span>(num):</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> tree[v]:</span><br><span class="line">                <span class="keyword">if</span> dis[v] &lt; min_dis:</span><br><span class="line">                    min_dis = dis[v]  </span><br><span class="line">                    min_index = v</span><br><span class="line">                </span><br><span class="line">        <span class="keyword">if</span> min_index == -<span class="number">1</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">        tree[min_index] = <span class="literal">True</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">for</span> v <span class="keyword">in</span> <span class="built_in">range</span>(num):</span><br><span class="line">            <span class="keyword">if</span> tree[v]:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">if</span> array[min_index] != math.inf <span class="keyword">and</span> array[min_index][v] != math.inf:</span><br><span class="line">                <span class="keyword">if</span> dis[min_index] + array[min_index][v] &lt; dis[v]:</span><br><span class="line">                    dis[v] = dis[min_index] + array[min_index][v] </span><br><span class="line">                    parent[v] = min_index</span><br><span class="line">                    </span><br><span class="line">    <span class="keyword">if</span> dis[end] == math.inf:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">    t = []</span><br><span class="line">    current = end</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> current != -<span class="number">1</span>:</span><br><span class="line">        t.append(current)</span><br><span class="line">        current = parent[current]</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> t[::-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">qidong</span>(<span class="params"><span class="built_in">input</span>, key, IV</span>):</span><br><span class="line">    cipher = pyDes.des(key, pyDes.CBC, IV, pad = <span class="literal">None</span>, padmode = pyDes.PAD_PKCS5)</span><br><span class="line">    encrypted_data = cipher.encrypt(<span class="built_in">input</span>)</span><br><span class="line">    encrypted_hex_list = encrypted_data()</span><br><span class="line">    <span class="keyword">return</span> encrypted_hex_list</span><br><span class="line"></span><br><span class="line"><span class="comment"># Wrong</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    data = [<span class="number">159</span>,..<span class="number">.123</span>]</span><br><span class="line">    key = <span class="built_in">input</span>(<span class="string">&#x27;请输入key: &#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(key) != <span class="number">8</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;wrong key lenth!&#x27;</span>)</span><br><span class="line">        exit()</span><br><span class="line">    flag = <span class="built_in">input</span>(<span class="string">&#x27;请输入flag: &#x27;</span>)</span><br><span class="line">    array = [</span><br><span class="line">        [<span class="number">0</span>,...<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>)],</span><br><span class="line">        ...,</span><br><span class="line">        [<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),..<span class="number">.0</span>]</span><br><span class="line">    ]</span><br><span class="line">    t = yuanshen(array, <span class="number">1</span>, <span class="number">8</span>)</span><br><span class="line">    IV = (<span class="keyword">lambda</span> <span class="number">.0</span>: <span class="keyword">pass</span><span class="comment"># WARNING: Decompyle incomplete</span></span><br><span class="line">)(t())</span><br><span class="line">    IV = adjust_length(IV)</span><br><span class="line">    check = qidong(flag, key, IV)</span><br><span class="line">    <span class="keyword">if</span> check == data:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;yes,yes,yes!!&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="string">&#x27;&#x27;</span>.join(<span class="string">&#x27;bad,bad,bad!!&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> ezpython <span class="keyword">import</span> yuanshen, adjust_length, qidong</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    data = (<span class="number">159</span>, <span class="number">41</span>, <span class="number">201</span>, <span class="number">125</span>, <span class="number">67</span>, <span class="number">60</span>, <span class="number">44</span>, <span class="number">34</span>, <span class="number">203</span>, <span class="number">56</span>, <span class="number">116</span>, <span class="number">186</span>, <span class="number">13</span>, <span class="number">71</span>, <span class="number">125</span>, <span class="number">30</span>, <span class="number">84</span>, <span class="number">123</span>, <span class="number">109</span>, <span class="number">54</span>, <span class="number">106</span>, <span class="number">56</span>, <span class="number">17</span>, <span class="number">124</span>, <span class="number">87</span>, <span class="number">236</span>, <span class="number">25</span>, <span class="number">12</span>, <span class="number">80</span>, <span class="number">178</span>, <span class="number">165</span>, <span class="number">123</span>)</span><br><span class="line">    </span><br><span class="line">    key = <span class="built_in">input</span>(<span class="string">&quot;请输入key: &quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(key) != <span class="number">8</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;wrong key lenth!&quot;</span>)</span><br><span class="line">        sys.exit()</span><br><span class="line">        </span><br><span class="line">    flag = <span class="built_in">input</span>(<span class="string">&quot;请输入flag: &quot;</span>)</span><br><span class="line">        </span><br><span class="line">    array = [</span><br><span class="line">        [<span class="number">0</span>, <span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>), <span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>), <span class="number">1</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>), <span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>), <span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>)],</span><br><span class="line">        [<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="number">0</span>,<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="number">2</span>,<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="number">4</span>,<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>)],</span><br><span class="line">        [<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="number">0</span>,<span class="number">8</span>,<span class="number">1</span>,<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="number">1</span>],</span><br><span class="line">        [<span class="number">1</span>,<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="number">8</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>)],</span><br><span class="line">        [<span class="number">3</span>,<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="number">1</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="number">1</span>,<span class="number">5</span>,<span class="number">3</span>],</span><br><span class="line">        [<span class="number">4</span>,<span class="number">2</span>,<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="number">5</span>,<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="number">0</span>,<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="number">1</span>,<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>)],</span><br><span class="line">        [<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="number">1</span>,<span class="number">1</span>,<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="number">0</span>,<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="number">5</span>],</span><br><span class="line">        [<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="number">4</span>,<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="number">2</span>,<span class="number">5</span>,<span class="number">1</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>)],</span><br><span class="line">        [<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="number">1</span>,<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="number">3</span>,<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="number">0</span>]</span><br><span class="line">    ]</span><br><span class="line">             </span><br><span class="line">    t = yuanshen(array, <span class="number">1</span>, <span class="number">8</span>)</span><br><span class="line">    IV = <span class="string">&quot;&quot;</span>.join(<span class="built_in">str</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> t)</span><br><span class="line">    IV = adjust_length(IV)</span><br><span class="line">    </span><br><span class="line">    check = qidong(flag, key, IV)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> check == data:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;yes,yes,yes!!&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;bad,bad,bad!!&quot;</span>)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>一个简单的DES加密，运行代码就可以获取IV。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pyDes</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">adjust_length</span>(<span class="params"><span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(<span class="built_in">str</span>) &lt; <span class="number">8</span>:</span><br><span class="line">        <span class="built_in">str</span> = <span class="built_in">str</span>.ljust(<span class="number">8</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    <span class="keyword">elif</span> <span class="built_in">len</span>(<span class="built_in">str</span>) &gt; <span class="number">8</span>:</span><br><span class="line">        <span class="built_in">str</span> = <span class="built_in">str</span>[:<span class="number">8</span>]</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">yuanshen</span>(<span class="params">array, start, end</span>):</span><br><span class="line">    num = <span class="built_in">len</span>(array)</span><br><span class="line">    inf = math.inf</span><br><span class="line">    dis = [inf] * num</span><br><span class="line">    tree = [<span class="literal">False</span>] * num </span><br><span class="line">    parent = [-<span class="number">1</span>] * num</span><br><span class="line">    </span><br><span class="line">    dis[start] = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num):</span><br><span class="line">        min_dis = inf</span><br><span class="line">        min_index = -<span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> v <span class="keyword">in</span> <span class="built_in">range</span>(num):</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> tree[v]:</span><br><span class="line">                <span class="keyword">if</span> dis[v] &lt; min_dis:</span><br><span class="line">                    min_dis = dis[v]  </span><br><span class="line">                    min_index = v</span><br><span class="line">                </span><br><span class="line">        <span class="keyword">if</span> min_index == -<span class="number">1</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">        tree[min_index] = <span class="literal">True</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">for</span> v <span class="keyword">in</span> <span class="built_in">range</span>(num):</span><br><span class="line">            <span class="keyword">if</span> tree[v]:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">if</span> array[min_index] != math.inf <span class="keyword">and</span> array[min_index][v] != math.inf:</span><br><span class="line">                <span class="keyword">if</span> dis[min_index] + array[min_index][v] &lt; dis[v]:</span><br><span class="line">                    dis[v] = dis[min_index] + array[min_index][v] </span><br><span class="line">                    parent[v] = min_index</span><br><span class="line">                    </span><br><span class="line">    <span class="keyword">if</span> dis[end] == math.inf:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">    t = []</span><br><span class="line">    current = end</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> current != -<span class="number">1</span>:</span><br><span class="line">        t.append(current)</span><br><span class="line">        current = parent[current]</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> t[::-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">qidong</span>(<span class="params"><span class="built_in">input</span>, key, IV</span>):</span><br><span class="line">    cipher = pyDes.des(key, pyDes.CBC, IV, pad = <span class="literal">None</span>, padmode = pyDes.PAD_PKCS5)</span><br><span class="line">    encrypted_data = cipher.decrypt(<span class="built_in">input</span>)</span><br><span class="line">    <span class="keyword">return</span> encrypted_data</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    data = (<span class="number">159</span>, <span class="number">41</span>, <span class="number">201</span>, <span class="number">125</span>, <span class="number">67</span>, <span class="number">60</span>, <span class="number">44</span>, <span class="number">34</span>, <span class="number">203</span>, <span class="number">56</span>, <span class="number">116</span>, <span class="number">186</span>, <span class="number">13</span>, <span class="number">71</span>, <span class="number">125</span>, <span class="number">30</span>, <span class="number">84</span>, <span class="number">123</span>, <span class="number">109</span>, <span class="number">54</span>, <span class="number">106</span>, <span class="number">56</span>, <span class="number">17</span>, <span class="number">124</span>, <span class="number">87</span>, <span class="number">236</span>, <span class="number">25</span>, <span class="number">12</span>, <span class="number">80</span>, <span class="number">178</span>, <span class="number">165</span>, <span class="number">123</span>)  </span><br><span class="line">    key = <span class="string">&quot;yuanshen&quot;</span></span><br><span class="line">    array = [</span><br><span class="line">        [<span class="number">0</span>, <span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>), <span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>), <span class="number">1</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>), <span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>), <span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>)],</span><br><span class="line">        [<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="number">0</span>,<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="number">2</span>,<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="number">4</span>,<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>)],</span><br><span class="line">        [<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="number">0</span>,<span class="number">8</span>,<span class="number">1</span>,<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="number">1</span>],</span><br><span class="line">        [<span class="number">1</span>,<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="number">8</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>)],</span><br><span class="line">        [<span class="number">3</span>,<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="number">1</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="number">1</span>,<span class="number">5</span>,<span class="number">3</span>],</span><br><span class="line">        [<span class="number">4</span>,<span class="number">2</span>,<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="number">5</span>,<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="number">0</span>,<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="number">1</span>,<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>)],</span><br><span class="line">        [<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="number">1</span>,<span class="number">1</span>,<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="number">0</span>,<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="number">5</span>],</span><br><span class="line">        [<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="number">4</span>,<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="number">2</span>,<span class="number">5</span>,<span class="number">1</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>)],</span><br><span class="line">        [<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="number">1</span>,<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="number">3</span>,<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>),<span class="number">0</span>]</span><br><span class="line">    ]</span><br><span class="line">             </span><br><span class="line">    t = yuanshen(array, <span class="number">1</span>, <span class="number">8</span>)</span><br><span class="line">    IV = <span class="string">&quot;&quot;</span>.join(<span class="built_in">str</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> t)</span><br><span class="line">    IV = adjust_length(IV)</span><br><span class="line">    </span><br><span class="line">    check = qidong(data, key, IV)</span><br><span class="line">    <span class="built_in">print</span>(check)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<h2 id="Tetris"><a href="#Tetris" class="headerlink" title="Tetris"></a>Tetris</h2><p>两段加密函数，分别构成整个FLAG：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">sub_E3B030</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> j; <span class="comment">// [esp+D0h] [ebp-70h]</span></span><br><span class="line">    <span class="type">int</span> i; <span class="comment">// [esp+DCh] [ebp-64h]</span></span><br><span class="line">    <span class="type">int</span> v4; <span class="comment">// [esp+E8h] [ebp-58h]</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> input_3; <span class="comment">// [esp+E8h] [ebp-58h]</span></span><br><span class="line">    <span class="type">int</span> v6; <span class="comment">// [esp+F4h] [ebp-4Ch]</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> input_2; <span class="comment">// [esp+F4h] [ebp-4Ch]</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> v8; <span class="comment">// [esp+100h] [ebp-40h]</span></span><br><span class="line">    <span class="type">int</span> input_1; <span class="comment">// [esp+100h] [ebp-40h]</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> input_1_; <span class="comment">// [esp+10Ch] [ebp-34h]</span></span><br><span class="line">    <span class="type">int</span> input_2_; <span class="comment">// [esp+110h] [ebp-30h]</span></span><br><span class="line">    <span class="type">int</span> input_3_; <span class="comment">// [esp+114h] [ebp-2Ch]</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> v13; <span class="comment">// [esp+120h] [ebp-20h]</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> v14; <span class="comment">// [esp+12Ch] [ebp-14h]</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> v15; <span class="comment">// [esp+138h] [ebp-8h]</span></span><br><span class="line"></span><br><span class="line">    __CheckForDebuggerJustMyCode(byte_E4D0FB);</span><br><span class="line">    v8 = *a1;</span><br><span class="line">    v6 = a1[<span class="number">1</span>];</span><br><span class="line">    v4 = a1[<span class="number">2</span>];</span><br><span class="line">    srand(<span class="number">0xABCDEF12</span>);</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">32</span>; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">        input_1_ = v8;</span><br><span class="line">        input_2_ = v6;</span><br><span class="line">        input_3_ = v4;</span><br><span class="line">        <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; <span class="number">12</span>; ++j )</span><br><span class="line">        *((_BYTE *)&amp;input_1_ + j) = <span class="number">17</span> * *((_BYTE *)&amp;input_1_ + j) + <span class="number">113</span>;</span><br><span class="line">        input_1 = (<span class="type">unsigned</span> __int8)input_1_ | (BYTE1(input_1_) &lt;&lt; <span class="number">8</span>) | (BYTE2(input_1_) &lt;&lt; <span class="number">16</span>) | (HIBYTE(input_1_) &lt;&lt; <span class="number">24</span>);</span><br><span class="line">        input_2 = (<span class="type">unsigned</span> __int8)input_2_ | (BYTE1(input_2_) &lt;&lt; <span class="number">8</span>) | (BYTE2(input_2_) &lt;&lt; <span class="number">16</span>) | (HIBYTE(input_2_) &lt;&lt; <span class="number">24</span>);</span><br><span class="line">        input_3 = (<span class="type">unsigned</span> __int8)input_3_ | (BYTE1(input_3_) &lt;&lt; <span class="number">8</span>) | (BYTE2(input_3_) &lt;&lt; <span class="number">16</span>) | (HIBYTE(input_3_) &lt;&lt; <span class="number">24</span>);</span><br><span class="line">        v15 = input_2 &gt;&gt; <span class="number">7</span>;</span><br><span class="line">        v14 = (input_2 &gt;&gt; <span class="number">7</span>) + rand();</span><br><span class="line">        v13 = (input_2 &lt;&lt; <span class="number">10</span>) ^ (input_2 &gt;&gt; <span class="number">15</span>) | <span class="number">3</span>;</span><br><span class="line">        v8 = input_1 + v14 + (v13 ^ rand());</span><br><span class="line">        v15 = input_3 &gt;&gt; <span class="number">7</span>;</span><br><span class="line">        v14 = (input_3 &gt;&gt; <span class="number">7</span>) + rand();</span><br><span class="line">        v13 = (input_3 &lt;&lt; <span class="number">10</span>) ^ (input_3 &gt;&gt; <span class="number">15</span>) | <span class="number">3</span>;</span><br><span class="line">        v6 = input_2 + v14 + (v13 ^ rand());</span><br><span class="line">        v15 = v8 &gt;&gt; <span class="number">7</span>;</span><br><span class="line">        v14 = (v8 &gt;&gt; <span class="number">7</span>) + rand();</span><br><span class="line">        v13 = (v8 &lt;&lt; <span class="number">10</span>) ^ (v8 &gt;&gt; <span class="number">15</span>) | <span class="number">3</span>;</span><br><span class="line">        v4 = input_3 + v14 + (v13 ^ rand());</span><br><span class="line">    &#125;</span><br><span class="line">    *a1 = v8;</span><br><span class="line">    a1[<span class="number">1</span>] = v6;</span><br><span class="line">    a1[<span class="number">2</span>] = v4;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 俄罗斯方块程序按I键进入一个函数，这个函数在那个函数里</span></span><br><span class="line"><span class="comment">// I键没有任何作用，很可疑</span></span><br><span class="line"><span class="type">int</span> __cdecl <span class="title function_">sub_E38A00</span><span class="params">(<span class="type">int</span> a1, <span class="type">int</span> a2, <span class="type">int</span> unk_30A00C__, <span class="type">int</span> unk_30A034__, <span class="type">int</span> output)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> k; <span class="comment">// [esp+D0h] [ebp-20h]</span></span><br><span class="line">    <span class="type">int</span> j; <span class="comment">// [esp+DCh] [ebp-14h]</span></span><br><span class="line">    <span class="type">int</span> i; <span class="comment">// [esp+E8h] [ebp-8h]</span></span><br><span class="line"></span><br><span class="line">    __CheckForDebuggerJustMyCode(byte_E4D0FB);</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">5</span>; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( *(_DWORD *)(output + <span class="number">8</span> * i + <span class="number">52</span>) * a1 + a2 * *(_DWORD *)(output + <span class="number">8</span> * i + <span class="number">48</span>) * *(_DWORD *)(output + <span class="number">4</span> * i) != *(_DWORD *)(unk_30A00C__ + <span class="number">4</span> * i) * a2 )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; <span class="number">5</span>; ++j )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( *(_DWORD *)(output + <span class="number">8</span> * j + <span class="number">92</span>) * a1 + a2 * *(_DWORD *)(output + <span class="number">8</span> * j + <span class="number">88</span>) * *(_DWORD *)(output + <span class="number">4</span> * j) != *(_DWORD *)(unk_30A00C__ + <span class="number">4</span> * j + <span class="number">20</span>) * a2 )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> ( k = <span class="number">0</span>; k &lt; <span class="number">9</span>; ++k )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( (*(_DWORD *)(output + <span class="number">4</span> * (<span class="number">2</span> * k + <span class="number">2</span>) + <span class="number">48</span>) ^ *(_DWORD *)(output + <span class="number">8</span> * k + <span class="number">48</span>)) != *(_DWORD *)(unk_30A034__ + <span class="number">4</span> * k) )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一段解密脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># DASCTF&#123;we1c0###################&#125;</span></span><br><span class="line"><span class="comment">#  ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789=#&#123;&#125;</span></span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inverse</span>(<span class="params">mul, mod</span>):</span><br><span class="line">    inverse = -<span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        <span class="keyword">if</span> (i * mul) % mod == <span class="number">1</span>:</span><br><span class="line">            inverse = i</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> inverse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dec1</span>():</span><br><span class="line">    result1 = [<span class="number">0xE266C86B</span>, <span class="number">0xED8632A1</span>, <span class="number">0x121540FF</span>]</span><br><span class="line">    randnum1 = [<span class="number">32115</span>, <span class="number">2364</span>, <span class="number">14693</span>, <span class="number">27985</span>, <span class="number">1927</span>, <span class="number">19812</span>, <span class="number">23296</span>, <span class="number">32389</span>, <span class="number">12568</span>, <span class="number">31600</span>, <span class="number">2532</span>, <span class="number">6912</span>, <span class="number">25453</span>, <span class="number">17238</span>, <span class="number">12991</span>, <span class="number">18185</span>, <span class="number">29384</span>, <span class="number">17699</span>, <span class="number">24313</span>, <span class="number">27061</span>, <span class="number">24567</span>, <span class="number">7232</span>, <span class="number">8937</span>, <span class="number">21072</span>, <span class="number">22566</span>, <span class="number">12276</span>, <span class="number">15432</span>, <span class="number">11518</span>, <span class="number">26359</span>, <span class="number">27947</span>, <span class="number">29926</span>, <span class="number">10914</span>, <span class="number">3797</span>, <span class="number">19830</span>, <span class="number">7579</span>, <span class="number">24575</span>, <span class="number">15237</span>, <span class="number">20306</span>, <span class="number">13697</span>, <span class="number">8222</span>, <span class="number">17149</span>, <span class="number">17325</span>, <span class="number">4448</span>, <span class="number">21999</span>, <span class="number">26746</span>, <span class="number">5286</span>, <span class="number">5994</span>, <span class="number">8498</span>, <span class="number">5581</span>, <span class="number">27029</span>, <span class="number">25385</span>, <span class="number">15000</span>, <span class="number">16117</span>, <span class="number">19531</span>, <span class="number">26037</span>, <span class="number">25382</span>, <span class="number">9203</span>, <span class="number">13211</span>, <span class="number">22058</span>, <span class="number">25307</span>, <span class="number">25818</span>, <span class="number">5913</span>, <span class="number">1625</span>, <span class="number">23186</span>, <span class="number">7206</span>, <span class="number">28705</span>, <span class="number">28606</span>, <span class="number">27946</span>, <span class="number">29518</span>, <span class="number">19483</span>, <span class="number">3251</span>, <span class="number">995</span>, <span class="number">26013</span>, <span class="number">21502</span>, <span class="number">20962</span>, <span class="number">12811</span>, <span class="number">9533</span>, <span class="number">27923</span>, <span class="number">23552</span>, <span class="number">31707</span>, <span class="number">22165</span>, <span class="number">22268</span>, <span class="number">9657</span>, <span class="number">1180</span>, <span class="number">5589</span>, <span class="number">27380</span>, <span class="number">23014</span>, <span class="number">26637</span>, <span class="number">31438</span>, <span class="number">24664</span>, <span class="number">5638</span>, <span class="number">17161</span>, <span class="number">3848</span>, <span class="number">14951</span>, <span class="number">12524</span>, <span class="number">12133</span>, <span class="number">27150</span>, <span class="number">17222</span>, <span class="number">22965</span>, <span class="number">14104</span>, <span class="number">26637</span>, <span class="number">14406</span>, <span class="number">8957</span>, <span class="number">670</span>, <span class="number">11933</span>, <span class="number">2922</span>, <span class="number">20051</span>, <span class="number">18078</span>, <span class="number">29663</span>, <span class="number">24100</span>, <span class="number">27625</span>, <span class="number">13514</span>, <span class="number">15304</span>, <span class="number">6496</span>, <span class="number">8848</span>, <span class="number">29702</span>, <span class="number">32700</span>, <span class="number">18115</span>, <span class="number">13284</span>, <span class="number">25549</span>, <span class="number">29791</span>, <span class="number">3893</span>, <span class="number">4292</span>, <span class="number">11985</span>, <span class="number">25000</span>, <span class="number">669</span>, <span class="number">4614</span>, <span class="number">28898</span>, <span class="number">16695</span>, <span class="number">3307</span>, <span class="number">10600</span>, <span class="number">29713</span>, <span class="number">5864</span>, <span class="number">15452</span>, <span class="number">7881</span>, <span class="number">18709</span>, <span class="number">14248</span>, <span class="number">15609</span>, <span class="number">11673</span>, <span class="number">16110</span>, <span class="number">29319</span>, <span class="number">11618</span>, <span class="number">5774</span>, <span class="number">32200</span>, <span class="number">20495</span>, <span class="number">12489</span>, <span class="number">31128</span>, <span class="number">18721</span>, <span class="number">23508</span>, <span class="number">25153</span>, <span class="number">3096</span>, <span class="number">11566</span>, <span class="number">11341</span>, <span class="number">3385</span>, <span class="number">32589</span>, <span class="number">7035</span>, <span class="number">7394</span>, <span class="number">20291</span>, <span class="number">11022</span>, <span class="number">15059</span>, <span class="number">28230</span>, <span class="number">1819</span>, <span class="number">20671</span>, <span class="number">28255</span>, <span class="number">16647</span>, <span class="number">13540</span>, <span class="number">2686</span>, <span class="number">22545</span>, <span class="number">7780</span>, <span class="number">12212</span>, <span class="number">15005</span>, <span class="number">23108</span>, <span class="number">862</span>, <span class="number">21587</span>, <span class="number">3925</span>, <span class="number">23708</span>, <span class="number">8722</span>, <span class="number">4416</span>, <span class="number">28344</span>, <span class="number">22580</span>, <span class="number">19781</span>, <span class="number">29685</span>, <span class="number">24296</span>, <span class="number">28408</span>, <span class="number">16961</span>, <span class="number">7020</span>, <span class="number">16007</span>, <span class="number">4687</span>, <span class="number">17632</span>, <span class="number">13282</span>, <span class="number">24942</span>, <span class="number">31998</span>]</span><br><span class="line">    randnum1.reverse()</span><br><span class="line">    rand_index = <span class="number">0</span></span><br><span class="line">    r1, r2, r3 = result1[<span class="number">0</span>], result1[<span class="number">1</span>], result1[<span class="number">2</span>]</span><br><span class="line">    inv = inverse(<span class="number">17</span>, <span class="number">256</span>)</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">32</span>):</span><br><span class="line">        t = ((r1 &lt;&lt; <span class="number">10</span>) ^ (r1 &gt;&gt; <span class="number">15</span>) | <span class="number">3</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        r3 = (r3 - (t ^ randnum1[rand_index])) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        rand_index += <span class="number">1</span></span><br><span class="line">        t = ((r1 &gt;&gt; <span class="number">7</span>) + randnum1[rand_index]) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        rand_index += <span class="number">1</span></span><br><span class="line">        r3 = (r3 - t) &amp; <span class="number">0xffffffff</span></span><br><span class="line"></span><br><span class="line">        t = ((r3 &lt;&lt; <span class="number">10</span>) ^ (r3 &gt;&gt; <span class="number">15</span>) | <span class="number">3</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        r2 = (r2 - (t ^ randnum1[rand_index])) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        rand_index += <span class="number">1</span></span><br><span class="line">        t = ((r3 &gt;&gt; <span class="number">7</span>) + randnum1[rand_index]) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        rand_index += <span class="number">1</span></span><br><span class="line">        r2 = (r2 - t) &amp; <span class="number">0xffffffff</span></span><br><span class="line"></span><br><span class="line">        t = ((r2 &lt;&lt; <span class="number">10</span>) ^ (r2 &gt;&gt; <span class="number">15</span>) | <span class="number">3</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        r1 = (r1 - (t ^ randnum1[rand_index])) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        rand_index += <span class="number">1</span></span><br><span class="line">        t = ((r2 &gt;&gt; <span class="number">7</span>) + randnum1[rand_index]) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        rand_index += <span class="number">1</span></span><br><span class="line">        r1 = (r1 - t) &amp; <span class="number">0xffffffff</span></span><br><span class="line"></span><br><span class="line">        r1_8bit = [(r1 &gt;&gt; j) &amp; <span class="number">0xFF</span> <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">32</span>, <span class="number">8</span>)]</span><br><span class="line">        r1_8bit = [(j * inv - <span class="number">113</span> * inv) % <span class="number">256</span> <span class="keyword">for</span> j <span class="keyword">in</span> r1_8bit]</span><br><span class="line">        r1 = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">            r1 += r1_8bit[j] &lt;&lt; (<span class="number">8</span> * j)</span><br><span class="line">        r2_8bit = [(r2 &gt;&gt; j) &amp; <span class="number">0xFF</span> <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">32</span>, <span class="number">8</span>)]</span><br><span class="line">        r2_8bit = [(j * inv - <span class="number">113</span> * inv) % <span class="number">256</span> <span class="keyword">for</span> j <span class="keyword">in</span> r2_8bit]</span><br><span class="line">        r2 = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">            r2 += r2_8bit[j] &lt;&lt; (<span class="number">8</span> * j)</span><br><span class="line">        r3_8bit = [(r3 &gt;&gt; j) &amp; <span class="number">0xFF</span> <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">32</span>, <span class="number">8</span>)]</span><br><span class="line">        r3_8bit = [(j * inv - <span class="number">113</span> * inv) % <span class="number">256</span> <span class="keyword">for</span> j <span class="keyword">in</span> r3_8bit]</span><br><span class="line">        r3 = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">            r3 += r3_8bit[j] &lt;&lt; (<span class="number">8</span> * j)</span><br><span class="line">    <span class="keyword">return</span> r1, r2, r3</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    flag = <span class="string">&quot;&quot;</span></span><br><span class="line">    flag1 = dec1()</span><br><span class="line">    flag1 = [struct.pack(<span class="string">&quot;&lt;I&quot;</span>, i) <span class="keyword">for</span> i <span class="keyword">in</span> flag1]</span><br><span class="line">    flag1 = <span class="string">b&quot;&quot;</span>.join(flag1)</span><br><span class="line">    <span class="built_in">print</span>(flag1)</span><br></pre></td></tr></table></figure>

<p>第二段解密脚本，直接那WP里的了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line">flag_length = <span class="number">32</span></span><br><span class="line">flag=[i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(flag_length)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(flag_length):</span><br><span class="line">    flag[i] = BitVec(<span class="string">&quot;v&#123;&#125;&quot;</span>.<span class="built_in">format</span>(i), <span class="number">32</span>)</span><br><span class="line">key1=[<span class="number">0x00000147</span>, <span class="number">0x00000098</span>, <span class="number">0x00000335</span>, <span class="number">0x00000099</span>, <span class="number">0x0000041C</span>, <span class="number">0x0000013A</span>, <span class="number">0x00000057</span>, <span class="number">0x00000442</span>, <span class="number">0x000000F6</span>, <span class="number">0x0000031E</span>]</span><br><span class="line">key2=[<span class="number">0x00000029</span>, <span class="number">0x00000027</span>, <span class="number">0x0000003D</span>, <span class="number">0x0000003A</span>, <span class="number">0x0000000D</span>, <span class="number">0x0000000E</span>, <span class="number">0x0000001C</span>, <span class="number">0x0000001D</span>, <span class="number">0x00000032</span>]</span><br><span class="line">s=Solver()</span><br><span class="line">flag1=[<span class="number">4</span>,<span class="number">1</span>,<span class="number">0x13</span>,<span class="number">3</span>,<span class="number">0x14</span>,<span class="number">6</span>,<span class="number">0x41</span>,<span class="number">0x31</span>,<span class="number">0x1F</span>,<span class="number">0x36</span>,<span class="number">0x1D</span>,<span class="number">0x35</span>]</span><br><span class="line"><span class="comment"># s.add(flag[0:12]==[4,1,0x13,3,0x14,6,0x41,0x31,0x1F,0x36,0x1D,0x35])</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">12</span>):</span><br><span class="line">    s.add(flag[i]==flag1[i])</span><br><span class="line">s.add(flag[<span class="number">31</span>]==<span class="number">0x42</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    s.add((flag[<span class="number">13</span>+i*<span class="number">2</span>]*<span class="number">3</span>+flag[<span class="number">12</span>+i*<span class="number">2</span>]*flag[i])==key1[i])</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    s.add((flag[<span class="number">23</span>+j*<span class="number">2</span>]*<span class="number">3</span>+flag[<span class="number">22</span>+j*<span class="number">2</span>]*flag[j])==key1[j+<span class="number">5</span>])</span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    s.add((flag[<span class="number">2</span>*k+<span class="number">2</span>+<span class="number">12</span>]^flag[<span class="number">2</span>*k+<span class="number">12</span>])==key2[k])</span><br><span class="line"><span class="keyword">if</span> s.check()==sat:</span><br><span class="line">    <span class="built_in">print</span>(s.model())</span><br></pre></td></tr></table></figure>

<h2 id="letsgo"><a href="#letsgo" class="headerlink" title="letsgo"></a>letsgo</h2><p>在<code>exe</code>的<code>hookmain</code>中，有一个函数，检测按键按下，如果都被按下了调用<code>r</code>，即DLL的加密函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">LRESULT __fastcall <span class="title function_">KeyboardHookProc</span><span class="params">(<span class="type">int</span> code, WPARAM wParam, _DWORD *lParam)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ( !code &amp;&amp; wParam == <span class="number">256</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( *lParam == <span class="string">&#x27;T&#x27;</span> )</span><br><span class="line">            flag = <span class="number">1</span>; <span class="comment">// 0x408030</span></span><br><span class="line">        <span class="keyword">if</span> ( *lParam == <span class="string">&#x27;O&#x27;</span> )</span><br><span class="line">            dword_408034 = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> ( *lParam == <span class="string">&#x27;U&#x27;</span> )</span><br><span class="line">            dword_408038 = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> ( *lParam == <span class="string">&#x27;F&#x27;</span> )</span><br><span class="line">            dword_40803C = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> ( *lParam == <span class="string">&#x27;U&#x27;</span> )</span><br><span class="line">            dword_408040 = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> ( *lParam == <span class="string">&#x27;L&#x27;</span> )</span><br><span class="line">            dword_408044 = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)sum(&amp;flag) == <span class="number">6</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        r();</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> CallNextHookEx(<span class="number">0</span>i64, code, wParam, (LPARAM)lParam);</span><br><span class="line">&#125;</span><br><span class="line">__int64 <span class="title function_">r</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    FARPROC ProcAddress; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line">    HMODULE hModule; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">    hModule = LoadLibraryA(<span class="string">&quot;test1.dll&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !hModule )</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    ProcAddress = GetProcAddress(hModule, <span class="string">&quot;Enc&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !ProcAddress )</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> ((__int64 (__fastcall *)(__int64))ProcAddress)(<span class="number">42</span>i64);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DLL进行UPX脱壳：</p>
<p><img src="/2023/12/24/CTF-wp-3/image-20231219134014904.png"></p>
<p><img src="/2023/12/24/CTF-wp-3/image-20231219134045921.png"></p>
<p>在<code>main_Enc</code>中，</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.Enc</span></span><br><span class="line"><span class="comment">// local variable allocation has failed, the output may be wrong!</span></span><br><span class="line"><span class="type">void</span> __golang <span class="title function_">main_Enc</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">   	.......</span><br><span class="line">    <span class="comment">// 获取加密的key和明文</span></span><br><span class="line">    v51.str = (uint8 *)<span class="string">&quot;touful&quot;</span>;</span><br><span class="line">    v51.len = <span class="number">6LL</span>;</span><br><span class="line">    v1 = os_Getenv(v51);</span><br><span class="line">    plainText.str = v1.str;</span><br><span class="line">    qmemcpy(ptr, <span class="string">&quot;A^=IadV[P2K.Nw:)&quot;</span>, <span class="keyword">sizeof</span>(ptr));</span><br><span class="line">    v43 = <span class="number">0x4C650A692B391345</span>LL;</span><br><span class="line">    v61 = runtime_stringtoslicebyte((runtime_tmpBuf *)buf, v1);</span><br><span class="line">    cap = v61.cap;</span><br><span class="line">    v61.cap = v61.len;</span><br><span class="line">    v61.len = (<span class="type">int</span>)v61.<span class="built_in">array</span>;</span><br><span class="line">    v3 = encoding_base64__ptr_Encoding_EncodeToString(encoding_base64_StdEncoding, *(__uint8 *)&amp;v61.len);</span><br><span class="line">    plainText.len = (<span class="type">int</span>)v3.str;</span><br><span class="line">    s = v3.len;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 循环 count += (pow(math_rand_Float64(), 2) + pow(math_rand_Float64(), 2) &lt;= 1)</span></span><br><span class="line">    <span class="comment">// 利用随机点在圆内外的不同概率来求 pi/4，作为随机种子</span></span><br><span class="line">    v13 = <span class="number">0LL</span>;</span><br><span class="line">    v14 = <span class="number">0LL</span>;</span><br><span class="line">    <span class="keyword">while</span> ( v13 &lt; <span class="number">0xE8D4A50FFF</span>LL )</span><br><span class="line">    &#123;</span><br><span class="line">        v35 = v13;</span><br><span class="line">        <span class="keyword">for</span> ( j = <span class="number">0LL</span>; j &lt; <span class="number">0xE8D4A50FFF</span>LL; ++j )</span><br><span class="line">        &#123;</span><br><span class="line">            v33 = j;</span><br><span class="line">            <span class="keyword">for</span> ( k = <span class="number">0LL</span>; k &lt; <span class="number">0xE8D4A50FFF</span>LL; ++k )</span><br><span class="line">            &#123;</span><br><span class="line">                v32 = k;</span><br><span class="line">                <span class="keyword">for</span> ( m = <span class="number">0LL</span>; m &lt; <span class="number">0xE8D4A50FFF</span>LL; ++m )</span><br><span class="line">                &#123;</span><br><span class="line">                    v29 = m;</span><br><span class="line">                    <span class="keyword">for</span> ( n = <span class="number">0LL</span>; n &lt; <span class="number">0xE8D4A50FFF</span>LL; ++n )</span><br><span class="line">                    &#123;</span><br><span class="line">                        v31 = n;</span><br><span class="line">                        v24 = <span class="number">0LL</span>;</span><br><span class="line">                        <span class="keyword">while</span> ( v24 &lt; <span class="number">0xE8D4A50FFF</span>LL )</span><br><span class="line">                        &#123;</span><br><span class="line">                            v30 = v24;</span><br><span class="line">                            v41 = v14;</span><br><span class="line">                            x = math_rand_Float64();</span><br><span class="line">                            v27 = math_rand_Float64();</span><br><span class="line">                            v26 = math_pow(x, <span class="number">2.0</span>);</span><br><span class="line">                            v25 = math_pow(v27, <span class="number">2.0</span>);</span><br><span class="line">                            v14 = v41;</span><br><span class="line">                            <span class="keyword">if</span> ( v26 + v25 &lt;= <span class="number">1.0</span> )</span><br><span class="line">                                v14 = v41 + <span class="number">1</span>;</span><br><span class="line">                            v24 = v30 + <span class="number">1</span>;</span><br><span class="line">                            v13 = v35;</span><br><span class="line">                            j = v33;</span><br><span class="line">                            k = v32;</span><br><span class="line">                            m = v29;</span><br><span class="line">                            n = v31;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ++v13;</span><br><span class="line">    &#125;</span><br><span class="line">    v40 = v14;</span><br><span class="line">    <span class="comment">// 上面的循环一共有 9999999999 ** 6 次</span></span><br><span class="line">    v16 = math_pow(<span class="number">9.99999999999e11</span>, <span class="number">6.0</span>);</span><br><span class="line">    <span class="comment">// pi/4作为随机种子，异或ptr（math_rand_Int()结果被修改会异或0xA），即key</span></span><br><span class="line">    math_rand__ptr_Rand_Seed(math_rand_globalRand, COERCE_UNSIGNED_INT64(<span class="number">4.0</span> * (<span class="type">double</span>)(<span class="type">int</span>)v40 / v16) % <span class="number">0x5F5E100</span>);</span><br><span class="line">    <span class="keyword">for</span> ( ii = <span class="number">0LL</span>; ii &lt; <span class="number">24</span>; ii = v34 + <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        v34 = ii;</span><br><span class="line">        ptr[ii] ^= math_rand_Int() % <span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 加密1</span></span><br><span class="line">    <span class="keyword">if</span> ( v1.len &lt; <span class="number">0x10</span>uLL )</span><br><span class="line">        runtime_panicSliceAlen();</span><br><span class="line">    v53 = runtime_slicebytetostring((runtime_tmpBuf *)v45, ptr, <span class="number">24LL</span>);</span><br><span class="line">    v57.str = plainText.str;</span><br><span class="line">    v57.len = <span class="number">16LL</span>;</span><br><span class="line">    v62 = main_encrypt(v53, v57);</span><br><span class="line">    <span class="keyword">if</span> ( v1.len &lt; <span class="number">0x20</span>uLL )</span><br><span class="line">        runtime_panicSliceAlen();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 加密2</span></span><br><span class="line">    v39 = v62._r0.len;</span><br><span class="line">    str = v62._r0.str;</span><br><span class="line">    v54 = runtime_slicebytetostring((runtime_tmpBuf *)v44, ptr, <span class="number">24LL</span>);</span><br><span class="line">    v58.str = plainText.str + <span class="number">16</span>;</span><br><span class="line">    v58.len = <span class="number">16LL</span>;</span><br><span class="line">    v63 = main_encrypt(v54, v58);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 比较1</span></span><br><span class="line">    <span class="keyword">if</span> ( v39 == <span class="number">32</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        v48 = v63._r0.str;</span><br><span class="line">        v38 = v63._r0.len;</span><br><span class="line">        runtime_memequal();</span><br><span class="line">        v63._r0.len = v38;</span><br><span class="line">        v18 = v19;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        v18 = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !v18 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_28;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 比较2</span></span><br><span class="line">    <span class="keyword">if</span> ( v63._r0.len == <span class="number">32</span> )</span><br><span class="line">        runtime_memequal();</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        v20 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v20 )</span><br><span class="line">    &#123;</span><br><span class="line">        v55.str = (uint8 *)<span class="string">&quot;TOUFUL&quot;</span>;</span><br><span class="line">        v55.len = <span class="number">6LL</span>;</span><br><span class="line">        v59.str = (uint8 *)<span class="string">&quot;yes you are right&quot;</span>;</span><br><span class="line">        v59.len = <span class="number">17LL</span>;</span><br><span class="line">        os_Setenv(v55, v59);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        LABEL_28:</span><br><span class="line">        v56.str = (uint8 *)<span class="string">&quot;TOUFUL&quot;</span>;</span><br><span class="line">        v56.len = <span class="number">6LL</span>;</span><br><span class="line">        v60.str = (uint8 *)<span class="string">&quot;no no no~~~&quot;</span>;</span><br><span class="line">        v60.len = <span class="number">11LL</span>;</span><br><span class="line">        os_Setenv(v56, v60);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// math/rand.Int</span></span><br><span class="line"><span class="type">int</span> __golang <span class="title function_">math_rand_Int</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> (*((__int64 (__golang **)(<span class="type">void</span> *))math_rand_globalRand-&gt;src.tab + <span class="number">3</span>))(math_rand_globalRand-&gt;src.data) &amp; <span class="number">0x7FFFFFFFFFFFFFFF</span>LL ^ <span class="number">0xA</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AES加密</span></span><br><span class="line"><span class="comment">// main.encrypt</span></span><br><span class="line">retval_37F67C700 __golang <span class="title function_">main_encrypt</span><span class="params">(<span class="built_in">string</span> key, <span class="built_in">string</span> plainText)</span></span><br><span class="line">&#123;</span><br><span class="line">    ......</span><br><span class="line">    plainText_8 = plainText.len;</span><br><span class="line">    plainTexta = plainText.str;</span><br><span class="line">    len = key.len;</span><br><span class="line">    v21.str = key.str;</span><br><span class="line">    v21.len = len;</span><br><span class="line">    v23 = runtime_stringtoslicebyte((runtime_tmpBuf *)buf, v21);</span><br><span class="line">    result = (retval_37F67C700)crypto_aes_NewCipher(v23);</span><br><span class="line">    <span class="keyword">if</span> ( result._r1.tab )</span><br><span class="line">    &#123;</span><br><span class="line">        v9 = <span class="number">0LL</span>;</span><br><span class="line">        v10 = <span class="number">0LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        v16 = result._r0.len;</span><br><span class="line">        str = result._r0.str;</span><br><span class="line">        v17 = runtime_makeslice((runtime__type *)&amp;RTYPE_uint8_0, plainText_8, plainText_8);</span><br><span class="line">        v22.str = plainTexta;</span><br><span class="line">        v22.len = plainText_8;</span><br><span class="line">        v24 = runtime_stringtoslicebyte(<span class="number">0LL</span>, v22);</span><br><span class="line">        (*((<span class="type">void</span> (__golang **)(<span class="type">int</span>, _BYTE *, <span class="type">int</span>, <span class="type">int</span>, uint8 *, <span class="type">int</span>, <span class="type">int</span>))str + <span class="number">5</span>))(</span><br><span class="line">            v16,</span><br><span class="line">            v17,</span><br><span class="line">            plainText_8,</span><br><span class="line">            plainText_8,</span><br><span class="line">            v24.<span class="built_in">array</span>,</span><br><span class="line">            v24.len,</span><br><span class="line">            v24.cap);</span><br><span class="line">        v4 = (uint8 *)runtime_makeslice((runtime__type *)&amp;RTYPE_uint8_0, <span class="number">2</span> * plainText_8, <span class="number">2</span> * plainText_8);</span><br><span class="line">        v5 = <span class="number">2</span> * plainText_8;</span><br><span class="line">        v6 = v17;</span><br><span class="line">        v7 = <span class="number">0LL</span>;</span><br><span class="line">        v8 = <span class="number">0LL</span>;</span><br><span class="line">        <span class="keyword">while</span> ( plainText_8 &gt; v7 )</span><br><span class="line">        &#123;</span><br><span class="line">            v11 = v6[v7];</span><br><span class="line">            <span class="keyword">if</span> ( v8 &gt;= v5 )</span><br><span class="line">                runtime_panicIndex();</span><br><span class="line">            v4[v8] = a0123456789abcd_0[v11 &gt;&gt; <span class="number">4</span>];</span><br><span class="line">            v12 = a0123456789abcd_0[v11 &amp; <span class="number">0xF</span>];</span><br><span class="line">            <span class="keyword">if</span> ( v5 &lt;= v8 + <span class="number">1</span> )</span><br><span class="line">                runtime_panicIndex();</span><br><span class="line">            v4[v8 + <span class="number">1</span>] = v12;</span><br><span class="line">            ++v7;</span><br><span class="line">            v8 += <span class="number">2LL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        v13 = runtime_slicebytetostring(<span class="number">0LL</span>, v4, v5);</span><br><span class="line">        v10 = v13.len;</span><br><span class="line">        v9 = v13.str;</span><br><span class="line">        result._r1.tab = <span class="number">0LL</span>;</span><br><span class="line">        result._r1.data = <span class="number">0LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    result._r0.len = v10;</span><br><span class="line">    result._r0.str = v9;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上可知计算出来的<code>pi/4</code>就是种子，这里直接patch掉计算的部分，将<code>rand_seed</code>的参数直接设置为计算好的：<code>0x31a2818&#39;</code></p>
<p>这里用的是WP里获取种子的大小，这个脚本其他不知道为啥，计算的key和flag不对。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">hello</span><span class="params">()</span></span>  &#123;</span><br><span class="line">    aeskey:=[]<span class="type">byte</span>&#123;<span class="number">65</span>,<span class="number">94</span>,<span class="number">61</span>,<span class="number">73</span>,<span class="number">97</span>,<span class="number">100</span>,<span class="number">86</span>,<span class="number">91</span>,<span class="number">80</span>,<span class="number">50</span>,<span class="number">75</span>,<span class="number">46</span>,<span class="number">78</span>,<span class="number">119</span>,<span class="number">58</span>,<span class="number">41</span>,<span class="number">69</span>,<span class="number">19</span>,<span class="number">57</span>,<span class="number">43</span>,<span class="number">105</span>,<span class="number">10</span>,<span class="number">101</span>,<span class="number">76</span>&#125;</span><br><span class="line">    key1:=(math.Float64bits(<span class="number">3.141592653589793238462643383279502884197</span>)%<span class="number">100000000</span>)<span class="comment">//</span></span><br><span class="line">    rand.Seed(<span class="type">int64</span>(key1))</span><br><span class="line">    <span class="keyword">for</span> i:=<span class="number">0</span>;i&lt;<span class="built_in">len</span>(aeskey);i++ &#123;</span><br><span class="line">        aeskey[i] = <span class="type">byte</span>((rand.Int())%<span class="number">100</span> ^ <span class="type">int</span>(aeskey[i]))</span><br><span class="line">    &#125;</span><br><span class="line">    a1,_:=DecryptAES(<span class="type">string</span>(aeskey),<span class="string">&quot;ff44ac7700732a16589f7ff8bdbaa923&quot;</span>)</span><br><span class="line">    a2,_:=DecryptAES(<span class="type">string</span>(aeskey),<span class="string">&quot;57c29c367a781ead5fb143469d75f319&quot;</span>)</span><br><span class="line">    fmt.Println(<span class="string">&quot;seed is:&quot;</span>,key1)</span><br><span class="line">    fmt.Println(<span class="string">&quot;key is:&quot;</span>,<span class="type">string</span>(aeskey))</span><br><span class="line">    fmt.Printf(<span class="string">&quot;flag is:%s%s&quot;</span>,a1,a2)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DecryptAES</span><span class="params">(key <span class="type">string</span>, encryptText <span class="type">string</span>)</span></span> (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line">    decodeText, _ := hex.DecodeString(encryptText)</span><br><span class="line">    cipher, err := aes.NewCipher([]<span class="type">byte</span>(key))</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    out := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="built_in">len</span>(decodeText))</span><br><span class="line">    cipher.Decrypt(out, decodeText)</span><br><span class="line">    <span class="keyword">return</span> <span class="type">string</span>(out[:]), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后获取加密的<code>key</code>：<code>[100, 111, 95, 121, 111, 117, 95, 116, 104, 105, 110, 107, 95, 116, 104, 105, 115, 95, 105, 115, 95, 107, 101, 121]</code></p>
<p>然后就可以进行AES解密了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="comment"># key = [0x5B566461493D5E41, 0x293A774E2E4B3250, 0x4C650A692B391345]</span></span><br><span class="line"><span class="comment"># key = b&#x27;&#x27;.join([i.to_bytes(8, &quot;little&quot;) for i in key])</span></span><br><span class="line"><span class="comment"># # key = base64.b64encode(key.encode()).decode()</span></span><br><span class="line"><span class="comment"># print(key)</span></span><br><span class="line"><span class="comment"># key = [i ^ j for i, j in zip(key, rand_num)]</span></span><br><span class="line">key = [<span class="number">100</span>, <span class="number">111</span>, <span class="number">95</span>, <span class="number">121</span>, <span class="number">111</span>, <span class="number">117</span>, <span class="number">95</span>, <span class="number">116</span>, <span class="number">104</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">107</span>, <span class="number">95</span>, <span class="number">116</span>, <span class="number">104</span>, <span class="number">105</span>, <span class="number">115</span>, <span class="number">95</span>, <span class="number">105</span>, <span class="number">115</span>, <span class="number">95</span>, <span class="number">107</span>, <span class="number">101</span>, <span class="number">121</span>]</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line">data = <span class="built_in">bytes</span>.fromhex(<span class="string">&#x27;ff44ac7700732a16589f7ff8bdbaa923&#x27;</span> + <span class="string">&#x27;57c29c367a781ead5fb143469d75f319&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(AES.new(<span class="built_in">bytearray</span>(key), AES.MODE_ECB).decrypt(data))</span><br></pre></td></tr></table></figure>

<h1 id="古剑杯"><a href="#古剑杯" class="headerlink" title="古剑杯"></a>古剑杯</h1><h2 id="re2"><a href="#re2" class="headerlink" title="re2"></a>re2</h2><p><code>v3</code>解密数据，数据以<code>ELF</code>开头，后面程序会自动dump出来的。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">void</span> *v3; <span class="comment">// rdi</span></span><br><span class="line">    sub_400A26(<span class="string">&quot;\x1B[31mUse emergency communication password: help me!&quot;</span>, a2, a3);</span><br><span class="line">    v3 = mmap(<span class="number">0LL</span>, <span class="number">0x10000</span>uLL, <span class="number">7</span>, <span class="number">34</span>, <span class="number">0</span>, <span class="number">0LL</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(v3, sub_400EF0, <span class="number">0xE9</span>uLL);</span><br><span class="line">    ((<span class="type">void</span> (*)(<span class="type">void</span>))v3)();</span><br><span class="line">    sub_400CFC();</span><br><span class="line">    sub_400BAE();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>开启子进程执行<code>ELF</code>，同时给父进程调式，父进程将<code>0x6020AC</code>的数据改为<code>7</code>，即子进程的密钥位置。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">sub_400BAE</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;v3[<span class="number">224</span>], <span class="number">0</span>, <span class="number">0x58</span>uLL);</span><br><span class="line">    v4 = <span class="number">0</span>;</span><br><span class="line">    pid__ = fork();</span><br><span class="line">    pid = pid__;</span><br><span class="line">    <span class="keyword">if</span> ( pid__ == <span class="number">-1</span> )</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( pid__ )</span><br><span class="line">    &#123;</span><br><span class="line">        wait(<span class="number">0LL</span>);</span><br><span class="line">        <span class="keyword">if</span> ( ptrace(PTRACE_GETREGS, pid, <span class="number">0LL</span>, v3) &lt; <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            perror(<span class="string">&quot;ptrace(GETREGS):&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        ptrace(PTRACE_POKEDATA, pid, &amp;unk_6020AC, <span class="number">7LL</span>); <span class="comment">// 写入数据</span></span><br><span class="line">        ptrace(PTRACE_CONT, pid, <span class="number">0LL</span>, <span class="number">0LL</span>); <span class="comment">// 子进程恢复执行</span></span><br><span class="line">        wait(<span class="number">0LL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        ptrace(PTRACE_TRACEME, <span class="number">0LL</span>, <span class="number">0LL</span>, <span class="number">0LL</span>);</span><br><span class="line">        execl(<span class="string">&quot;./core&quot;</span>, <span class="string">&quot;./core&quot;</span>, <span class="number">0LL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>子进程解flag逻辑，是个TEA解密，只是密钥需要父进程写入一下。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">sub_400914</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    v2 = (<span class="type">unsigned</span> <span class="type">int</span> *)byte_6020C0;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">3</span>; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">        TEA(v2, dword_6020A0);</span><br><span class="line">        result = <span class="number">8LL</span>;</span><br><span class="line">        v2 += <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">tea_dec</span>(<span class="params">cipher, key</span>):</span><br><span class="line">    num = <span class="number">0xE3779B90</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">        cipher[<span class="number">1</span>] -= ((num + cipher[<span class="number">0</span>]) ^ ((cipher[<span class="number">0</span>] &lt;&lt; <span class="number">4</span>) + key[<span class="number">2</span>]) ^ ((cipher[<span class="number">0</span>] &gt;&gt; <span class="number">5</span>) + key[<span class="number">3</span>])) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        cipher[<span class="number">1</span>] &amp;= <span class="number">0xFFFFFFFF</span></span><br><span class="line">        cipher[<span class="number">0</span>] -= ((num + cipher[<span class="number">1</span>]) ^ ((cipher[<span class="number">1</span>] &lt;&lt; <span class="number">4</span>) + key[<span class="number">0</span>]) ^ ((cipher[<span class="number">1</span>] &gt;&gt; <span class="number">5</span>) + key[<span class="number">1</span>])) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        cipher[<span class="number">0</span>] &amp;= <span class="number">0xFFFFFFFF</span></span><br><span class="line">        num = (num + <span class="number">0x61C88647</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    <span class="keyword">return</span> cipher</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cipher = [</span><br><span class="line">    <span class="number">0xF7</span>, <span class="number">0xBE</span>, <span class="number">0x1D</span>, <span class="number">0xC1</span>, <span class="number">0x95</span>, <span class="number">0xB3</span>, <span class="number">0xC2</span>, <span class="number">0x62</span>, <span class="number">0x16</span>, <span class="number">0x33</span>,</span><br><span class="line">    <span class="number">0x9B</span>, <span class="number">0x3B</span>, <span class="number">0xBB</span>, <span class="number">0x54</span>, <span class="number">0xE2</span>, <span class="number">0x69</span>, <span class="number">0xA6</span>, <span class="number">0xCC</span>, <span class="number">0x20</span>, <span class="number">0xC1</span>,</span><br><span class="line">    <span class="number">0x4E</span>, <span class="number">0x44</span>, <span class="number">0x79</span>, <span class="number">0x37</span>, <span class="number">0x6B</span>, <span class="number">0x6E</span>, <span class="number">0x93</span>, <span class="number">0x6B</span>, <span class="number">0xB5</span>, <span class="number">0x77</span>,</span><br><span class="line">    <span class="number">0xC2</span>, <span class="number">0x35</span></span><br><span class="line">]</span><br><span class="line">key = [<span class="number">6</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line"><span class="keyword">import</span> struct </span><br><span class="line">cipher = <span class="built_in">list</span>(struct.unpack(<span class="string">&#x27;&lt;8I&#x27;</span>, <span class="built_in">bytes</span>(cipher)))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(cipher) // <span class="number">2</span>):</span><br><span class="line">    cipher[i * <span class="number">2</span>:i * <span class="number">2</span> + <span class="number">2</span>] = tea_dec(cipher[i * <span class="number">2</span>:i * <span class="number">2</span> + <span class="number">2</span>], key)</span><br><span class="line"><span class="built_in">print</span>(struct.pack(<span class="string">&#x27;&lt;8I&#x27;</span>, *cipher))</span><br></pre></td></tr></table></figure>

<h2 id="re3"><a href="#re3" class="headerlink" title="re3"></a>re3</h2><p><code>pyc</code>文件反编译出字节码让GPT去生成代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># visit https://tool.lu/pyc/ for more information</span></span><br><span class="line"><span class="comment"># Version: Python 2.7</span></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">flag1</span>():</span><br><span class="line">    code = <span class="built_in">str</span>[::-<span class="number">3</span>]</span><br><span class="line">    result = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> code:</span><br><span class="line">        ss = <span class="built_in">ord</span>(i) - <span class="number">1</span></span><br><span class="line">        result += <span class="built_in">chr</span>(ss)</span><br><span class="line">    <span class="built_in">print</span> result[::-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">flag2</span>():</span><br><span class="line">    code = <span class="built_in">str</span>[::-<span class="number">2</span>]</span><br><span class="line">    result = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> code:</span><br><span class="line">        ss = <span class="built_in">ord</span>(i) - <span class="number">1</span></span><br><span class="line">        result += <span class="built_in">chr</span>(ss)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span> result[::-<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">flag3</span>():</span><br><span class="line">    code = base64.b64decode(<span class="built_in">str</span>[::-<span class="number">1</span>])</span><br><span class="line">    result = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> code:</span><br><span class="line">        ss = <span class="built_in">ord</span>(i) - <span class="number">1</span></span><br><span class="line">        result += <span class="built_in">chr</span>(ss)</span><br><span class="line">    <span class="built_in">print</span> result[::-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">str</span> = <span class="string">&#x27;=cWbihGfyMzNllzZ&#x27;</span> + <span class="string">&#x27;0cjZzMW&#x27;</span>+<span class="string">&#x27;N5cTM4Y&#x27;</span>+<span class="string">&#x27;jYygTOy&#x27;</span>+<span class="string">&#x27;cmNycWNyYmM1Ujf&#x27;</span></span><br><span class="line">flag = <span class="string">&#x27;0cjZzMW&#x27;</span>+<span class="string">&#x27;N5cTM4Y&#x27;</span>+<span class="string">&#x27;jYygTOy&#x27;</span>+<span class="string">&#x27;cmNycWNyYmM1Ujf&#x27;</span></span><br><span class="line">flag1()</span><br></pre></td></tr></table></figure>

<p>有点不太对劲的，改改字节码，尝试执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──(biu㉿Biu)-[~/Desktop]</span><br><span class="line">└─$ python2 op.py | grep CALL_FUNCTION</span><br><span class="line">0x83 CALL_FUNCTION</span><br><span class="line">0x8d CALL_FUNCTION_KW</span><br><span class="line">0x8c CALL_FUNCTION_VAR</span><br><span class="line">0x8e CALL_FUNCTION_VAR_KW</span><br><span class="line">                                                        </span><br><span class="line">┌──(biu㉿Biu)-[~/Desktop]</span><br><span class="line">└─$ python2 op.py | grep LOAD_NAME    </span><br><span class="line">0x65 LOAD_NAME</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">65 02 就是CALL flag1</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">把 02 修改成 03 即可执行 CALL flag2</span></span><br></pre></td></tr></table></figure>



<p><img src="/2023/12/24/CTF-wp-3/image-20231208150907514.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">flag1输出：ifxMVX0e</span><br><span class="line">flag2输出：XNMMLe</span><br><span class="line">flag3报错，输出不出来...</span><br></pre></td></tr></table></figure>

<p>更改字节码，把<code>flag1</code>的<code>LOAD_FAST 1: result</code>改为<code>LOAD_GLOBAL 0: str</code>，输出str的逆序：<code>fjU1MmYyNWcyNmcyOTgyYj</code></p>
<p><img src="/2023/12/24/CTF-wp-3/image-20231208153005802.png"></p>
<p>然后，就看不懂了……</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># str = &#x27;=cWbi&#x27; + &#x27;hGfyM&#x27; + &#x27;zNllzZ&#x27; + &#x27;0cjZzMW&#x27; + &#x27;N5cTM4Y&#x27; + &#x27;jYygTOy&#x27; + &#x27;cmNycWNyYmM1Ujf&#x27;</span></span><br><span class="line"><span class="comment"># print(base64.b64decode(str[::-1]))</span></span><br><span class="line"><span class="comment"># b&#x27;~552f25g26g2982b681795c3f74g9e732|hbmg&#x27;</span></span><br><span class="line"><span class="comment"># 552f25g26g2982b681795c3f74g9e732</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">flag1</span>():</span><br><span class="line">    code = <span class="built_in">str</span>[::-<span class="number">3</span>]</span><br><span class="line">    result = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> code:</span><br><span class="line">        ss = <span class="built_in">ord</span>(i) - <span class="number">1</span></span><br><span class="line">        result += <span class="built_in">chr</span>(ss)</span><br><span class="line">    <span class="keyword">return</span> result[::-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">flag2</span>():</span><br><span class="line">    code = <span class="built_in">str</span>[::-<span class="number">2</span>]</span><br><span class="line">    result = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> code:</span><br><span class="line">        ss = <span class="built_in">ord</span>(i) - <span class="number">1</span></span><br><span class="line">        result += <span class="built_in">chr</span>(ss)</span><br><span class="line">    <span class="keyword">return</span> result[::-<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">flag3</span>():</span><br><span class="line">    code = base64.b64decode(<span class="built_in">str</span>[::-<span class="number">1</span>])</span><br><span class="line">    result = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> code:</span><br><span class="line">        ss = <span class="built_in">ord</span>(i) - <span class="number">1</span></span><br><span class="line">        result += <span class="built_in">chr</span>(ss)</span><br><span class="line">    <span class="keyword">return</span> result[::-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">str</span> = <span class="string">&quot;jYygTOycmNycWNyYmM1Ujf&quot;</span></span><br><span class="line"><span class="built_in">print</span>(flag1()) <span class="comment">#  ifxMVX0e</span></span><br><span class="line"><span class="built_in">print</span>(flag2()) <span class="comment">#  XNMMLe</span></span><br><span class="line"><span class="built_in">print</span>(flag3()) <span class="comment">#  </span></span><br></pre></td></tr></table></figure>





</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://hahbiubiubiu.github.io">hahbiubiubiu</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://hahbiubiubiu.github.io/2023/12/24/CTF-wp-3/">http://hahbiubiubiu.github.io/2023/12/24/CTF-wp-3/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://hahbiubiubiu.github.io" target="_blank">hahbiubiubiu</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Reverse/">Reverse</a><a class="post-meta__tags" href="/tags/CTF/">CTF</a></div><div class="post_share"><div class="social-share" data-image="/./img/preview.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/12/24/CTF-wp-4/"><img class="prev-cover" src="/./img/preview.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">CTF-WP-4</div></div></a></div><div class="next-post pull-right"><a href="/2023/12/11/PWN_%E5%AD%A6%E4%B9%A0/"><img class="next-cover" src="/./img/preview.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info"></div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/10/04/Bingo%E2%80%94%E2%80%94bugku/" title="Bingo——bugku"><img class="cover" src="/./img/preview.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-04</div><div class="title">Bingo——bugku</div></div></a></div><div><a href="/2023/06/23/DASCTF2023%E4%BA%8C%E8%BF%9B%E5%88%B6/" title="DASCTF2023二进制"><img class="cover" src="/./img/preview.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-23</div><div class="title">DASCTF2023二进制</div></div></a></div><div><a href="/2023/03/23/QExtend/" title="QExtend-300"><img class="cover" src="/./img/preview.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-23</div><div class="title">QExtend-300</div></div></a></div><div><a href="/2022/11/18/SCU2022%E6%96%B0%E7%94%9F%E8%B5%9B/" title="SCU2022新生赛"><img class="cover" src="/./img/preview.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-18</div><div class="title">SCU2022新生赛</div></div></a></div><div><a href="/2022/10/03/babyLoginPlus-bugku/" title="babyLoginPlus——bugku"><img class="cover" src="/./img/preview.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-03</div><div class="title">babyLoginPlus——bugku</div></div></a></div><div><a href="/2023/05/07/d3ctf2023%E5%AD%A6%E4%B9%A0/" title="d3ctf2023学习"><img class="cover" src="/./img/preview.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-07</div><div class="title">d3ctf2023学习</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/./img/Valkyrie.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">hahbiubiubiu</div><div class="author-info__description">派派玩家搞搞震</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">24</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/hahbiubiubiu"><i class="fab fa-github"></i><span>biubiaboom</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="/965116991@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">Hello!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#N1CTF2023"><span class="toc-number">1.</span> <span class="toc-text">N1CTF2023</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#AdditionPlus"><span class="toc-number">1.1.</span> <span class="toc-text">AdditionPlus</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%B8%80%E2%80%94%E2%80%94Ponce"><span class="toc-number">1.1.1.</span> <span class="toc-text">解法一——Ponce</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#N1LLua"><span class="toc-number">1.2.</span> <span class="toc-text">N1LLua</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#N1go"><span class="toc-number">1.3.</span> <span class="toc-text">N1go</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%B9%8F%E7%A8%8B%E6%9D%AF"><span class="toc-number">2.</span> <span class="toc-text">鹏程杯</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#bad-pe"><span class="toc-number">2.1.</span> <span class="toc-text">bad_pe</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E7%BC%96%E7%A8%8B"><span class="toc-number">2.2.</span> <span class="toc-text">安全编程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#babyre"><span class="toc-number">2.3.</span> <span class="toc-text">babyre</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ezapk"><span class="toc-number">2.4.</span> <span class="toc-text">ezapk</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%BB%E8%BE%91"><span class="toc-number">2.4.1.</span> <span class="toc-text">逻辑</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#DES-cbc-enc"><span class="toc-number">2.4.1.1.</span> <span class="toc-text">DES_cbc_enc</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AD%90%E5%AF%86%E9%92%A5%E7%94%9F%E6%88%90"><span class="toc-number">2.4.1.1.1.</span> <span class="toc-text">子密钥生成</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#DES-64bit-%E5%8A%A0%E5%AF%86"><span class="toc-number">2.4.1.1.2.</span> <span class="toc-text">DES 64bit 加密</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DES-ecb-enc"><span class="toc-number">2.4.1.2.</span> <span class="toc-text">DES_ecb_enc</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp"><span class="toc-number">2.4.2.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#StateMachine"><span class="toc-number">2.5.</span> <span class="toc-text">StateMachine</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%BB%E8%BE%91-1"><span class="toc-number">2.5.1.</span> <span class="toc-text">逻辑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-1"><span class="toc-number">2.5.2.</span> <span class="toc-text">exp</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ACTF2023"><span class="toc-number">3.</span> <span class="toc-text">ACTF2023</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#native-app"><span class="toc-number">3.1.</span> <span class="toc-text">native-app</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#blutter"><span class="toc-number">3.1.1.</span> <span class="toc-text">blutter</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#DASCTF-X-0psu3%E5%8D%81%E4%B8%80%E6%9C%88%E6%8C%91%E6%88%98%E8%B5%9B"><span class="toc-number">4.</span> <span class="toc-text">DASCTF X 0psu3十一月挑战赛</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ezpython"><span class="toc-number">4.1.</span> <span class="toc-text">ezpython</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tetris"><span class="toc-number">4.2.</span> <span class="toc-text">Tetris</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#letsgo"><span class="toc-number">4.3.</span> <span class="toc-text">letsgo</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%A4%E5%89%91%E6%9D%AF"><span class="toc-number">5.</span> <span class="toc-text">古剑杯</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#re2"><span class="toc-number">5.1.</span> <span class="toc-text">re2</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-2"><span class="toc-number">5.1.1.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#re3"><span class="toc-number">5.2.</span> <span class="toc-text">re3</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/12/24/CTF-wp-5/" title="CTF-WP-5"><img src="/./img/preview.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CTF-WP-5"/></a><div class="content"><a class="title" href="/2023/12/24/CTF-wp-5/" title="CTF-WP-5">CTF-WP-5</a><time datetime="2023-12-24T06:15:07.046Z" title="发表于 2023-12-24 14:15:07">2023-12-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/12/24/CTF-wp-4/" title="CTF-WP-4"><img src="/./img/preview.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CTF-WP-4"/></a><div class="content"><a class="title" href="/2023/12/24/CTF-wp-4/" title="CTF-WP-4">CTF-WP-4</a><time datetime="2023-12-24T06:15:07.043Z" title="发表于 2023-12-24 14:15:07">2023-12-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/12/24/CTF-wp-3/" title="CTF-WP-3"><img src="/./img/preview.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CTF-WP-3"/></a><div class="content"><a class="title" href="/2023/12/24/CTF-wp-3/" title="CTF-WP-3">CTF-WP-3</a><time datetime="2023-12-24T06:15:07.041Z" title="发表于 2023-12-24 14:15:07">2023-12-24</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2023 By hahbiubiubiu</div><div class="footer_custom_text">hahahahah biubiubiu boomboomboom</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"]):not([href="/music/"]):not([href="/no-pjax/"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>